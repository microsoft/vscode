/*---------------------------------------------------------------------------------------------
 *  Copyright (c) 2025 Lotas Inc. All rights reserved.
 *--------------------------------------------------------------------------------------------*/

(function(){let l=acquireVsCodeApi(),a={table:"",columns:[],indexes:[],comment:"",dbType:""},u=null,m=null,s=!1,r=null,x=document.getElementById("tableNameInput"),E=document.getElementById("tableComment"),D=document.getElementById("updateTableBtn"),T=document.getElementById("refreshBtn"),I=document.querySelectorAll(".tab-btn"),w=document.querySelectorAll(".tab-panel"),L=document.getElementById("addColumnBtn"),M=document.getElementById("columnsGrid"),C=document.getElementById("columnDialog"),A=document.getElementById("columnDialogTitle"),i=document.getElementById("columnName"),y=document.getElementById("columnType"),p=document.getElementById("columnComment"),f=document.getElementById("columnNotNull"),q=document.getElementById("saveColumnBtn"),G=document.getElementById("cancelColumnBtn"),_=document.getElementById("addIndexBtn"),U=document.getElementById("indexesGrid"),B=document.getElementById("indexDialog"),d=document.getElementById("indexColumn"),v=document.getElementById("indexType"),O=document.getElementById("saveIndexBtn"),P=document.getElementById("cancelIndexBtn");D.addEventListener("click",K),T.addEventListener("click",b),I.forEach(e=>{e.addEventListener("click",t=>H(t.target.dataset.tab))}),L.addEventListener("click",()=>N()),q.addEventListener("click",Q),G.addEventListener("click",h),_.addEventListener("click",()=>j()),O.addEventListener("click",z),P.addEventListener("click",k),window.addEventListener("message",e=>{let t=e.data;switch(t.type){case"designData":S(t.data);break;case"success":c(t.message,"success"),b();break;case"error":c(t.message,"error");break}});function S(e){a=e,x.value=e.table||"",E.value=e.comment||"",$(),V(),Y()}function $(){u||(u=new DataGrid(M,{sortable:!0,contextMenu:!0,onContextAction:F}));let e=[{field:"name",title:"Name"},{field:"type",title:"Type"},{field:"comment",title:"Comment"},{field:"maxLength",title:"Length"},{field:"defaultValue",title:"Default"},{field:"isPrimary",title:"Primary Key",render:t=>t?"\u2713":""},{field:"isUnique",title:"Unique",render:t=>t?"\u2713":""},{field:"nullable",title:"Not Null",render:t=>t==="NO"?"\u2713":""},{field:"isAutoIncrement",title:"Auto Increment",render:t=>t?"\u2713":""}];u.setData(a.columns||[],e)}function V(){m||(m=new DataGrid(U,{sortable:!0,contextMenu:!0,onContextAction:J}));let e=[{field:"index_name",title:"Index Name"},{field:"column_name",title:"Column Name"},{field:"non_unique",title:"Non Unique",render:t=>t?"Yes":"No"},{field:"index_type",title:"Index Type"}];m.setData(a.indexes||[],e)}function Y(){d.innerHTML="",(a.columns||[]).forEach(e=>{let t=document.createElement("option");t.value=e.name,t.textContent=e.name,d.appendChild(t)})}function H(e){I.forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),w.forEach(t=>{t.style.display=t.id===`${e}Panel`?"block":"none"})}function K(){let e=x.value.trim(),t=E.value.trim();if(!e){c("Table name is required","error");return}l.postMessage({type:"updateTable",newTableName:e,newComment:t})}function b(){l.postMessage({type:"refresh"})}function N(e=null){s=e!==null,r=e,A.textContent=s?"Edit Column":"Add Column",s?(i.value=e.name||"",y.value=e.type||"",p.value=e.comment||"",f.checked=e.nullable==="NO"):(i.value="",y.value="",p.value="",f.checked=!1),C.style.display="block",i.focus()}function h(){C.style.display="none",s=!1,r=null}function Q(){let e=i.value.trim(),t=y.value.trim(),n=p.value.trim(),o=f.checked;if(!e||!t){c("Column name and type are required","error");return}let g={name:e,type:t,comment:n,nullable:o?"NO":"YES"};s?(g.originalName=r.name,l.postMessage({type:"updateColumn",column:g})):l.postMessage({type:"addColumn",column:g}),h()}function j(){B.style.display="block",d.focus()}function k(){B.style.display="none",d.value="",v.value="UNIQUE"}function z(){let e=d.value,t=v.value;if(!e){c("Column selection is required","error");return}l.postMessage({type:"addIndex",index:{column:e,type:t}}),k()}function F(e){let{action:t,row:n}=e,o=a.columns[parseInt(n)];switch(t){case"edit":N(o);break;case"delete":confirm(`Are you sure you want to delete column "${o.name}"?`)&&l.postMessage({type:"deleteColumn",columnName:o.name});break}}function J(e){let{action:t,row:n}=e,o=a.indexes[parseInt(n)];switch(t){case"delete":confirm(`Are you sure you want to delete index "${o.index_name}"?`)&&l.postMessage({type:"deleteIndex",indexName:o.index_name});break}}function c(e,t){let n=document.querySelector(".status-message");n||(n=document.createElement("div"),n.className="status-message",document.body.appendChild(n)),n.textContent=e,n.className=`status-message status-${t}`,n.style.display="block",setTimeout(()=>{n.style.display="none"},3e3)}l.postMessage({type:"refresh"})})();
