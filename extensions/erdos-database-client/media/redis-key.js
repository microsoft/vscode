/*---------------------------------------------------------------------------------------------
 *  Copyright (c) 2025 Lotas Inc. All rights reserved.
 *--------------------------------------------------------------------------------------------*/

var o=class{constructor(){this.currentKey=null,this.currentKeyType=null,this.keyData=null,this.editModel=!1,this.init()}init(){this.initializeElements(),this.setupEventListeners(),this.setupVSCodeMessaging()}initializeElements(){if(this.keyNameInput=document.getElementById("keyName"),this.keyTypeSpan=document.getElementById("keyType"),this.keyTtlInput=document.getElementById("keyTtl"),this.renameBtn=document.getElementById("renameBtn"),this.deleteBtn=document.getElementById("deleteBtn"),this.refreshBtn=document.getElementById("refreshBtn"),this.stringContent=document.getElementById("stringContent"),this.collectionContent=document.getElementById("collectionContent"),this.viewFormat=document.getElementById("viewFormat"),this.stringValue=document.getElementById("stringValue"),this.saveStringBtn=document.getElementById("saveStringBtn"),this.addItemBtn=document.getElementById("addItemBtn"),this.collectionGrid=document.getElementById("collectionGrid"),this.editDialog=document.getElementById("editDialog"),this.dialogTitle=document.getElementById("dialogTitle"),this.itemKey=document.getElementById("itemKey"),this.itemValue=document.getElementById("itemValue"),this.confirmBtn=document.getElementById("confirmBtn"),this.cancelBtn=document.getElementById("cancelBtn"),!this.keyNameInput){console.error("Required DOM elements not found");return}}setupEventListeners(){this.renameBtn&&this.renameBtn.addEventListener("click",()=>this.renameKey()),this.deleteBtn&&this.deleteBtn.addEventListener("click",()=>this.deleteKey()),this.refreshBtn&&this.refreshBtn.addEventListener("click",()=>this.refreshKey()),this.keyTtlInput&&this.keyTtlInput.addEventListener("blur",()=>this.updateTtl()),this.saveStringBtn&&this.saveStringBtn.addEventListener("click",()=>this.saveStringValue()),this.viewFormat&&this.viewFormat.addEventListener("change",e=>this.changeViewFormat(e.target.value)),this.addItemBtn&&this.addItemBtn.addEventListener("click",()=>this.showAddItemDialog()),this.confirmBtn&&this.confirmBtn.addEventListener("click",()=>this.confirmDialog()),this.cancelBtn&&this.cancelBtn.addEventListener("click",()=>this.cancelDialog()),this.editDialog&&this.editDialog.addEventListener("click",e=>{e.target===this.editDialog&&this.cancelDialog()})}setupVSCodeMessaging(){window.addEventListener("message",e=>{let t=e.data;switch(t.type){case"detail":this.displayKeyData(t.res);break;case"msg":this.showSuccess(t.content);break;case"error":this.showError(t.message);break;case"refresh":this.refreshKey();break}})}displayKeyData(e){switch(this.keyData=e,this.currentKey=e.name,this.currentKeyType=e.type,this.keyNameInput&&(this.keyNameInput.value=e.name),this.keyTypeSpan&&(this.keyTypeSpan.textContent=e.type.toUpperCase(),this.keyTypeSpan.className=`key-type type-${e.type}`),this.keyTtlInput&&(this.keyTtlInput.value=e.ttl>0?e.ttl:""),this.showContentPanel(e.type),e.type){case"string":if(this.displayStringContent(e.content),e.content&&typeof e.content=="string"){let t=e.content.trim();(t.startsWith("[")||t.startsWith("{"))&&(this.viewFormat.value="json",this.changeViewFormat("json"))}break;case"list":case"set":case"hash":case"zset":this.displayCollectionContent(e.content,e.type);break}}showContentPanel(e){this.stringContent&&(this.stringContent.style.display="none"),this.collectionContent&&(this.collectionContent.style.display="none"),e==="string"?this.stringContent&&(this.stringContent.style.display="block"):this.collectionContent&&(this.collectionContent.style.display="block")}displayStringContent(e){this.stringValue&&(this.stringValue.value=e||"")}displayCollectionContent(e,t){if(!this.collectionGrid)return;this.collectionGrid.innerHTML="";let s=document.createElement("table");s.className="collection-table";let a=[];switch(t){case"list":a=e.map((i,l)=>({key:l.toString(),value:i,type:"list"}));break;case"set":a=e.map(i=>({key:i,value:i,type:"set"}));break;case"hash":a=Object.entries(e).map(([i,l])=>({key:i,value:l,type:"hash"}));break;case"zset":for(let i=0;i<e.length;i+=2)a.push({key:e[i],value:e[i+1],type:"zset"});break}let r=document.createElement("thead");r.innerHTML=`
            <tr>
                <th>Key</th>
                <th>Value</th>
                <th>Actions</th>
            </tr>
        `,s.appendChild(r);let c=document.createElement("tbody");a.forEach((i,l)=>{let d=document.createElement("tr");d.innerHTML=`
                <td>${this.escapeHtml(i.key)}</td>
                <td>${this.escapeHtml(i.value)}</td>
                <td>
                    <button class="btn btn-sm btn-secondary edit-item" data-index="${l}">
                        <i class="codicon codicon-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-item" data-index="${l}">
                        <i class="codicon codicon-trash"></i>
                    </button>
                </td>
            `,c.appendChild(d)}),s.appendChild(c),this.collectionGrid.appendChild(s),this.setupItemActions()}setupItemActions(){document.querySelectorAll(".edit-item").forEach(e=>{e.addEventListener("click",t=>{let s=parseInt(t.currentTarget.dataset.index);this.editItem(s)})}),document.querySelectorAll(".delete-item").forEach(e=>{e.addEventListener("click",t=>{let s=parseInt(t.currentTarget.dataset.index);this.deleteItem(s)})})}renameKey(){let e=this.keyNameInput.value;e&&e!==this.currentKey&&n.postMessage({type:"rename",key:{name:this.currentKey,newName:e}})}deleteKey(){confirm(`Are you sure you want to delete key "${this.currentKey}"?`)&&n.postMessage({type:"del",key:{name:this.currentKey}})}refreshKey(){this.currentKey&&n.postMessage({type:"refresh",key:{name:this.currentKey}})}updateTtl(){let e=parseInt(this.keyTtlInput.value)||-1;n.postMessage({type:"ttl",key:{name:this.currentKey,ttl:e}})}saveStringValue(){let e=this.stringValue.value;n.postMessage({type:"update",key:{name:this.currentKey,type:this.currentKeyType,content:e}})}changeViewFormat(e){let t=this.stringValue.value;switch(e){case"json":try{let s=JSON.parse(t);this.displayFormattedJson(s)}catch{this.stringValue.style.display="block",this.hideJsonPanel()}break;case"hex":this.stringValue.value=this.stringToHex(t),this.stringValue.style.display="block",this.hideJsonPanel();break;case"text":default:this.stringValue.style.display="block",this.hideJsonPanel();break}}editItem(e){let t=this.getCollectionRows();if(t[e]){let s=t[e];this.editModel=!0,this.itemKey.value=s.key||"",this.itemValue.value=s.value||s,this.dialogTitle.textContent=this.getEditDialogTitle(),this.editDialog.style.display="block"}}deleteItem(e){let t=this.getCollectionRows();t[e]&&n.postMessage({type:"deleteLine",row:t[e]})}confirmDialog(){let e=this.itemKey.value,t=this.itemValue.value;n.postMessage({type:"add",key:e,value:t,editModel:this.editModel||!1}),this.cancelDialog()}cancelDialog(){this.editDialog&&(this.editDialog.style.display="none")}showSuccess(e){n.postMessage({type:"showMessage",level:"info",message:e})}showError(e){n.postMessage({type:"showMessage",level:"error",message:e})}escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}stringToHex(e){return e.split("").map(t=>t.charCodeAt(0).toString(16).padStart(2,"0")).join(" ")}displayFormattedJson(e){let t=document.querySelector(".json-panel");t||(t=document.createElement("div"),t.className="json-panel",t.contentEditable="true",t.style.cssText=`
                line-height: 1.3;
                background: #292a2b;
                font-family: var(--vscode-editor-font-family);
                color: #f8f8f2;
                padding: 10px;
                border-radius: 4px;
                white-space: pre;
            `,this.stringContent.appendChild(t));let s=JSON.stringify(e,null,2);t.innerHTML=this.highlightJson(s),this.stringValue.style.display="none",t.style.display="block",t.addEventListener("input",a=>{this.stringValue.value=a.target.innerText})}hideJsonPanel(){let e=document.querySelector(".json-panel");e&&(e.style.display="none")}highlightJson(e){return e.replace(/"([^"]+)":/g,'<span style="color: #C792EA">"$1":</span>').replace(/: "([^"]*)"/g,': <span style="color: #92D69E">"$1"</span>').replace(/: (\d+)/g,': <span style="color: #CE9178">$1</span>').replace(/: (true|false)/g,': <span style="color: #569cD6">$1</span>').replace(/: null/g,': <span style="color: #569cD6">null</span>')}getCollectionRows(){if(!this.keyData||!this.keyData.content)return[];switch(this.currentKeyType){case"list":return this.keyData.content.map((e,t)=>({key:t.toString(),value:e}));case"set":return this.keyData.content.map(e=>({key:e,value:e}));case"hash":return this.keyData.content;case"zset":return this.keyData.content;default:return[]}}getEditDialogTitle(){let e=this.editModel;switch(this.currentKeyType){case"hash":return e?"Edit Hash":"Add to hash";case"set":return e?"Edit Set":"Add to set";case"zset":return e?"Edit ZSet":"Add to zset";case"list":return e?"Edit List":"Add to list";default:return"Add Item"}}showAddItemDialog(){if(this.editModel=!1,this.editDialog){this.dialogTitle.textContent=this.getEditDialogTitle(),this.itemKey.value="",this.itemValue.value="";let e=this.itemKey.closest(".form-group");e&&(e.style.display=this.currentKeyType==="hash"?"block":"none"),this.editDialog.style.display="block"}}},n=acquireVsCodeApi();document.addEventListener("DOMContentLoaded",()=>{new o});
