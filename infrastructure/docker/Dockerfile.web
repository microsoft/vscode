# Logos Web IDE Dockerfile
# Based on OpenVSCode Server with Logos customizations
# Branding: Logos - A Bravo Zero Platform

# Stage 1: Build ARIA Chat extension
FROM node:20-alpine AS extension-builder
WORKDIR /build/logos-aria-chat
COPY extensions/logos-aria-chat/package*.json ./
RUN npm install
COPY extensions/logos-aria-chat/ ./
RUN npm run compile

# Stage 2: Final OpenVSCode Server image
FROM gitpod/openvscode-server:1.95.3

# Switch to root to install dependencies
USER root

# Install additional tools
RUN apt-get update && apt-get install -y \
    curl \
    git \
    python3 \
    python3-pip \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Create extension directories
RUN mkdir -p /home/.openvscode-server/extensions/logos-aria-chat \
    && mkdir -p /home/.openvscode-server/data/Machine \
    && mkdir -p /home/.openvscode-server/data/User \
    && mkdir -p /home/workspace/.vscode

# Copy compiled ARIA Chat extension from builder
COPY --from=extension-builder --chown=openvscode-server:openvscode-server \
    /build/logos-aria-chat/package.json \
    /home/.openvscode-server/extensions/logos-aria-chat/

COPY --from=extension-builder --chown=openvscode-server:openvscode-server \
    /build/logos-aria-chat/out/ \
    /home/.openvscode-server/extensions/logos-aria-chat/out/

# Copy Logos configuration
COPY --chown=openvscode-server:openvscode-server .vscode/ /home/workspace/.vscode/

# Copy custom settings
COPY --chown=openvscode-server:openvscode-server infrastructure/docker/settings.json /home/.openvscode-server/data/Machine/settings.json

# Copy custom product.json for Logos branding (replaces OpenVSCode Server branding)
COPY --chown=openvscode-server:openvscode-server infrastructure/docker/product.json /tmp/logos-product.json

# Merge Logos branding into existing product.json
RUN if [ -f /home/.openvscode-server/product.json ]; then \
      jq -s '.[0] * .[1]' /home/.openvscode-server/product.json /tmp/logos-product.json > /tmp/merged-product.json \
      && mv /tmp/merged-product.json /home/.openvscode-server/product.json; \
    else \
      cp /tmp/logos-product.json /home/.openvscode-server/product.json; \
    fi \
    && rm /tmp/logos-product.json

# Patch hardcoded branding strings in workbench files
# Replace "OpenVSCode Server" with "Logos" and "Editing evolved" with "A Bravo Zero platform"
RUN find /home/.openvscode-server/out -type f -name "*.js" -exec \
    sed -i 's/OpenVSCode Server/Logos/g' {} \; 2>/dev/null || true
RUN find /home/.openvscode-server/out -type f -name "*.js" -exec \
    sed -i 's/Editing evolved/A Bravo Zero platform/g' {} \; 2>/dev/null || true
RUN find /home/.openvscode-server/out -type f -name "*.html" -exec \
    sed -i 's/OpenVSCode Server/Logos/g' {} \; 2>/dev/null || true
RUN find /home/.openvscode-server/out -type f -name "*.html" -exec \
    sed -i 's/Editing evolved/A Bravo Zero platform/g' {} \; 2>/dev/null || true

# Copy Hydra-styled theme CSS to multiple locations for accessibility
COPY --chown=openvscode-server:openvscode-server infrastructure/docker/logos-theme.css /home/.openvscode-server/logos-theme.css
COPY --chown=openvscode-server:openvscode-server infrastructure/docker/logos-theme.css /home/.openvscode-server/out/logos-theme.css

# Inject custom CSS into workbench CSS directly (inline the CSS to avoid 404s)
RUN mkdir -p /home/.openvscode-server/out/vs/workbench \
    && cat /home/.openvscode-server/logos-theme.css >> /home/.openvscode-server/out/vs/workbench/workbench.web.main.css 2>/dev/null || true

# Find and append custom CSS to all workbench CSS files
RUN find /home/.openvscode-server/out -name "workbench*.css" -type f -exec sh -c \
    'cat /home/.openvscode-server/logos-theme.css >> "$1"' _ {} \; 2>/dev/null || true

# Create custom startup script that injects CSS into HTML and serves static files
RUN echo '#!/bin/bash\n\
# Logos IDE Startup Script\n\
# Inject custom CSS into the HTML and ensure proper serving\n\
\n\
OPENVSCODE_ROOT="${OPENVSCODE_SERVER_ROOT:-/home/.openvscode-server}"\n\
\n\
# Find and patch workbench HTML to include inline CSS style tag\n\
for html_file in $(find "$OPENVSCODE_ROOT" -name "workbench.html" 2>/dev/null); do\n\
  if ! grep -q "logos-theme-inline" "$html_file" 2>/dev/null; then\n\
    # Read the CSS file and inject it as inline style\n\
    CSS_CONTENT=$(cat "$OPENVSCODE_ROOT/logos-theme.css" 2>/dev/null | tr "\n" " " | sed "s/\"/\\\\\\&/g")\n\
    sed -i "s|</head>|<style id=\"logos-theme-inline\">$CSS_CONTENT</style></head>|g" "$html_file" 2>/dev/null || true\n\
  fi\n\
done\n\
\n\
exec "$OPENVSCODE_ROOT/bin/openvscode-server" \\\n\
  --host 0.0.0.0 \\\n\
  --port 3000 \\\n\
  --without-connection-token \\\n\
  --extensions-dir "$OPENVSCODE_ROOT/extensions"\n\
' > /home/.openvscode-server/logos-start.sh \
    && chmod +x /home/.openvscode-server/logos-start.sh

# Set proper ownership
RUN chown -R openvscode-server:openvscode-server /home/.openvscode-server \
    && chown -R openvscode-server:openvscode-server /home/workspace

# Set environment variables
ENV OPENVSCODE_SERVER_ROOT=/home/.openvscode-server
ENV D3N_ENDPOINT=http://d3n-gateway:9090
ENV ARIA_ENDPOINT=http://aria-inference:80
ENV PERSONA_ENDPOINT=http://persona-api:80
ENV LOGOS_CHAT_ENDPOINT=http://logos-chat:8081
ENV LOGOS_COMPLETION_ENDPOINT=http://logos-completion:8082
ENV LOGOS_CA_ENDPOINT=http://logos-ca:8083
ENV LOGOS_AUDIT_ENDPOINT=http://logos-audit:8084

# Switch back to non-root user
USER openvscode-server

# Set workdir
WORKDIR /home/workspace

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/ || exit 1

# Start Logos IDE with custom startup script
ENTRYPOINT ["/home/.openvscode-server/logos-start.sh"]
