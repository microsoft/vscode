/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

/**
 * ADMX Validation Module
 *
 * This module validates ADMX files against Microsoft's Group Policy schema constraints.
 * Specifically, it validates that string references and resource IDs follow the correct
 * pattern: only letters, numbers, and underscores are allowed (NO dots).
 *
 * This prevents issues like https://github.com/microsoft/vscode/issues/278352 where
 * invalid ID patterns (containing dots) caused Group Policy Editor errors.
 *
 * The validation follows the patterns defined in Microsoft's ADMX PolicyDefinitions schema:
 * - stringReference: $(string.ID) where ID matches [a-zA-Z0-9_]+
 * - presentationReference: $(presentation.ID) where ID matches [a-zA-Z0-9_]+
 * - resourceID: matches [a-zA-Z0-9_]+
 *
 * Reference: https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpreg/81a89003-5121-4216-b788-fde8daa71c78
 */

export interface ADMXValidationError {
	readonly line: number;
	readonly column: number;
	readonly message: string;
	readonly value: string;
}

export interface ADMXValidationResult {
	readonly valid: boolean;
	readonly errors: ADMXValidationError[];
}

/**
 * Pattern for valid resource IDs (id attributes): only letters, numbers, and underscores
 */
const RESOURCE_ID_PATTERN = /^[a-zA-Z0-9_]+$/;

/**
 * Validates an ADMX file content against Microsoft's Group Policy schema constraints.
 *
 * @param admxContent The content of the ADMX file to validate
 * @returns Validation result containing whether the file is valid and any errors found
 */
export function validateADMX(admxContent: string): ADMXValidationResult {
	const errors: ADMXValidationError[] = [];
	const lines = admxContent.split('\n');

	for (let lineNum = 0; lineNum < lines.length; lineNum++) {
		const line = lines[lineNum];
		const lineNumber = lineNum + 1;

		// Check for invalid string references
		validateStringReferences(line, lineNumber, errors);

		// Check for invalid presentation references
		validatePresentationReferences(line, lineNumber, errors);

		// Check for invalid id attributes
		validateIdAttributes(line, lineNumber, errors);
	}

	return {
		valid: errors.length === 0,
		errors
	};
}

function validateStringReferences(line: string, lineNumber: number, errors: ADMXValidationError[]): void {
	// Find all string references in the line
	const stringRefPattern = /\$\(string\.([^)]+)\)/g;
	let match;

	while ((match = stringRefPattern.exec(line)) !== null) {
		const id = match[1];
		const fullMatch = match[0];
		const column = match.index + 1;

		// Check if the ID contains invalid characters (dots)
		if (id.includes('.')) {
			errors.push({
				line: lineNumber,
				column,
				message: `Invalid string reference: ID "${id}" contains dots. Only letters, numbers, and underscores are allowed.`,
				value: fullMatch
			});
		} else if (!RESOURCE_ID_PATTERN.test(id)) {
			errors.push({
				line: lineNumber,
				column,
				message: `Invalid string reference: ID "${id}" contains invalid characters. Only letters, numbers, and underscores are allowed.`,
				value: fullMatch
			});
		}
	}
}

function validatePresentationReferences(line: string, lineNumber: number, errors: ADMXValidationError[]): void {
	// Find all presentation references in the line
	const presentationRefPattern = /\$\(presentation\.([^)]+)\)/g;
	let match;

	while ((match = presentationRefPattern.exec(line)) !== null) {
		const id = match[1];
		const fullMatch = match[0];
		const column = match.index + 1;

		// Check if the ID contains invalid characters (dots)
		if (id.includes('.')) {
			errors.push({
				line: lineNumber,
				column,
				message: `Invalid presentation reference: ID "${id}" contains dots. Only letters, numbers, and underscores are allowed.`,
				value: fullMatch
			});
		} else if (!RESOURCE_ID_PATTERN.test(id)) {
			errors.push({
				line: lineNumber,
				column,
				message: `Invalid presentation reference: ID "${id}" contains invalid characters. Only letters, numbers, and underscores are allowed.`,
				value: fullMatch
			});
		}
	}
}

function validateIdAttributes(line: string, lineNumber: number, errors: ADMXValidationError[]): void {
	// Find all id="value" attributes in the line
	// Note: This pattern matches double-quoted id attributes (id="value").
	// ADMX files generated by VS Code always use double-quoted attributes,
	// so this simplified approach is sufficient for our use case.
	const idAttrPattern = /\bid="([^"]+)"/g;
	let match;

	while ((match = idAttrPattern.exec(line)) !== null) {
		const id = match[1];
		const fullMatch = match[0];
		const column = match.index + 1;

		// Check if the ID contains invalid characters (dots)
		if (id.includes('.')) {
			errors.push({
				line: lineNumber,
				column,
				message: `Invalid id attribute: "${id}" contains dots. Only letters, numbers, and underscores are allowed.`,
				value: fullMatch
			});
		} else if (!RESOURCE_ID_PATTERN.test(id)) {
			errors.push({
				line: lineNumber,
				column,
				message: `Invalid id attribute: "${id}" contains invalid characters. Only letters, numbers, and underscores are allowed.`,
				value: fullMatch
			});
		}
	}
}

/**
 * Validates an ADML file content against Microsoft's Group Policy schema constraints.
 *
 * ADML files contain the localized strings referenced by ADMX files.
 * The string table entries must have valid IDs (no dots).
 *
 * @param admlContent The content of the ADML file to validate
 * @returns Validation result containing whether the file is valid and any errors found
 */
export function validateADML(admlContent: string): ADMXValidationResult {
	const errors: ADMXValidationError[] = [];
	const lines = admlContent.split('\n');

	for (let lineNum = 0; lineNum < lines.length; lineNum++) {
		const line = lines[lineNum];
		const lineNumber = lineNum + 1;

		// Check for invalid id attributes in string elements
		validateIdAttributes(line, lineNumber, errors);

		// Check for invalid presentation references
		validatePresentationReferences(line, lineNumber, errors);
	}

	return {
		valid: errors.length === 0,
		errors
	};
}

/**
 * Validates both ADMX and ADML files.
 *
 * @param admxContent The content of the ADMX file
 * @param admlContents Array of ADML file contents (for different languages)
 * @returns Combined validation result
 */
export function validatePolicyFiles(
	admxContent: string,
	admlContents: { languageId: string; contents: string }[]
): { admx: ADMXValidationResult; adml: { languageId: string; result: ADMXValidationResult }[] } {
	const admxResult = validateADMX(admxContent);

	const admlResults = admlContents.map(({ languageId, contents }) => ({
		languageId,
		result: validateADML(contents)
	}));

	return {
		admx: admxResult,
		adml: admlResults
	};
}
