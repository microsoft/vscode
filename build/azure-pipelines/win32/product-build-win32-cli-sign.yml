parameters:
  - name: VSCODE_BUILD_WIN32
    type: boolean
  - name: VSCODE_BUILD_WIN32_ARM64
    type: boolean

steps:
  - task: NodeTool@0
    displayName: "Use Node.js"
    inputs:
      versionSource: fromFile
      versionFilePath: .nvmrc
      nodejsMirror: https://github.com/joaomoreno/node-mirror/releases/download

  - powershell: node build/setup-npm-registry.js $env:NPM_REGISTRY
    condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
    displayName: Setup NPM Registry

  - powershell: |
      . azure-pipelines/win32/exec.ps1
      $ErrorActionPreference = "Stop"
      exec { npm config set registry "$env:NPM_REGISTRY" --location=project }
    workingDirectory: build
    condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
    displayName: Setup NPM

  - task: npmAuthenticate@0
    inputs:
      workingFile: .npmrc
    condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
    displayName: Setup NPM Authentication

  - powershell: |
      . azure-pipelines/win32/exec.ps1
      . azure-pipelines/win32/retry.ps1
      $ErrorActionPreference = "Stop"
      $env:CHILD_CONCURRENCY="1"
      retry { exec { node npm/setupNpmrc.js } }
      retry { exec { npm ci } }
    workingDirectory: build
    displayName: Install build dependencies

  - template: ../cli/cli-win32-sign.yml@self
    parameters:
      VSCODE_CLI_ARTIFACTS:
        - ${{ if eq(parameters.VSCODE_BUILD_WIN32, true) }}:
          - unsigned_vscode_cli_win32_x64_cli
        - ${{ if eq(parameters.VSCODE_BUILD_WIN32_ARM64, true) }}:
          - unsigned_vscode_cli_win32_arm64_cli
