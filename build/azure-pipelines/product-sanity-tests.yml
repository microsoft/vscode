pr: none

trigger: none

parameters:
  - name: BUILD_COMMIT
    displayName: Published Build Commit
    type: string

  - name: BUILD_QUALITY
    displayName: Published Build Quality
    type: string
    default: insider
    values:
      - exploration
      - insider
      - stable

  - name: NPM_REGISTRY
    displayName: Custom NPM Registry URL
    type: string
    default: "https://pkgs.dev.azure.com/monacotools/Monaco/_packaging/vscode/npm/registry/"

variables:
  - name: skipComponentGovernanceDetection
    value: true
  - name: Codeql.SkipTaskAutoInjection
    value: true
  - name: BUILD_COMMIT
    value: ${{ parameters.BUILD_COMMIT }}
  - name: BUILD_QUALITY
    value: ${{ parameters.BUILD_QUALITY }}
  - name: NPM_REGISTRY
    value: ${{ parameters.NPM_REGISTRY }}

name: "$(Date:yyyyMMdd).$(Rev:r) (${{ parameters.BUILD_QUALITY }} ${{ parameters.BUILD_COMMIT }})"

resources:
  repositories:
    - repository: 1ESPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:
    sdl:
      tsa:
        enabled: false
      codeql:
        compiled:
          enabled: false
          justificationForDisabling: "Sanity tests only, no code compilation"
      credscan:
        suppressionsFile: $(Build.SourcesDirectory)/build/azure-pipelines/config/CredScanSuppressions.json
      eslint:
        enabled: false
      sourceAnalysisPool: 1es-windows-2022-x64
      createAdoIssuesForJustificationsForDisablement: false
    stages:
      - stage: sanity_tests
        displayName: Run Sanity Tests
        jobs:
          # Windows tests
          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Windows_x64
              displayName: Windows x64 Sanity Tests
              poolName: 1es-windows-2022-x64
              os: windows

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Windows_arm64
              displayName: Windows arm64 Sanity Tests (no runtime)
              poolName: 1es-windows-2022-x64
              os: windows
              args: --no-runtime-check --grep "win32-arm64"

          # macOS tests
          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: macOS_x64
              displayName: MacOS x64 Sanity Tests (no runtime)
              poolName: AcesShared
              os: macOS
              args: --no-runtime-check --grep "darwin-x64"

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: macOS_arm64
              displayName: MacOS arm64 Sanity Tests
              poolName: AcesShared
              os: macOS

          # Linux x64 tests
          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Ubuntu_22_04_x64
              displayName: Ubuntu 22.04 x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: ubuntu:22.04
              containerPlatform: linux/amd64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Ubuntu_24_04_x64
              displayName: Ubuntu 24.04 x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: ubuntu:24.04
              containerPlatform: linux/amd64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Debian_12_x64
              displayName: Debian 12 x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: debian:12
              containerPlatform: linux/amd64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: RedHat_UBI9_x64
              displayName: Red Hat UBI 9 x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: redhat/ubi9:latest
              containerPlatform: linux/amd64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Fedora_40_x64
              displayName: Fedora 40 x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: fedora:40
              containerPlatform: linux/amd64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: openSUSE_Leap_x64
              displayName: openSUSE Leap x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: opensuse/leap:latest
              containerPlatform: linux/amd64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Alpine_x64
              displayName: Alpine x64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: alpine:latest
              containerPlatform: linux/amd64

          # Linux arm32 tests (emulated via QEMU)
          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Ubuntu_22_04_arm32
              displayName: Ubuntu 22.04 arm32 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: ubuntu:22.04
              containerPlatform: linux/arm

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Ubuntu_24_04_arm32
              displayName: Ubuntu 24.04 arm32 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: ubuntu:24.04
              containerPlatform: linux/arm

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Debian_12_arm32
              displayName: Debian 12 arm32 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: debian:12
              containerPlatform: linux/arm

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: openSUSE_Leap_arm32
              displayName: openSUSE Leap arm32 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: opensuse/leap:latest
              containerPlatform: linux/arm

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Alpine_arm32
              displayName: Alpine arm32 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: alpine:latest
              containerPlatform: linux/arm

          # Linux arm64 tests (emulated via QEMU)
          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Ubuntu_22_04_arm64
              displayName: Ubuntu 22.04 arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: ubuntu:22.04
              containerPlatform: linux/arm64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Ubuntu_24_04_arm64
              displayName: Ubuntu 24.04 arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: ubuntu:24.04
              containerPlatform: linux/arm64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Debian_12_arm64
              displayName: Debian 12 arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: debian:12
              containerPlatform: linux/arm64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: RedHat_UBI9_arm64
              displayName: Red Hat UBI 9 arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: redhat/ubi9:latest
              containerPlatform: linux/arm64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Fedora_40_arm64
              displayName: Fedora 40 arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: fedora:40
              containerPlatform: linux/arm64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: openSUSE_Leap_arm64
              displayName: openSUSE Leap arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: opensuse/leap:latest
              containerPlatform: linux/arm64

          - template: build/azure-pipelines/common/sanity-tests.yml@self
            parameters:
              name: Alpine_arm64
              displayName: Alpine arm64 Sanity Tests
              poolName: 1es-ubuntu-22.04-x64
              container: alpine:latest
              containerPlatform: linux/arm64
