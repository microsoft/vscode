parameters:
  name: VSCODE_QUALITY
  type: string

steps:
  - ${{ if and(ne(parameters.VSCODE_QUALITY, 'stable')) }}:
    - script: |
        set -e
        BUILD_NAME="$(Build.BuildNumber)" # example "20251114.34 (insider)"
        VSCODE_PRERELEASE="$(echo $BUILD_NAME | cut -d' ' -f1 | awk -F. '{printf "%s%03d", $1, $2}')"
        CURRENT_VERSION="$(node -p "require('./package.json').version")"
        VSCODE_MAJOR_MINOR_PATCH="$(node -p "require('./package.json').version.replace(/-.+$/, '')")"
        VSCODE_VERSION="${VSCODE_MAJOR_MINOR_PATCH}-${VSCODE_PRERELEASE}.${{ parameters.VSCODE_QUALITY }}"
        echo "Setting version to: $VSCODE_VERSION (from $CURRENT_VERSION)"
        node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.argv[1]}, null, 2))" $VSCODE_VERSION
      displayName: Update package version
      condition: and(succeeded(), not(contains(variables['Agent.OS'], 'windows')))

    - pwsh: |
        $ErrorActionPreference = "Stop"
        $buildName = "$(Build.BuildNumber)" # example "20251114.34 (insider)"
        $buildParts = ($buildName -split ' ')[0] -split '\.'
        $prerelease = "{0}{1:000}" -f $buildParts[0], [int]$buildParts[1]
        $currentVersion = node -p "require('./package.json').version"
        $majorMinorPatch = node -p "require('./package.json').version.replace(/-.+$/, '')"
        $version = "$majorMinorPatch-$prerelease.${{ parameters.VSCODE_QUALITY }}"
        Write-Host "Setting version to: $version (from $currentVersion)"
        node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.argv[1]}, null, 2))" $version
      displayName: Update package version
      condition: and(succeeded(), contains(variables['Agent.OS'], 'windows'))
