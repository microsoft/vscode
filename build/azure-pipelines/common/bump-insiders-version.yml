steps:
  - script: |
      set -e
      VSCODE_MAJOR_MINOR_VERSION=$(node -p "require('./package.json').version.replace(/\.\d+$/, '')")
      echo "Major minor version: $VSCODE_MAJOR_MINOR_VERSION"
      echo "##vso[task.setvariable variable=VSCODE_MAJOR_MINOR_VERSION]$VSCODE_MAJOR_MINOR_VERSION"
    displayName: Set Insiders Major.Minor Version
    condition: and(succeeded(), not(contains(variables['Agent.OS'], 'windows')))

  - script: |
      set -e
      VSCODE_INSIDERS_VERSION="$(VSCODE_MAJOR_MINOR_VERSION).$(VSCODE_INSIDERS_PATCH_VERSION)"
      echo "Setting product version to: $VSCODE_INSIDERS_VERSION"
      node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.env.VSCODE_INSIDERS_VERSION}, null, 2))"
    variables:
      VSCODE_INSIDERS_PATCH_VERSION: $[counter(variables['VSCODE_MAJOR_MINOR_VERSION'], 0)]
    displayName: Override Insiders Version
    condition: and(succeeded(), not(contains(variables['Agent.OS'], 'windows')))

  - pwsh: |
      $ErrorActionPreference = "Stop"
      $VSCODE_MAJOR_MINOR_VERSION = node -p "require('./package.json').version.replace(/\.\d+$/, '')"
      Write-Host "Major minor version: $VSCODE_MAJOR_MINOR_VERSION"
      Write-Host "##vso[task.setvariable variable=VSCODE_MAJOR_MINOR_VERSION]$VSCODE_MAJOR_MINOR_VERSION"
    displayName: Set Insiders Major.Minor Version
    condition: and(succeeded(), contains(variables['Agent.OS'], 'windows'))

  - pwsh: |
      $ErrorActionPreference = "Stop"
      $VSCODE_INSIDERS_VERSION = "$(VSCODE_MAJOR_MINOR_VERSION).$(VSCODE_INSIDERS_PATCH_VERSION)"
      Write-Host "Setting product version to: $VSCODE_INSIDERS_VERSION"
      node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.env.VSCODE_INSIDERS_VERSION}, null, 2))"
    variables:
      VSCODE_INSIDERS_PATCH_VERSION: $[counter(variables['VSCODE_MAJOR_MINOR_VERSION'], 0)]
    displayName: Override Insiders Version
    condition: and(succeeded(), contains(variables['Agent.OS'], 'windows'))
