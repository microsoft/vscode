steps:
  - script: |
      set -e
      VSCODE_MAJOR_MINOR_VERSION="$(node -p "require('./package.json').version.replace(/\.\d+$/, '')")"
      VSCODE_INSIDERS_VERSION="${VSCODE_MAJOR_MINOR_VERSION}.$(Date:yyyyMMdd)$(printf "%03d" $(Rev:r))"
      echo "Setting Insiders version to: $VSCODE_INSIDERS_VERSION"
      node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.env.VSCODE_INSIDERS_VERSION}, null, 2))"
    displayName: Override Insiders Version
    condition: and(succeeded(), not(contains(variables['Agent.OS'], 'windows')))

  - pwsh: |
      $ErrorActionPreference = "Stop"
      $majorMinor = node -p "require('./package.json').version.replace(/\.\d+$/, '')"
      $date = "$(Date:yyyyMMdd)"
      $rev = "{0:000}" -f [int]"$(Rev:r)"
      $insidersVersion = "$majorMinor.$date$rev"
      Write-Host "Setting Insiders version to: $insidersVersion"
      node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.env.VSCODE_INSIDERS_VERSION}, null, 2))"
      $env:VSCODE_INSIDERS_VERSION = $insidersVersion
    displayName: Override Insiders Version
    condition: and(succeeded(), contains(variables['Agent.OS'], 'windows'))
