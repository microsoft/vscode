steps:
  - script: |
      set -e
      BUILD_NAME="$(Build.BuildNumber)" # example "20251114.34 (insider)"
      VSCODE_PATCH_VERSION="$(echo $BUILD_NAME | cut -d' ' -f1 | awk -F. '{printf "%s%03d", $1, $2}')"
      VSCODE_MAJOR_MINOR_VERSION="$(node -p "require('./package.json').version.replace(/\.\d+$/, '')")"
      VSCODE_INSIDERS_VERSION="${VSCODE_MAJOR_MINOR_VERSION}.${VSCODE_PATCH_VERSION}"
      echo "Setting Insiders version to: $VSCODE_INSIDERS_VERSION"
      node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.argv[1]}, null, 2))" $VSCODE_INSIDERS_VERSION
    displayName: Override Insiders Version
    condition: and(succeeded(), not(contains(variables['Agent.OS'], 'windows')))

  - pwsh: |
      $ErrorActionPreference = "Stop"
      $buildName = "$(Build.BuildNumber)" # example "20251114.34 (insider)"
      $buildParts = ($buildName -split ' ')[0] -split '\.'
      $patchVersion = "{0}{1:000}" -f $buildParts[0], [int]$buildParts[1]
      $majorMinorVersion = node -p "require('./package.json').version.replace(/\.\d+$/, '')"
      $insidersVersion = "$majorMinorVersion.$patchVersion"
      Write-Host "Setting Insiders version to: $insidersVersion"
      node -e "require('fs').writeFileSync('package.json', JSON.stringify({...require('./package.json'), version: process.argv[1]}, null, 2))" $insidersVersion
    displayName: Override Insiders Version
    condition: and(succeeded(), contains(variables['Agent.OS'], 'windows'))
