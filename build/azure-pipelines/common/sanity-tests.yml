parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: poolName
    type: string
  - name: os
    type: string
    default: linux
  - name: args
    type: string
    default: ""
  - name: container
    type: string
    default: ""
  - name: containerPlatform
    type: string
    default: ""

jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    pool:
      name: ${{ parameters.poolName }}
      os: ${{ parameters.os }}
    timeoutInMinutes: 30
    variables:
      SANITY_TEST_LOGS: $(Build.SourcesDirectory)/.build/sanity-test-logs
      LOG_FILE: $(SANITY_TEST_LOGS)/results.xml
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - bash: |
          npm config set registry "$(NPM_REGISTRY)"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Configure NPM Registry

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Authenticate with NPM Registry

      - script: npm ci
        workingDirectory: ./test/sanity
        displayName: Install Dependencies

      - script: npm run compile
        workingDirectory: ./test/sanity
        displayName: Compile Sanity Tests

      # Host-based test execution (Windows, macOS)
      - script: node out/index.js -c $(BUILD_COMMIT) -q $(BUILD_QUALITY) -t $(LOG_FILE) -v ${{ parameters.args }}
        workingDirectory: ./test/sanity
        displayName: Run Sanity Tests
        condition: eq('${{ parameters.container }}', '')

      # Container-based test execution (Linux)
      - bash: |
          docker run --privileged --rm tonistiigi/binfmt --uninstall '*'
          docker run --pull always --privileged --rm tonistiigi/binfmt --install all
        displayName: Setup QEMU for Multi-Architecture Support
        condition: and(ne('${{ parameters.container }}', ''), contains('${{ parameters.containerPlatform }}', 'arm'))

      - bash: |
          set -e
          docker run --rm --platform ${{ parameters.containerPlatform }} \
            -v "$(Build.SourcesDirectory):/workspace" \
            -w /workspace \
            ${{ parameters.container }} \
            /bin/sh -c '
              set -e

              if command -v apt-get &> /dev/null; then
                echo "Installing dependencies using apt-get (Ubuntu, Debian)"
                apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
                  curl ca-certificates xvfb x11-utils libgtk-3-0 libnss3 libgbm1 xdg-utils sudo dbus dbus-x11
                apt-get install -y libasound2t64 || apt-get install -y libasound2
                curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
                apt-get install -y nodejs
              elif command -v dnf &> /dev/null; then
                echo "Installing dependencies using dnf (Fedora, RHEL)"
                dnf install -y epel-release 2>/dev/null || true
                dnf install -y nodejs gtk3 nss mesa-libgbm alsa-lib sudo dbus dbus-x11
                dnf install -y xorg-x11-server-Xvfb xorg-x11-apps
                dnf install -y xdg-utils
              elif command -v zypper &> /dev/null; then
                echo "Installing dependencies using zypper (openSUSE)"
                zypper install -y nodejs22 xorg-x11-server-Xvfb xorg-x11 libgtk-3-0 mozilla-nss libgbm1 alsa xdg-utils sudo tar gzip dbus-1 dbus-1-x11
              elif command -v apk &> /dev/null; then
                echo "Installing dependencies using apk (Alpine)"
                apk add --no-cache nodejs npm xvfb xdpyinfo gtk+3.0 nss mesa-gbm sudo dbus dbus-x11
              fi

              echo "Starting Xvfb on display :99"
              Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
              export DISPLAY=:99
              sleep 2

              echo "Starting D-Bus session for Electron"
              mkdir -p /run/dbus
              dbus-daemon --system --fork

              echo "Install Playwright Chrome browser"
              cd /workspace/test/sanity
              ./node_modules/.bin/playwright install chrome

              echo "Running sanity tests"
              node out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
            '
        displayName: Run Sanity Tests in Container
        condition: ne('${{ parameters.container }}', '')

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $(LOG_FILE)
          testRunTitle: ${{ parameters.displayName }}
        condition: succeededOrFailed()
        displayName: Publish Test Results
