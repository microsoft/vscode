parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: poolName
    type: string
  - name: os
    type: string
    default: linux
  - name: args
    type: string
    default: ""
  - name: container
    type: string
    default: ""
  - name: containerPlatform
    type: string
    default: ""

jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    pool:
      name: ${{ parameters.poolName }}
      os: ${{ parameters.os }}
    timeoutInMinutes: 30
    variables:
      SANITY_TEST_LOGS: $(Build.SourcesDirectory)/.build/sanity-test-logs
      LOG_FILE: $(SANITY_TEST_LOGS)/results.xml
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - bash: |
          npm config set registry "$(NPM_REGISTRY)"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        displayName: Configure NPM Registry

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        displayName: Authenticate with NPM Registry

      - script: npm ci
        workingDirectory: ./test/sanity
        displayName: Install Dependencies

      - ${{ if eq(parameters.os, 'windows') }}:
          script: ./node_modules/.bin/playwright install --with-deps chromium
        ${{ elseif eq(parameters.os, 'macos') }}:
          script: ./node_modules/.bin/playwright install --with-deps webkit
        ${{ else }}:
          script: ./node_modules/.bin/playwright install --with-deps firefox
        workingDirectory: ./test/sanity
        displayName: Install Playwright Browser
        condition: eq('${{ parameters.container }}', '')

      - script: npm run compile
        workingDirectory: ./test/sanity
        displayName: Compile Sanity Tests

      # Setup X11 for native Linux hosts (needed for Electron tests)
      - bash: |
          set -e
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils dbus dbus-x11 snapd

          echo "Start Xvfb on display :99"
          sudo Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
          echo "##vso[task.setvariable variable=DISPLAY]:99"
          sleep 2

          echo "Start D-Bus daemon"
          sudo mkdir -p /var/run/dbus
          sudo dbus-daemon --system --fork || true

          echo "Start snapd service for snap package tests"
          sudo systemctl start snapd.socket || true
          sudo systemctl start snapd.service || true
          sleep 2

          echo "Install Playwright browser"
          /workspace/test/sanity/node_modules/.bin/playwright install --with-deps firefox
        displayName: Setup X11 Display
        condition: and(eq('${{ parameters.container }}', ''), eq('${{ parameters.os }}', 'linux'))

      # Host-based test execution (Windows, macOS, Linux)
      - script: node out/index.js -c $(BUILD_COMMIT) -q $(BUILD_QUALITY) -t $(LOG_FILE) -v ${{ parameters.args }}
        workingDirectory: ./test/sanity
        displayName: Run Sanity Tests
        condition: eq('${{ parameters.container }}', '')

      # Container-based test execution (Linux)
      - bash: |
          docker run --privileged --rm tonistiigi/binfmt --uninstall '*'
          docker run --pull always --privileged --rm tonistiigi/binfmt --install all
        displayName: Setup QEMU for Multi-Architecture Support
        condition: and(ne('${{ parameters.container }}', ''), contains('${{ parameters.containerPlatform }}', 'arm'))

      - bash: |
          set -e
          docker run --rm --platform ${{ parameters.containerPlatform }} \
            -v "$(Build.SourcesDirectory):/workspace" \
            -w /workspace \
            ${{ parameters.container }} \
            /bin/sh -c '
              set -e

              if command -v apt-get &> /dev/null; then

                echo "Installing dependencies using apt-get (Ubuntu, Debian)"
                apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
                  curl ca-certificates xvfb x11-utils libnss3 libgbm1 xdg-utils sudo dbus dbus-x11
                apt-get install -y libgtk-3-0t64 || apt-get install -y libgtk-3-0
                apt-get install -y libasound2t64 || apt-get install -y libasound2

                # Install Node.js 22 from NodeSource (only supports amd64 and arm64)
                if [ "$(arch)" = "x86_64" ] || [ "$(arch)" = "aarch64" ]; then
                  curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
                  apt-get install -y nodejs
                else
                  # For arm32, use system nodejs (may be older)
                  apt-get install -y nodejs npm
                fi

                # Install webkit dependencies for ARM platforms
                if [ "$(arch)" = "aarch64" ] || [ "$(arch)" = "armv7l" ] || [ "$(arch)" = "arm" ]; then
                  echo "Installing webkit dependencies for ARM"

                  apt-get install -y \
                    libgstreamer1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer-gl1.0-0 \
                    gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
                    libxslt1.1 libvpx7 libevent-2.1-7 libopus0 \
                    libwebpdemux2 libwebpmux3 libharfbuzz-icu0 \
                    libenchant-2-2 libsecret-1-0 libhyphen0 libgles2 || true

                  # Try to install optional packages that may not be available on all versions
                  apt-get install -y libgtk-4-1 libgraphene-1.0-0 libwoff1 \
                    libmanette-0.2-0 gstreamer1.0-libav || true

                  # Install flite libraries
                  apt-get install -y flite1-dev libflite1 || true

                  # Install additional codecs and formats
                  apt-get install -y libavif15 libavif13 || true
                  apt-get install -y libx264-163 libx264-164 || true
                  apt-get install -y libwoff2-1.0.2 || true

                  # From error: apt-get install libavif13
                fi

              elif command -v dnf &> /dev/null; then

                echo "Installing dependencies using dnf (Fedora, RHEL, CentOS)"
                dnf install -y epel-release 2>/dev/null || true

                # Install Node.js 22 from NodeSource
                curl -fsSL https://rpm.nodesource.com/setup_22.x | bash -
                dnf install -y nodejs

                dnf install -y gtk3 nss mesa-libgbm alsa-lib sudo dbus dbus-daemon
                dnf install -y dbus-x11 || true
                dnf install -y xorg-x11-server-Xvfb || true
                dnf install -y xorg-x11-utils || true
                dnf install -y xdg-utils || true

              elif command -v zypper &> /dev/null; then

                echo "Installing dependencies using zypper (openSUSE)"
                zypper install -y nodejs22 xorg-x11-server-Xvfb xorg-x11 libgtk-3-0 mozilla-nss libgbm1 alsa xdg-utils sudo tar gzip dbus-1 dbus-1-x11

              elif command -v apk &> /dev/null; then

                echo "Installing dependencies using apk (Alpine)"
                apk add --no-cache nodejs npm xvfb xdpyinfo gtk+3.0 nss mesa-gbm sudo dbus dbus-x11

              fi

              echo "Starting Xvfb on display :99"
              Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
              export DISPLAY=:99
              sleep 2

              echo "Starting D-Bus session for Electron"
              mkdir -p /run/dbus
              dbus-daemon --system --fork

              echo "Install Playwright browser"
              cd /workspace/test/sanity
              ./node_modules/.bin/playwright install --with-deps firefox

              echo "Running sanity tests"
              node ./out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
            '
        displayName: Run Sanity Tests in Container
        condition: ne('${{ parameters.container }}', '')

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $(LOG_FILE)
          testRunTitle: ${{ parameters.displayName }}
        displayName: Publish Test Results
        condition: succeededOrFailed()
