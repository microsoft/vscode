parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: poolName
    type: string
  - name: os
    type: string
    default: linux
  - name: container
    type: string
    default: ""
  - name: containerPlatform
    type: string
    default: ""
  - name: args
    type: string
    default: ""

jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    pool:
      name: ${{ parameters.poolName }}
      os: ${{ parameters.os }}
    timeoutInMinutes: 30
    variables:
      TEST_DIR: ./test/sanity
      LOG_FILE: $(Build.SourcesDirectory)/.build/sanity-test-logs/results.xml
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - bash: |
          npm config set registry "$(NPM_REGISTRY)"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        displayName: Configure NPM Registry

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        displayName: Authenticate with NPM Registry

      - script: npm ci
        workingDirectory: $(TEST_DIR)
        displayName: Install NPM Dependencies

      # Native host: Install Playwright browser
      - ${{ if eq(parameters.os, 'windows') }}:
          script: ./node_modules/.bin/playwright install --with-deps chromium
        ${{ elseif eq(parameters.os, 'macos') }}:
          script: ./node_modules/.bin/playwright install --with-deps webkit
        ${{ else }}:
          script: ./node_modules/.bin/playwright install --with-deps firefox
        workingDirectory: $(TEST_DIR)
        displayName: Install Playwright Browser
        condition: eq('${{ parameters.container }}', '')

      - script: npm run compile
        workingDirectory: $(TEST_DIR)
        displayName: Compile Sanity Tests

      # Native Linux host: Setup X11
      - bash: |
          set -e
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils dbus dbus-x11 snapd

          echo "Start Xvfb on display :99"
          sudo Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
          echo "##vso[task.setvariable variable=DISPLAY]:99"

          echo "Start D-Bus daemon"
          sudo mkdir -p /var/run/dbus
          sudo dbus-daemon --system --fork

          echo "Start snapd service for Snap package tests"
          sudo systemctl start snapd.socket
          sudo systemctl start snapd.service
        displayName: Setup X11 Display
        condition: and(eq('${{ parameters.container }}', ''), eq('${{ parameters.os }}', 'linux'))

      # Native host: Run Sanity Tests
      - script: node out/index.js -c $(BUILD_COMMIT) -q $(BUILD_QUALITY) -t $(LOG_FILE) -v ${{ parameters.args }}
        workingDirectory: $(TEST_DIR)
        displayName: Run Sanity Tests
        condition: eq('${{ parameters.container }}', '')

      # Container host: Run Sanity Tests
      - bash: |
          docker run --privileged --rm tonistiigi/binfmt --uninstall '*'
          docker run --pull always --privileged --rm tonistiigi/binfmt --install all
        displayName: Setup QEMU for Multi-Architecture Support
        condition: and(ne('${{ parameters.container }}', ''), contains('${{ parameters.containerPlatform }}', 'arm'))

      - bash: |
          set -e
          docker run --rm --platform ${{ parameters.containerPlatform }} \
            -v "$(Build.SourcesDirectory):/workspace" \
            -w /workspace \
            ${{ parameters.container }} \
            /bin/sh -c '
              set -e

              if command -v apt-get &> /dev/null; then
                echo "Installing dependencies using apt-get (Ubuntu, Debian)"
                apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
                  ca-certificates \
                  curl \
                  dbus \
                  dbus-x11 \
                  libgbm1 \
                  libnss3 \
                  sudo \
                  x11-utils \
                  xdg-utils \
                  xvfb \
                  xz-utils

                apt-get install -y libgtk-3-0t64 || apt-get install -y libgtk-3-0
                apt-get install -y libasound2t64 || apt-get install -y libasound2

                echo "Installing Node.js 22"
                if [ "$(arch)" = "x86_64" ] || [ "$(arch)" = "aarch64" ]; then
                  curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
                  apt-get install -y nodejs
                else
                  curl -fsSL https://nodejs.org/dist/v22.13.0/node-v22.13.0-linux-armv7l.tar.xz | tar -xJ -C /usr/local --strip-components=1
                fi

              elif command -v dnf &> /dev/null; then
                echo "Installing dependencies using dnf (CentOS, Fedora, RHEL)"
                dnf install -y epel-release 2>/dev/null || true

                dnf install -y \
                  gtk3 \
                  nss \
                  mesa-libgbm \
                  alsa-lib \
                  sudo \
                  dbus \
                  dbus-daemon

                dnf install -y dbus-x11 || true
                dnf install -y xorg-x11-server-Xvfb || true
                dnf install -y xorg-x11-utils || true
                dnf install -y xdg-utils || true

                echo "Installing Node.js 22"
                curl -fsSL https://rpm.nodesource.com/setup_22.x | bash -
                dnf install -y nodejs

              elif command -v zypper &> /dev/null; then
                echo "Installing dependencies using zypper (openSUSE)"
                zypper install -y \
                  alsa \
                  dbus-1 \
                  dbus-1-x11 \
                  gzip \
                  libgbm1 \
                  libgtk-3-0 \
                  mozilla-nss \
                  nodejs22 \
                  sudo \
                  tar \
                  xdg-utils \
                  xorg-x11 \
                  xorg-x11-server-Xvfb

              elif command -v apk &> /dev/null; then
                echo "Installing dependencies using apk (Alpine)"
                apk add --no-cache \
                  dbus \
                  dbus-x11 \
                  gtk+3.0 \
                  mesa-gbm \
                  nodejs \
                  npm \
                  nss \
                  sudo \
                  xdpyinfo \
                  xvfb

              fi

              echo "Starting Xvfb on display :99"
              Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
              export DISPLAY=:99

              echo "Starting D-Bus session for Electron"
              mkdir -p /run/dbus
              dbus-daemon --system --fork

              echo "Install Playwright browser"
              cd /workspace/test/sanity
              ./node_modules/.bin/playwright install --with-deps firefox

              echo "Running sanity tests"
              node ./out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
            '
        displayName: Run Sanity Tests in Container
        condition: ne('${{ parameters.container }}', '')

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $(LOG_FILE)
          testRunTitle: ${{ parameters.displayName }}
        displayName: Publish Test Results
        condition: succeededOrFailed()
