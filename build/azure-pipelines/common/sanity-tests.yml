parameters:
  - name: poolName
    type: string
  - name: os
    type: string

jobs:
  - job: ${{ parameters.os }}
    displayName: ${{ parameters.os }} Sanity Tests
    pool:
      name: ${{ parameters.poolName }}
      os: ${{ parameters.os }}
    timeoutInMinutes: 30
    variables:
      SANITY_TEST_LOGS: $(Build.SourcesDirectory)/.build/sanity-test-logs
      LOG_FILE: $(SANITY_TEST_LOGS)/results.xml
    templateContext:
      outputs:
        - output: pipelineArtifact
          targetPath: $SANITY_TEST_LOGS
          artifactName: sanity-test-logs-${{ lower(parameters.os) }}-$(System.JobAttempt)
          displayName: Sanity Tests Logs
          sbomEnabled: false
          isProduction: false
          condition: succeededOrFailed()
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - script: node build/setup-npm-registry.ts $NPM_REGISTRY
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Setup NPM Registry

      - script: mkdir -p .build && node build/azure-pipelines/common/computeNodeModulesCacheKey.ts compile $(node -p process.arch) > .build/packagelockhash
        displayName: Prepare node_modules cache key

      - task: Cache@2
        inputs:
          key: '"node_modules" | .build/packagelockhash'
          path: .build/node_modules_cache
          cacheHitVar: NODE_MODULES_RESTORED
        displayName: Restore node_modules cache

      - script: tar -xzf .build/node_modules_cache/cache.tgz
        condition: and(succeeded(), eq(variables.NODE_MODULES_RESTORED, 'true'))
        displayName: Extract node_modules cache

      - script: |
          set -e
          # Set the private NPM registry to the global npmrc file
          # so that authentication works for subfolders like build/, remote/, extensions/ etc
          # which does not have their own .npmrc file
          npm config set registry "$NPM_REGISTRY"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Setup NPM

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Setup NPM Authentication

      - script: |
          set -e

          for i in {1..5}; do # try 5 times
            npm ci && break
            if [ $i -eq 5 ]; then
              echo "Npm install failed too many times" >&2
              exit 1
            fi
            echo "Npm install failed $i, trying again..."
          done
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
        displayName: Install dependencies
        condition: and(succeeded(), ne(variables.NODE_MODULES_RESTORED, 'true'))

      - script: |
          set -e
          node build/azure-pipelines/common/listNodeModules.ts .build/node_modules_list.txt
          mkdir -p .build/node_modules_cache
          tar -czf .build/node_modules_cache/cache.tgz --files-from .build/node_modules_list.txt
        condition: and(succeeded(), ne(variables.NODE_MODULES_RESTORED, 'true'))
        displayName: Create node_modules archive

      - script: npm run postinstall
        displayName: Install Playwright dependencies
        workingDirectory: ./test/sanity

      - script: >
          npm run sanity-test --
            --commit $BUILD_COMMIT
            --quality $BUILD_QUALITY
            --verbose --test-results $LOG_FILE
        displayName: Run Sanity Tests

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $LOG_FILE
          testRunTitle: ${{ parameters.os }} Sanity Tests
        condition: succeededOrFailed()
        displayName: Publish Test Results
