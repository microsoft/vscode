parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: poolName
    type: string
  - name: os
    type: string
    default: linux
  - name: container
    type: string
    default: ""
  - name: arch
    type: string
    default: amd64
  - name: args
    type: string
    default: ""

jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    pool:
      name: ${{ parameters.poolName }}
      os: ${{ parameters.os }}
    timeoutInMinutes: 30
    variables:
      TEST_DIR: $(Build.SourcesDirectory)/test/sanity
      LOG_FILE: $(Build.SourcesDirectory)/test/sanity/results.xml
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - bash: |
          npm config set registry "$(NPM_REGISTRY)"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        displayName: Configure NPM Registry

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        displayName: Authenticate with NPM Registry

      - script: npm ci
        workingDirectory: $(TEST_DIR)
        displayName: Install NPM Dependencies

      # Native host: Install Playwright browser
      - ${{ if eq(parameters.container, '') }}:
        - ${{ if eq(parameters.os, 'windows') }}:
          - script: ./node_modules/.bin/playwright install --with-deps chromium
            workingDirectory: $(TEST_DIR)
            displayName: Install Playwright Browser
        - ${{ elseif eq(parameters.os, 'macOS') }}:
          - script: ./node_modules/.bin/playwright install --with-deps webkit
            workingDirectory: $(TEST_DIR)
            displayName: Install Playwright Browser
        - ${{ else }}:
          - script: ./node_modules/.bin/playwright install --with-deps firefox
            workingDirectory: $(TEST_DIR)
            displayName: Install Playwright Browser

      - script: npm run compile
        workingDirectory: $(TEST_DIR)
        displayName: Compile Sanity Tests

      # Native Linux host: Setup X11 and Snap
      - ${{ if and(eq(parameters.container, ''), eq(parameters.os, 'linux')) }}:
        - bash: |
            set -e
            echo "Installing X11 dependencies"
            sudo apt-get update
            sudo apt-get install -y \
              dbus \
              dbus-x11 \
              snapd \
              x11-utils \
              xvfb

            echo "Starting Xvfb on display :99"
            sudo Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
            echo "##vso[task.setvariable variable=DISPLAY]:99"

            echo "Starting D-Bus daemon"
            sudo mkdir -p /var/run/dbus && sudo dbus-daemon --system --fork

            echo "Starting snapd service"
            sudo systemctl start snapd.socket
            sudo systemctl start snapd.service
          displayName: Setup X11 Display

      # Native host
      - ${{ if eq(parameters.container, '') }}:
        - script: node out/index.js -c $(BUILD_COMMIT) -q $(BUILD_QUALITY) -t $(LOG_FILE) -v ${{ parameters.args }}
          workingDirectory: $(TEST_DIR)
          displayName: Run Sanity Tests

      # Configure QEMU for cross-architecture builds
      - ${{ if and(ne(parameters.container, ''), ne(parameters.arch, 'amd64')) }}:
        - bash: |
            docker run --privileged --rm tonistiigi/binfmt --uninstall '*'
            docker run --pull always --privileged --rm tonistiigi/binfmt --install all
          displayName: Setup QEMU for Multi-Architecture Support

      # Build test container image
      - ${{ if ne(parameters.container, '') }}:
        - bash: |
            docker buildx build \
              --platform "linux/${{ parameters.arch }}" \
              --tag "${{ parameters.container }}" \
              --file "containers/${{ parameters.container }}.dockerfile" \
              ./containers
          workingDirectory: $(TEST_DIR)
          displayName: Build Test Container Image

      # Run sanity tests in container
      - ${{ if ne(parameters.container, '') }}:
        - bash: |
            docker run \
              --rm \
              --platform "linux/${{ parameters.arch }}" \
              --volume "$(TEST_DIR):/root" \
              ${{ parameters.container }} \
              --quality "$(BUILD_QUALITY)" \
              --commit "$(BUILD_COMMIT)" \
              --test-results-path "/root/results.xml" \
              --verbose
          workingDirectory: $(TEST_DIR)
          displayName: Run Sanity Tests in Container

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $(LOG_FILE)
          testRunTitle: ${{ parameters.displayName }}
        displayName: Publish Test Results
        condition: succeededOrFailed()
