parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: poolName
    type: string
  - name: os
    type: string
    default: linux
  - name: container
    type: string
    default: ""
  - name: containerPlatform
    type: string
    default: ""
  - name: args
    type: string
    default: ""

jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    pool:
      name: ${{ parameters.poolName }}
      os: ${{ parameters.os }}
    timeoutInMinutes: 30
    variables:
      TEST_DIR: ./test/sanity
      LOG_FILE: $(Build.SourcesDirectory)/.build/sanity-test-logs/results.xml
      DOCKER_COMMAND: |
        docker run --rm --platform ${{ parameters.containerPlatform }} \
          -v "$(Build.SourcesDirectory):/workspace" \
          -w /workspace \
          ${{ parameters.container }} \
          /bin/sh -c
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - bash: |
          npm config set registry "$(NPM_REGISTRY)"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        displayName: Configure NPM Registry

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        displayName: Authenticate with NPM Registry

      - script: npm ci
        workingDirectory: $(TEST_DIR)
        displayName: Install NPM Dependencies

      # Native host: Install Playwright browser
      - ${{ if eq(parameters.os, 'windows') }}:
          script: ./node_modules/.bin/playwright install --with-deps chromium
        ${{ elseif eq(parameters.os, 'macos') }}:
          script: ./node_modules/.bin/playwright install --with-deps webkit
        ${{ else }}:
          script: ./node_modules/.bin/playwright install --with-deps firefox
        workingDirectory: $(TEST_DIR)
        displayName: Install Playwright Browser
        condition: eq('${{ parameters.container }}', '')

      - script: npm run compile
        workingDirectory: $(TEST_DIR)
        displayName: Compile Sanity Tests

      # Native Linux host: Setup X11 and Snap
      - bash: |
          set -e
          echo "Installing X11 dependencies"
          sudo apt-get update
          sudo apt-get install -y \
            dbus \
            dbus-x11 \
            snapd \
            x11-utils \
            xvfb

          echo "Starting Xvfb on display :99"
          sudo Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset &
          echo "##vso[task.setvariable variable=DISPLAY]:99"

          echo "Starting D-Bus daemon"
          sudo mkdir -p /var/run/dbus && sudo dbus-daemon --system --fork

          echo "Starting snapd service"
          sudo systemctl start snapd.socket
          sudo systemctl start snapd.service
        displayName: Setup X11 Display
        condition: and(eq('${{ parameters.container }}', ''), eq('${{ parameters.os }}', 'linux'))

      # Native host
      - script: node out/index.js -c $(BUILD_COMMIT) -q $(BUILD_QUALITY) -t $(LOG_FILE) -v ${{ parameters.args }}
        workingDirectory: $(TEST_DIR)
        displayName: Run Sanity Tests
        condition: eq('${{ parameters.container }}', '')

      # Configure QEMU for ARM containers
      - bash: |
          docker run --privileged --rm tonistiigi/binfmt --uninstall '*'
          docker run --pull always --privileged --rm tonistiigi/binfmt --install all
        displayName: Setup QEMU for Multi-Architecture Support
        condition: and(ne('${{ parameters.container }}', ''), contains('${{ parameters.containerPlatform }}', 'arm'), ne('${{ parameters.poolName }}', '1es-mariner-2.0-arm64'))

      # Ubuntu/Debian
      - bash: |
          ${{ variables.DOCKER_COMMAND }} '
            set -e
            apt-get update
            DEBIAN_FRONTEND=noninteractive
            apt-get install -y \
              ca-certificates \
              curl \
              dbus \
              dbus-x11 \
              libatk-bridge2.0-0 \
              libatomic1 \
              libdrm2 \
              libgbm1 \
              libnss3 \
              libxcomposite1 \
              libxdamage1 \
              libxkbcommon0 \
              libxrandr2 \
              libxss1 \
              sudo \
              x11-utils \
              xdg-utils \
              xvfb \
              xz-utils

            # apt-get install -y libgtk-3-0t64 || apt-get install -y libgtk-3-0
            apt-get install -y libasound2t64 || apt-get install -y libasound2

            # if [ "$(arch)" = "armv7l" ] || [ "$(arch)" = "aarch64" ]; then
            #   echo "Installing libatomic1 for ARM"
            #   apt-get install -y libatomic1
            # fi

            echo "Installing Node.js 22"
            if [ "$(arch)" = "x86_64" ] || [ "$(arch)" = "aarch64" ]; then
              curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
              apt-get install -y nodejs
            else
              curl -fsSL https://nodejs.org/dist/v22.13.0/node-v22.13.0-linux-armv7l.tar.xz | tar -xJ -C /usr/local --strip-components=1
            fi

            echo "Starting Xvfb on display :99"
            Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset && export DISPLAY=:99

            echo "Starting D-Bus session"
            mkdir -p /run/dbus && dbus-daemon --system --fork

            echo "Running sanity tests"
            node /workspace/test/sanity/out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
          '
        displayName: Run Sanity Tests
        condition: or(contains('${{ parameters.container }}', 'ubuntu'), contains('${{ parameters.container }}', 'debian'))

      # CentOS/Fedora/RHEL
      - bash: |
          ${{ variables.DOCKER_COMMAND }} '
              set -e
              dnf install -y \
                alsa-lib \
                at-spi2-atk \
                atk \
                dbus \
                dbus-daemon
                dbus-x11 \
                gtk3 \
                libdrm \
                libxcomposite \
                libxdamage \
                libxkbcommon \
                libxrandr \
                libXScrnSaver \
                mesa-libgbm \
                nss \
                sudo \
                xdg-utils \
                xorg-x11-server-Xvfb \
                xorg-x11-utils

              echo "Installing Node.js 22"
              curl -fsSL https://rpm.nodesource.com/setup_22.x | bash -
              dnf install -y nodejs

              echo "Starting Xvfb on display :99"
              Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset && export DISPLAY=:99

              echo "Starting D-Bus session"
              mkdir -p /run/dbus && dbus-daemon --system --fork

              echo "Running sanity tests"
              node /workspace/test/sanity/out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
          '
        displayName: Run Sanity Tests
        condition: or(contains('${{ parameters.container }}', 'centos'), contains('${{ parameters.container }}', 'fedora'), contains('${{ parameters.container }}', 'rhel'))

      # OpenSUSE
      - bash: |
          ${{ variables.DOCKER_COMMAND }} '
              set -e
              zypper install -y \
                alsa \
                dbus-1 \
                dbus-1-daemon \
                dbus-1-x11 \
                gzip \
                libgbm1 \
                libgtk-3-0 \
                mozilla-nss \
                nodejs22 \
                sudo \
                tar \
                xdg-utils \
                xorg-x11 \
                xorg-x11-server-Xvfb

              echo "Starting Xvfb on display :99"
              Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset && export DISPLAY=:99

              echo "Starting D-Bus session"
              mkdir -p /run/dbus && dbus-daemon --system --fork

              echo "Running sanity tests"
              node /workspace/test/sanity/out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
            '
        displayName: Run Sanity Tests
        condition: contains('${{ parameters.container }}', 'opensuse')

      # Alpine Linux
      - bash: |
          ${{ variables.DOCKER_COMMAND }} '
              set -e
              apk add --no-cache \
                ca-certificates \
                chromium \
                dbus \
                dbus-x11 \
                freetype \
                freetype-dev \
                gtk+3.0 \
                harfbuzz \
                mesa-gbm \
                nodejs \
                nss \
                sudo \
                ttf-freefont \
                xdpyinfo \
                xvfb

              echo "Starting Xvfb on display :99"
              Xvfb :99 -screen 0 1280x960x24 -ac +extension GLX +render -noreset && export DISPLAY=:99

              echo "Starting D-Bus session"
              mkdir -p /run/dbus && dbus-daemon --system --fork

              echo "Running sanity tests"
              node /workspace/test/sanity/out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
            '
        displayName: Run Sanity Tests
        condition: contains('${{ parameters.container }}', 'alpine')

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $(LOG_FILE)
          testRunTitle: ${{ parameters.displayName }}
        displayName: Publish Test Results
        condition: succeededOrFailed()
