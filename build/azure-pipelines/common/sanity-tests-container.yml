parameters:
  - name: name
    type: string
  - name: displayName
    type: string
  - name: poolName
    type: string
  - name: container
    type: string
  - name: containerPlatform
    type: string

jobs:
  - job: ${{ parameters.name }}
    displayName: ${{ parameters.displayName }}
    pool:
      name: ${{ parameters.poolName }}
      os: linux
    timeoutInMinutes: 30
    variables:
      SANITY_TEST_LOGS: $(Build.SourcesDirectory)/.build/sanity-test-logs
      LOG_FILE: $(SANITY_TEST_LOGS)/results.xml
    templateContext:
      outputs:
        - output: pipelineArtifact
          targetPath: $(SANITY_TEST_LOGS)
          artifactName: sanity-test-logs-${{ parameters.name }}-$(System.JobAttempt)
          displayName: Sanity Tests Logs
          sbomEnabled: false
          isProduction: false
          condition: succeededOrFailed()
    steps:
      - template: ./checkout.yml@self

      - task: NodeTool@0
        inputs:
          versionSource: fromFile
          versionFilePath: .nvmrc
        displayName: Install Node.js

      - bash: |
          npm config set registry "$(NPM_REGISTRY)"
          echo "##vso[task.setvariable variable=NPMRC_PATH]$(npm config get userconfig)"
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Configure NPM Registry

      - task: npmAuthenticate@0
        inputs:
          workingFile: $(NPMRC_PATH)
        condition: and(succeeded(), ne(variables['NPM_REGISTRY'], 'none'))
        displayName: Authenticate with NPM Registry

      - script: npm ci
        workingDirectory: ./test/sanity
        displayName: Install Dependencies

      - script: npm run compile
        workingDirectory: ./test/sanity
        displayName: Compile Sanity Tests

      - bash: |
          docker run --privileged --rm tonistiigi/binfmt --uninstall '*'
          docker run --pull always --privileged --rm tonistiigi/binfmt --install all
        displayName: Setup QEMU for Multi-Architecture Support
        condition: contains('${{ parameters.containerPlatform }}', 'arm')

      - bash: |
          set -e
          docker run --rm --platform ${{ parameters.containerPlatform }} \
            -v "$(Build.SourcesDirectory):/workspace" \
            -w /workspace \
            ${{ parameters.container }} \
            /bin/bash -c '
              set -e

              # Install Node.js and X11
              if command -v apt-get &> /dev/null; then

                apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y curl ca-certificates \
                  xvfb libx11-6 libx11-xcb1 libxcomposite1 libxcursor1 libxdamage1 libxi6 libxtst6 libnss3 \
                  libcups2 libxss1 libxrandr2 libasound2 libatk1.0-0 libatk-bridge2.0-0 libpangocairo-1.0-0 \
                  libgtk-3-0

                curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
                apt-get install -y nodejs

              elif command -v dnf &> /dev/null; then

                dnf install -y nodejs xorg-x11-server-Xvfb libX11 libX11-xcb libXcomposite libXcursor \
                  libXdamage libXi libXtst nss cups-libs libXScrnSaver libXrandr alsa-lib atk at-spi2-atk gtk3

              elif command -v yum &> /dev/null; then

                yum install -y nodejs xorg-x11-server-Xvfb libX11 libX11-xcb libXcomposite libXcursor \
                  libXdamage libXi libXtst nss cups-libs libXScrnSaver libXrandr alsa-lib atk at-spi2-atk gtk3

              elif command -v zypper &> /dev/null; then

                zypper install -y nodejs22 xorg-x11-server-Xvfb libX11-6 libX11-xcb1 libXcomposite1 \
                  libXcursor1 libXdamage1 libXi6 libXtst6 mozilla-nss libcups2 libXss1 libXrandr2 \
                  libasound2 libatk-1_0-0 at-spi2-core libgtk-3-0

              fi

              # Run tests
              cd /workspace/test/sanity
              node out/index.js -c "$(BUILD_COMMIT)" -q "$(BUILD_QUALITY)" -t "/workspace/.build/sanity-test-logs/results.xml" -v
            '
        displayName: Run Sanity Tests

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: JUnit
          testResultsFiles: $(LOG_FILE)
          testRunTitle: ${{ parameters.displayName }}
        condition: succeededOrFailed()
        displayName: Publish Test Results
