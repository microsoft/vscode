# ResonanceIDE: Windows tests workflow
# Uses GitHub-hosted runners instead of Microsoft self-hosted runners
# Note: Full Windows testing is optional; we prioritize Linux CI for PRs

on:
  workflow_call:
    inputs:
      job_name:
        type: string
        required: true
      electron_tests:
        type: boolean
        default: false
      browser_tests:
        type: boolean
        default: false
      remote_tests:
        type: boolean
        default: false

jobs:
  windows-test:
    name: ${{ inputs.job_name }}
    runs-on: windows-latest
    # Only run on main branch pushes, not PRs (to save runner costs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      ARTIFACT_NAME: ${{ (inputs.electron_tests && 'electron') || (inputs.browser_tests && 'browser') || (inputs.remote_tests && 'remote') || 'unknown' }}
      NPM_ARCH: x64
      VSCODE_ARCH: x64
    steps:
      - name: Checkout ResonanceIDE
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Install dependencies
        shell: pwsh
        run: |
          npm ci --ignore-scripts
          cd build
          npm ci
        env:
          npm_config_arch: ${{ env.NPM_ARCH }}
          VSCODE_ARCH: ${{ env.VSCODE_ARCH }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install extension dependencies
        shell: pwsh
        run: |
          Get-ChildItem -Path extensions -Directory | ForEach-Object {
            if (Test-Path "$($_.FullName)/package.json") {
              Push-Location $_.FullName
              npm install --ignore-scripts --no-audit --no-fund 2>$null
              Pop-Location
            }
          }

      - name: Compile
        shell: pwsh
        run: npm run compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§ª Run unit tests (node.js)
        if: ${{ inputs.electron_tests }}
        shell: pwsh
        run: npm run test-node
        timeout-minutes: 15

      - name: Publish Log Files
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: ${{ format('logs-windows-{0}-{1}-{2}', env.VSCODE_ARCH, env.ARTIFACT_NAME, github.run_attempt) }}
          path: .build/logs
          if-no-files-found: ignore
