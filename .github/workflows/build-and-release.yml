name: Build and Release VS Code

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release

env:
  NODE_VERSION: '20.x'
  PYTHON_VERSION: '3.11'

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          npm install -g yarn
          yarn install --frozen-lockfile

      - name: Compile
        run: yarn compile

      - name: Run tests
        if: matrix.arch == 'x64'
        run: yarn test --build
        continue-on-error: true

      - name: Build Windows (${{ matrix.arch }})
        env:
          VSCODE_ARCH: ${{ matrix.arch }}
        run: |
          yarn gulp vscode-win32-${{ matrix.arch }}-min
          yarn gulp vscode-win32-${{ matrix.arch }}-system-setup
          yarn gulp vscode-win32-${{ matrix.arch }}-user-setup
          yarn gulp vscode-win32-${{ matrix.arch }}-archive

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vscode-windows-${{ matrix.arch }}
          path: |
            .build/win32-${{ matrix.arch }}/system-setup/*.exe
            .build/win32-${{ matrix.arch }}/user-setup/*.exe
            .build/win32-${{ matrix.arch }}/archive/*.zip
          retention-days: 7

  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64, armhf]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev rpm
          if [ "${{ matrix.arch }}" != "x64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi

      - name: Install dependencies
        run: |
          npm install -g yarn
          yarn install --frozen-lockfile

      - name: Compile
        run: yarn compile

      - name: Run tests
        if: matrix.arch == 'x64'
        run: |
          xvfb-run -a yarn test --build
        continue-on-error: true

      - name: Build Linux (${{ matrix.arch }})
        env:
          VSCODE_ARCH: ${{ matrix.arch }}
        run: |
          yarn gulp vscode-linux-${{ matrix.arch }}-min
          yarn gulp vscode-linux-${{ matrix.arch }}-build-deb
          yarn gulp vscode-linux-${{ matrix.arch }}-build-rpm
          yarn gulp vscode-linux-${{ matrix.arch }}-archive

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vscode-linux-${{ matrix.arch }}
          path: |
            .build/linux/deb/${{ matrix.arch }}/deb/*.deb
            .build/linux/rpm/${{ matrix.arch }}/*.rpm
            .build/linux/archive/*.tar.gz
          retention-days: 7

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          npm install -g yarn
          yarn install --frozen-lockfile

      - name: Compile
        run: yarn compile

      - name: Run tests
        if: matrix.arch == 'x64'
        run: yarn test --build
        continue-on-error: true

      - name: Build macOS (${{ matrix.arch }})
        env:
          VSCODE_ARCH: ${{ matrix.arch }}
        run: |
          yarn gulp vscode-darwin-${{ matrix.arch }}-min
          yarn gulp vscode-darwin-${{ matrix.arch }}-archive

      - name: Create DMG (x64 only)
        if: matrix.arch == 'x64'
        run: yarn gulp vscode-darwin-${{ matrix.arch }}-dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vscode-macos-${{ matrix.arch }}
          path: |
            .build/darwin/${{ matrix.arch }}/*.dmg
            .build/darwin/archive/*.zip
          retention-days: 7

  build-universal-macos:
    name: Build Universal macOS
    runs-on: macos-latest
    needs: [build-macos]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: vscode-macos-*
          path: artifacts

      - name: Install dependencies
        run: |
          npm install -g yarn
          yarn install --frozen-lockfile

      - name: Create Universal Binary
        run: |
          yarn gulp vscode-darwin-universal-min
          yarn gulp vscode-darwin-universal-archive
          yarn gulp vscode-darwin-universal-dmg

      - name: Upload Universal macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vscode-macos-universal
          path: |
            .build/darwin/universal/*.dmg
            .build/darwin/archive/*.zip
          retention-days: 7

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, build-macos, build-universal-macos]
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.dmg" -o -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} release/ \;

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          md5sum * > MD5SUMS.txt

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=manual-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: VS Code ${{ steps.get_version.outputs.version }}
          draft: ${{ github.event.inputs.release_type == 'draft' || github.event_name == 'push' }}
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
          files: |
            release/*
          body: |
            ## VS Code Build ${{ steps.get_version.outputs.version }}
            
            ### Downloads
            
            **Windows:**
            - System Installer (x64, arm64)
            - User Installer (x64, arm64)
            - ZIP Archive (x64, arm64)
            
            **Linux:**
            - DEB Package (x64, arm64, armhf)
            - RPM Package (x64, arm64, armhf)
            - TAR.GZ Archive (x64, arm64, armhf)
            
            **macOS:**
            - DMG (x64, arm64, universal)
            - ZIP Archive (x64, arm64, universal)
            
            ### Checksums
            - SHA256SUMS.txt
            - MD5SUMS.txt
            
            ---
            Built with GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    
    steps:
      - name: Build Status
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "✅ Build and Release completed successfully!"
          else
            echo "❌ Build or Release failed!"
            exit 1
          fi