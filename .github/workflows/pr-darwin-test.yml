# ResonanceIDE: macOS tests workflow
# Note: This workflow uses macOS-14 (GitHub-hosted) instead of the Microsoft self-hosted macos-14-xlarge
# Full macOS testing is optional and expensive; we prioritize Linux CI for PRs

on:
  workflow_call:
    inputs:
      job_name:
        type: string
        required: true
      electron_tests:
        type: boolean
        default: false
      browser_tests:
        type: boolean
        default: false
      remote_tests:
        type: boolean
        default: false

jobs:
  macOS-test:
    name: ${{ inputs.job_name }}
    # Use GitHub-hosted macOS runner (not Microsoft self-hosted)
    runs-on: macos-14
    # Only run on main branch pushes, not PRs (to save runner costs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      ARTIFACT_NAME: ${{ (inputs.electron_tests && 'electron') || (inputs.browser_tests && 'browser') || (inputs.remote_tests && 'remote') || 'unknown' }}
      NPM_ARCH: arm64
      VSCODE_ARCH: arm64
    steps:
      - name: Checkout ResonanceIDE
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Install dependencies
        run: |
          set -e
          python3 -m pip install --break-system-packages setuptools || true
          npm ci --ignore-scripts || npm ci --ignore-scripts
          cd build && npm ci
        env:
          npm_config_arch: ${{ env.NPM_ARCH }}
          VSCODE_ARCH: ${{ env.VSCODE_ARCH }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GYP_DEFINES: "kerberos_use_rtld=false"

      - name: Install extension dependencies
        run: |
          for dir in extensions/*/; do
            if [ -f "$dir/package.json" ]; then
              (cd "$dir" && npm install --ignore-scripts --no-audit --no-fund 2>/dev/null || true)
            fi
          done

      - name: Compile
        run: npm run compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run node unit tests
        if: ${{ inputs.electron_tests }}
        timeout-minutes: 15
        run: npm run test-node

      - name: Publish Log Files
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: ${{ format('logs-macos-{0}-{1}-{2}', env.VSCODE_ARCH, env.ARTIFACT_NAME, github.run_attempt) }}
          path: .build/logs
          if-no-files-found: ignore
