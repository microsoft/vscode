# ResonanceIDE: Linux tests workflow
# Uses GitHub-hosted runners instead of Microsoft self-hosted runners

on:
  workflow_call:
    inputs:
      job_name:
        type: string
        required: true
      electron_tests:
        type: boolean
        default: false
      browser_tests:
        type: boolean
        default: false
      remote_tests:
        type: boolean
        default: false

jobs:
  linux-test:
    name: ${{ inputs.job_name }}
    runs-on: ubuntu-latest
    env:
      ARTIFACT_NAME: ${{ (inputs.electron_tests && 'electron') || (inputs.browser_tests && 'browser') || (inputs.remote_tests && 'remote') || 'unknown' }}
      NPM_ARCH: x64
      VSCODE_ARCH: x64
    steps:
      - name: Checkout ResonanceIDE
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'npm'

      - name: Setup system services
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            xvfb \
            libgtk-3-0 \
            libxkbfile-dev \
            libx11-dev \
            libx11-xcb-dev \
            libkrb5-dev \
            libsecret-1-dev \
            libgbm1 \
            libnotify-bin

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts || npm ci --ignore-scripts
          cd build && npm ci
        env:
          npm_config_arch: ${{ env.NPM_ARCH }}
          VSCODE_ARCH: ${{ env.VSCODE_ARCH }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install extension dependencies
        run: |
          find extensions -name "package.json" -not -path "*/node_modules/*" | while read pkg; do
            dir=$(dirname "$pkg")
            echo "Installing dependencies in $dir"
            (cd "$dir" && npm install --ignore-scripts --no-audit --no-fund 2>/dev/null || true)
          done
          if [ -d ".vscode/extensions/vscode-selfhost-test-provider" ]; then
            cd .vscode/extensions/vscode-selfhost-test-provider && npm install --ignore-scripts || true
            cd ../vscode-selfhost-import-aid && npm install --ignore-scripts || true
          fi

      - name: Compile
        run: npm run compile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§ª Run unit tests (node.js)
        if: ${{ inputs.electron_tests }}
        timeout-minutes: 15
        run: npm run test-node

      - name: Publish Log Files
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: ${{ format('logs-linux-{0}-{1}-{2}', env.VSCODE_ARCH, env.ARTIFACT_NAME, github.run_attempt) }}
          path: .build/logs
          if-no-files-found: ignore
