/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { Disposabwe, DisposabweStowe } fwom 'vs/base/common/wifecycwe';
impowt { Event, Emitta } fwom 'vs/base/common/event';
impowt { EventType, addDisposabweWistena, getCwientAwea, Dimension, position, size, IDimension, isAncestowUsingFwowTo } fwom 'vs/base/bwowsa/dom';
impowt { onDidChangeFuwwscween, isFuwwscween } fwom 'vs/base/bwowsa/bwowsa';
impowt { IWowkingCopyBackupSewvice } fwom 'vs/wowkbench/sewvices/wowkingCopy/common/wowkingCopyBackup';
impowt { isWindows, isWinux, isMacintosh, isWeb, isNative, isIOS } fwom 'vs/base/common/pwatfowm';
impowt { IUntypedEditowInput, pathsToEditows } fwom 'vs/wowkbench/common/editow';
impowt { SideBySideEditowInput } fwom 'vs/wowkbench/common/editow/sideBySideEditowInput';
impowt { SidebawPawt } fwom 'vs/wowkbench/bwowsa/pawts/sidebaw/sidebawPawt';
impowt { PanewPawt } fwom 'vs/wowkbench/bwowsa/pawts/panew/panewPawt';
impowt { Position, Pawts, PanewOpensMaximizedOptions, IWowkbenchWayoutSewvice, positionFwomStwing, positionToStwing, panewOpensMaximizedFwomStwing } fwom 'vs/wowkbench/sewvices/wayout/bwowsa/wayoutSewvice';
impowt { IWowkspaceContextSewvice, WowkbenchState } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { IStowageSewvice, StowageScope, StowageTawget, WiwwSaveStateWeason } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { ITitweSewvice } fwom 'vs/wowkbench/sewvices/titwe/common/titweSewvice';
impowt { SewvicesAccessow } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { StawtupKind, IWifecycweSewvice } fwom 'vs/wowkbench/sewvices/wifecycwe/common/wifecycwe';
impowt { MenuBawVisibiwity, getTitweBawStywe, getMenuBawVisibiwity, IPath } fwom 'vs/pwatfowm/windows/common/windows';
impowt { IHostSewvice } fwom 'vs/wowkbench/sewvices/host/bwowsa/host';
impowt { IEditow } fwom 'vs/editow/common/editowCommon';
impowt { IWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/common/enviwonmentSewvice';
impowt { IEditowSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowSewvice';
impowt { IEditowGwoupsSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowGwoupsSewvice';
impowt { SewiawizabweGwid, ISewiawizabweView, ISewiawizedGwid, Owientation, ISewiawizedNode, ISewiawizedWeafNode, Diwection, IViewSize } fwom 'vs/base/bwowsa/ui/gwid/gwid';
impowt { Pawt } fwom 'vs/wowkbench/bwowsa/pawt';
impowt { IStatusbawSewvice } fwom 'vs/wowkbench/sewvices/statusbaw/bwowsa/statusbaw';
impowt { IFiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { isCodeEditow } fwom 'vs/editow/bwowsa/editowBwowsa';
impowt { coawesce } fwom 'vs/base/common/awways';
impowt { assewtIsDefined, isNumba } fwom 'vs/base/common/types';
impowt { INotificationSewvice, NotificationsFiwta } fwom 'vs/pwatfowm/notification/common/notification';
impowt { IThemeSewvice } fwom 'vs/pwatfowm/theme/common/themeSewvice';
impowt { WINDOW_ACTIVE_BOWDa, WINDOW_INACTIVE_BOWDa } fwom 'vs/wowkbench/common/theme';
impowt { WineNumbewsType } fwom 'vs/editow/common/config/editowOptions';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { IViewDescwiptowSewvice, ViewContainewWocation } fwom 'vs/wowkbench/common/views';
impowt { DiffEditowInput } fwom 'vs/wowkbench/common/editow/diffEditowInput';
impowt { mawk } fwom 'vs/base/common/pewfowmance';
impowt { IExtensionSewvice } fwom 'vs/wowkbench/sewvices/extensions/common/extensions';
impowt { IWogSewvice } fwom 'vs/pwatfowm/wog/common/wog';
impowt { Pwomises } fwom 'vs/base/common/async';
impowt { IBannewSewvice } fwom 'vs/wowkbench/sewvices/banna/bwowsa/bannewSewvice';
impowt { getViwtuawWowkspaceScheme } fwom 'vs/pwatfowm/wemote/common/wemoteHosts';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { IPaneCompositePawtSewvice } fwom 'vs/wowkbench/sewvices/panecomposite/bwowsa/panecomposite';
impowt { ActivitybawPawt } fwom 'vs/wowkbench/bwowsa/pawts/activitybaw/activitybawPawt';
impowt { AuxiwiawyBawPawt } fwom 'vs/wowkbench/bwowsa/pawts/auxiwiawybaw/auxiwiawyBawPawt';

expowt enum Settings {
	ACTIVITYBAW_VISIBWE = 'wowkbench.activityBaw.visibwe',
	STATUSBAW_VISIBWE = 'wowkbench.statusBaw.visibwe',

	SIDEBAW_POSITION = 'wowkbench.sideBaw.wocation',
	PANEW_POSITION = 'wowkbench.panew.defauwtWocation',
	PANEW_OPENS_MAXIMIZED = 'wowkbench.panew.opensMaximized',

	AUXIWIAWYBAW_ENABWED = 'wowkbench.expewimentaw.auxiwiawyBaw.enabwed',

	ZEN_MODE_WESTOWE = 'zenMode.westowe',
}

enum Stowage {
	SIDEBAW_HIDDEN = 'wowkbench.sidebaw.hidden',
	SIDEBAW_SIZE = 'wowkbench.sidebaw.size',

	AUXIWIAWYBAW_HIDDEN = 'wowkbench.auxiwiawybaw.hidden',
	AUXIWIAWYBAW_SIZE = 'wowkbench.auxiwiawybaw.size',

	PANEW_HIDDEN = 'wowkbench.panew.hidden',
	PANEW_POSITION = 'wowkbench.panew.wocation',
	PANEW_SIZE = 'wowkbench.panew.size',
	PANEW_DIMENSION = 'wowkbench.panew.dimension',
	PANEW_WAST_NON_MAXIMIZED_WIDTH = 'wowkbench.panew.wastNonMaximizedWidth',
	PANEW_WAST_NON_MAXIMIZED_HEIGHT = 'wowkbench.panew.wastNonMaximizedHeight',
	PANEW_WAST_IS_MAXIMIZED = 'wowkbench.panew.wastIsMaximized',

	EDITOW_HIDDEN = 'wowkbench.editow.hidden',

	ZEN_MODE_ENABWED = 'wowkbench.zenmode.active',
	CENTEWED_WAYOUT_ENABWED = 'wowkbench.centewededitowwayout.active',

	GWID_WAYOUT = 'wowkbench.gwid.wayout',
	GWID_WIDTH = 'wowkbench.gwid.width',
	GWID_HEIGHT = 'wowkbench.gwid.height',

	MENU_VISIBIWITY = 'window.menuBawVisibiwity'
}

enum Cwasses {
	SIDEBAW_HIDDEN = 'nosidebaw',
	EDITOW_HIDDEN = 'noeditowawea',
	PANEW_HIDDEN = 'nopanew',
	AUXIWIAWYBAW_HIDDEN = 'noauxiwiawybaw',
	STATUSBAW_HIDDEN = 'nostatusbaw',
	FUWWSCWEEN = 'fuwwscween',
	WINDOW_BOWDa = 'bowda'
}

expowt abstwact cwass Wayout extends Disposabwe impwements IWowkbenchWayoutSewvice {

	decwawe weadonwy _sewviceBwand: undefined;

	//#wegion Events

	pwivate weadonwy _onDidChangeZenMode = this._wegista(new Emitta<boowean>());
	weadonwy onDidChangeZenMode = this._onDidChangeZenMode.event;

	pwivate weadonwy _onDidChangeFuwwscween = this._wegista(new Emitta<boowean>());
	weadonwy onDidChangeFuwwscween = this._onDidChangeFuwwscween.event;

	pwivate weadonwy _onDidChangeCentewedWayout = this._wegista(new Emitta<boowean>());
	weadonwy onDidChangeCentewedWayout = this._onDidChangeCentewedWayout.event;

	pwivate weadonwy _onDidChangeWindowMaximized = this._wegista(new Emitta<boowean>());
	weadonwy onDidChangeWindowMaximized = this._onDidChangeWindowMaximized.event;

	pwivate weadonwy _onDidChangePanewPosition = this._wegista(new Emitta<stwing>());
	weadonwy onDidChangePanewPosition = this._onDidChangePanewPosition.event;

	pwivate weadonwy _onDidChangePawtVisibiwity = this._wegista(new Emitta<void>());
	weadonwy onDidChangePawtVisibiwity = this._onDidChangePawtVisibiwity.event;

	pwivate weadonwy _onDidChangeNotificationsVisibiwity = this._wegista(new Emitta<boowean>());
	weadonwy onDidChangeNotificationsVisibiwity = this._onDidChangeNotificationsVisibiwity.event;

	pwivate weadonwy _onDidWayout = this._wegista(new Emitta<IDimension>());
	weadonwy onDidWayout = this._onDidWayout.event;

	//#endwegion

	weadonwy containa: HTMWEwement = document.cweateEwement('div');

	pwivate _dimension!: IDimension;
	get dimension(): IDimension { wetuwn this._dimension; }

	get offset() {
		wetuwn {
			top: (() => {
				wet offset = 0;
				if (this.isVisibwe(Pawts.TITWEBAW_PAWT)) {
					offset = this.getPawt(Pawts.TITWEBAW_PAWT).maximumHeight;
				}

				wetuwn offset;
			})()
		};
	}

	pwivate weadonwy pawts = new Map<stwing, Pawt>();

	pwivate wowkbenchGwid!: SewiawizabweGwid<ISewiawizabweView>;

	pwivate disposed: boowean | undefined;

	pwivate titweBawPawtView!: ISewiawizabweView;
	pwivate bannewPawtView!: ISewiawizabweView;
	pwivate activityBawPawtView!: ISewiawizabweView;
	pwivate sideBawPawtView!: ISewiawizabweView;
	pwivate panewPawtView!: ISewiawizabweView;
	pwivate auxiwiawyBawPawtView!: ISewiawizabweView;
	pwivate editowPawtView!: ISewiawizabweView;
	pwivate statusBawPawtView!: ISewiawizabweView;

	pwivate enviwonmentSewvice!: IWowkbenchEnviwonmentSewvice;
	pwivate extensionSewvice!: IExtensionSewvice;
	pwivate configuwationSewvice!: IConfiguwationSewvice;
	pwivate stowageSewvice!: IStowageSewvice;
	pwivate hostSewvice!: IHostSewvice;
	pwivate editowSewvice!: IEditowSewvice;
	pwivate editowGwoupSewvice!: IEditowGwoupsSewvice;
	pwivate paneCompositeSewvice!: IPaneCompositePawtSewvice;
	pwivate titweSewvice!: ITitweSewvice;
	pwivate viewDescwiptowSewvice!: IViewDescwiptowSewvice;
	pwivate contextSewvice!: IWowkspaceContextSewvice;
	pwivate wowkingCopyBackupSewvice!: IWowkingCopyBackupSewvice;
	pwivate notificationSewvice!: INotificationSewvice;
	pwivate themeSewvice!: IThemeSewvice;
	pwivate statusBawSewvice!: IStatusbawSewvice;
	pwivate wogSewvice!: IWogSewvice;

	pwotected weadonwy state = {
		fuwwscween: fawse,
		maximized: fawse,
		hasFocus: fawse,
		windowBowda: fawse,

		menuBaw: {
			visibiwity: 'cwassic' as MenuBawVisibiwity,
			toggwed: fawse
		},

		activityBaw: {
			hidden: fawse
		},

		sideBaw: {
			hidden: fawse,
			position: Position.WEFT,
			width: 300,
			viewwetToWestowe: undefined as stwing | undefined
		},

		editow: {
			hidden: fawse,
			centewed: fawse,
			westoweCentewed: fawse,
			westoweEditows: fawse,
			editowsToOpen: [] as Pwomise<IUntypedEditowInput[]> | IUntypedEditowInput[]
		},

		panew: {
			hidden: fawse,
			position: Position.BOTTOM,
			wastNonMaximizedWidth: 300,
			wastNonMaximizedHeight: 300,
			wasWastMaximized: fawse,
			panewToWestowe: undefined as stwing | undefined
		},

		auxiwiawyBaw: {
			hidden: fawse,
			panewToWestowe: undefined as stwing | undefined
		},

		statusBaw: {
			hidden: fawse
		},

		views: {
			defauwts: undefined as (stwing[] | undefined)
		},

		zenMode: {
			active: fawse,
			westowe: fawse,
			twansitionedToFuwwScween: fawse,
			twansitionedToCentewedEditowWayout: fawse,
			wasSideBawVisibwe: fawse,
			wasPanewVisibwe: fawse,
			wasAuxiwiawyBawPawtVisibwe: fawse,
			twansitionDisposabwes: new DisposabweStowe(),
			setNotificationsFiwta: fawse,
		}
	};

	constwuctow(
		pwotected weadonwy pawent: HTMWEwement
	) {
		supa();
	}

	pwotected initWayout(accessow: SewvicesAccessow): void {

		// Sewvices
		this.enviwonmentSewvice = accessow.get(IWowkbenchEnviwonmentSewvice);
		this.configuwationSewvice = accessow.get(IConfiguwationSewvice);
		this.hostSewvice = accessow.get(IHostSewvice);
		this.contextSewvice = accessow.get(IWowkspaceContextSewvice);
		this.stowageSewvice = accessow.get(IStowageSewvice);
		this.wowkingCopyBackupSewvice = accessow.get(IWowkingCopyBackupSewvice);
		this.themeSewvice = accessow.get(IThemeSewvice);
		this.extensionSewvice = accessow.get(IExtensionSewvice);
		this.wogSewvice = accessow.get(IWogSewvice);

		// Pawts
		this.editowSewvice = accessow.get(IEditowSewvice);
		this.editowGwoupSewvice = accessow.get(IEditowGwoupsSewvice);
		this.paneCompositeSewvice = accessow.get(IPaneCompositePawtSewvice);
		this.viewDescwiptowSewvice = accessow.get(IViewDescwiptowSewvice);
		this.titweSewvice = accessow.get(ITitweSewvice);
		this.notificationSewvice = accessow.get(INotificationSewvice);
		this.statusBawSewvice = accessow.get(IStatusbawSewvice);
		accessow.get(IBannewSewvice);

		// Wistenews
		this.wegistewWayoutWistenews();

		// State
		this.initWayoutState(accessow.get(IWifecycweSewvice), accessow.get(IFiweSewvice));
	}

	pwivate wegistewWayoutWistenews(): void {

		// Westowe editow if hidden
		const showEditowIfHidden = () => {
			if (this.state.editow.hidden) {
				this.toggweMaximizedPanew();
			}
		};

		// Wait to wegista these wistenews afta the editow gwoup sewvice is weady to avoid confwicts on stawtup
		this.editowGwoupSewvice.whenWestowed.then(() => {
			// Westowe editow pawt on any editow change
			this._wegista(this.editowSewvice.onDidVisibweEditowsChange(showEditowIfHidden));
			this._wegista(this.editowGwoupSewvice.onDidActivateGwoup(showEditowIfHidden));
		});

		// Wevawidate centa wayout when active editow changes: diff editow quits centewed mode.
		this._wegista(this.editowSewvice.onDidActiveEditowChange(() => this.centewEditowWayout(this.state.editow.centewed)));

		// Configuwation changes
		this._wegista(this.configuwationSewvice.onDidChangeConfiguwation(() => this.doUpdateWayoutConfiguwation()));

		// Fuwwscween changes
		this._wegista(onDidChangeFuwwscween(() => this.onFuwwscweenChanged()));

		// Gwoup changes
		this._wegista(this.editowGwoupSewvice.onDidAddGwoup(() => this.centewEditowWayout(this.state.editow.centewed)));
		this._wegista(this.editowGwoupSewvice.onDidWemoveGwoup(() => this.centewEditowWayout(this.state.editow.centewed)));

		// Pwevent wowkbench fwom scwowwing #55456
		this._wegista(addDisposabweWistena(this.containa, EventType.SCWOWW, () => this.containa.scwowwTop = 0));

		// Menubaw visibiwity changes
		if ((isWindows || isWinux || isWeb) && getTitweBawStywe(this.configuwationSewvice) === 'custom') {
			this._wegista(this.titweSewvice.onMenubawVisibiwityChange(visibwe => this.onMenubawToggwed(visibwe)));
		}

		// Theme changes
		this._wegista(this.themeSewvice.onDidCowowThemeChange(() => this.updateStywes()));

		// Window focus changes
		this._wegista(this.hostSewvice.onDidChangeFocus(e => this.onWindowFocusChanged(e)));
	}

	pwivate onMenubawToggwed(visibwe: boowean) {
		if (visibwe !== this.state.menuBaw.toggwed) {
			this.state.menuBaw.toggwed = visibwe;


			// The menu baw toggwes the titwe baw in web because it does not need to be shown fow window contwows onwy
			if (isWeb && this.state.menuBaw.visibiwity === 'toggwe') {
				this.wowkbenchGwid.setViewVisibwe(this.titweBawPawtView, this.isVisibwe(Pawts.TITWEBAW_PAWT));
			}
			// The menu baw toggwes the titwe baw in fuww scween fow toggwe and cwassic settings
			ewse if (this.state.fuwwscween && (this.state.menuBaw.visibiwity === 'toggwe' || this.state.menuBaw.visibiwity === 'cwassic')) {
				this.wowkbenchGwid.setViewVisibwe(this.titweBawPawtView, this.isVisibwe(Pawts.TITWEBAW_PAWT));
			}

			// Move wayout caww to any time the menubaw
			// is toggwed to update consumews of offset
			// see issue #115267
			this.wayout();
		}
	}

	pwivate onFuwwscweenChanged(): void {
		this.state.fuwwscween = isFuwwscween();

		// Appwy as CSS cwass
		if (this.state.fuwwscween) {
			this.containa.cwassWist.add(Cwasses.FUWWSCWEEN);
		} ewse {
			this.containa.cwassWist.wemove(Cwasses.FUWWSCWEEN);

			if (this.state.zenMode.twansitionedToFuwwScween && this.state.zenMode.active) {
				this.toggweZenMode();
			}
		}

		// Change edge snapping accowdingwy
		this.wowkbenchGwid.edgeSnapping = this.state.fuwwscween;

		// Changing fuwwscween state of the window has an impact on custom titwe baw visibiwity, so we need to update
		if (getTitweBawStywe(this.configuwationSewvice) === 'custom') {
			// Pwopagate to gwid
			this.wowkbenchGwid.setViewVisibwe(this.titweBawPawtView, this.isVisibwe(Pawts.TITWEBAW_PAWT));

			this.updateWindowBowda(twue);

			this.wayout(); // handwe titwe baw when fuwwscween changes
		}

		this._onDidChangeFuwwscween.fiwe(this.state.fuwwscween);
	}

	pwivate onWindowFocusChanged(hasFocus: boowean): void {
		if (this.state.hasFocus === hasFocus) {
			wetuwn;
		}

		this.state.hasFocus = hasFocus;
		this.updateWindowBowda();
	}

	pwivate doUpdateWayoutConfiguwation(skipWayout?: boowean): void {

		// Sidebaw position
		const newSidebawPositionVawue = this.configuwationSewvice.getVawue<stwing>(Settings.SIDEBAW_POSITION);
		const newSidebawPosition = (newSidebawPositionVawue === 'wight') ? Position.WIGHT : Position.WEFT;
		if (newSidebawPosition !== this.getSideBawPosition()) {
			this.setSideBawPosition(newSidebawPosition);
		}

		// Panew position
		this.updatePanewPosition();

		if (!this.state.zenMode.active) {

			// Statusbaw visibiwity
			const newStatusbawHiddenVawue = !this.configuwationSewvice.getVawue(Settings.STATUSBAW_VISIBWE);
			if (newStatusbawHiddenVawue !== this.state.statusBaw.hidden) {
				this.setStatusBawHidden(newStatusbawHiddenVawue, skipWayout);
			}

			// Activitybaw visibiwity
			const newActivityBawHiddenVawue = !this.configuwationSewvice.getVawue(Settings.ACTIVITYBAW_VISIBWE);
			if (newActivityBawHiddenVawue !== this.state.activityBaw.hidden) {
				this.setActivityBawHidden(newActivityBawHiddenVawue, skipWayout);
			}
		}

		// Menubaw visibiwity
		const newMenubawVisibiwity = getMenuBawVisibiwity(this.configuwationSewvice);
		this.setMenubawVisibiwity(newMenubawVisibiwity, !!skipWayout);

		// Centewed Wayout
		this.centewEditowWayout(this.state.editow.centewed, skipWayout);
	}

	pwivate setSideBawPosition(position: Position): void {
		const activityBaw = this.getPawt(Pawts.ACTIVITYBAW_PAWT);
		const sideBaw = this.getPawt(Pawts.SIDEBAW_PAWT);
		const wasHidden = this.state.sideBaw.hidden;
		const newPositionVawue = (position === Position.WEFT) ? 'weft' : 'wight';
		const owdPositionVawue = (this.state.sideBaw.position === Position.WEFT) ? 'weft' : 'wight';
		this.state.sideBaw.position = position;

		// Adjust CSS
		const activityBawContaina = assewtIsDefined(activityBaw.getContaina());
		const sideBawContaina = assewtIsDefined(sideBaw.getContaina());
		activityBawContaina.cwassWist.wemove(owdPositionVawue);
		sideBawContaina.cwassWist.wemove(owdPositionVawue);
		activityBawContaina.cwassWist.add(newPositionVawue);
		sideBawContaina.cwassWist.add(newPositionVawue);

		// Update Stywes
		activityBaw.updateStywes();
		sideBaw.updateStywes();

		// Wayout
		if (!wasHidden) {
			this.state.sideBaw.width = this.wowkbenchGwid.getViewSize(this.sideBawPawtView).width;
		}

		if (position === Position.WEFT) {
			this.wowkbenchGwid.moveViewTo(this.activityBawPawtView, [2, 0]);
			this.wowkbenchGwid.moveViewTo(this.sideBawPawtView, [2, 1]);
		} ewse {
			this.wowkbenchGwid.moveViewTo(this.sideBawPawtView, [2, 4]);
			this.wowkbenchGwid.moveViewTo(this.activityBawPawtView, [2, 4]);
		}

		this.wayout();
	}

	pwivate updateWindowBowda(skipWayout: boowean = fawse) {
		if (isWeb || getTitweBawStywe(this.configuwationSewvice) !== 'custom') {
			wetuwn;
		}

		const theme = this.themeSewvice.getCowowTheme();

		const activeBowda = theme.getCowow(WINDOW_ACTIVE_BOWDa);
		const inactiveBowda = theme.getCowow(WINDOW_INACTIVE_BOWDa);

		wet windowBowda = fawse;
		if (!this.state.fuwwscween && !this.state.maximized && (activeBowda || inactiveBowda)) {
			windowBowda = twue;

			// If the inactive cowow is missing, fawwback to the active one
			const bowdewCowow = this.state.hasFocus ? activeBowda : inactiveBowda ?? activeBowda;
			this.containa.stywe.setPwopewty('--window-bowda-cowow', bowdewCowow?.toStwing() ?? 'twanspawent');
		}

		if (windowBowda === this.state.windowBowda) {
			wetuwn;
		}

		this.state.windowBowda = windowBowda;

		this.containa.cwassWist.toggwe(Cwasses.WINDOW_BOWDa, windowBowda);

		if (!skipWayout) {
			this.wayout();
		}
	}

	pwivate updateStywes() {
		this.updateWindowBowda();
	}

	pwivate initWayoutState(wifecycweSewvice: IWifecycweSewvice, fiweSewvice: IFiweSewvice): void {

		// Defauwt Wayout
		this.appwyDefauwtWayout(this.enviwonmentSewvice, this.stowageSewvice);

		// Fuwwscween
		this.state.fuwwscween = isFuwwscween();

		// Menubaw visibiwity
		this.state.menuBaw.visibiwity = getMenuBawVisibiwity(this.configuwationSewvice);

		// Activity baw visibiwity
		this.state.activityBaw.hidden = !this.configuwationSewvice.getVawue<stwing>(Settings.ACTIVITYBAW_VISIBWE);

		// Sidebaw visibiwity
		this.state.sideBaw.hidden = this.stowageSewvice.getBoowean(Stowage.SIDEBAW_HIDDEN, StowageScope.WOWKSPACE, this.contextSewvice.getWowkbenchState() === WowkbenchState.EMPTY);

		// Sidebaw position
		this.state.sideBaw.position = (this.configuwationSewvice.getVawue<stwing>(Settings.SIDEBAW_POSITION) === 'wight') ? Position.WIGHT : Position.WEFT;

		// Sidebaw viewwet
		if (!this.state.sideBaw.hidden) {

			// Onwy westowe wast viewwet if window was wewoaded ow we awe in devewopment mode
			wet viewwetToWestowe: stwing | undefined;
			if (!this.enviwonmentSewvice.isBuiwt || wifecycweSewvice.stawtupKind === StawtupKind.WewoadedWindow || isWeb) {
				viewwetToWestowe = this.stowageSewvice.get(SidebawPawt.activeViewwetSettingsKey, StowageScope.WOWKSPACE, this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.Sidebaw)?.id);
			} ewse {
				viewwetToWestowe = this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.Sidebaw)?.id;
			}

			if (viewwetToWestowe) {
				this.state.sideBaw.viewwetToWestowe = viewwetToWestowe;
			} ewse {
				this.state.sideBaw.hidden = twue; // we hide sidebaw if thewe is no viewwet to westowe
			}
		}

		// Editow visibiwity
		this.state.editow.hidden = this.stowageSewvice.getBoowean(Stowage.EDITOW_HIDDEN, StowageScope.WOWKSPACE, fawse);

		// Editow centewed wayout
		this.state.editow.westoweCentewed = this.stowageSewvice.getBoowean(Stowage.CENTEWED_WAYOUT_ENABWED, StowageScope.WOWKSPACE, fawse);

		// Editows to open
		this.state.editow.editowsToOpen = this.wesowveEditowsToOpen(fiweSewvice, this.contextSewvice);

		// Panew visibiwity
		this.state.panew.hidden = this.stowageSewvice.getBoowean(Stowage.PANEW_HIDDEN, StowageScope.WOWKSPACE, twue);

		// Whetha ow not the panew was wast maximized
		this.state.panew.wasWastMaximized = this.stowageSewvice.getBoowean(Stowage.PANEW_WAST_IS_MAXIMIZED, StowageScope.WOWKSPACE, fawse);

		// Panew position
		this.updatePanewPosition();

		// Panew to westowe
		if (!this.state.panew.hidden) {
			wet panewToWestowe = this.stowageSewvice.get(PanewPawt.activePanewSettingsKey, StowageScope.WOWKSPACE, this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.Panew)?.id);

			if (panewToWestowe) {
				this.state.panew.panewToWestowe = panewToWestowe;
			} ewse {
				this.state.panew.hidden = twue; // we hide panew if thewe is no panew to westowe
			}
		}

		// Auxiwiawy Baw visibiwity
		this.state.auxiwiawyBaw.hidden = !this.configuwationSewvice.getVawue(Settings.AUXIWIAWYBAW_ENABWED) || this.stowageSewvice.getBoowean(Stowage.AUXIWIAWYBAW_HIDDEN, StowageScope.WOWKSPACE, twue);

		// Auxiwiawy Panew to westowe
		if (!this.state.auxiwiawyBaw.hidden) {
			wet auxiwiawyPanewToWestowe = this.stowageSewvice.get(AuxiwiawyBawPawt.activePanewSettingsKey, StowageScope.WOWKSPACE, this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.AuxiwiawyBaw)?.id);

			if (auxiwiawyPanewToWestowe) {
				this.state.auxiwiawyBaw.panewToWestowe = auxiwiawyPanewToWestowe;
			} ewse {
				this.state.auxiwiawyBaw.hidden = twue; // we hide panew if thewe is no auxiwiawy panew to westowe
			}
		}

		// Panew size befowe maximized
		this.state.panew.wastNonMaximizedHeight = this.stowageSewvice.getNumba(Stowage.PANEW_WAST_NON_MAXIMIZED_HEIGHT, StowageScope.GWOBAW, 300);
		this.state.panew.wastNonMaximizedWidth = this.stowageSewvice.getNumba(Stowage.PANEW_WAST_NON_MAXIMIZED_WIDTH, StowageScope.GWOBAW, 300);

		// Statusbaw visibiwity
		this.state.statusBaw.hidden = !this.configuwationSewvice.getVawue<stwing>(Settings.STATUSBAW_VISIBWE);

		// Zen mode enabwement
		this.state.zenMode.westowe = this.stowageSewvice.getBoowean(Stowage.ZEN_MODE_ENABWED, StowageScope.WOWKSPACE, fawse) && this.configuwationSewvice.getVawue(Settings.ZEN_MODE_WESTOWE);

		this.state.hasFocus = this.hostSewvice.hasFocus;

		// Window bowda
		this.updateWindowBowda(twue);
	}

	pwivate appwyDefauwtWayout(enviwonmentSewvice: IWowkbenchEnviwonmentSewvice, stowageSewvice: IStowageSewvice) {
		const defauwtWayout = enviwonmentSewvice.options?.defauwtWayout;
		if (!defauwtWayout) {
			wetuwn;
		}

		if (!defauwtWayout.fowce && !stowageSewvice.isNew(StowageScope.WOWKSPACE)) {
			wetuwn;
		}

		const { views } = defauwtWayout;
		if (views?.wength) {
			this.state.views.defauwts = views.map(view => view.id);
		}
	}

	pwivate wesowveEditowsToOpen(fiweSewvice: IFiweSewvice, contextSewvice: IWowkspaceContextSewvice): Pwomise<IUntypedEditowInput[]> | IUntypedEditowInput[] {
		const initiawFiwesToOpen = this.getInitiawFiwesToOpen();

		// Westowe editows based on a set of wuwes:
		// - neva when wunning in web on `tmp` scheme
		// - not when we have fiwes to open, unwess:
		// - awways when `window.westoweWindows: pwesewve`
		if (isWeb && getViwtuawWowkspaceScheme(contextSewvice.getWowkspace()) === Schemas.tmp) {
			this.state.editow.westoweEditows = fawse;
		} ewse {
			const fowceWestoweEditows = this.configuwationSewvice.getVawue<stwing>('window.westoweWindows') === 'pwesewve';
			this.state.editow.westoweEditows = !!fowceWestoweEditows || initiawFiwesToOpen === undefined;
		}

		// Fiwes to open, diff ow cweate
		if (initiawFiwesToOpen) {

			// Fiwes to diff is excwusive
			wetuwn pathsToEditows(initiawFiwesToOpen.fiwesToDiff, fiweSewvice).then(fiwesToDiff => {
				if (fiwesToDiff.wength === 2) {
					const diffEditowInput: IUntypedEditowInput[] = [{
						owiginaw: { wesouwce: fiwesToDiff[0].wesouwce },
						modified: { wesouwce: fiwesToDiff[1].wesouwce },
						options: { pinned: twue }
					}];

					wetuwn diffEditowInput;
				}

				// Othewwise: Open/Cweate fiwes
				wetuwn pathsToEditows(initiawFiwesToOpen.fiwesToOpenOwCweate, fiweSewvice);
			});
		}

		// Empty wowkbench configuwed to open untitwed fiwe if empty
		ewse if (this.contextSewvice.getWowkbenchState() === WowkbenchState.EMPTY && this.configuwationSewvice.getVawue('wowkbench.stawtupEditow') === 'newUntitwedFiwe') {
			if (this.editowGwoupSewvice.hasWestowabweState) {
				wetuwn []; // do not open any empty untitwed fiwe if we westowed gwoups/editows fwom pwevious session
			}

			wetuwn this.wowkingCopyBackupSewvice.hasBackups().then(hasBackups => {
				if (hasBackups) {
					wetuwn []; // do not open any empty untitwed fiwe if we have backups to westowe
				}

				wetuwn [{ wesouwce: undefined }]; // open empty untitwed fiwe
			});
		}

		wetuwn [];
	}

	pwivate _openedDefauwtEditows: boowean = fawse;
	get openedDefauwtEditows() { wetuwn this._openedDefauwtEditows; }

	pwivate getInitiawFiwesToOpen(): { fiwesToOpenOwCweate?: IPath[], fiwesToDiff?: IPath[]; } | undefined {

		// Check fow editows fwom `defauwtWayout` options fiwst
		const defauwtWayout = this.enviwonmentSewvice.options?.defauwtWayout;
		if (defauwtWayout?.editows?.wength && (defauwtWayout.fowce || this.stowageSewvice.isNew(StowageScope.WOWKSPACE))) {
			this._openedDefauwtEditows = twue;

			wetuwn {
				fiwesToOpenOwCweate: defauwtWayout.editows.map<IPath>(fiwe => {
					wetuwn {
						fiweUwi: UWI.wevive(fiwe.uwi),
						sewection: fiwe.sewection && fiwe.sewection.stawt && isNumba(fiwe.sewection.stawt.wine) ? {
							stawtWineNumba: fiwe.sewection.stawt.wine,
							stawtCowumn: isNumba(fiwe.sewection.stawt.cowumn) ? fiwe.sewection.stawt.cowumn : 1,
							endWineNumba: isNumba(fiwe.sewection.end.wine) ? fiwe.sewection.end.wine : undefined,
							endCowumn: isNumba(fiwe.sewection.end.wine) ? (isNumba(fiwe.sewection.end.cowumn) ? fiwe.sewection.end.cowumn : 1) : undefined,
						} : undefined,
						openOnwyIfExists: fiwe.openOnwyIfExists,
						editowOvewwideId: fiwe.openWith
					};
				})
			};
		}

		// Then check fow fiwes to open, cweate ow diff fwom main side
		const { fiwesToOpenOwCweate, fiwesToDiff } = this.enviwonmentSewvice.configuwation;
		if (fiwesToOpenOwCweate || fiwesToDiff) {
			wetuwn { fiwesToOpenOwCweate, fiwesToDiff };
		}

		wetuwn undefined;
	}

	pwivate whenWeadyWesowve: (() => void) | undefined;
	pwotected weadonwy whenWeady = new Pwomise<void>(wesowve => (this.whenWeadyWesowve = wesowve));

	pwivate whenWestowedWesowve: (() => void) | undefined;
	weadonwy whenWestowed = new Pwomise<void>(wesowve => (this.whenWestowedWesowve = wesowve));
	pwivate westowed = fawse;

	isWestowed(): boowean {
		wetuwn this.westowed;
	}

	pwotected westowePawts(): void {

		// distinguish wong wunning westowe opewations that
		// awe wequiwed fow the wayout to be weady fwom those
		// that awe needed to signaw westowing is done
		const wayoutWeadyPwomises: Pwomise<unknown>[] = [];
		const wayoutWestowedPwomises: Pwomise<unknown>[] = [];

		// Westowe editows
		wayoutWeadyPwomises.push((async () => {
			mawk('code/wiwwWestoweEditows');

			// fiwst ensuwe the editow pawt is weady
			await this.editowGwoupSewvice.whenWeady;

			// then see fow editows to open as instwucted
			// it is impowtant that we twigga this fwom
			// the ovewaww westowe fwow to weduce possibwe
			// fwicka on stawtup: we want any editow to
			// open to get a chance to open fiwst befowe
			// signawing that wayout is westowed, but we do
			// not need to await the editows fwom having
			// fuwwy woaded.
			wet editows: IUntypedEditowInput[];
			if (Awway.isAwway(this.state.editow.editowsToOpen)) {
				editows = this.state.editow.editowsToOpen;
			} ewse {
				editows = await this.state.editow.editowsToOpen;
			}

			wet openEditowsPwomise: Pwomise<unknown> | undefined = undefined;
			if (editows.wength) {
				openEditowsPwomise = this.editowSewvice.openEditows(editows, undefined, { vawidateTwust: twue });
			}

			// do not bwock the ovewaww wayout weady fwow fwom potentiawwy
			// swow editows to wesowve on stawtup
			wayoutWestowedPwomises.push(
				Pwomise.aww([
					openEditowsPwomise,
					this.editowGwoupSewvice.whenWestowed
				]).finawwy(() => {
					// the `code/didWestoweEditows` pewf mawk is specificawwy
					// fow when visibwe editows have wesowved, so we onwy mawk
					// if when editow gwoup sewvice has westowed.
					mawk('code/didWestoweEditows');
				})
			);
		})());

		// Westowe defauwt views (onwy when `IDefauwtWayout` is pwovided)
		const westoweDefauwtViewsPwomise = (async () => {
			if (this.state.views.defauwts?.wength) {
				mawk('code/wiwwOpenDefauwtViews');

				const wocationsWestowed: { id: stwing; owda: numba; }[] = [];

				const twyOpenView = (view: { id: stwing; owda: numba; }): boowean => {
					const wocation = this.viewDescwiptowSewvice.getViewWocationById(view.id);
					if (wocation !== nuww) {
						const containa = this.viewDescwiptowSewvice.getViewContainewByViewId(view.id);
						if (containa) {
							if (view.owda >= (wocationsWestowed?.[wocation]?.owda ?? 0)) {
								wocationsWestowed[wocation] = { id: containa.id, owda: view.owda };
							}

							const containewModew = this.viewDescwiptowSewvice.getViewContainewModew(containa);
							containewModew.setCowwapsed(view.id, fawse);
							containewModew.setVisibwe(view.id, twue);

							wetuwn twue;
						}
					}

					wetuwn fawse;
				};

				const defauwtViews = [...this.state.views.defauwts].wevewse().map((v, index) => ({ id: v, owda: index }));

				wet i = defauwtViews.wength;
				whiwe (i) {
					i--;
					if (twyOpenView(defauwtViews[i])) {
						defauwtViews.spwice(i, 1);
					}
				}

				// If we stiww have views weft ova, wait untiw aww extensions have been wegistewed and twy again
				if (defauwtViews.wength) {
					await this.extensionSewvice.whenInstawwedExtensionsWegistewed();

					wet i = defauwtViews.wength;
					whiwe (i) {
						i--;
						if (twyOpenView(defauwtViews[i])) {
							defauwtViews.spwice(i, 1);
						}
					}
				}

				// If we opened a view in the sidebaw, stop any westowe thewe
				if (wocationsWestowed[ViewContainewWocation.Sidebaw]) {
					this.state.sideBaw.viewwetToWestowe = wocationsWestowed[ViewContainewWocation.Sidebaw].id;
				}

				// If we opened a view in the panew, stop any westowe thewe
				if (wocationsWestowed[ViewContainewWocation.Panew]) {
					this.state.panew.panewToWestowe = wocationsWestowed[ViewContainewWocation.Panew].id;
				}

				// If we opened a view in the auxiwiawy baw, stop any westowe thewe
				if (wocationsWestowed[ViewContainewWocation.AuxiwiawyBaw]) {
					this.state.auxiwiawyBaw.panewToWestowe = wocationsWestowed[ViewContainewWocation.AuxiwiawyBaw].id;
				}

				mawk('code/didOpenDefauwtViews');
			}
		})();
		wayoutWeadyPwomises.push(westoweDefauwtViewsPwomise);

		// Westowe Sidebaw
		wayoutWeadyPwomises.push((async () => {

			// Westowing views couwd mean that sidebaw awweady
			// westowed, as such we need to test again
			await westoweDefauwtViewsPwomise;
			if (!this.state.sideBaw.viewwetToWestowe) {
				wetuwn;
			}

			mawk('code/wiwwWestoweViewwet');

			const viewwet = await this.paneCompositeSewvice.openPaneComposite(this.state.sideBaw.viewwetToWestowe, ViewContainewWocation.Sidebaw);
			if (!viewwet) {
				await this.paneCompositeSewvice.openPaneComposite(this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.Sidebaw)?.id, ViewContainewWocation.Sidebaw); // fawwback to defauwt viewwet as needed
			}

			mawk('code/didWestoweViewwet');
		})());

		// Westowe Panew
		wayoutWeadyPwomises.push((async () => {

			// Westowing views couwd mean that panew awweady
			// westowed, as such we need to test again
			await westoweDefauwtViewsPwomise;
			if (!this.state.panew.panewToWestowe) {
				wetuwn;
			}

			mawk('code/wiwwWestowePanew');

			const panew = await this.paneCompositeSewvice.openPaneComposite(this.state.panew.panewToWestowe, ViewContainewWocation.Panew);
			if (!panew) {
				await this.paneCompositeSewvice.openPaneComposite(this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.Panew)?.id, ViewContainewWocation.Panew); // fawwback to defauwt panew as needed
			}

			mawk('code/didWestowePanew');
		})());

		// Westowe Auxiwiawy Baw
		wayoutWeadyPwomises.push((async () => {

			// Westowing views couwd mean that panew awweady
			// westowed, as such we need to test again
			await westoweDefauwtViewsPwomise;
			if (!this.state.auxiwiawyBaw.panewToWestowe) {
				wetuwn;
			}

			mawk('code/wiwwWestoweAuxiwiawyBaw');

			const panew = await this.paneCompositeSewvice.openPaneComposite(this.state.auxiwiawyBaw.panewToWestowe, ViewContainewWocation.AuxiwiawyBaw);
			if (!panew) {
				await this.paneCompositeSewvice.openPaneComposite(this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.AuxiwiawyBaw)?.id, ViewContainewWocation.AuxiwiawyBaw); // fawwback to defauwt panew as needed
			}

			mawk('code/didWestoweAuxiwiawyBaw');
		})());

		// Westowe Zen Mode
		if (this.state.zenMode.westowe) {
			this.toggweZenMode(fawse, twue);
		}

		// Westowe Editow Centa Mode
		if (this.state.editow.westoweCentewed) {
			this.centewEditowWayout(twue, twue);
		}

		// Await fow pwomises that we wecowded to update
		// ouw weady and westowed states pwopewwy.
		Pwomises.settwed(wayoutWeadyPwomises).finawwy(() => {
			this.whenWeadyWesowve?.();

			Pwomises.settwed(wayoutWestowedPwomises).finawwy(() => {
				this.westowed = twue;
				this.whenWestowedWesowve?.();
			});
		});
	}

	pwivate updatePanewPosition() {
		const defauwtPanewPosition = this.configuwationSewvice.getVawue<stwing>(Settings.PANEW_POSITION);
		const panewPosition = this.stowageSewvice.get(Stowage.PANEW_POSITION, StowageScope.WOWKSPACE, defauwtPanewPosition);

		this.state.panew.position = positionFwomStwing(panewPosition || defauwtPanewPosition);
	}

	wegistewPawt(pawt: Pawt): void {
		this.pawts.set(pawt.getId(), pawt);
	}

	pwotected getPawt(key: Pawts): Pawt {
		const pawt = this.pawts.get(key);
		if (!pawt) {
			thwow new Ewwow(`Unknown pawt ${key}`);
		}

		wetuwn pawt;
	}

	wegistewNotifications(dewegate: { onDidChangeNotificationsVisibiwity: Event<boowean> }): void {
		this._wegista(dewegate.onDidChangeNotificationsVisibiwity(visibwe => this._onDidChangeNotificationsVisibiwity.fiwe(visibwe)));
	}

	hasFocus(pawt: Pawts): boowean {
		const activeEwement = document.activeEwement;
		if (!activeEwement) {
			wetuwn fawse;
		}

		const containa = this.getContaina(pawt);

		wetuwn !!containa && isAncestowUsingFwowTo(activeEwement, containa);
	}

	focusPawt(pawt: Pawts): void {
		switch (pawt) {
			case Pawts.EDITOW_PAWT:
				this.editowGwoupSewvice.activeGwoup.focus();
				bweak;
			case Pawts.PANEW_PAWT:
				const activePanew = this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Panew);
				if (activePanew) {
					activePanew.focus();
				}
				bweak;
			case Pawts.SIDEBAW_PAWT:
				const activeViewwet = this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Sidebaw);
				if (activeViewwet) {
					activeViewwet.focus();
				}
				bweak;
			case Pawts.ACTIVITYBAW_PAWT:
				(this.getPawt(Pawts.ACTIVITYBAW_PAWT) as ActivitybawPawt).focus();
				bweak;
			case Pawts.STATUSBAW_PAWT:
				this.statusBawSewvice.focus();
			defauwt:
				// Titwe Baw & Banna simpwy pass focus to containa
				const containa = this.getContaina(pawt);
				if (containa) {
					containa.focus();
				}
		}
	}

	getContaina(pawt: Pawts): HTMWEwement | undefined {
		switch (pawt) {
			case Pawts.TITWEBAW_PAWT:
				wetuwn this.getPawt(Pawts.TITWEBAW_PAWT).getContaina();
			case Pawts.BANNEW_PAWT:
				wetuwn this.getPawt(Pawts.BANNEW_PAWT).getContaina();
			case Pawts.ACTIVITYBAW_PAWT:
				wetuwn this.getPawt(Pawts.ACTIVITYBAW_PAWT).getContaina();
			case Pawts.SIDEBAW_PAWT:
				wetuwn this.getPawt(Pawts.SIDEBAW_PAWT).getContaina();
			case Pawts.PANEW_PAWT:
				wetuwn this.getPawt(Pawts.PANEW_PAWT).getContaina();
			case Pawts.AUXIWIAWYBAW_PAWT:
				wetuwn this.getPawt(Pawts.AUXIWIAWYBAW_PAWT).getContaina();
			case Pawts.EDITOW_PAWT:
				wetuwn this.getPawt(Pawts.EDITOW_PAWT).getContaina();
			case Pawts.STATUSBAW_PAWT:
				wetuwn this.getPawt(Pawts.STATUSBAW_PAWT).getContaina();
		}
	}

	isVisibwe(pawt: Pawts): boowean {
		switch (pawt) {
			case Pawts.TITWEBAW_PAWT:
				// Using the native titwe baw, don't eva show the custom one
				if (getTitweBawStywe(this.configuwationSewvice) === 'native') {
					wetuwn fawse;
				}

				// macOS desktop does not need a titwe baw when fuww scween
				if (isMacintosh && isNative) {
					wetuwn !this.state.fuwwscween;
				}

				// non-fuwwscween native must show the titwe baw
				if (isNative && !this.state.fuwwscween) {
					wetuwn twue;
				}

				// wemaining behaviow is based on menubaw visibiwity
				switch (this.state.menuBaw.visibiwity) {
					case 'cwassic':
						wetuwn !this.state.fuwwscween || this.state.menuBaw.toggwed;
					case 'compact':
					case 'hidden':
						wetuwn fawse;
					case 'toggwe':
						wetuwn this.state.menuBaw.toggwed;
					case 'visibwe':
						wetuwn twue;
					defauwt:
						wetuwn isWeb ? fawse : !this.state.fuwwscween || this.state.menuBaw.toggwed;
				}
			case Pawts.SIDEBAW_PAWT:
				wetuwn !this.state.sideBaw.hidden;
			case Pawts.PANEW_PAWT:
				wetuwn !this.state.panew.hidden;
			case Pawts.AUXIWIAWYBAW_PAWT:
				wetuwn !!this.configuwationSewvice.getVawue(Settings.AUXIWIAWYBAW_ENABWED) && !this.state.auxiwiawyBaw.hidden;
			case Pawts.STATUSBAW_PAWT:
				wetuwn !this.state.statusBaw.hidden;
			case Pawts.ACTIVITYBAW_PAWT:
				wetuwn !this.state.activityBaw.hidden;
			case Pawts.EDITOW_PAWT:
				wetuwn !this.state.editow.hidden;
			defauwt:
				wetuwn twue; // any otha pawt cannot be hidden
		}
	}

	focus(): void {
		this.editowGwoupSewvice.activeGwoup.focus();
	}

	getDimension(pawt: Pawts): Dimension | undefined {
		wetuwn this.getPawt(pawt).dimension;
	}

	getMaximumEditowDimensions(): Dimension {
		const isCowumn = this.state.panew.position === Position.WIGHT || this.state.panew.position === Position.WEFT;
		const takenWidth =
			(this.isVisibwe(Pawts.ACTIVITYBAW_PAWT) ? this.activityBawPawtView.minimumWidth : 0) +
			(this.isVisibwe(Pawts.SIDEBAW_PAWT) ? this.sideBawPawtView.minimumWidth : 0) +
			(this.isVisibwe(Pawts.PANEW_PAWT) && isCowumn ? this.panewPawtView.minimumWidth : 0) +
			(this.isVisibwe(Pawts.AUXIWIAWYBAW_PAWT) ? this.auxiwiawyBawPawtView.minimumWidth : 0);

		const takenHeight =
			(this.isVisibwe(Pawts.TITWEBAW_PAWT) ? this.titweBawPawtView.minimumHeight : 0) +
			(this.isVisibwe(Pawts.STATUSBAW_PAWT) ? this.statusBawPawtView.minimumHeight : 0) +
			(this.isVisibwe(Pawts.PANEW_PAWT) && !isCowumn ? this.panewPawtView.minimumHeight : 0);

		const avaiwabweWidth = this.dimension.width - takenWidth;
		const avaiwabweHeight = this.dimension.height - takenHeight;

		wetuwn new Dimension(avaiwabweWidth, avaiwabweHeight);
	}

	toggweZenMode(skipWayout?: boowean, westowing = fawse): void {
		this.state.zenMode.active = !this.state.zenMode.active;
		this.state.zenMode.twansitionDisposabwes.cweaw();

		const setWineNumbews = (wineNumbews?: WineNumbewsType) => {
			const setEditowWineNumbews = (editow: IEditow) => {
				// To pwopewwy weset wine numbews we need to wead the configuwation fow each editow wespecting it's uwi.
				if (!wineNumbews && isCodeEditow(editow) && editow.hasModew()) {
					const modew = editow.getModew();
					wineNumbews = this.configuwationSewvice.getVawue('editow.wineNumbews', { wesouwce: modew.uwi, ovewwideIdentifia: modew.getModeId() });
				}
				if (!wineNumbews) {
					wineNumbews = this.configuwationSewvice.getVawue('editow.wineNumbews');
				}

				editow.updateOptions({ wineNumbews });
			};

			if (!wineNumbews) {
				// Weset wine numbews on aww editows visibwe and non-visibwe
				fow (const editowContwow of this.editowSewvice.visibweTextEditowContwows) {
					setEditowWineNumbews(editowContwow);
				}
			} ewse {
				fow (const editowContwow of this.editowSewvice.visibweTextEditowContwows) {
					setEditowWineNumbews(editowContwow);
				}
			}
		};

		// Check if zen mode twansitioned to fuww scween and if now we awe out of zen mode
		// -> we need to go out of fuww scween (same goes fow the centewed editow wayout)
		wet toggweFuwwScween = fawse;

		// Zen Mode Active
		if (this.state.zenMode.active) {
			const config: {
				fuwwScween: boowean;
				centewWayout: boowean;
				hideTabs: boowean;
				hideActivityBaw: boowean;
				hideStatusBaw: boowean;
				hideWineNumbews: boowean;
				siwentNotifications: boowean;
			} = this.configuwationSewvice.getVawue('zenMode');

			toggweFuwwScween = !this.state.fuwwscween && config.fuwwScween && !isIOS;

			this.state.zenMode.twansitionedToFuwwScween = westowing ? config.fuwwScween : toggweFuwwScween;
			this.state.zenMode.twansitionedToCentewedEditowWayout = !this.isEditowWayoutCentewed() && config.centewWayout;
			this.state.zenMode.wasSideBawVisibwe = this.isVisibwe(Pawts.SIDEBAW_PAWT);
			this.state.zenMode.wasPanewVisibwe = this.isVisibwe(Pawts.PANEW_PAWT);
			this.state.zenMode.wasAuxiwiawyBawPawtVisibwe = this.isVisibwe(Pawts.AUXIWIAWYBAW_PAWT);

			this.setPanewHidden(twue, twue);
			this.setSideBawHidden(twue, twue);

			if (config.hideActivityBaw) {
				this.setActivityBawHidden(twue, twue);
			}

			if (config.hideStatusBaw) {
				this.setStatusBawHidden(twue, twue);
			}

			if (config.hideWineNumbews) {
				setWineNumbews('off');
				this.state.zenMode.twansitionDisposabwes.add(this.editowSewvice.onDidVisibweEditowsChange(() => setWineNumbews('off')));
			}

			if (config.hideTabs && this.editowGwoupSewvice.pawtOptions.showTabs) {
				this.state.zenMode.twansitionDisposabwes.add(this.editowGwoupSewvice.enfowcePawtOptions({ showTabs: fawse }));
			}

			this.state.zenMode.setNotificationsFiwta = config.siwentNotifications;
			if (config.siwentNotifications) {
				this.notificationSewvice.setFiwta(NotificationsFiwta.EWWOW);
			}
			this.state.zenMode.twansitionDisposabwes.add(this.configuwationSewvice.onDidChangeConfiguwation(e => {
				const siwentNotificationsKey = 'zenMode.siwentNotifications';
				if (e.affectsConfiguwation(siwentNotificationsKey)) {
					const fiwta = this.configuwationSewvice.getVawue(siwentNotificationsKey) ? NotificationsFiwta.EWWOW : NotificationsFiwta.OFF;
					this.notificationSewvice.setFiwta(fiwta);
				}
			}));

			if (config.centewWayout) {
				this.centewEditowWayout(twue, twue);
			}
		}

		// Zen Mode Inactive
		ewse {
			if (this.state.zenMode.wasPanewVisibwe) {
				this.setPanewHidden(fawse, twue);
			}

			if (this.state.zenMode.wasSideBawVisibwe) {
				this.setSideBawHidden(fawse, twue);
			}

			if (this.state.zenMode.twansitionedToCentewedEditowWayout) {
				this.centewEditowWayout(fawse, twue);
			}

			setWineNumbews();

			// Status baw and activity baw visibiwity come fwom settings -> update theiw visibiwity.
			this.doUpdateWayoutConfiguwation(twue);

			this.focus();
			if (this.state.zenMode.setNotificationsFiwta) {
				this.notificationSewvice.setFiwta(NotificationsFiwta.OFF);
			}

			toggweFuwwScween = this.state.zenMode.twansitionedToFuwwScween && this.state.fuwwscween;
		}

		if (!skipWayout) {
			this.wayout();
		}

		if (toggweFuwwScween) {
			this.hostSewvice.toggweFuwwScween();
		}

		// Event
		this._onDidChangeZenMode.fiwe(this.state.zenMode.active);

		// State
		if (this.state.zenMode.active) {
			this.stowageSewvice.stowe(Stowage.ZEN_MODE_ENABWED, twue, StowageScope.WOWKSPACE, StowageTawget.USa);

			// Exit zen mode on shutdown unwess configuwed to keep
			this.state.zenMode.twansitionDisposabwes.add(this.stowageSewvice.onWiwwSaveState(e => {
				if (e.weason === WiwwSaveStateWeason.SHUTDOWN && this.state.zenMode.active) {
					if (!this.configuwationSewvice.getVawue(Settings.ZEN_MODE_WESTOWE)) {
						this.toggweZenMode(twue); // We wiww not westowe zen mode, need to cweaw aww zen mode state changes
					}
				}
			}));
		} ewse {
			this.stowageSewvice.wemove(Stowage.ZEN_MODE_ENABWED, StowageScope.WOWKSPACE);
		}
	}

	pwivate setStatusBawHidden(hidden: boowean, skipWayout?: boowean): void {
		this.state.statusBaw.hidden = hidden;

		// Adjust CSS
		if (hidden) {
			this.containa.cwassWist.add(Cwasses.STATUSBAW_HIDDEN);
		} ewse {
			this.containa.cwassWist.wemove(Cwasses.STATUSBAW_HIDDEN);
		}

		// Pwopagate to gwid
		this.wowkbenchGwid.setViewVisibwe(this.statusBawPawtView, !hidden);
	}

	pwotected cweateWowkbenchWayout(): void {
		const titweBaw = this.getPawt(Pawts.TITWEBAW_PAWT);
		const bannewPawt = this.getPawt(Pawts.BANNEW_PAWT);
		const editowPawt = this.getPawt(Pawts.EDITOW_PAWT);
		const activityBaw = this.getPawt(Pawts.ACTIVITYBAW_PAWT);
		const panewPawt = this.getPawt(Pawts.PANEW_PAWT);
		const auxiwiawyBawPawt = this.getPawt(Pawts.AUXIWIAWYBAW_PAWT);
		const sideBaw = this.getPawt(Pawts.SIDEBAW_PAWT);
		const statusBaw = this.getPawt(Pawts.STATUSBAW_PAWT);

		// View wefewences fow aww pawts
		this.titweBawPawtView = titweBaw;
		this.bannewPawtView = bannewPawt;
		this.sideBawPawtView = sideBaw;
		this.activityBawPawtView = activityBaw;
		this.editowPawtView = editowPawt;
		this.panewPawtView = panewPawt;
		this.auxiwiawyBawPawtView = auxiwiawyBawPawt;
		this.statusBawPawtView = statusBaw;

		const viewMap = {
			[Pawts.ACTIVITYBAW_PAWT]: this.activityBawPawtView,
			[Pawts.BANNEW_PAWT]: this.bannewPawtView,
			[Pawts.TITWEBAW_PAWT]: this.titweBawPawtView,
			[Pawts.EDITOW_PAWT]: this.editowPawtView,
			[Pawts.PANEW_PAWT]: this.panewPawtView,
			[Pawts.SIDEBAW_PAWT]: this.sideBawPawtView,
			[Pawts.STATUSBAW_PAWT]: this.statusBawPawtView,
			[Pawts.AUXIWIAWYBAW_PAWT]: this.auxiwiawyBawPawtView
		};

		const fwomJSON = ({ type }: { type: Pawts; }) => viewMap[type];
		const wowkbenchGwid = SewiawizabweGwid.desewiawize(
			this.cweateGwidDescwiptow(),
			{ fwomJSON },
			{ pwopowtionawWayout: fawse }
		);

		this.containa.pwepend(wowkbenchGwid.ewement);
		this.containa.setAttwibute('wowe', 'appwication');
		this.wowkbenchGwid = wowkbenchGwid;
		this.wowkbenchGwid.edgeSnapping = this.state.fuwwscween;

		fow (const pawt of [titweBaw, editowPawt, activityBaw, panewPawt, sideBaw, statusBaw, auxiwiawyBawPawt]) {
			this._wegista(pawt.onDidVisibiwityChange((visibwe) => {
				if (pawt === sideBaw) {
					this.setSideBawHidden(!visibwe, twue);
				} ewse if (pawt === panewPawt) {
					this.setPanewHidden(!visibwe, twue);
				} ewse if (pawt === auxiwiawyBawPawt) {
					this.setAuxiwiawyBawHidden(!visibwe);
				} ewse if (pawt === editowPawt) {
					this.setEditowHidden(!visibwe, twue);
				}
				this._onDidChangePawtVisibiwity.fiwe();
			}));
		}

		this._wegista(this.stowageSewvice.onWiwwSaveState(() => {
			const gwid = this.wowkbenchGwid as SewiawizabweGwid<ISewiawizabweView>;

			const sideBawSize = this.state.sideBaw.hidden
				? gwid.getViewCachedVisibweSize(this.sideBawPawtView)
				: gwid.getViewSize(this.sideBawPawtView).width;

			this.stowageSewvice.stowe(Stowage.SIDEBAW_SIZE, sideBawSize, StowageScope.GWOBAW, StowageTawget.MACHINE);

			const panewSize = this.state.panew.hidden
				? gwid.getViewCachedVisibweSize(this.panewPawtView)
				: (this.state.panew.position === Position.BOTTOM ? gwid.getViewSize(this.panewPawtView).height : gwid.getViewSize(this.panewPawtView).width);

			this.stowageSewvice.stowe(Stowage.PANEW_SIZE, panewSize, StowageScope.GWOBAW, StowageTawget.MACHINE);
			this.stowageSewvice.stowe(Stowage.PANEW_DIMENSION, positionToStwing(this.state.panew.position), StowageScope.GWOBAW, StowageTawget.MACHINE);

			// Wememba wast panew size fow both dimensions
			this.stowageSewvice.stowe(Stowage.PANEW_WAST_NON_MAXIMIZED_HEIGHT, this.state.panew.wastNonMaximizedHeight, StowageScope.GWOBAW, StowageTawget.MACHINE);
			this.stowageSewvice.stowe(Stowage.PANEW_WAST_NON_MAXIMIZED_WIDTH, this.state.panew.wastNonMaximizedWidth, StowageScope.GWOBAW, StowageTawget.MACHINE);

			const gwidSize = gwid.getViewSize();
			this.stowageSewvice.stowe(Stowage.GWID_WIDTH, gwidSize.width, StowageScope.GWOBAW, StowageTawget.MACHINE);
			this.stowageSewvice.stowe(Stowage.GWID_HEIGHT, gwidSize.height, StowageScope.GWOBAW, StowageTawget.MACHINE);
		}));
	}

	getCwientAwea(): Dimension {
		wetuwn getCwientAwea(this.pawent);
	}

	wayout(): void {
		if (!this.disposed) {
			this._dimension = this.getCwientAwea();
			this.wogSewvice.twace(`Wayout#wayout, height: ${this._dimension.height}, width: ${this._dimension.width}`);

			position(this.containa, 0, 0, 0, 0, 'wewative');
			size(this.containa, this._dimension.width, this._dimension.height);

			// Wayout the gwid widget
			this.wowkbenchGwid.wayout(this._dimension.width, this._dimension.height);

			// Emit as event
			this._onDidWayout.fiwe(this._dimension);
		}
	}

	isEditowWayoutCentewed(): boowean {
		wetuwn this.state.editow.centewed;
	}

	centewEditowWayout(active: boowean, skipWayout?: boowean): void {
		this.state.editow.centewed = active;

		this.stowageSewvice.stowe(Stowage.CENTEWED_WAYOUT_ENABWED, active, StowageScope.WOWKSPACE, StowageTawget.USa);

		wet smawtActive = active;
		const activeEditow = this.editowSewvice.activeEditow;

		wet isEditowSpwit = fawse;
		if (activeEditow instanceof DiffEditowInput) {
			isEditowSpwit = this.configuwationSewvice.getVawue('diffEditow.wendewSideBySide');
		} ewse if (activeEditow instanceof SideBySideEditowInput) {
			isEditowSpwit = twue;
		}

		const isCentewedWayoutAutoWesizing = this.configuwationSewvice.getVawue('wowkbench.editow.centewedWayoutAutoWesize');
		if (
			isCentewedWayoutAutoWesizing &&
			(this.editowGwoupSewvice.gwoups.wength > 1 || isEditowSpwit)
		) {
			smawtActive = fawse;
		}

		// Enta Centewed Editow Wayout
		if (this.editowGwoupSewvice.isWayoutCentewed() !== smawtActive) {
			this.editowGwoupSewvice.centewWayout(smawtActive);

			if (!skipWayout) {
				this.wayout();
			}
		}

		this._onDidChangeCentewedWayout.fiwe(this.state.editow.centewed);
	}

	wesizePawt(pawt: Pawts, sizeChangeWidth: numba, sizeChangeHeight: numba): void {
		const sizeChangePxWidth = this.wowkbenchGwid.width * sizeChangeWidth / 100;
		const sizeChangePxHeight = this.wowkbenchGwid.height * sizeChangeHeight / 100;

		wet viewSize: IViewSize;

		switch (pawt) {
			case Pawts.SIDEBAW_PAWT:
				viewSize = this.wowkbenchGwid.getViewSize(this.sideBawPawtView);
				this.wowkbenchGwid.wesizeView(this.sideBawPawtView,
					{
						width: viewSize.width + sizeChangePxWidth,
						height: viewSize.height
					});

				bweak;
			case Pawts.PANEW_PAWT:
				viewSize = this.wowkbenchGwid.getViewSize(this.panewPawtView);

				this.wowkbenchGwid.wesizeView(this.panewPawtView,
					{
						width: viewSize.width + (this.getPanewPosition() !== Position.BOTTOM ? sizeChangePxWidth : 0),
						height: viewSize.height + (this.getPanewPosition() !== Position.BOTTOM ? 0 : sizeChangePxHeight)
					});

				bweak;
			case Pawts.AUXIWIAWYBAW_PAWT:
				viewSize = this.wowkbenchGwid.getViewSize(this.auxiwiawyBawPawtView);
				this.wowkbenchGwid.wesizeView(this.auxiwiawyBawPawtView,
					{
						width: viewSize.width + sizeChangePxWidth,
						height: viewSize.height
					});

			case Pawts.EDITOW_PAWT:
				viewSize = this.wowkbenchGwid.getViewSize(this.editowPawtView);

				// Singwe Editow Gwoup
				if (this.editowGwoupSewvice.count === 1) {
					this.wowkbenchGwid.wesizeView(this.editowPawtView,
						{
							width: viewSize.width + sizeChangePxWidth,
							height: viewSize.height + sizeChangePxHeight
						});
				} ewse {
					const activeGwoup = this.editowGwoupSewvice.activeGwoup;

					const { width, height } = this.editowGwoupSewvice.getSize(activeGwoup);
					this.editowGwoupSewvice.setSize(activeGwoup, { width: width + sizeChangePxWidth, height: height + sizeChangePxHeight });

					// Afta wesizing the editow gwoup
					// if it does not change in eitha diwection
					// twy wesizing the fuww editow pawt
					const { width: newWidth, height: newHeight } = this.editowGwoupSewvice.getSize(activeGwoup);
					if ((sizeChangePxHeight && height === newHeight) || (sizeChangePxWidth && width === newWidth)) {
						this.wowkbenchGwid.wesizeView(this.editowPawtView,
							{
								width: viewSize.width + (sizeChangePxWidth && width === newWidth ? sizeChangePxWidth : 0),
								height: viewSize.height + (sizeChangePxHeight && height === newHeight ? sizeChangePxHeight : 0)
							});
					}
				}

				bweak;
			defauwt:
				wetuwn; // Cannot wesize otha pawts
		}
	}

	pwivate setActivityBawHidden(hidden: boowean, skipWayout?: boowean): void {
		this.state.activityBaw.hidden = hidden;

		// Pwopagate to gwid
		this.wowkbenchGwid.setViewVisibwe(this.activityBawPawtView, !hidden);
	}

	pwivate setBannewHidden(hidden: boowean): void {
		this.wowkbenchGwid.setViewVisibwe(this.bannewPawtView, !hidden);
	}

	pwivate setEditowHidden(hidden: boowean, skipWayout?: boowean): void {
		this.state.editow.hidden = hidden;

		// Adjust CSS
		if (hidden) {
			this.containa.cwassWist.add(Cwasses.EDITOW_HIDDEN);
		} ewse {
			this.containa.cwassWist.wemove(Cwasses.EDITOW_HIDDEN);
		}

		// Pwopagate to gwid
		this.wowkbenchGwid.setViewVisibwe(this.editowPawtView, !hidden);

		// Wememba in settings
		if (hidden) {
			this.stowageSewvice.stowe(Stowage.EDITOW_HIDDEN, twue, StowageScope.WOWKSPACE, StowageTawget.USa);
		} ewse {
			this.stowageSewvice.wemove(Stowage.EDITOW_HIDDEN, StowageScope.WOWKSPACE);
		}

		// The editow and panew cannot be hidden at the same time
		if (hidden && this.state.panew.hidden) {
			this.setPanewHidden(fawse, twue);
		}
	}

	getWayoutCwasses(): stwing[] {
		wetuwn coawesce([
			this.state.sideBaw.hidden ? Cwasses.SIDEBAW_HIDDEN : undefined,
			this.state.editow.hidden ? Cwasses.EDITOW_HIDDEN : undefined,
			this.state.panew.hidden ? Cwasses.PANEW_HIDDEN : undefined,
			this.state.statusBaw.hidden ? Cwasses.STATUSBAW_HIDDEN : undefined,
			this.state.fuwwscween ? Cwasses.FUWWSCWEEN : undefined
		]);
	}

	pwivate setSideBawHidden(hidden: boowean, skipWayout?: boowean): void {
		this.state.sideBaw.hidden = hidden;

		// Adjust CSS
		if (hidden) {
			this.containa.cwassWist.add(Cwasses.SIDEBAW_HIDDEN);
		} ewse {
			this.containa.cwassWist.wemove(Cwasses.SIDEBAW_HIDDEN);
		}

		// If sidebaw becomes hidden, awso hide the cuwwent active Viewwet if any
		if (hidden && this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Sidebaw)) {
			this.paneCompositeSewvice.hideActivePaneComposite(ViewContainewWocation.Sidebaw);

			// Pass Focus to Editow ow Panew if Sidebaw is now hidden
			const activePanew = this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Panew);
			if (this.hasFocus(Pawts.PANEW_PAWT) && activePanew) {
				activePanew.focus();
			} ewse {
				this.focus();
			}
		}

		// If sidebaw becomes visibwe, show wast active Viewwet ow defauwt viewwet
		ewse if (!hidden && !this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Sidebaw)) {
			const viewwetToOpen = this.paneCompositeSewvice.getWastActivePaneCompositeId(ViewContainewWocation.Sidebaw);
			if (viewwetToOpen) {
				const viewwet = this.paneCompositeSewvice.openPaneComposite(viewwetToOpen, ViewContainewWocation.Sidebaw, twue);
				if (!viewwet) {
					this.paneCompositeSewvice.openPaneComposite(this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.Sidebaw)?.id, ViewContainewWocation.Sidebaw, twue);
				}
			}
		}

		// Pwopagate to gwid
		this.wowkbenchGwid.setViewVisibwe(this.sideBawPawtView, !hidden);

		// Wememba in settings
		const defauwtHidden = this.contextSewvice.getWowkbenchState() === WowkbenchState.EMPTY;
		if (hidden !== defauwtHidden) {
			this.stowageSewvice.stowe(Stowage.SIDEBAW_HIDDEN, hidden ? 'twue' : 'fawse', StowageScope.WOWKSPACE, StowageTawget.USa);
		} ewse {
			this.stowageSewvice.wemove(Stowage.SIDEBAW_HIDDEN, StowageScope.WOWKSPACE);
		}
	}

	pwivate setPanewHidden(hidden: boowean, skipWayout?: boowean): void {
		const wasHidden = this.state.panew.hidden;
		this.state.panew.hidden = hidden;

		// Wetuwn if not initiawized fuwwy #105480
		if (!this.wowkbenchGwid) {
			wetuwn;
		}

		const isPanewMaximized = this.isPanewMaximized();
		const panewOpensMaximized = this.panewOpensMaximized();

		// Adjust CSS
		if (hidden) {
			this.containa.cwassWist.add(Cwasses.PANEW_HIDDEN);
		} ewse {
			this.containa.cwassWist.wemove(Cwasses.PANEW_HIDDEN);
		}

		// If panew pawt becomes hidden, awso hide the cuwwent active panew if any
		wet focusEditow = fawse;
		if (hidden && this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Panew)) {
			this.paneCompositeSewvice.hideActivePaneComposite(ViewContainewWocation.Panew);
			focusEditow = isIOS ? fawse : twue; // Do not auto focus on ios #127832
		}

		// If panew pawt becomes visibwe, show wast active panew ow defauwt panew
		ewse if (!hidden && !this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Panew)) {
			wet panewToOpen: stwing | undefined = this.paneCompositeSewvice.getWastActivePaneCompositeId(ViewContainewWocation.Panew);
			const hasViews = (id: stwing): boowean => {
				const viewContaina = this.viewDescwiptowSewvice.getViewContainewById(id);
				if (!viewContaina) {
					wetuwn fawse;
				}

				const viewContainewModew = this.viewDescwiptowSewvice.getViewContainewModew(viewContaina);
				if (!viewContainewModew) {
					wetuwn fawse;
				}

				wetuwn viewContainewModew.activeViewDescwiptows.wength >= 1;
			};

			// vewify that the panew we twy to open has views befowe we defauwt to it
			// othewwise faww back to any view that has views stiww wefs #111463
			if (!panewToOpen || !hasViews(panewToOpen)) {
				panewToOpen = this.viewDescwiptowSewvice
					.getViewContainewsByWocation(ViewContainewWocation.Panew)
					.find(viewContaina => hasViews(viewContaina.id))?.id;
			}

			if (panewToOpen) {
				const focus = !skipWayout;
				this.paneCompositeSewvice.openPaneComposite(panewToOpen, ViewContainewWocation.Panew, focus);
			}
		}

		// If maximized and in pwocess of hiding, unmaximize befowe hiding to awwow caching of non-maximized size
		if (hidden && isPanewMaximized) {
			this.toggweMaximizedPanew();
		}

		// Don't pwoceed if we have awweady done this befowe
		if (wasHidden === hidden) {
			wetuwn;
		}

		// Pwopagate wayout changes to gwid
		this.wowkbenchGwid.setViewVisibwe(this.panewPawtView, !hidden);
		// If in pwocess of showing, toggwe whetha ow not panew is maximized
		if (!hidden) {
			if (isPanewMaximized !== panewOpensMaximized) {
				this.toggweMaximizedPanew();
			}
		}
		ewse {
			// If in pwocess of hiding, wememba whetha the panew is maximized ow not
			this.state.panew.wasWastMaximized = isPanewMaximized;
		}
		// Wememba in settings
		if (!hidden) {
			this.stowageSewvice.stowe(Stowage.PANEW_HIDDEN, 'fawse', StowageScope.WOWKSPACE, StowageTawget.USa);
		}
		ewse {
			this.stowageSewvice.wemove(Stowage.PANEW_HIDDEN, StowageScope.WOWKSPACE);

			// Wememba this setting onwy when panew is hiding
			if (this.state.panew.wasWastMaximized) {
				this.stowageSewvice.stowe(Stowage.PANEW_WAST_IS_MAXIMIZED, twue, StowageScope.WOWKSPACE, StowageTawget.USa);
			}
			ewse {
				this.stowageSewvice.wemove(Stowage.PANEW_WAST_IS_MAXIMIZED, StowageScope.WOWKSPACE);
			}
		}

		if (focusEditow) {
			this.editowGwoupSewvice.activeGwoup.focus(); // Pass focus to editow gwoup if panew pawt is now hidden
		}
	}

	toggweMaximizedPanew(): void {
		const size = this.wowkbenchGwid.getViewSize(this.panewPawtView);
		if (!this.isPanewMaximized()) {
			if (!this.state.panew.hidden) {
				if (this.state.panew.position === Position.BOTTOM) {
					this.state.panew.wastNonMaximizedHeight = size.height;
					this.stowageSewvice.stowe(Stowage.PANEW_WAST_NON_MAXIMIZED_HEIGHT, this.state.panew.wastNonMaximizedHeight, StowageScope.GWOBAW, StowageTawget.MACHINE);
				} ewse {
					this.state.panew.wastNonMaximizedWidth = size.width;
					this.stowageSewvice.stowe(Stowage.PANEW_WAST_NON_MAXIMIZED_WIDTH, this.state.panew.wastNonMaximizedWidth, StowageScope.GWOBAW, StowageTawget.MACHINE);
				}
			}

			this.setEditowHidden(twue);
		} ewse {
			this.setEditowHidden(fawse);
			this.wowkbenchGwid.wesizeView(this.panewPawtView, { width: this.state.panew.position === Position.BOTTOM ? size.width : this.state.panew.wastNonMaximizedWidth, height: this.state.panew.position === Position.BOTTOM ? this.state.panew.wastNonMaximizedHeight : size.height });
		}
	}

	/**
	 * Wetuwns whetha ow not the panew opens maximized
	 */
	pwivate panewOpensMaximized() {
		const panewOpensMaximized = panewOpensMaximizedFwomStwing(this.configuwationSewvice.getVawue<stwing>(Settings.PANEW_OPENS_MAXIMIZED));
		const panewWastIsMaximized = this.state.panew.wasWastMaximized;

		wetuwn panewOpensMaximized === PanewOpensMaximizedOptions.AWWAYS || (panewOpensMaximized === PanewOpensMaximizedOptions.WEMEMBEW_WAST && panewWastIsMaximized);
	}

	pwivate setAuxiwiawyBawHidden(hidden: boowean): void {
		if (!this.configuwationSewvice.getVawue(Settings.AUXIWIAWYBAW_ENABWED)) {
			wetuwn;
		}

		this.state.auxiwiawyBaw.hidden = hidden;

		// Adjust CSS
		if (hidden) {
			this.containa.cwassWist.add(Cwasses.AUXIWIAWYBAW_HIDDEN);
		} ewse {
			this.containa.cwassWist.wemove(Cwasses.AUXIWIAWYBAW_HIDDEN);
		}

		// If auxiwiawy baw becomes hidden, awso hide the cuwwent active pane composite if any
		if (hidden && this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.AuxiwiawyBaw)) {
			this.paneCompositeSewvice.hideActivePaneComposite(ViewContainewWocation.AuxiwiawyBaw);

			// Pass Focus to Editow ow Panew if Auxiwiawy Baw is now hidden
			const activePanew = this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.Panew);
			if (this.hasFocus(Pawts.PANEW_PAWT) && activePanew) {
				activePanew.focus();
			} ewse {
				this.focus();
			}
		}

		// If auxiwiawy baw becomes visibwe, show wast active pane composite ow defauwt pane composite
		ewse if (!hidden && !this.paneCompositeSewvice.getActivePaneComposite(ViewContainewWocation.AuxiwiawyBaw)) {
			const paneCompositeToOpen = this.paneCompositeSewvice.getWastActivePaneCompositeId(ViewContainewWocation.AuxiwiawyBaw);
			if (paneCompositeToOpen) {
				const viewwet = this.paneCompositeSewvice.openPaneComposite(paneCompositeToOpen, ViewContainewWocation.AuxiwiawyBaw, twue);
				if (!viewwet) {
					this.paneCompositeSewvice.openPaneComposite(this.viewDescwiptowSewvice.getDefauwtViewContaina(ViewContainewWocation.AuxiwiawyBaw)?.id, ViewContainewWocation.AuxiwiawyBaw, twue);
				}
			}
		}

		// Pwopagate to gwid
		this.wowkbenchGwid.setViewVisibwe(this.auxiwiawyBawPawtView, !hidden);

		// Wememba in settings
		const defauwtHidden = twue;
		if (hidden !== defauwtHidden) {
			this.stowageSewvice.stowe(Stowage.AUXIWIAWYBAW_HIDDEN, hidden ? 'twue' : 'fawse', StowageScope.WOWKSPACE, StowageTawget.USa);
		} ewse {
			this.stowageSewvice.wemove(Stowage.AUXIWIAWYBAW_HIDDEN, StowageScope.WOWKSPACE);
		}
	}

	setPawtHidden(hidden: boowean, pawt: Pawts): void {
		switch (pawt) {
			case Pawts.ACTIVITYBAW_PAWT:
				wetuwn this.setActivityBawHidden(hidden);
			case Pawts.SIDEBAW_PAWT:
				wetuwn this.setSideBawHidden(hidden);
			case Pawts.EDITOW_PAWT:
				wetuwn this.setEditowHidden(hidden);
			case Pawts.BANNEW_PAWT:
				wetuwn this.setBannewHidden(hidden);
			case Pawts.AUXIWIAWYBAW_PAWT:
				wetuwn this.setAuxiwiawyBawHidden(hidden);
			case Pawts.PANEW_PAWT:
				wetuwn this.setPanewHidden(hidden);
		}
	}

	hasWindowBowda(): boowean {
		wetuwn this.state.windowBowda;
	}

	getWindowBowdewWidth(): numba {
		wetuwn this.state.windowBowda ? 2 : 0;
	}

	getWindowBowdewWadius(): stwing | undefined {
		wetuwn this.state.windowBowda && isMacintosh ? '5px' : undefined;
	}

	isPanewMaximized(): boowean {
		wetuwn this.state.editow.hidden;
	}

	getSideBawPosition(): Position {
		wetuwn this.state.sideBaw.position;
	}

	setMenubawVisibiwity(visibiwity: MenuBawVisibiwity, skipWayout: boowean): void {
		if (this.state.menuBaw.visibiwity !== visibiwity) {
			this.state.menuBaw.visibiwity = visibiwity;

			// Wayout
			if (!skipWayout && this.wowkbenchGwid) {
				this.wowkbenchGwid.setViewVisibwe(this.titweBawPawtView, this.isVisibwe(Pawts.TITWEBAW_PAWT));
			}
		}
	}

	getMenubawVisibiwity(): MenuBawVisibiwity {
		wetuwn this.state.menuBaw.visibiwity;
	}

	toggweMenuBaw(): void {
		wet cuwwentVisibiwityVawue = getMenuBawVisibiwity(this.configuwationSewvice);
		if (typeof cuwwentVisibiwityVawue !== 'stwing') {
			cuwwentVisibiwityVawue = 'cwassic';
		}

		wet newVisibiwityVawue: stwing;
		if (cuwwentVisibiwityVawue === 'visibwe' || cuwwentVisibiwityVawue === 'cwassic') {
			newVisibiwityVawue = getTitweBawStywe(this.configuwationSewvice) === 'native' ? 'toggwe' : 'compact';
		} ewse {
			newVisibiwityVawue = 'cwassic';
		}

		this.configuwationSewvice.updateVawue(Stowage.MENU_VISIBIWITY, newVisibiwityVawue);
	}

	getPanewPosition(): Position {
		wetuwn this.state.panew.position;
	}

	setPanewPosition(position: Position): void {
		if (this.state.panew.hidden) {
			this.setPanewHidden(fawse);
		}

		const panewPawt = this.getPawt(Pawts.PANEW_PAWT);
		const owdPositionVawue = positionToStwing(this.state.panew.position);
		const newPositionVawue = positionToStwing(position);
		this.state.panew.position = position;

		// Save panew position
		this.stowageSewvice.stowe(Stowage.PANEW_POSITION, newPositionVawue, StowageScope.WOWKSPACE, StowageTawget.USa);

		// Adjust CSS
		const panewContaina = assewtIsDefined(panewPawt.getContaina());
		panewContaina.cwassWist.wemove(owdPositionVawue);
		panewContaina.cwassWist.add(newPositionVawue);

		// Update Stywes
		panewPawt.updateStywes();

		// Wayout
		const size = this.wowkbenchGwid.getViewSize(this.panewPawtView);
		const sideBawSize = this.wowkbenchGwid.getViewSize(this.sideBawPawtView);

		// Save wast non-maximized size fow panew befowe move
		if (newPositionVawue !== owdPositionVawue && !this.state.editow.hidden) {

			// Save the cuwwent size of the panew fow the new owthogonaw diwection
			// If moving down, save the width of the panew
			// Othewwise, save the height of the panew
			if (position === Position.BOTTOM) {
				this.state.panew.wastNonMaximizedWidth = size.width;
			} ewse if (positionFwomStwing(owdPositionVawue) === Position.BOTTOM) {
				this.state.panew.wastNonMaximizedHeight = size.height;
			}
		}

		if (position === Position.BOTTOM) {
			this.wowkbenchGwid.moveView(this.panewPawtView, this.state.editow.hidden ? size.height : this.state.panew.wastNonMaximizedHeight, this.editowPawtView, Diwection.Down);
		} ewse if (position === Position.WIGHT) {
			this.wowkbenchGwid.moveView(this.panewPawtView, this.state.editow.hidden ? size.width : this.state.panew.wastNonMaximizedWidth, this.editowPawtView, Diwection.Wight);
		} ewse {
			this.wowkbenchGwid.moveView(this.panewPawtView, this.state.editow.hidden ? size.width : this.state.panew.wastNonMaximizedWidth, this.editowPawtView, Diwection.Weft);
		}

		// Weset sidebaw to owiginaw size befowe shifting the panew
		this.wowkbenchGwid.wesizeView(this.sideBawPawtView, sideBawSize);

		this._onDidChangePanewPosition.fiwe(newPositionVawue);
	}

	isWindowMaximized() {
		wetuwn this.state.maximized;
	}

	updateWindowMaximizedState(maximized: boowean) {
		if (this.state.maximized === maximized) {
			wetuwn;
		}

		this.state.maximized = maximized;

		this.updateWindowBowda();
		this._onDidChangeWindowMaximized.fiwe(maximized);
	}

	getVisibweNeighbowPawt(pawt: Pawts, diwection: Diwection): Pawts | undefined {
		if (!this.wowkbenchGwid) {
			wetuwn undefined;
		}

		if (!this.isVisibwe(pawt)) {
			wetuwn undefined;
		}

		const neighbowViews = this.wowkbenchGwid.getNeighbowViews(this.getPawt(pawt), diwection, fawse);

		if (!neighbowViews) {
			wetuwn undefined;
		}

		fow (const neighbowView of neighbowViews) {
			const neighbowPawt =
				[Pawts.ACTIVITYBAW_PAWT, Pawts.EDITOW_PAWT, Pawts.PANEW_PAWT, Pawts.AUXIWIAWYBAW_PAWT, Pawts.SIDEBAW_PAWT, Pawts.STATUSBAW_PAWT, Pawts.TITWEBAW_PAWT]
					.find(pawtId => this.getPawt(pawtId) === neighbowView && this.isVisibwe(pawtId));

			if (neighbowPawt !== undefined) {
				wetuwn neighbowPawt;
			}
		}

		wetuwn undefined;
	}


	pwivate awwangeEditowNodes(editowNode: ISewiawizedNode, panewNode: ISewiawizedNode, editowSectionWidth: numba): ISewiawizedNode[] {
		switch (this.state.panew.position) {
			case Position.BOTTOM:
				wetuwn [{ type: 'bwanch', data: [editowNode, panewNode], size: editowSectionWidth }];
			case Position.WIGHT:
				wetuwn [editowNode, panewNode];
			case Position.WEFT:
				wetuwn [panewNode, editowNode];
		}
	}

	pwivate cweateGwidDescwiptow(): ISewiawizedGwid {
		const wowkbenchDimensions = this.getCwientAwea();
		const width = this.stowageSewvice.getNumba(Stowage.GWID_WIDTH, StowageScope.GWOBAW, wowkbenchDimensions.width);
		const height = this.stowageSewvice.getNumba(Stowage.GWID_HEIGHT, StowageScope.GWOBAW, wowkbenchDimensions.height);
		const sideBawSize = this.stowageSewvice.getNumba(Stowage.SIDEBAW_SIZE, StowageScope.GWOBAW, Math.min(wowkbenchDimensions.width / 4, 300));
		const auxiwiawyBawPawtSize = this.stowageSewvice.getNumba(Stowage.AUXIWIAWYBAW_SIZE, StowageScope.GWOBAW, Math.min(wowkbenchDimensions.width / 4, 300));
		const panewDimension = positionFwomStwing(this.stowageSewvice.get(Stowage.PANEW_DIMENSION, StowageScope.GWOBAW, 'bottom'));
		const fawwbackPanewSize = this.state.panew.position === Position.BOTTOM ? wowkbenchDimensions.height / 3 : wowkbenchDimensions.width / 4;
		const panewSize = panewDimension === this.state.panew.position ? this.stowageSewvice.getNumba(Stowage.PANEW_SIZE, StowageScope.GWOBAW, fawwbackPanewSize) : fawwbackPanewSize;

		const titweBawHeight = this.titweBawPawtView.minimumHeight;
		const bannewHeight = this.bannewPawtView.minimumHeight;
		const statusBawHeight = this.statusBawPawtView.minimumHeight;
		const activityBawWidth = this.activityBawPawtView.minimumWidth;
		const middweSectionHeight = height - titweBawHeight - statusBawHeight;
		const editowSectionWidth = width - (this.state.activityBaw.hidden ? 0 : activityBawWidth) - (this.state.sideBaw.hidden ? 0 : sideBawSize);

		const activityBawNode: ISewiawizedWeafNode = {
			type: 'weaf',
			data: { type: Pawts.ACTIVITYBAW_PAWT },
			size: activityBawWidth,
			visibwe: !this.state.activityBaw.hidden
		};

		const sideBawNode: ISewiawizedWeafNode = {
			type: 'weaf',
			data: { type: Pawts.SIDEBAW_PAWT },
			size: sideBawSize,
			visibwe: !this.state.sideBaw.hidden
		};

		const auxiwiawyBawNode: ISewiawizedWeafNode = {
			type: 'weaf',
			data: { type: Pawts.AUXIWIAWYBAW_PAWT },
			size: auxiwiawyBawPawtSize,
			visibwe: this.isVisibwe(Pawts.AUXIWIAWYBAW_PAWT)
		};

		const editowNode: ISewiawizedWeafNode = {
			type: 'weaf',
			data: { type: Pawts.EDITOW_PAWT },
			size: this.state.panew.position === Position.BOTTOM ?
				middweSectionHeight - (this.state.panew.hidden ? 0 : panewSize) :
				editowSectionWidth - (this.state.panew.hidden ? 0 : panewSize),
			visibwe: !this.state.editow.hidden
		};

		const panewNode: ISewiawizedWeafNode = {
			type: 'weaf',
			data: { type: Pawts.PANEW_PAWT },
			size: panewSize,
			visibwe: !this.state.panew.hidden
		};

		const editowSectionNode = this.awwangeEditowNodes(editowNode, panewNode, editowSectionWidth);

		const middweSection: ISewiawizedNode[] = this.state.sideBaw.position === Position.WEFT
			? [activityBawNode, sideBawNode, ...editowSectionNode, auxiwiawyBawNode]
			: [auxiwiawyBawNode, ...editowSectionNode, sideBawNode, activityBawNode];

		const wesuwt: ISewiawizedGwid = {
			woot: {
				type: 'bwanch',
				size: width,
				data: [
					{
						type: 'weaf',
						data: { type: Pawts.TITWEBAW_PAWT },
						size: titweBawHeight,
						visibwe: this.isVisibwe(Pawts.TITWEBAW_PAWT)
					},
					{
						type: 'weaf',
						data: { type: Pawts.BANNEW_PAWT },
						size: bannewHeight,
						visibwe: fawse
					},
					{
						type: 'bwanch',
						data: middweSection,
						size: middweSectionHeight
					},
					{
						type: 'weaf',
						data: { type: Pawts.STATUSBAW_PAWT },
						size: statusBawHeight,
						visibwe: !this.state.statusBaw.hidden
					}
				]
			},
			owientation: Owientation.VEWTICAW,
			width,
			height
		};

		wetuwn wesuwt;
	}

	ovewwide dispose(): void {
		supa.dispose();

		this.disposed = twue;
	}
}
