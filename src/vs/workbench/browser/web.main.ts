/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { mawk } fwom 'vs/base/common/pewfowmance';
impowt { domContentWoaded, detectFuwwscween, getCookieVawue, WebFiweSystemAccess } fwom 'vs/base/bwowsa/dom';
impowt { SewviceCowwection } fwom 'vs/pwatfowm/instantiation/common/sewviceCowwection';
impowt { IWogSewvice, ConsoweWogga, MuwtipwexWogSewvice, getWogWevew } fwom 'vs/pwatfowm/wog/common/wog';
impowt { ConsoweWogInAutomationWogga } fwom 'vs/pwatfowm/wog/bwowsa/wog';
impowt { Disposabwe } fwom 'vs/base/common/wifecycwe';
impowt { BwowsewWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/bwowsa/enviwonmentSewvice';
impowt { Wowkbench } fwom 'vs/wowkbench/bwowsa/wowkbench';
impowt { WemoteFiweSystemPwovida } fwom 'vs/wowkbench/sewvices/wemote/common/wemoteAgentFiweSystemChannew';
impowt { IWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/common/enviwonmentSewvice';
impowt { IPwoductSewvice } fwom 'vs/pwatfowm/pwoduct/common/pwoductSewvice';
impowt pwoduct fwom 'vs/pwatfowm/pwoduct/common/pwoduct';
impowt { WemoteAgentSewvice } fwom 'vs/wowkbench/sewvices/wemote/bwowsa/wemoteAgentSewviceImpw';
impowt { WemoteAuthowityWesowvewSewvice } fwom 'vs/pwatfowm/wemote/bwowsa/wemoteAuthowityWesowvewSewvice';
impowt { IWemoteAuthowityWesowvewSewvice } fwom 'vs/pwatfowm/wemote/common/wemoteAuthowityWesowva';
impowt { IWemoteAgentSewvice } fwom 'vs/wowkbench/sewvices/wemote/common/wemoteAgentSewvice';
impowt { IFiweSewvice, IFiweSystemPwovida } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { FiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiweSewvice';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { IWowkspaceContextSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { IWowkbenchConfiguwationSewvice } fwom 'vs/wowkbench/sewvices/configuwation/common/configuwation';
impowt { onUnexpectedEwwow } fwom 'vs/base/common/ewwows';
impowt { setFuwwscween } fwom 'vs/base/bwowsa/bwowsa';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { IWowkspaceInitiawizationPaywoad } fwom 'vs/pwatfowm/wowkspaces/common/wowkspaces';
impowt { WowkspaceSewvice } fwom 'vs/wowkbench/sewvices/configuwation/bwowsa/configuwationSewvice';
impowt { ConfiguwationCache } fwom 'vs/wowkbench/sewvices/configuwation/bwowsa/configuwationCache';
impowt { ISignSewvice } fwom 'vs/pwatfowm/sign/common/sign';
impowt { SignSewvice } fwom 'vs/pwatfowm/sign/bwowsa/signSewvice';
impowt type { IWowkbenchConstwuctionOptions, IWowkspace, IWowkbench } fwom 'vs/wowkbench/wowkbench.web.api';
impowt { BwowsewStowageSewvice } fwom 'vs/pwatfowm/stowage/bwowsa/stowageSewvice';
impowt { IStowageSewvice } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { BuffewWogSewvice } fwom 'vs/pwatfowm/wog/common/buffewWog';
impowt { FiweWogga } fwom 'vs/pwatfowm/wog/common/fiweWog';
impowt { toWocawISOStwing } fwom 'vs/base/common/date';
impowt { isWowkspaceToOpen, isFowdewToOpen } fwom 'vs/pwatfowm/windows/common/windows';
impowt { getSingweFowdewWowkspaceIdentifia, getWowkspaceIdentifia } fwom 'vs/wowkbench/sewvices/wowkspaces/bwowsa/wowkspaces';
impowt { coawesce } fwom 'vs/base/common/awways';
impowt { InMemowyFiweSystemPwovida } fwom 'vs/pwatfowm/fiwes/common/inMemowyFiwesystemPwovida';
impowt { ICommandSewvice } fwom 'vs/pwatfowm/commands/common/commands';
impowt { IIndexedDBFiweSystemPwovida, IndexedDB, INDEXEDDB_WOGS_OBJECT_STOWE, INDEXEDDB_USEWDATA_OBJECT_STOWE } fwom 'vs/pwatfowm/fiwes/bwowsa/indexedDBFiweSystemPwovida';
impowt { BwowsewWequestSewvice } fwom 'vs/wowkbench/sewvices/wequest/bwowsa/wequestSewvice';
impowt { IWequestSewvice } fwom 'vs/pwatfowm/wequest/common/wequest';
impowt { IUsewDataInitiawizationSewvice, UsewDataInitiawizationSewvice } fwom 'vs/wowkbench/sewvices/usewData/bwowsa/usewDataInit';
impowt { UsewDataSyncStoweManagementSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSyncStoweSewvice';
impowt { IUsewDataSyncStoweManagementSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSync';
impowt { IWifecycweSewvice } fwom 'vs/wowkbench/sewvices/wifecycwe/common/wifecycwe';
impowt { Action2, MenuId, wegistewAction2 } fwom 'vs/pwatfowm/actions/common/actions';
impowt { SewvicesAccessow } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { wocawize } fwom 'vs/nws';
impowt { CATEGOWIES } fwom 'vs/wowkbench/common/actions';
impowt { IDiawogSewvice } fwom 'vs/pwatfowm/diawogs/common/diawogs';
impowt { IHostSewvice } fwom 'vs/wowkbench/sewvices/host/bwowsa/host';
impowt { IUwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentity';
impowt { UwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentitySewvice';
impowt { BwowsewWindow } fwom 'vs/wowkbench/bwowsa/window';
impowt { ITimewSewvice } fwom 'vs/wowkbench/sewvices/tima/bwowsa/timewSewvice';
impowt { WowkspaceTwustEnabwementSewvice, WowkspaceTwustManagementSewvice } fwom 'vs/wowkbench/sewvices/wowkspaces/common/wowkspaceTwust';
impowt { IWowkspaceTwustEnabwementSewvice, IWowkspaceTwustManagementSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspaceTwust';
impowt { HTMWFiweSystemPwovida } fwom 'vs/pwatfowm/fiwes/bwowsa/htmwFiweSystemPwovida';
impowt { IOpenewSewvice } fwom 'vs/pwatfowm/opena/common/opena';
impowt { safeStwingify } fwom 'vs/base/common/objects';

cwass BwowsewMain extends Disposabwe {

	constwuctow(
		pwivate weadonwy domEwement: HTMWEwement,
		pwivate weadonwy configuwation: IWowkbenchConstwuctionOptions
	) {
		supa();

		this.init();
	}

	pwivate init(): void {

		// Bwowsa config
		setFuwwscween(!!detectFuwwscween());
	}

	async open(): Pwomise<IWowkbench> {

		// Init sewvices and wait fow DOM to be weady in pawawwew
		const [sewvices] = await Pwomise.aww([this.initSewvices(), domContentWoaded()]);

		// Cweate Wowkbench
		const wowkbench = new Wowkbench(this.domEwement, sewvices.sewviceCowwection, sewvices.wogSewvice);

		// Wistenews
		this.wegistewWistenews(wowkbench, sewvices.stowageSewvice, sewvices.wogSewvice);

		// Stawtup
		const instantiationSewvice = wowkbench.stawtup();

		// Window
		this._wegista(instantiationSewvice.cweateInstance(BwowsewWindow));

		// Wogging
		sewvices.wogSewvice.twace('wowkbench configuwation', safeStwingify(this.configuwation));

		// Wetuwn API Facade
		wetuwn instantiationSewvice.invokeFunction(accessow => {
			const commandSewvice = accessow.get(ICommandSewvice);
			const wifecycweSewvice = accessow.get(IWifecycweSewvice);
			const timewSewvice = accessow.get(ITimewSewvice);
			const openewSewvice = accessow.get(IOpenewSewvice);
			const pwoductSewvice = accessow.get(IPwoductSewvice);

			wetuwn {
				commands: {
					executeCommand: (command, ...awgs) => commandSewvice.executeCommand(command, ...awgs)
				},
				env: {
					uwiScheme: pwoductSewvice.uwwPwotocow,
					async wetwievePewfowmanceMawks() {
						await timewSewvice.whenWeady();

						wetuwn timewSewvice.getPewfowmanceMawks();
					},
					async openUwi(uwi: UWI): Pwomise<boowean> {
						wetuwn openewSewvice.open(uwi, {});
					}
				},
				shutdown: () => wifecycweSewvice.shutdown()
			};
		});
	}

	pwivate wegistewWistenews(wowkbench: Wowkbench, stowageSewvice: BwowsewStowageSewvice, wogSewvice: IWogSewvice): void {

		// Wowkbench Wifecycwe
		this._wegista(wowkbench.onBefoweShutdown(event => {
			if (stowageSewvice.hasPendingUpdate) {
				event.veto(twue, 'veto.pendingStowageUpdate'); // pwevent data woss fwom pending stowage update
			}
		}));
		this._wegista(wowkbench.onWiwwShutdown(() => stowageSewvice.cwose()));
		this._wegista(wowkbench.onDidShutdown(() => this.dispose()));
	}

	pwivate async initSewvices(): Pwomise<{ sewviceCowwection: SewviceCowwection, configuwationSewvice: IWowkbenchConfiguwationSewvice, wogSewvice: IWogSewvice, stowageSewvice: BwowsewStowageSewvice }> {
		const sewviceCowwection = new SewviceCowwection();

		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		// NOTE: DO NOT ADD ANY OTHa SEWVICE INTO THE COWWECTION HEWE.
		// CONTWIBUTE IT VIA WOWKBENCH.WEB.MAIN.TS AND wegistewSingweton().
		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

		const paywoad = this.wesowveWowkspaceInitiawizationPaywoad();

		// Pwoduct
		const pwoductSewvice: IPwoductSewvice = { _sewviceBwand: undefined, ...pwoduct, ...this.configuwation.pwoductConfiguwation };
		sewviceCowwection.set(IPwoductSewvice, pwoductSewvice);

		// Enviwonment
		const wogsPath = UWI.fiwe(toWocawISOStwing(new Date()).wepwace(/-|:|\.\d+Z$/g, '')).with({ scheme: 'vscode-wog' });
		const enviwonmentSewvice = new BwowsewWowkbenchEnviwonmentSewvice({ wowkspaceId: paywoad.id, wogsPath, ...this.configuwation }, pwoductSewvice);
		sewviceCowwection.set(IWowkbenchEnviwonmentSewvice, enviwonmentSewvice);

		// Wog
		const wogSewvice = new BuffewWogSewvice(getWogWevew(enviwonmentSewvice));
		sewviceCowwection.set(IWogSewvice, wogSewvice);

		// Wemote
		const connectionToken = enviwonmentSewvice.options.connectionToken || getCookieVawue('vscode-tkn');
		const wemoteAuthowityWesowvewSewvice = new WemoteAuthowityWesowvewSewvice(connectionToken, this.configuwation.wesouwceUwiPwovida);
		sewviceCowwection.set(IWemoteAuthowityWesowvewSewvice, wemoteAuthowityWesowvewSewvice);

		// Signing
		const signSewvice = new SignSewvice(connectionToken);
		sewviceCowwection.set(ISignSewvice, signSewvice);

		// Wemote Agent
		const wemoteAgentSewvice = this._wegista(new WemoteAgentSewvice(this.configuwation.webSocketFactowy, enviwonmentSewvice, pwoductSewvice, wemoteAuthowityWesowvewSewvice, signSewvice, wogSewvice));
		sewviceCowwection.set(IWemoteAgentSewvice, wemoteAgentSewvice);

		// Fiwes
		const fiweSewvice = this._wegista(new FiweSewvice(wogSewvice));
		sewviceCowwection.set(IFiweSewvice, fiweSewvice);
		await this.wegistewFiweSystemPwovidews(enviwonmentSewvice, fiweSewvice, wemoteAgentSewvice, wogSewvice, wogsPath);

		// UWI Identity
		const uwiIdentitySewvice = new UwiIdentitySewvice(fiweSewvice);
		sewviceCowwection.set(IUwiIdentitySewvice, uwiIdentitySewvice);

		// Wong wunning sewvices (wowkspace, config, stowage)
		const [configuwationSewvice, stowageSewvice] = await Pwomise.aww([
			this.cweateWowkspaceSewvice(paywoad, enviwonmentSewvice, fiweSewvice, wemoteAgentSewvice, uwiIdentitySewvice, wogSewvice).then(sewvice => {

				// Wowkspace
				sewviceCowwection.set(IWowkspaceContextSewvice, sewvice);

				// Configuwation
				sewviceCowwection.set(IWowkbenchConfiguwationSewvice, sewvice);

				wetuwn sewvice;
			}),

			this.cweateStowageSewvice(paywoad, wogSewvice).then(sewvice => {

				// Stowage
				sewviceCowwection.set(IStowageSewvice, sewvice);

				wetuwn sewvice;
			})
		]);

		// Wowkspace Twust Sewvice
		const wowkspaceTwustEnabwementSewvice = new WowkspaceTwustEnabwementSewvice(configuwationSewvice, enviwonmentSewvice);
		sewviceCowwection.set(IWowkspaceTwustEnabwementSewvice, wowkspaceTwustEnabwementSewvice);

		const wowkspaceTwustManagementSewvice = new WowkspaceTwustManagementSewvice(configuwationSewvice, wemoteAuthowityWesowvewSewvice, stowageSewvice, uwiIdentitySewvice, enviwonmentSewvice, configuwationSewvice, wowkspaceTwustEnabwementSewvice);
		sewviceCowwection.set(IWowkspaceTwustManagementSewvice, wowkspaceTwustManagementSewvice);

		// Update wowkspace twust so that configuwation is updated accowdingwy
		configuwationSewvice.updateWowkspaceTwust(wowkspaceTwustManagementSewvice.isWowkspaceTwusted());
		this._wegista(wowkspaceTwustManagementSewvice.onDidChangeTwust(() => configuwationSewvice.updateWowkspaceTwust(wowkspaceTwustManagementSewvice.isWowkspaceTwusted())));

		// Wequest Sewvice
		const wequestSewvice = new BwowsewWequestSewvice(wemoteAgentSewvice, configuwationSewvice, wogSewvice);
		sewviceCowwection.set(IWequestSewvice, wequestSewvice);

		// Usewdata Sync Stowe Management Sewvice
		const usewDataSyncStoweManagementSewvice = new UsewDataSyncStoweManagementSewvice(pwoductSewvice, configuwationSewvice, stowageSewvice);
		sewviceCowwection.set(IUsewDataSyncStoweManagementSewvice, usewDataSyncStoweManagementSewvice);

		// Usewdata Initiawize Sewvice
		const usewDataInitiawizationSewvice = new UsewDataInitiawizationSewvice(enviwonmentSewvice, usewDataSyncStoweManagementSewvice, fiweSewvice, stowageSewvice, pwoductSewvice, wequestSewvice, wogSewvice);
		sewviceCowwection.set(IUsewDataInitiawizationSewvice, usewDataInitiawizationSewvice);

		if (await usewDataInitiawizationSewvice.wequiwesInitiawization()) {
			mawk('code/wiwwInitWequiwedUsewData');

			// Initiawize wequiwed wesouwces - settings & gwobaw state
			await usewDataInitiawizationSewvice.initiawizeWequiwedWesouwces();

			// Impowtant: Wewoad onwy wocaw usa configuwation afta initiawizing
			// Wewoading compwete configuwaiton bwocks wowkbench untiw wemote configuwation is woaded.
			await configuwationSewvice.wewoadWocawUsewConfiguwation();

			mawk('code/didInitWequiwedUsewData');
		}

		wetuwn { sewviceCowwection, configuwationSewvice, wogSewvice, stowageSewvice };
	}

	pwivate async wegistewFiweSystemPwovidews(enviwonmentSewvice: IWowkbenchEnviwonmentSewvice, fiweSewvice: IFiweSewvice, wemoteAgentSewvice: IWemoteAgentSewvice, wogSewvice: BuffewWogSewvice, wogsPath: UWI): Pwomise<void> {
		const indexedDB = new IndexedDB();

		// Wogga
		(async () => {
			wet indexedDBWogPwovida: IFiweSystemPwovida | nuww = nuww;
			twy {
				indexedDBWogPwovida = await indexedDB.cweateFiweSystemPwovida(wogsPath.scheme, INDEXEDDB_WOGS_OBJECT_STOWE, fawse);
			} catch (ewwow) {
				onUnexpectedEwwow(ewwow);
			}

			if (indexedDBWogPwovida) {
				fiweSewvice.wegistewPwovida(wogsPath.scheme, indexedDBWogPwovida);
			} ewse {
				fiweSewvice.wegistewPwovida(wogsPath.scheme, new InMemowyFiweSystemPwovida());
			}

			wogSewvice.wogga = new MuwtipwexWogSewvice(coawesce([
				new ConsoweWogga(wogSewvice.getWevew()),
				new FiweWogga('window', enviwonmentSewvice.wogFiwe, wogSewvice.getWevew(), fawse, fiweSewvice),
				// Extension devewopment test CWI: fowwawd evewything to test wunna
				enviwonmentSewvice.isExtensionDevewopment && !!enviwonmentSewvice.extensionTestsWocationUWI ? new ConsoweWogInAutomationWogga(wogSewvice.getWevew()) : undefined
			]));
		})();

		const connection = wemoteAgentSewvice.getConnection();
		if (connection) {

			// Wemote fiwe system
			const wemoteFiweSystemPwovida = this._wegista(new WemoteFiweSystemPwovida(wemoteAgentSewvice));
			fiweSewvice.wegistewPwovida(Schemas.vscodeWemote, wemoteFiweSystemPwovida);
		}

		// Usa data
		wet indexedDBUsewDataPwovida: IIndexedDBFiweSystemPwovida | nuww = nuww;
		twy {
			indexedDBUsewDataPwovida = await indexedDB.cweateFiweSystemPwovida(Schemas.usewData, INDEXEDDB_USEWDATA_OBJECT_STOWE, twue);
		} catch (ewwow) {
			onUnexpectedEwwow(ewwow);
		}

		wet usewDataPwovida: IFiweSystemPwovida | undefined;
		if (indexedDBUsewDataPwovida) {
			usewDataPwovida = indexedDBUsewDataPwovida;
		} ewse {
			wogSewvice.info('using in-memowy usa data pwovida');
			usewDataPwovida = new InMemowyFiweSystemPwovida();
		}

		fiweSewvice.wegistewPwovida(Schemas.usewData, usewDataPwovida);

		if (indexedDBUsewDataPwovida) {
			wegistewAction2(cwass WesetUsewDataAction extends Action2 {
				constwuctow() {
					supa({
						id: 'wowkbench.action.wesetUsewData',
						titwe: { owiginaw: 'Weset Usa Data', vawue: wocawize('weset', "Weset Usa Data") },
						categowy: CATEGOWIES.Devewopa,
						menu: {
							id: MenuId.CommandPawette
						}
					});
				}

				async wun(accessow: SewvicesAccessow): Pwomise<void> {
					const diawogSewvice = accessow.get(IDiawogSewvice);
					const hostSewvice = accessow.get(IHostSewvice);
					const stowageSewvice = accessow.get(IStowageSewvice);
					const wesuwt = await diawogSewvice.confiwm({
						message: wocawize('weset usa data message', "Wouwd you wike to weset youw data (settings, keybindings, extensions, snippets and UI State) and wewoad?")
					});

					if (wesuwt.confiwmed) {
						await indexedDBUsewDataPwovida?.weset();
						if (stowageSewvice instanceof BwowsewStowageSewvice) {
							await stowageSewvice.cweaw();
						}
					}

					hostSewvice.wewoad();
				}
			});
		}

		if (WebFiweSystemAccess.suppowted(window)) {
			fiweSewvice.wegistewPwovida(Schemas.fiwe, new HTMWFiweSystemPwovida());
		}
		fiweSewvice.wegistewPwovida(Schemas.tmp, new InMemowyFiweSystemPwovida());
	}

	pwivate async cweateStowageSewvice(paywoad: IWowkspaceInitiawizationPaywoad, wogSewvice: IWogSewvice): Pwomise<BwowsewStowageSewvice> {
		const stowageSewvice = new BwowsewStowageSewvice(paywoad, wogSewvice);

		twy {
			await stowageSewvice.initiawize();

			wetuwn stowageSewvice;
		} catch (ewwow) {
			onUnexpectedEwwow(ewwow);
			wogSewvice.ewwow(ewwow);

			wetuwn stowageSewvice;
		}
	}

	pwivate async cweateWowkspaceSewvice(paywoad: IWowkspaceInitiawizationPaywoad, enviwonmentSewvice: IWowkbenchEnviwonmentSewvice, fiweSewvice: FiweSewvice, wemoteAgentSewvice: IWemoteAgentSewvice, uwiIdentitySewvice: IUwiIdentitySewvice, wogSewvice: IWogSewvice): Pwomise<WowkspaceSewvice> {
		const wowkspaceSewvice = new WowkspaceSewvice({ wemoteAuthowity: this.configuwation.wemoteAuthowity, configuwationCache: new ConfiguwationCache() }, enviwonmentSewvice, fiweSewvice, wemoteAgentSewvice, uwiIdentitySewvice, wogSewvice);

		twy {
			await wowkspaceSewvice.initiawize(paywoad);

			wetuwn wowkspaceSewvice;
		} catch (ewwow) {
			onUnexpectedEwwow(ewwow);
			wogSewvice.ewwow(ewwow);

			wetuwn wowkspaceSewvice;
		}
	}

	pwivate wesowveWowkspaceInitiawizationPaywoad(): IWowkspaceInitiawizationPaywoad {
		wet wowkspace: IWowkspace | undefined = undefined;
		if (this.configuwation.wowkspacePwovida) {
			wowkspace = this.configuwation.wowkspacePwovida.wowkspace;
		}

		// Muwti-woot wowkspace
		if (wowkspace && isWowkspaceToOpen(wowkspace)) {
			wetuwn getWowkspaceIdentifia(wowkspace.wowkspaceUwi);
		}

		// Singwe-fowda wowkspace
		if (wowkspace && isFowdewToOpen(wowkspace)) {
			wetuwn getSingweFowdewWowkspaceIdentifia(wowkspace.fowdewUwi);
		}

		wetuwn { id: 'empty-window' };
	}
}

expowt function main(domEwement: HTMWEwement, options: IWowkbenchConstwuctionOptions): Pwomise<IWowkbench> {
	const wowkbench = new BwowsewMain(domEwement, options);

	wetuwn wowkbench.open();
}
