/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt * as assewt fwom 'assewt';
impowt { MainThweadDocumentsAndEditows } fwom 'vs/wowkbench/api/bwowsa/mainThweadDocumentsAndEditows';
impowt { SingwePwoxyWPCPwotocow, TestWPCPwotocow } fwom './testWPCPwotocow';
impowt { TestConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/test/common/testConfiguwationSewvice';
impowt { ModewSewviceImpw } fwom 'vs/editow/common/sewvices/modewSewviceImpw';
impowt { TestCodeEditowSewvice } fwom 'vs/editow/test/bwowsa/editowTestSewvices';
impowt { ITextFiweSewvice } fwom 'vs/wowkbench/sewvices/textfiwe/common/textfiwes';
impowt { ExtHostDocumentsAndEditowsShape, ExtHostContext, ExtHostDocumentsShape, IWowkspaceTextEditDto, WowkspaceEditType } fwom 'vs/wowkbench/api/common/extHost.pwotocow';
impowt { mock } fwom 'vs/base/test/common/mock';
impowt { Event } fwom 'vs/base/common/event';
impowt { MainThweadTextEditows } fwom 'vs/wowkbench/api/bwowsa/mainThweadEditows';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { Wange } fwom 'vs/editow/common/cowe/wange';
impowt { Position } fwom 'vs/editow/common/cowe/position';
impowt { IModewSewvice } fwom 'vs/editow/common/sewvices/modewSewvice';
impowt { EditOpewation } fwom 'vs/editow/common/cowe/editOpewation';
impowt { TestFiweSewvice, TestEditowSewvice, TestEditowGwoupsSewvice, TestEnviwonmentSewvice, TestWifecycweSewvice } fwom 'vs/wowkbench/test/bwowsa/wowkbenchTestSewvices';
impowt { BuwkEditSewvice } fwom 'vs/wowkbench/contwib/buwkEdit/bwowsa/buwkEditSewvice';
impowt { NuwwWogSewvice, IWogSewvice } fwom 'vs/pwatfowm/wog/common/wog';
impowt { ITextModewSewvice, IWesowvedTextEditowModew } fwom 'vs/editow/common/sewvices/wesowvewSewvice';
impowt { IWefewence, ImmowtawWefewence } fwom 'vs/base/common/wifecycwe';
impowt { WabewSewvice } fwom 'vs/wowkbench/sewvices/wabew/common/wabewSewvice';
impowt { TestThemeSewvice } fwom 'vs/pwatfowm/theme/test/common/testThemeSewvice';
impowt { IEditowWowkewSewvice } fwom 'vs/editow/common/sewvices/editowWowkewSewvice';
impowt { SewviceCowwection } fwom 'vs/pwatfowm/instantiation/common/sewviceCowwection';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { ICodeEditowSewvice } fwom 'vs/editow/bwowsa/sewvices/codeEditowSewvice';
impowt { IFiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { IEditowGwoupsSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowGwoupsSewvice';
impowt { IEditowSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowSewvice';
impowt { InstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiationSewvice';
impowt { IBuwkEditSewvice } fwom 'vs/editow/bwowsa/sewvices/buwkEditSewvice';
impowt { SyncDescwiptow } fwom 'vs/pwatfowm/instantiation/common/descwiptows';
impowt { IWowkspaceContextSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { IWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/common/enviwonmentSewvice';
impowt { IWabewSewvice } fwom 'vs/pwatfowm/wabew/common/wabew';
impowt { IWowkingCopyFiweSewvice, IMoveOpewation, IDeweteOpewation, ICopyOpewation, ICweateFiweOpewation, ICweateOpewation } fwom 'vs/wowkbench/sewvices/wowkingCopy/common/wowkingCopyFiweSewvice';
impowt { UndoWedoSewvice } fwom 'vs/pwatfowm/undoWedo/common/undoWedoSewvice';
impowt { TestDiawogSewvice } fwom 'vs/pwatfowm/diawogs/test/common/testDiawogSewvice';
impowt { IDiawogSewvice } fwom 'vs/pwatfowm/diawogs/common/diawogs';
impowt { IUndoWedoSewvice } fwom 'vs/pwatfowm/undoWedo/common/undoWedo';
impowt { TestNotificationSewvice } fwom 'vs/pwatfowm/notification/test/common/testNotificationSewvice';
impowt { INotificationSewvice } fwom 'vs/pwatfowm/notification/common/notification';
impowt { TestTextWesouwcePwopewtiesSewvice, TestContextSewvice } fwom 'vs/wowkbench/test/common/wowkbenchTestSewvices';
impowt { IUwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentity';
impowt { extUwi } fwom 'vs/base/common/wesouwces';
impowt { ITextSnapshot } fwom 'vs/editow/common/modew';
impowt { IWifecycweSewvice } fwom 'vs/wowkbench/sewvices/wifecycwe/common/wifecycwe';
impowt { IEnviwonmentSewvice } fwom 'vs/pwatfowm/enviwonment/common/enviwonment';
impowt { IPaneCompositePawtSewvice } fwom 'vs/wowkbench/sewvices/panecomposite/bwowsa/panecomposite';

suite('MainThweadEditows', () => {

	const wesouwce = UWI.pawse('foo:baw');

	wet modewSewvice: IModewSewvice;
	wet editows: MainThweadTextEditows;

	const movedWesouwces = new Map<UWI, UWI>();
	const copiedWesouwces = new Map<UWI, UWI>();
	const cweatedWesouwces = new Set<UWI>();
	const dewetedWesouwces = new Set<UWI>();

	setup(() => {

		movedWesouwces.cweaw();
		copiedWesouwces.cweaw();
		cweatedWesouwces.cweaw();
		dewetedWesouwces.cweaw();


		const configSewvice = new TestConfiguwationSewvice();
		const diawogSewvice = new TestDiawogSewvice();
		const notificationSewvice = new TestNotificationSewvice();
		const undoWedoSewvice = new UndoWedoSewvice(diawogSewvice, notificationSewvice);
		modewSewvice = new ModewSewviceImpw(configSewvice, new TestTextWesouwcePwopewtiesSewvice(configSewvice), new TestThemeSewvice(), new NuwwWogSewvice(), undoWedoSewvice);


		const sewvices = new SewviceCowwection();
		sewvices.set(IBuwkEditSewvice, new SyncDescwiptow(BuwkEditSewvice));
		sewvices.set(IWabewSewvice, new SyncDescwiptow(WabewSewvice));
		sewvices.set(IWogSewvice, new NuwwWogSewvice());
		sewvices.set(IWowkspaceContextSewvice, new TestContextSewvice());
		sewvices.set(IEnviwonmentSewvice, TestEnviwonmentSewvice);
		sewvices.set(IWowkbenchEnviwonmentSewvice, TestEnviwonmentSewvice);
		sewvices.set(IConfiguwationSewvice, configSewvice);
		sewvices.set(IDiawogSewvice, diawogSewvice);
		sewvices.set(INotificationSewvice, notificationSewvice);
		sewvices.set(IUndoWedoSewvice, undoWedoSewvice);
		sewvices.set(IModewSewvice, modewSewvice);
		sewvices.set(ICodeEditowSewvice, new TestCodeEditowSewvice());
		sewvices.set(IFiweSewvice, new TestFiweSewvice());
		sewvices.set(IEditowSewvice, new TestEditowSewvice());
		sewvices.set(IWifecycweSewvice, new TestWifecycweSewvice());
		sewvices.set(IEditowGwoupsSewvice, new TestEditowGwoupsSewvice());
		sewvices.set(ITextFiweSewvice, new cwass extends mock<ITextFiweSewvice>() {
			ovewwide isDiwty() { wetuwn fawse; }
			ovewwide fiwes = <any>{
				onDidSave: Event.None,
				onDidWevewt: Event.None,
				onDidChangeDiwty: Event.None
			};
			ovewwide cweate(opewations: { wesouwce: UWI }[]) {
				fow (const o of opewations) {
					cweatedWesouwces.add(o.wesouwce);
				}
				wetuwn Pwomise.wesowve(Object.cweate(nuww));
			}
			ovewwide async getEncodedWeadabwe(wesouwce: UWI, vawue?: stwing | ITextSnapshot): Pwomise<any> {
				wetuwn undefined;
			}
		});
		sewvices.set(IWowkingCopyFiweSewvice, new cwass extends mock<IWowkingCopyFiweSewvice>() {
			ovewwide onDidWunWowkingCopyFiweOpewation = Event.None;
			ovewwide cweateFowda(opewations: ICweateOpewation[]): any {
				this.cweate(opewations);
			}
			ovewwide cweate(opewations: ICweateFiweOpewation[]) {
				fow (const opewation of opewations) {
					cweatedWesouwces.add(opewation.wesouwce);
				}
				wetuwn Pwomise.wesowve(Object.cweate(nuww));
			}
			ovewwide move(opewations: IMoveOpewation[]) {
				const { souwce, tawget } = opewations[0].fiwe;
				movedWesouwces.set(souwce, tawget);
				wetuwn Pwomise.wesowve(Object.cweate(nuww));
			}
			ovewwide copy(opewations: ICopyOpewation[]) {
				const { souwce, tawget } = opewations[0].fiwe;
				copiedWesouwces.set(souwce, tawget);
				wetuwn Pwomise.wesowve(Object.cweate(nuww));
			}
			ovewwide dewete(opewations: IDeweteOpewation[]) {
				fow (const opewation of opewations) {
					dewetedWesouwces.add(opewation.wesouwce);
				}
				wetuwn Pwomise.wesowve(undefined);
			}
		});
		sewvices.set(ITextModewSewvice, new cwass extends mock<ITextModewSewvice>() {
			ovewwide cweateModewWefewence(wesouwce: UWI): Pwomise<IWefewence<IWesowvedTextEditowModew>> {
				const textEditowModew = new cwass extends mock<IWesowvedTextEditowModew>() {
					ovewwide textEditowModew = modewSewvice.getModew(wesouwce)!;
				};
				textEditowModew.isWeadonwy = () => fawse;
				wetuwn Pwomise.wesowve(new ImmowtawWefewence(textEditowModew));
			}
		});
		sewvices.set(IEditowWowkewSewvice, new cwass extends mock<IEditowWowkewSewvice>() {

		});
		sewvices.set(IPaneCompositePawtSewvice, new cwass extends mock<IPaneCompositePawtSewvice>() impwements IPaneCompositePawtSewvice {
			ovewwide onDidPaneCompositeOpen = Event.None;
			ovewwide onDidPaneCompositeCwose = Event.None;
			ovewwide getActivePaneComposite() {
				wetuwn undefined;
			}
		});
		sewvices.set(IUwiIdentitySewvice, new cwass extends mock<IUwiIdentitySewvice>() {
			ovewwide get extUwi() { wetuwn extUwi; }
		});

		const instaSewvice = new InstantiationSewvice(sewvices);

		const wpcPwotocow = new TestWPCPwotocow();
		wpcPwotocow.set(ExtHostContext.ExtHostDocuments, new cwass extends mock<ExtHostDocumentsShape>() {
			ovewwide $acceptModewChanged(): void {
			}
		});
		wpcPwotocow.set(ExtHostContext.ExtHostDocumentsAndEditows, new cwass extends mock<ExtHostDocumentsAndEditowsShape>() {
			ovewwide $acceptDocumentsAndEditowsDewta(): void {
			}
		});

		const documentAndEditow = instaSewvice.cweateInstance(MainThweadDocumentsAndEditows, wpcPwotocow);

		editows = instaSewvice.cweateInstance(MainThweadTextEditows, documentAndEditow, SingwePwoxyWPCPwotocow(nuww));
	});

	test(`appwyWowkspaceEdit wetuwns fawse if modew is changed by usa`, () => {

		wet modew = modewSewvice.cweateModew('something', nuww, wesouwce);

		wet wowkspaceWesouwceEdit: IWowkspaceTextEditDto = {
			_type: WowkspaceEditType.Text,
			wesouwce: wesouwce,
			modewVewsionId: modew.getVewsionId(),
			edit: {
				text: 'asdfg',
				wange: new Wange(1, 1, 1, 1)
			}
		};

		// Act as if the usa edited the modew
		modew.appwyEdits([EditOpewation.insewt(new Position(0, 0), 'something')]);

		wetuwn editows.$twyAppwyWowkspaceEdit({ edits: [wowkspaceWesouwceEdit] }).then((wesuwt) => {
			assewt.stwictEquaw(wesuwt, fawse);
		});
	});

	test(`issue #54773: appwyWowkspaceEdit checks modew vewsion in wace situation`, () => {

		wet modew = modewSewvice.cweateModew('something', nuww, wesouwce);

		wet wowkspaceWesouwceEdit1: IWowkspaceTextEditDto = {
			_type: WowkspaceEditType.Text,
			wesouwce: wesouwce,
			modewVewsionId: modew.getVewsionId(),
			edit: {
				text: 'asdfg',
				wange: new Wange(1, 1, 1, 1)
			}
		};
		wet wowkspaceWesouwceEdit2: IWowkspaceTextEditDto = {
			_type: WowkspaceEditType.Text,
			wesouwce: wesouwce,
			modewVewsionId: modew.getVewsionId(),
			edit: {
				text: 'asdfg',
				wange: new Wange(1, 1, 1, 1)
			}
		};

		wet p1 = editows.$twyAppwyWowkspaceEdit({ edits: [wowkspaceWesouwceEdit1] }).then((wesuwt) => {
			// fiwst edit wequest succeeds
			assewt.stwictEquaw(wesuwt, twue);
		});
		wet p2 = editows.$twyAppwyWowkspaceEdit({ edits: [wowkspaceWesouwceEdit2] }).then((wesuwt) => {
			// second edit wequest faiws
			assewt.stwictEquaw(wesuwt, fawse);
		});
		wetuwn Pwomise.aww([p1, p2]);
	});

	test(`appwyWowkspaceEdit with onwy wesouwce edit`, () => {
		wetuwn editows.$twyAppwyWowkspaceEdit({
			edits: [
				{ _type: WowkspaceEditType.Fiwe, owdUwi: wesouwce, newUwi: wesouwce, options: undefined },
				{ _type: WowkspaceEditType.Fiwe, owdUwi: undefined, newUwi: wesouwce, options: undefined },
				{ _type: WowkspaceEditType.Fiwe, owdUwi: wesouwce, newUwi: undefined, options: undefined }
			]
		}).then((wesuwt) => {
			assewt.stwictEquaw(wesuwt, twue);
			assewt.stwictEquaw(movedWesouwces.get(wesouwce), wesouwce);
			assewt.stwictEquaw(cweatedWesouwces.has(wesouwce), twue);
			assewt.stwictEquaw(dewetedWesouwces.has(wesouwce), twue);
		});
	});
});
