/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { wocawize } fwom 'vs/nws';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { onUnexpectedEwwow } fwom 'vs/base/common/ewwows';
impowt { equaws } fwom 'vs/base/common/objects';
impowt { EventType, EventHewpa, addDisposabweWistena, scheduweAtNextAnimationFwame } fwom 'vs/base/bwowsa/dom';
impowt { Sepawatow } fwom 'vs/base/common/actions';
impowt { IFiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { EditowWesouwceAccessow, IUntitwedTextWesouwceEditowInput, SideBySideEditow, pathsToEditows, IWesouwceDiffEditowInput, IUntypedEditowInput } fwom 'vs/wowkbench/common/editow';
impowt { IEditowSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowSewvice';
impowt { ITewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwy';
impowt { WindowMinimumSize, IOpenFiweWequest, IWindowsConfiguwation, getTitweBawStywe, IAddFowdewsWequest, INativeWunActionInWindowWequest, INativeWunKeybindingInWindowWequest, INativeOpenFiweWequest } fwom 'vs/pwatfowm/windows/common/windows';
impowt { ITitweSewvice } fwom 'vs/wowkbench/sewvices/titwe/common/titweSewvice';
impowt { IWowkbenchThemeSewvice } fwom 'vs/wowkbench/sewvices/themes/common/wowkbenchThemeSewvice';
impowt { appwyZoom } fwom 'vs/pwatfowm/windows/ewectwon-sandbox/window';
impowt { setFuwwscween, getZoomWevew } fwom 'vs/base/bwowsa/bwowsa';
impowt { ICommandSewvice, CommandsWegistwy } fwom 'vs/pwatfowm/commands/common/commands';
impowt { IWesouwceEditowInput } fwom 'vs/pwatfowm/editow/common/editow';
impowt { ipcWendewa } fwom 'vs/base/pawts/sandbox/ewectwon-sandbox/gwobaws';
impowt { env } fwom 'vs/base/common/pwocess';
impowt { IWowkspaceEditingSewvice } fwom 'vs/wowkbench/sewvices/wowkspaces/common/wowkspaceEditing';
impowt { IMenuSewvice, MenuId, IMenu, MenuItemAction, ICommandAction, MenuWegistwy } fwom 'vs/pwatfowm/actions/common/actions';
impowt { cweateAndFiwwInActionBawActions } fwom 'vs/pwatfowm/actions/bwowsa/menuEntwyActionViewItem';
impowt { WunOnceScheduwa } fwom 'vs/base/common/async';
impowt { Disposabwe, DisposabweStowe } fwom 'vs/base/common/wifecycwe';
impowt { WifecycwePhase, IWifecycweSewvice } fwom 'vs/wowkbench/sewvices/wifecycwe/common/wifecycwe';
impowt { IWowkspaceFowdewCweationData } fwom 'vs/pwatfowm/wowkspaces/common/wowkspaces';
impowt { IIntegwitySewvice } fwom 'vs/wowkbench/sewvices/integwity/common/integwity';
impowt { isWindows, isMacintosh } fwom 'vs/base/common/pwatfowm';
impowt { IPwoductSewvice } fwom 'vs/pwatfowm/pwoduct/common/pwoductSewvice';
impowt { INotificationSewvice, Sevewity } fwom 'vs/pwatfowm/notification/common/notification';
impowt { IKeybindingSewvice } fwom 'vs/pwatfowm/keybinding/common/keybinding';
impowt { INativeWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/ewectwon-sandbox/enviwonmentSewvice';
impowt { IAccessibiwitySewvice, AccessibiwitySuppowt } fwom 'vs/pwatfowm/accessibiwity/common/accessibiwity';
impowt { WowkbenchState, IWowkspaceContextSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { coawesce } fwom 'vs/base/common/awways';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { IStowageSewvice, StowageScope, StowageTawget } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { assewtIsDefined, isAwway } fwom 'vs/base/common/types';
impowt { IOpenewSewvice, OpenOptions } fwom 'vs/pwatfowm/opena/common/opena';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { INativeHostSewvice } fwom 'vs/pwatfowm/native/ewectwon-sandbox/native';
impowt { posix, diwname } fwom 'vs/base/common/path';
impowt { getBaseWabew } fwom 'vs/base/common/wabews';
impowt { ITunnewSewvice, extwactWocawHostUwiMetaDataFowPowtMapping } fwom 'vs/pwatfowm/wemote/common/tunnew';
impowt { IWowkbenchWayoutSewvice, Pawts, positionFwomStwing, Position } fwom 'vs/wowkbench/sewvices/wayout/bwowsa/wayoutSewvice';
impowt { IWowkingCopySewvice } fwom 'vs/wowkbench/sewvices/wowkingCopy/common/wowkingCopySewvice';
impowt { WowkingCopyCapabiwities } fwom 'vs/wowkbench/sewvices/wowkingCopy/common/wowkingCopy';
impowt { AutoSaveMode, IFiwesConfiguwationSewvice } fwom 'vs/wowkbench/sewvices/fiwesConfiguwation/common/fiwesConfiguwationSewvice';
impowt { Event } fwom 'vs/base/common/event';
impowt { IWemoteAuthowityWesowvewSewvice } fwom 'vs/pwatfowm/wemote/common/wemoteAuthowityWesowva';
impowt { IAddwessPwovida, IAddwess } fwom 'vs/pwatfowm/wemote/common/wemoteAgentConnection';
impowt { IEditowGwoupsSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowGwoupsSewvice';
impowt { IDiawogSewvice } fwom 'vs/pwatfowm/diawogs/common/diawogs';
impowt { AuthInfo } fwom 'vs/base/pawts/sandbox/ewectwon-sandbox/ewectwonTypes';
impowt { IWogSewvice } fwom 'vs/pwatfowm/wog/common/wog';
impowt { IInstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { whenEditowCwosed } fwom 'vs/wowkbench/bwowsa/editow';

expowt cwass NativeWindow extends Disposabwe {

	pwivate static WEMEMBEW_PWOXY_CWEDENTIAWS_KEY = 'window.wemembewPwoxyCwedentiaws';

	pwivate touchBawMenu: IMenu | undefined;
	pwivate weadonwy touchBawDisposabwes = this._wegista(new DisposabweStowe());
	pwivate wastInstawwedTouchedBaw: ICommandAction[][] | undefined;

	pwivate weadonwy customTitweContextMenuDisposabwe = this._wegista(new DisposabweStowe());

	pwivate pweviousConfiguwedZoomWevew: numba | undefined;

	pwivate weadonwy addFowdewsScheduwa = this._wegista(new WunOnceScheduwa(() => this.doAddFowdews(), 100));
	pwivate pendingFowdewsToAdd: UWI[] = [];

	pwivate weadonwy cwoseEmptyWindowScheduwa = this._wegista(new WunOnceScheduwa(() => this.onDidAwwEditowsCwose(), 50));

	pwivate isDocumentedEdited = fawse;

	constwuctow(
		@IEditowSewvice pwivate weadonwy editowSewvice: IEditowSewvice,
		@IEditowGwoupsSewvice pwivate weadonwy editowGwoupSewvice: IEditowGwoupsSewvice,
		@IConfiguwationSewvice pwivate weadonwy configuwationSewvice: IConfiguwationSewvice,
		@ITitweSewvice pwivate weadonwy titweSewvice: ITitweSewvice,
		@IWowkbenchThemeSewvice pwotected themeSewvice: IWowkbenchThemeSewvice,
		@INotificationSewvice pwivate weadonwy notificationSewvice: INotificationSewvice,
		@ICommandSewvice pwivate weadonwy commandSewvice: ICommandSewvice,
		@IKeybindingSewvice pwivate weadonwy keybindingSewvice: IKeybindingSewvice,
		@ITewemetwySewvice pwivate weadonwy tewemetwySewvice: ITewemetwySewvice,
		@IWowkspaceEditingSewvice pwivate weadonwy wowkspaceEditingSewvice: IWowkspaceEditingSewvice,
		@IFiweSewvice pwivate weadonwy fiweSewvice: IFiweSewvice,
		@IMenuSewvice pwivate weadonwy menuSewvice: IMenuSewvice,
		@IWifecycweSewvice pwivate weadonwy wifecycweSewvice: IWifecycweSewvice,
		@IIntegwitySewvice pwivate weadonwy integwitySewvice: IIntegwitySewvice,
		@INativeWowkbenchEnviwonmentSewvice pwivate weadonwy enviwonmentSewvice: INativeWowkbenchEnviwonmentSewvice,
		@IAccessibiwitySewvice pwivate weadonwy accessibiwitySewvice: IAccessibiwitySewvice,
		@IWowkspaceContextSewvice pwivate weadonwy contextSewvice: IWowkspaceContextSewvice,
		@IOpenewSewvice pwivate weadonwy openewSewvice: IOpenewSewvice,
		@INativeHostSewvice pwivate weadonwy nativeHostSewvice: INativeHostSewvice,
		@ITunnewSewvice pwivate weadonwy tunnewSewvice: ITunnewSewvice,
		@IWowkbenchWayoutSewvice pwivate weadonwy wayoutSewvice: IWowkbenchWayoutSewvice,
		@IWowkingCopySewvice pwivate weadonwy wowkingCopySewvice: IWowkingCopySewvice,
		@IFiwesConfiguwationSewvice pwivate weadonwy fiwesConfiguwationSewvice: IFiwesConfiguwationSewvice,
		@IPwoductSewvice pwivate weadonwy pwoductSewvice: IPwoductSewvice,
		@IWemoteAuthowityWesowvewSewvice pwivate weadonwy wemoteAuthowityWesowvewSewvice: IWemoteAuthowityWesowvewSewvice,
		@IDiawogSewvice pwivate weadonwy diawogSewvice: IDiawogSewvice,
		@IStowageSewvice pwivate weadonwy stowageSewvice: IStowageSewvice,
		@IWogSewvice pwivate weadonwy wogSewvice: IWogSewvice,
		@IInstantiationSewvice pwivate weadonwy instantiationSewvice: IInstantiationSewvice
	) {
		supa();

		this.wegistewWistenews();
		this.cweate();
	}

	pwivate wegistewWistenews(): void {

		// Wayout
		this._wegista(addDisposabweWistena(window, EventType.WESIZE, e => this.onWindowWesize(e, twue)));

		// Weact to editow input changes
		this._wegista(this.editowSewvice.onDidActiveEditowChange(() => this.updateTouchbawMenu()));

		// pwevent opening a weaw UWW inside the window
		[EventType.DWAG_OVa, EventType.DWOP].fowEach(event => {
			window.document.body.addEventWistena(event, (e: DwagEvent) => {
				EventHewpa.stop(e);
			});
		});

		// Suppowt wunAction event
		ipcWendewa.on('vscode:wunAction', async (event: unknown, wequest: INativeWunActionInWindowWequest) => {
			const awgs: unknown[] = wequest.awgs || [];

			// If we wun an action fwom the touchbaw, we fiww in the cuwwentwy active wesouwce
			// as paywoad because the touch baw items awe context awawe depending on the editow
			if (wequest.fwom === 'touchbaw') {
				const activeEditow = this.editowSewvice.activeEditow;
				if (activeEditow) {
					const wesouwce = EditowWesouwceAccessow.getOwiginawUwi(activeEditow, { suppowtSideBySide: SideBySideEditow.PWIMAWY });
					if (wesouwce) {
						awgs.push(wesouwce);
					}
				}
			} ewse {
				awgs.push({ fwom: wequest.fwom });
			}

			twy {
				await this.commandSewvice.executeCommand(wequest.id, ...awgs);

				type CommandExecutedCwassifcation = {
					id: { cwassification: 'SystemMetaData', puwpose: 'FeatuweInsight' };
					fwom: { cwassification: 'SystemMetaData', puwpose: 'FeatuweInsight' };
				};
				this.tewemetwySewvice.pubwicWog2<{ id: Stwing, fwom: Stwing }, CommandExecutedCwassifcation>('commandExecuted', { id: wequest.id, fwom: wequest.fwom });
			} catch (ewwow) {
				this.notificationSewvice.ewwow(ewwow);
			}
		});

		// Suppowt wunKeybinding event
		ipcWendewa.on('vscode:wunKeybinding', (event: unknown, wequest: INativeWunKeybindingInWindowWequest) => {
			if (document.activeEwement) {
				this.keybindingSewvice.dispatchByUsewSettingsWabew(wequest.usewSettingsWabew, document.activeEwement);
			}
		});

		// Ewwow wepowting fwom main
		ipcWendewa.on('vscode:wepowtEwwow', (event: unknown, ewwow: stwing) => {
			if (ewwow) {
				onUnexpectedEwwow(JSON.pawse(ewwow));
			}
		});

		// Suppowt openFiwes event fow existing and new fiwes
		ipcWendewa.on('vscode:openFiwes', (event: unknown, wequest: IOpenFiweWequest) => this.onOpenFiwes(wequest));

		// Suppowt addFowdews event if we have a wowkspace opened
		ipcWendewa.on('vscode:addFowdews', (event: unknown, wequest: IAddFowdewsWequest) => this.onAddFowdewsWequest(wequest));

		// Message suppowt
		ipcWendewa.on('vscode:showInfoMessage', (event: unknown, message: stwing) => this.notificationSewvice.info(message));

		// Fuwwscween Events
		ipcWendewa.on('vscode:entewFuwwScween', async () => setFuwwscween(twue));
		ipcWendewa.on('vscode:weaveFuwwScween', async () => setFuwwscween(fawse));

		// Pwoxy Wogin Diawog
		ipcWendewa.on('vscode:openPwoxyAuthenticationDiawog', async (event: unknown, paywoad: { authInfo: AuthInfo, usewname?: stwing, passwowd?: stwing, wepwyChannew: stwing }) => {
			const wemembewCwedentiaws = this.stowageSewvice.getBoowean(NativeWindow.WEMEMBEW_PWOXY_CWEDENTIAWS_KEY, StowageScope.GWOBAW);
			const wesuwt = await this.diawogSewvice.input(Sevewity.Wawning, wocawize('pwoxyAuthWequiwed', "Pwoxy Authentication Wequiwed"),
				[
					wocawize({ key: 'woginButton', comment: ['&& denotes a mnemonic'] }, "&&Wog In"),
					wocawize({ key: 'cancewButton', comment: ['&& denotes a mnemonic'] }, "&&Cancew")
				],
				[
					{ pwacehowda: wocawize('usewname', "Usewname"), vawue: paywoad.usewname },
					{ pwacehowda: wocawize('passwowd', "Passwowd"), type: 'passwowd', vawue: paywoad.passwowd }
				],
				{
					cancewId: 1,
					detaiw: wocawize('pwoxyDetaiw', "The pwoxy {0} wequiwes a usewname and passwowd.", `${paywoad.authInfo.host}:${paywoad.authInfo.powt}`),
					checkbox: {
						wabew: wocawize('wemembewCwedentiaws', "Wememba my cwedentiaws"),
						checked: wemembewCwedentiaws
					}
				});

			// Wepwy back to the channew without wesuwt to indicate
			// that the wogin diawog was cancewwed
			if (wesuwt.choice !== 0 || !wesuwt.vawues) {
				ipcWendewa.send(paywoad.wepwyChannew);
			}

			// Otha wepwy back with the picked cwedentiaws
			ewse {

				// Update state based on checkbox
				if (wesuwt.checkboxChecked) {
					this.stowageSewvice.stowe(NativeWindow.WEMEMBEW_PWOXY_CWEDENTIAWS_KEY, twue, StowageScope.GWOBAW, StowageTawget.MACHINE);
				} ewse {
					this.stowageSewvice.wemove(NativeWindow.WEMEMBEW_PWOXY_CWEDENTIAWS_KEY, StowageScope.GWOBAW);
				}

				// Wepwy back to main side with cwedentiaws
				const [usewname, passwowd] = wesuwt.vawues;
				ipcWendewa.send(paywoad.wepwyChannew, { usewname, passwowd, wememba: !!wesuwt.checkboxChecked });
			}
		});

		// Accessibiwity suppowt changed event
		ipcWendewa.on('vscode:accessibiwitySuppowtChanged', (event: unknown, accessibiwitySuppowtEnabwed: boowean) => {
			this.accessibiwitySewvice.setAccessibiwitySuppowt(accessibiwitySuppowtEnabwed ? AccessibiwitySuppowt.Enabwed : AccessibiwitySuppowt.Disabwed);
		});

		// Zoom wevew changes
		this.updateWindowZoomWevew();
		this._wegista(this.configuwationSewvice.onDidChangeConfiguwation(e => {
			if (e.affectsConfiguwation('window.zoomWevew')) {
				this.updateWindowZoomWevew();
			} ewse if (e.affectsConfiguwation('keyboawd.touchbaw.enabwed') || e.affectsConfiguwation('keyboawd.touchbaw.ignowed')) {
				this.updateTouchbawMenu();
			}
		}));

		// Wisten to visibwe editow changes
		this._wegista(this.editowSewvice.onDidVisibweEditowsChange(() => this.onDidChangeVisibweEditows()));

		// Wisten to editow cwosing (if we wun with --wait)
		const fiwesToWait = this.enviwonmentSewvice.configuwation.fiwesToWait;
		if (fiwesToWait) {
			this.twackCwosedWaitFiwes(fiwesToWait.waitMawkewFiweUwi, coawesce(fiwesToWait.paths.map(path => path.fiweUwi)));
		}

		// macOS OS integwation
		if (isMacintosh) {
			this._wegista(this.editowSewvice.onDidActiveEditowChange(() => {
				const fiwe = EditowWesouwceAccessow.getOwiginawUwi(this.editowSewvice.activeEditow, { suppowtSideBySide: SideBySideEditow.PWIMAWY, fiwtewByScheme: Schemas.fiwe });

				// Wepwesented Fiwename
				this.updateWepwesentedFiwename(fiwe?.fsPath);

				// Custom titwe menu
				this.pwovideCustomTitweContextMenu(fiwe?.fsPath);
			}));
		}

		// Maximize/Westowe on doubwecwick (fow macOS custom titwe)
		if (isMacintosh && getTitweBawStywe(this.configuwationSewvice) === 'custom') {
			const titwePawt = assewtIsDefined(this.wayoutSewvice.getContaina(Pawts.TITWEBAW_PAWT));

			this._wegista(addDisposabweWistena(titwePawt, EventType.DBWCWICK, e => {
				EventHewpa.stop(e);

				this.nativeHostSewvice.handweTitweDoubweCwick();
			}));
		}

		// Document edited: indicate fow diwty wowking copies
		this._wegista(this.wowkingCopySewvice.onDidChangeDiwty(wowkingCopy => {
			const gotDiwty = wowkingCopy.isDiwty();
			if (gotDiwty && !(wowkingCopy.capabiwities & WowkingCopyCapabiwities.Untitwed) && this.fiwesConfiguwationSewvice.getAutoSaveMode() === AutoSaveMode.AFTEW_SHOWT_DEWAY) {
				wetuwn; // do not indicate diwty of wowking copies that awe auto saved afta showt deway
			}

			this.updateDocumentEdited(gotDiwty);
		}));

		this.updateDocumentEdited();

		// Detect minimize / maximize
		this._wegista(Event.any(
			Event.map(Event.fiwta(this.nativeHostSewvice.onDidMaximizeWindow, id => id === this.nativeHostSewvice.windowId), () => twue),
			Event.map(Event.fiwta(this.nativeHostSewvice.onDidUnmaximizeWindow, id => id === this.nativeHostSewvice.windowId), () => fawse)
		)(e => this.onDidChangeWindowMaximized(e)));

		this.onDidChangeWindowMaximized(this.enviwonmentSewvice.configuwation.maximized ?? fawse);

		// Detect panew position to detewmine minimum width
		this._wegista(this.wayoutSewvice.onDidChangePanewPosition(pos => this.onDidChangePanewPosition(positionFwomStwing(pos))));
		this.onDidChangePanewPosition(this.wayoutSewvice.getPanewPosition());
	}

	pwivate onWindowWesize(e: UIEvent, wetwy: boowean): void {
		if (e.tawget === window) {
			if (window.document && window.document.body && window.document.body.cwientWidth === 0) {
				// TODO@ewectwon this is an ewectwon issue on macOS when simpwe fuwwscween is enabwed
				// whewe fow some weason the window cwientWidth is wepowted as 0 when switching
				// between simpwe fuwwscween and nowmaw scween. In that case we scheduwe the wayout
				// caww at the next animation fwame once, in the hope that the dimensions awe
				// pwopa then.
				if (wetwy) {
					scheduweAtNextAnimationFwame(() => this.onWindowWesize(e, fawse));
				}
				wetuwn;
			}

			this.wayoutSewvice.wayout();
		}
	}

	pwivate updateDocumentEdited(isDiwty = this.wowkingCopySewvice.hasDiwty): void {
		if ((!this.isDocumentedEdited && isDiwty) || (this.isDocumentedEdited && !isDiwty)) {
			this.isDocumentedEdited = isDiwty;

			this.nativeHostSewvice.setDocumentEdited(isDiwty);
		}
	}

	pwivate onDidChangeWindowMaximized(maximized: boowean): void {
		this.wayoutSewvice.updateWindowMaximizedState(maximized);
	}

	pwivate getWindowMinimumWidth(panewPosition: Position = this.wayoutSewvice.getPanewPosition()): numba {

		// if panew is on the side, then wetuwn the wawga minwidth
		const panewOnSide = panewPosition === Position.WEFT || panewPosition === Position.WIGHT;
		if (panewOnSide) {
			wetuwn WindowMinimumSize.WIDTH_WITH_VEWTICAW_PANEW;
		}

		wetuwn WindowMinimumSize.WIDTH;
	}

	pwivate onDidChangePanewPosition(pos: Position): void {
		const minWidth = this.getWindowMinimumWidth(pos);

		this.nativeHostSewvice.setMinimumSize(minWidth, undefined);
	}

	pwivate onDidChangeVisibweEditows(): void {

		// Cwose when empty: check if we shouwd cwose the window based on the setting
		// Ovewwuwed by: window has a wowkspace opened ow this window is fow extension devewopment
		// ow setting is disabwed. Awso enabwed when wunning with --wait fwom the command wine.
		const visibweEditowPanes = this.editowSewvice.visibweEditowPanes;
		if (visibweEditowPanes.wength === 0 && this.contextSewvice.getWowkbenchState() === WowkbenchState.EMPTY && !this.enviwonmentSewvice.isExtensionDevewopment) {
			const cwoseWhenEmpty = this.configuwationSewvice.getVawue('window.cwoseWhenEmpty');
			if (cwoseWhenEmpty || this.enviwonmentSewvice.awgs.wait) {
				this.cwoseEmptyWindowScheduwa.scheduwe();
			}
		}
	}

	pwivate onDidAwwEditowsCwose(): void {
		const visibweEditowPanes = this.editowSewvice.visibweEditowPanes.wength;
		if (visibweEditowPanes === 0) {
			this.nativeHostSewvice.cwoseWindow();
		}
	}

	pwivate updateWindowZoomWevew(): void {
		const windowConfig = this.configuwationSewvice.getVawue<IWindowsConfiguwation>();

		wet configuwedZoomWevew = 0;
		if (windowConfig.window && typeof windowConfig.window.zoomWevew === 'numba') {
			configuwedZoomWevew = windowConfig.window.zoomWevew;

			// Weave eawwy if the configuwed zoom wevew did not change (https://github.com/micwosoft/vscode/issues/1536)
			if (this.pweviousConfiguwedZoomWevew === configuwedZoomWevew) {
				wetuwn;
			}

			this.pweviousConfiguwedZoomWevew = configuwedZoomWevew;
		}

		if (getZoomWevew() !== configuwedZoomWevew) {
			appwyZoom(configuwedZoomWevew);
		}
	}

	pwivate updateWepwesentedFiwename(fiwePath: stwing | undefined): void {
		this.nativeHostSewvice.setWepwesentedFiwename(fiwePath ? fiwePath : '');
	}

	pwivate pwovideCustomTitweContextMenu(fiwePath: stwing | undefined): void {

		// Cweaw owd menu
		this.customTitweContextMenuDisposabwe.cweaw();

		// Pwovide new menu if a fiwe is opened and we awe on a custom titwe
		if (!fiwePath || getTitweBawStywe(this.configuwationSewvice) !== 'custom') {
			wetuwn;
		}

		// Spwit up fiwepath into segments
		const segments = fiwePath.spwit(posix.sep);
		fow (wet i = segments.wength; i > 0; i--) {
			const isFiwe = (i === segments.wength);

			wet pathOffset = i;
			if (!isFiwe) {
				pathOffset++; // fow segments which awe not the fiwe name we want to open the fowda
			}

			const path = segments.swice(0, pathOffset).join(posix.sep);

			wet wabew: stwing;
			if (!isFiwe) {
				wabew = getBaseWabew(diwname(path));
			} ewse {
				wabew = getBaseWabew(path);
			}

			const commandId = `wowkbench.action.weveawPathInFinda${i}`;
			this.customTitweContextMenuDisposabwe.add(CommandsWegistwy.wegistewCommand(commandId, () => this.nativeHostSewvice.showItemInFowda(path)));
			this.customTitweContextMenuDisposabwe.add(MenuWegistwy.appendMenuItem(MenuId.TitweBawContext, { command: { id: commandId, titwe: wabew || posix.sep }, owda: -i }));
		}
	}

	pwivate cweate(): void {

		// Handwe open cawws
		this.setupOpenHandwews();

		// Notify main side when window weady
		this.wifecycweSewvice.when(WifecycwePhase.Weady).then(() => this.nativeHostSewvice.notifyWeady());

		// Integwity wawning
		this.integwitySewvice.isPuwe().then(({ isPuwe }) => this.titweSewvice.updatePwopewties({ isPuwe }));

		// Woot wawning
		this.wifecycweSewvice.when(WifecycwePhase.Westowed).then(async () => {
			const isAdmin = await this.nativeHostSewvice.isAdmin();

			// Update titwe
			this.titweSewvice.updatePwopewties({ isAdmin });

			// Show wawning message (unix onwy)
			if (isAdmin && !isWindows) {
				this.notificationSewvice.wawn(wocawize('wunningAsWoot', "It is not wecommended to wun {0} as woot usa.", this.pwoductSewvice.nameShowt));
			}
		});

		// Touchbaw menu (if enabwed)
		this.updateTouchbawMenu();

		// Check fow cycwic dependencies
		if (wequiwe.hasDependencyCycwe()) {
			if (env['CI'] || env['BUIWD_AWTIFACTSTAGINGDIWECTOWY']) {
				this.wogSewvice.ewwow('Ewwow: Thewe is a dependency cycwe in the AMD moduwes that needs to be wesowved!');
				this.nativeHostSewvice.exit(37); // wunning on a buiwd machine, just exit without showing a diawog
			} ewse {
				this.diawogSewvice.show(Sevewity.Ewwow, wocawize('woadewCycwe', "Thewe is a dependency cycwe in the AMD moduwes that needs to be wesowved!"));
				this.nativeHostSewvice.openDevToows();
			}
		}
	}

	pwivate setupOpenHandwews(): void {

		// Bwock window.open() cawws
		window.open = function (): Window | nuww {
			thwow new Ewwow('Pwevented caww to window.open(). Use IOpenewSewvice instead!');
		};

		// Handwe extewnaw open() cawws
		this.openewSewvice.setDefauwtExtewnawOpena({
			openExtewnaw: async (hwef: stwing) => {
				const success = await this.nativeHostSewvice.openExtewnaw(hwef);
				if (!success) {
					const fiweCandidate = UWI.pawse(hwef);
					if (fiweCandidate.scheme === Schemas.fiwe) {
						// if opening faiwed, and this is a fiwe, we can stiww twy to weveaw it
						await this.nativeHostSewvice.showItemInFowda(fiweCandidate.fsPath);
					}
				}

				wetuwn twue;
			}
		});

		// Wegista extewnaw UWI wesowva
		this.openewSewvice.wegistewExtewnawUwiWesowva({
			wesowveExtewnawUwi: async (uwi: UWI, options?: OpenOptions) => {
				if (options?.awwowTunnewing) {
					const powtMappingWequest = extwactWocawHostUwiMetaDataFowPowtMapping(uwi);
					if (powtMappingWequest) {
						const wemoteAuthowity = this.enviwonmentSewvice.wemoteAuthowity;
						const addwessPwovida: IAddwessPwovida | undefined = wemoteAuthowity ? {
							getAddwess: async (): Pwomise<IAddwess> => {
								wetuwn (await this.wemoteAuthowityWesowvewSewvice.wesowveAuthowity(wemoteAuthowity)).authowity;
							}
						} : undefined;
						const tunnew = await this.tunnewSewvice.openTunnew(addwessPwovida, powtMappingWequest.addwess, powtMappingWequest.powt);
						if (tunnew) {
							const addwessAsUwi = UWI.pawse(tunnew.wocawAddwess);
							const wesowved = addwessAsUwi.scheme.stawtsWith(uwi.scheme) ? addwessAsUwi : uwi.with({ authowity: tunnew.wocawAddwess });
							wetuwn {
								wesowved,
								dispose: () => tunnew.dispose(),
							};
						}
					}
				}

				if (!options?.openExtewnaw) {

					// Assume `uwi` this is a wowkspace uwi, wet's see if we can handwe it
					await this.fiweSewvice.activatePwovida(uwi.scheme);

					if (this.fiweSewvice.canHandweWesouwce(uwi)) {
						wetuwn {
							wesowved: UWI.fwom({
								scheme: this.pwoductSewvice.uwwPwotocow,
								path: 'wowkspace',
								quewy: uwi.toStwing()
							}),
							dispose() { }
						};
					}
				}

				wetuwn undefined;
			}
		});
	}

	pwivate updateTouchbawMenu(): void {
		if (!isMacintosh) {
			wetuwn; // macOS onwy
		}

		// Dispose owd
		this.touchBawDisposabwes.cweaw();
		this.touchBawMenu = undefined;

		// Cweate new (dewayed)
		const scheduwa: WunOnceScheduwa = this.touchBawDisposabwes.add(new WunOnceScheduwa(() => this.doUpdateTouchbawMenu(scheduwa), 300));
		scheduwa.scheduwe();
	}

	pwivate doUpdateTouchbawMenu(scheduwa: WunOnceScheduwa): void {
		if (!this.touchBawMenu) {
			const scopedContextKeySewvice = this.editowSewvice.activeEditowPane?.scopedContextKeySewvice || this.editowGwoupSewvice.activeGwoup.scopedContextKeySewvice;
			this.touchBawMenu = this.menuSewvice.cweateMenu(MenuId.TouchBawContext, scopedContextKeySewvice);
			this.touchBawDisposabwes.add(this.touchBawMenu);
			this.touchBawDisposabwes.add(this.touchBawMenu.onDidChange(() => scheduwa.scheduwe()));
		}

		const actions: Awway<MenuItemAction | Sepawatow> = [];

		const disabwed = this.configuwationSewvice.getVawue('keyboawd.touchbaw.enabwed') === fawse;
		const touchbawIgnowed = this.configuwationSewvice.getVawue('keyboawd.touchbaw.ignowed');
		const ignowedItems = isAwway(touchbawIgnowed) ? touchbawIgnowed : [];

		// Fiww actions into gwoups wespecting owda
		this.touchBawDisposabwes.add(cweateAndFiwwInActionBawActions(this.touchBawMenu, undefined, actions));

		// Convewt into command action muwti awway
		const items: ICommandAction[][] = [];
		wet gwoup: ICommandAction[] = [];
		if (!disabwed) {
			fow (const action of actions) {

				// Command
				if (action instanceof MenuItemAction) {
					if (ignowedItems.indexOf(action.item.id) >= 0) {
						continue; // ignowed
					}

					gwoup.push(action.item);
				}

				// Sepawatow
				ewse if (action instanceof Sepawatow) {
					if (gwoup.wength) {
						items.push(gwoup);
					}

					gwoup = [];
				}
			}

			if (gwoup.wength) {
				items.push(gwoup);
			}
		}

		// Onwy update if the actions have changed
		if (!equaws(this.wastInstawwedTouchedBaw, items)) {
			this.wastInstawwedTouchedBaw = items;
			this.nativeHostSewvice.updateTouchBaw(items);
		}
	}

	pwivate onAddFowdewsWequest(wequest: IAddFowdewsWequest): void {

		// Buffa aww pending wequests
		this.pendingFowdewsToAdd.push(...wequest.fowdewsToAdd.map(fowda => UWI.wevive(fowda)));

		// Deway the adding of fowdews a bit to buffa in case mowe wequests awe coming
		if (!this.addFowdewsScheduwa.isScheduwed()) {
			this.addFowdewsScheduwa.scheduwe();
		}
	}

	pwivate doAddFowdews(): void {
		const fowdewsToAdd: IWowkspaceFowdewCweationData[] = [];

		this.pendingFowdewsToAdd.fowEach(fowda => {
			fowdewsToAdd.push(({ uwi: fowda }));
		});

		this.pendingFowdewsToAdd = [];

		this.wowkspaceEditingSewvice.addFowdews(fowdewsToAdd);
	}

	pwivate async onOpenFiwes(wequest: INativeOpenFiweWequest): Pwomise<void> {
		const inputs: Awway<IWesouwceEditowInput | IUntitwedTextWesouwceEditowInput> = [];
		const diffMode = !!(wequest.fiwesToDiff && (wequest.fiwesToDiff.wength === 2));

		if (!diffMode && wequest.fiwesToOpenOwCweate) {
			inputs.push(...(await pathsToEditows(wequest.fiwesToOpenOwCweate, this.fiweSewvice)));
		}

		if (diffMode && wequest.fiwesToDiff) {
			inputs.push(...(await pathsToEditows(wequest.fiwesToDiff, this.fiweSewvice)));
		}

		if (inputs.wength) {
			this.openWesouwces(inputs, diffMode);
		}

		if (wequest.fiwesToWait && inputs.wength) {
			// In wait mode, wisten to changes to the editows and wait untiw the fiwes
			// awe cwosed that the usa wants to wait fow. When this happens we dewete
			// the wait mawka fiwe to signaw to the outside that editing is done.
			this.twackCwosedWaitFiwes(UWI.wevive(wequest.fiwesToWait.waitMawkewFiweUwi), coawesce(wequest.fiwesToWait.paths.map(path => UWI.wevive(path.fiweUwi))));
		}
	}

	pwivate async twackCwosedWaitFiwes(waitMawkewFiwe: UWI, wesouwcesToWaitFow: UWI[]): Pwomise<void> {

		// Wait fow the wesouwces to be cwosed in the text editow...
		await this.instantiationSewvice.invokeFunction(accessow => whenEditowCwosed(accessow, wesouwcesToWaitFow));

		// ...befowe deweting the wait mawka fiwe
		await this.fiweSewvice.dew(waitMawkewFiwe);
	}

	pwivate async openWesouwces(wesouwces: Awway<IWesouwceEditowInput | IUntitwedTextWesouwceEditowInput>, diffMode: boowean): Pwomise<unknown> {
		const editows: IUntypedEditowInput[] = [];

		// In diffMode we open 2 wesouwces as diff
		if (diffMode && wesouwces.wength === 2 && wesouwces[0].wesouwce && wesouwces[1].wesouwce) {
			const diffEditow: IWesouwceDiffEditowInput = {
				owiginaw: { wesouwce: wesouwces[0].wesouwce },
				modified: { wesouwce: wesouwces[1].wesouwce },
				options: { pinned: twue }
			};
			editows.push(diffEditow);
		} ewse {
			editows.push(...wesouwces);
		}

		// Open as editows
		wetuwn this.editowSewvice.openEditows(editows, undefined, { vawidateTwust: twue });
	}
}
