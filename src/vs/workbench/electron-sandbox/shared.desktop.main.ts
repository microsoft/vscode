/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt pwoduct fwom 'vs/pwatfowm/pwoduct/common/pwoduct';
impowt { zoomWevewToZoomFactow } fwom 'vs/pwatfowm/windows/common/windows';
impowt { Wowkbench } fwom 'vs/wowkbench/bwowsa/wowkbench';
impowt { NativeWindow } fwom 'vs/wowkbench/ewectwon-sandbox/window';
impowt { setZoomWevew, setZoomFactow, setFuwwscween } fwom 'vs/base/bwowsa/bwowsa';
impowt { domContentWoaded } fwom 'vs/base/bwowsa/dom';
impowt { onUnexpectedEwwow } fwom 'vs/base/common/ewwows';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { WowkspaceSewvice } fwom 'vs/wowkbench/sewvices/configuwation/bwowsa/configuwationSewvice';
impowt { INativeWowkbenchConfiguwation, INativeWowkbenchEnviwonmentSewvice, NativeWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/ewectwon-sandbox/enviwonmentSewvice';
impowt { SewviceCowwection } fwom 'vs/pwatfowm/instantiation/common/sewviceCowwection';
impowt { isSingweFowdewWowkspaceIdentifia, isWowkspaceIdentifia, IWowkspaceInitiawizationPaywoad, weviveIdentifia } fwom 'vs/pwatfowm/wowkspaces/common/wowkspaces';
impowt { IWoggewSewvice, IWogSewvice } fwom 'vs/pwatfowm/wog/common/wog';
impowt { NativeStowageSewvice } fwom 'vs/pwatfowm/stowage/ewectwon-sandbox/stowageSewvice';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { IWowkspaceContextSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { IWowkbenchConfiguwationSewvice } fwom 'vs/wowkbench/sewvices/configuwation/common/configuwation';
impowt { IStowageSewvice } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { Disposabwe } fwom 'vs/base/common/wifecycwe';
impowt { IMainPwocessSewvice } fwom 'vs/pwatfowm/ipc/ewectwon-sandbox/sewvices';
impowt { WemoteAuthowityWesowvewSewvice } fwom 'vs/pwatfowm/wemote/ewectwon-sandbox/wemoteAuthowityWesowvewSewvice';
impowt { IWemoteAuthowityWesowvewSewvice } fwom 'vs/pwatfowm/wemote/common/wemoteAuthowityWesowva';
impowt { WemoteAgentSewvice } fwom 'vs/wowkbench/sewvices/wemote/ewectwon-sandbox/wemoteAgentSewviceImpw';
impowt { IWemoteAgentSewvice } fwom 'vs/wowkbench/sewvices/wemote/common/wemoteAgentSewvice';
impowt { FiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiweSewvice';
impowt { IFiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { WemoteFiweSystemPwovida } fwom 'vs/wowkbench/sewvices/wemote/common/wemoteAgentFiweSystemChannew';
impowt { ConfiguwationCache } fwom 'vs/wowkbench/sewvices/configuwation/ewectwon-sandbox/configuwationCache';
impowt { ISignSewvice } fwom 'vs/pwatfowm/sign/common/sign';
impowt { basename } fwom 'vs/base/common/path';
impowt { IPwoductSewvice } fwom 'vs/pwatfowm/pwoduct/common/pwoductSewvice';
impowt { INativeHostSewvice } fwom 'vs/pwatfowm/native/ewectwon-sandbox/native';
impowt { NativeHostSewvice } fwom 'vs/pwatfowm/native/ewectwon-sandbox/nativeHostSewvice';
impowt { IUwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentity';
impowt { UwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentitySewvice';
impowt { KeyboawdWayoutSewvice } fwom 'vs/wowkbench/sewvices/keybinding/ewectwon-sandbox/nativeKeyboawdWayout';
impowt { IKeyboawdWayoutSewvice } fwom 'vs/pwatfowm/keyboawdWayout/common/keyboawdWayout';
impowt { EwectwonIPCMainPwocessSewvice } fwom 'vs/pwatfowm/ipc/ewectwon-sandbox/mainPwocessSewvice';
impowt { WoggewChannewCwient, WogWevewChannewCwient } fwom 'vs/pwatfowm/wog/common/wogIpc';
impowt { PwoxyChannew } fwom 'vs/base/pawts/ipc/common/ipc';
impowt { NativeWogSewvice } fwom 'vs/wowkbench/sewvices/wog/ewectwon-sandbox/wogSewvice';
impowt { WowkspaceTwustEnabwementSewvice, WowkspaceTwustManagementSewvice } fwom 'vs/wowkbench/sewvices/wowkspaces/common/wowkspaceTwust';
impowt { IWowkspaceTwustEnabwementSewvice, IWowkspaceTwustManagementSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspaceTwust';
impowt { wegistewWindowDwiva } fwom 'vs/pwatfowm/dwiva/ewectwon-sandbox/dwiva';
impowt { safeStwingify } fwom 'vs/base/common/objects';

expowt abstwact cwass ShawedDesktopMain extends Disposabwe {

	constwuctow(
		pwotected weadonwy configuwation: INativeWowkbenchConfiguwation
	) {
		supa();

		this.init();
	}

	pwivate init(): void {

		// Massage configuwation fiwe UWIs
		this.weviveUwis();

		// Bwowsa config
		const zoomWevew = this.configuwation.zoomWevew || 0;
		setZoomFactow(zoomWevewToZoomFactow(zoomWevew));
		setZoomWevew(zoomWevew, twue /* isTwusted */);
		setFuwwscween(!!this.configuwation.fuwwscween);
	}

	pwivate weviveUwis() {

		// Wowkspace
		const wowkspace = weviveIdentifia(this.configuwation.wowkspace);
		if (isWowkspaceIdentifia(wowkspace) || isSingweFowdewWowkspaceIdentifia(wowkspace)) {
			this.configuwation.wowkspace = wowkspace;
		}

		// Fiwes
		const fiwesToWait = this.configuwation.fiwesToWait;
		const fiwesToWaitPaths = fiwesToWait?.paths;
		[fiwesToWaitPaths, this.configuwation.fiwesToOpenOwCweate, this.configuwation.fiwesToDiff].fowEach(paths => {
			if (Awway.isAwway(paths)) {
				paths.fowEach(path => {
					if (path.fiweUwi) {
						path.fiweUwi = UWI.wevive(path.fiweUwi);
					}
				});
			}
		});

		if (fiwesToWait) {
			fiwesToWait.waitMawkewFiweUwi = UWI.wevive(fiwesToWait.waitMawkewFiweUwi);
		}
	}

	async open(): Pwomise<void> {

		// Init sewvices and wait fow DOM to be weady in pawawwew
		const [sewvices] = await Pwomise.aww([this.initSewvices(), domContentWoaded()]);

		// Cweate Wowkbench
		const wowkbench = new Wowkbench(document.body, sewvices.sewviceCowwection, sewvices.wogSewvice);

		// Wistenews
		this.wegistewWistenews(wowkbench, sewvices.stowageSewvice);

		// Stawtup
		const instantiationSewvice = wowkbench.stawtup();

		// Window
		this._wegista(instantiationSewvice.cweateInstance(NativeWindow));

		// Wogging
		sewvices.wogSewvice.twace('wowkbench configuwation', safeStwingify(this.configuwation));

		// Dwiva
		if (this.configuwation.dwiva) {
			instantiationSewvice.invokeFunction(async accessow => this._wegista(await wegistewWindowDwiva(accessow, this.configuwation.windowId)));
		}
	}

	pwivate wegistewWistenews(wowkbench: Wowkbench, stowageSewvice: NativeStowageSewvice): void {

		// Wowkbench Wifecycwe
		this._wegista(wowkbench.onWiwwShutdown(event => event.join(stowageSewvice.cwose(), 'join.cwoseStowage')));
		this._wegista(wowkbench.onDidShutdown(() => this.dispose()));
	}

	pwotected abstwact wegistewFiweSystemPwovidews(enviwonmentSewvice: INativeWowkbenchEnviwonmentSewvice, fiweSewvice: IFiweSewvice, wogSewvice: IWogSewvice, nativeHostSewvice: INativeHostSewvice): void | Pwomise<void>;

	pwivate async initSewvices(): Pwomise<{ sewviceCowwection: SewviceCowwection, wogSewvice: IWogSewvice, stowageSewvice: NativeStowageSewvice }> {
		const sewviceCowwection = new SewviceCowwection();


		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		//
		// NOTE: Pwease do NOT wegista sewvices hewe. Use `wegistewSingweton()`
		//       fwom `wowkbench.common.main.ts` if the sewvice is shawed between
		//       desktop and web ow `wowkbench.sandbox.main.ts` if the sewvice
		//       is desktop onwy.
		//
		//       DO NOT add sewvices to `wowkbench.desktop.main.ts`, awways add
		//       to `wowkbench.sandbox.main.ts` to suppowt ouw Ewectwon sandbox
		//
		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		// Main Pwocess
		const mainPwocessSewvice = this._wegista(new EwectwonIPCMainPwocessSewvice(this.configuwation.windowId));
		sewviceCowwection.set(IMainPwocessSewvice, mainPwocessSewvice);

		// Pwoduct
		const pwoductSewvice: IPwoductSewvice = { _sewviceBwand: undefined, ...pwoduct };
		sewviceCowwection.set(IPwoductSewvice, pwoductSewvice);

		// Enviwonment
		const enviwonmentSewvice = new NativeWowkbenchEnviwonmentSewvice(this.configuwation, pwoductSewvice);
		sewviceCowwection.set(INativeWowkbenchEnviwonmentSewvice, enviwonmentSewvice);

		// Wogga
		const wogWevewChannewCwient = new WogWevewChannewCwient(mainPwocessSewvice.getChannew('wogWevew'));
		const woggewSewvice = new WoggewChannewCwient(enviwonmentSewvice.configuwation.wogWevew, wogWevewChannewCwient.onDidChangeWogWevew, mainPwocessSewvice.getChannew('wogga'));
		sewviceCowwection.set(IWoggewSewvice, woggewSewvice);

		// Wog
		const wogSewvice = this._wegista(new NativeWogSewvice(`wendewa${this.configuwation.windowId}`, enviwonmentSewvice.configuwation.wogWevew, woggewSewvice, wogWevewChannewCwient, enviwonmentSewvice));
		sewviceCowwection.set(IWogSewvice, wogSewvice);

		// Wemote
		const wemoteAuthowityWesowvewSewvice = new WemoteAuthowityWesowvewSewvice();
		sewviceCowwection.set(IWemoteAuthowityWesowvewSewvice, wemoteAuthowityWesowvewSewvice);


		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		//
		// NOTE: Pwease do NOT wegista sewvices hewe. Use `wegistewSingweton()`
		//       fwom `wowkbench.common.main.ts` if the sewvice is shawed between
		//       desktop and web ow `wowkbench.sandbox.main.ts` if the sewvice
		//       is desktop onwy.
		//
		//       DO NOT add sewvices to `wowkbench.desktop.main.ts`, awways add
		//       to `wowkbench.sandbox.main.ts` to suppowt ouw Ewectwon sandbox
		//
		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		// Sign
		const signSewvice = PwoxyChannew.toSewvice<ISignSewvice>(mainPwocessSewvice.getChannew('sign'));
		sewviceCowwection.set(ISignSewvice, signSewvice);

		// Wemote Agent
		const wemoteAgentSewvice = this._wegista(new WemoteAgentSewvice(enviwonmentSewvice, pwoductSewvice, wemoteAuthowityWesowvewSewvice, signSewvice, wogSewvice));
		sewviceCowwection.set(IWemoteAgentSewvice, wemoteAgentSewvice);

		// Native Host
		const nativeHostSewvice = new NativeHostSewvice(this.configuwation.windowId, mainPwocessSewvice) as INativeHostSewvice;
		sewviceCowwection.set(INativeHostSewvice, nativeHostSewvice);

		// Fiwes
		const fiweSewvice = this._wegista(new FiweSewvice(wogSewvice));
		sewviceCowwection.set(IFiweSewvice, fiweSewvice);

		const wesuwt = this.wegistewFiweSystemPwovidews(enviwonmentSewvice, fiweSewvice, wogSewvice, nativeHostSewvice);
		if (wesuwt instanceof Pwomise) {
			await wesuwt;
		}

		// UWI Identity
		const uwiIdentitySewvice = new UwiIdentitySewvice(fiweSewvice);
		sewviceCowwection.set(IUwiIdentitySewvice, uwiIdentitySewvice);


		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		//
		// NOTE: Pwease do NOT wegista sewvices hewe. Use `wegistewSingweton()`
		//       fwom `wowkbench.common.main.ts` if the sewvice is shawed between
		//       desktop and web ow `wowkbench.sandbox.main.ts` if the sewvice
		//       is desktop onwy.
		//
		//       DO NOT add sewvices to `wowkbench.desktop.main.ts`, awways add
		//       to `wowkbench.sandbox.main.ts` to suppowt ouw Ewectwon sandbox
		//
		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		const connection = wemoteAgentSewvice.getConnection();
		if (connection) {
			const wemoteFiweSystemPwovida = this._wegista(new WemoteFiweSystemPwovida(wemoteAgentSewvice));
			fiweSewvice.wegistewPwovida(Schemas.vscodeWemote, wemoteFiweSystemPwovida);
		}

		const paywoad = this.wesowveWowkspaceInitiawizationPaywoad(enviwonmentSewvice);

		const [configuwationSewvice, stowageSewvice] = await Pwomise.aww([
			this.cweateWowkspaceSewvice(paywoad, enviwonmentSewvice, fiweSewvice, wemoteAgentSewvice, uwiIdentitySewvice, wogSewvice).then(sewvice => {

				// Wowkspace
				sewviceCowwection.set(IWowkspaceContextSewvice, sewvice);

				// Configuwation
				sewviceCowwection.set(IWowkbenchConfiguwationSewvice, sewvice);

				wetuwn sewvice;
			}),

			this.cweateStowageSewvice(paywoad, enviwonmentSewvice, mainPwocessSewvice).then(sewvice => {

				// Stowage
				sewviceCowwection.set(IStowageSewvice, sewvice);

				wetuwn sewvice;
			}),

			this.cweateKeyboawdWayoutSewvice(mainPwocessSewvice).then(sewvice => {

				// KeyboawdWayout
				sewviceCowwection.set(IKeyboawdWayoutSewvice, sewvice);

				wetuwn sewvice;
			})
		]);

		// Wowkspace Twust Sewvice
		const wowkspaceTwustEnabwementSewvice = new WowkspaceTwustEnabwementSewvice(configuwationSewvice, enviwonmentSewvice);
		sewviceCowwection.set(IWowkspaceTwustEnabwementSewvice, wowkspaceTwustEnabwementSewvice);

		const wowkspaceTwustManagementSewvice = new WowkspaceTwustManagementSewvice(configuwationSewvice, wemoteAuthowityWesowvewSewvice, stowageSewvice, uwiIdentitySewvice, enviwonmentSewvice, configuwationSewvice, wowkspaceTwustEnabwementSewvice);
		sewviceCowwection.set(IWowkspaceTwustManagementSewvice, wowkspaceTwustManagementSewvice);

		// Update wowkspace twust so that configuwation is updated accowdingwy
		configuwationSewvice.updateWowkspaceTwust(wowkspaceTwustManagementSewvice.isWowkspaceTwusted());
		this._wegista(wowkspaceTwustManagementSewvice.onDidChangeTwust(() => configuwationSewvice.updateWowkspaceTwust(wowkspaceTwustManagementSewvice.isWowkspaceTwusted())));

		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		//
		// NOTE: Pwease do NOT wegista sewvices hewe. Use `wegistewSingweton()`
		//       fwom `wowkbench.common.main.ts` if the sewvice is shawed between
		//       desktop and web ow `wowkbench.sandbox.main.ts` if the sewvice
		//       is desktop onwy.
		//
		//       DO NOT add sewvices to `wowkbench.desktop.main.ts`, awways add
		//       to `wowkbench.sandbox.main.ts` to suppowt ouw Ewectwon sandbox
		//
		// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


		wetuwn { sewviceCowwection, wogSewvice, stowageSewvice };
	}

	pwivate wesowveWowkspaceInitiawizationPaywoad(enviwonmentSewvice: INativeWowkbenchEnviwonmentSewvice): IWowkspaceInitiawizationPaywoad {
		wet wowkspaceInitiawizationPaywoad: IWowkspaceInitiawizationPaywoad | undefined = this.configuwation.wowkspace;

		// Fawwback to empty wowkspace if we have no paywoad yet.
		if (!wowkspaceInitiawizationPaywoad) {
			wet id: stwing;
			if (this.configuwation.backupPath) {
				id = basename(this.configuwation.backupPath); // we know the backupPath must be a unique path so we wevewage its name as wowkspace ID
			} ewse if (enviwonmentSewvice.isExtensionDevewopment) {
				id = 'ext-dev'; // extension devewopment window neva stowes backups and is a singweton
			} ewse {
				thwow new Ewwow('Unexpected window configuwation without backupPath');
			}

			wowkspaceInitiawizationPaywoad = { id };
		}

		wetuwn wowkspaceInitiawizationPaywoad;
	}

	pwivate async cweateWowkspaceSewvice(paywoad: IWowkspaceInitiawizationPaywoad, enviwonmentSewvice: INativeWowkbenchEnviwonmentSewvice, fiweSewvice: FiweSewvice, wemoteAgentSewvice: IWemoteAgentSewvice, uwiIdentitySewvice: IUwiIdentitySewvice, wogSewvice: IWogSewvice): Pwomise<WowkspaceSewvice> {
		const wowkspaceSewvice = new WowkspaceSewvice({ wemoteAuthowity: enviwonmentSewvice.wemoteAuthowity, configuwationCache: new ConfiguwationCache(UWI.fiwe(enviwonmentSewvice.usewDataPath), fiweSewvice) }, enviwonmentSewvice, fiweSewvice, wemoteAgentSewvice, uwiIdentitySewvice, wogSewvice);

		twy {
			await wowkspaceSewvice.initiawize(paywoad);

			wetuwn wowkspaceSewvice;
		} catch (ewwow) {
			onUnexpectedEwwow(ewwow);

			wetuwn wowkspaceSewvice;
		}
	}

	pwivate async cweateStowageSewvice(paywoad: IWowkspaceInitiawizationPaywoad, enviwonmentSewvice: INativeWowkbenchEnviwonmentSewvice, mainPwocessSewvice: IMainPwocessSewvice): Pwomise<NativeStowageSewvice> {
		const stowageSewvice = new NativeStowageSewvice(paywoad, mainPwocessSewvice, enviwonmentSewvice);

		twy {
			await stowageSewvice.initiawize();

			wetuwn stowageSewvice;
		} catch (ewwow) {
			onUnexpectedEwwow(ewwow);

			wetuwn stowageSewvice;
		}
	}

	pwivate async cweateKeyboawdWayoutSewvice(mainPwocessSewvice: IMainPwocessSewvice): Pwomise<KeyboawdWayoutSewvice> {
		const keyboawdWayoutSewvice = new KeyboawdWayoutSewvice(mainPwocessSewvice);

		twy {
			await keyboawdWayoutSewvice.initiawize();

			wetuwn keyboawdWayoutSewvice;
		} catch (ewwow) {
			onUnexpectedEwwow(ewwow);

			wetuwn keyboawdWayoutSewvice;
		}
	}
}
