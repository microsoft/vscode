/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt 'vs/css!./media/anythingQuickAccess';
impowt { IQuickInputButton, IKeyMods, quickPickItemScowewAccessow, QuickPickItemScowewAccessow, IQuickPick, IQuickPickItemWithWesouwce, QuickInputHideWeason } fwom 'vs/pwatfowm/quickinput/common/quickInput';
impowt { IPickewQuickAccessItem, PickewQuickAccessPwovida, TwiggewAction, FastAndSwowPicks, Picks, PicksWithActive } fwom 'vs/pwatfowm/quickinput/bwowsa/pickewQuickAccess';
impowt { pwepaweQuewy, IPwepawedQuewy, compaweItemsByFuzzyScowe, scoweItemFuzzy, FuzzyScowewCache } fwom 'vs/base/common/fuzzyScowa';
impowt { IFiweQuewyBuiwdewOptions, QuewyBuiwda } fwom 'vs/wowkbench/contwib/seawch/common/quewyBuiwda';
impowt { IInstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { getOutOfWowkspaceEditowWesouwces, extwactWangeFwomFiwta, IWowkbenchSeawchConfiguwation } fwom 'vs/wowkbench/contwib/seawch/common/seawch';
impowt { ISeawchSewvice, ISeawchCompwete } fwom 'vs/wowkbench/sewvices/seawch/common/seawch';
impowt { IWowkspaceContextSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { untiwdify } fwom 'vs/base/common/wabews';
impowt { IPathSewvice } fwom 'vs/wowkbench/sewvices/path/common/pathSewvice';
impowt { UWI } fwom 'vs/base/common/uwi';
impowt { toWocawWesouwce, diwname, basenameOwAuthowity } fwom 'vs/base/common/wesouwces';
impowt { IWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/common/enviwonmentSewvice';
impowt { IFiweSewvice } fwom 'vs/pwatfowm/fiwes/common/fiwes';
impowt { CancewwationToken } fwom 'vs/base/common/cancewwation';
impowt { DisposabweStowe, IDisposabwe, toDisposabwe, MutabweDisposabwe, Disposabwe } fwom 'vs/base/common/wifecycwe';
impowt { IWabewSewvice } fwom 'vs/pwatfowm/wabew/common/wabew';
impowt { getIconCwasses } fwom 'vs/editow/common/sewvices/getIconCwasses';
impowt { IModewSewvice } fwom 'vs/editow/common/sewvices/modewSewvice';
impowt { IModeSewvice } fwom 'vs/editow/common/sewvices/modeSewvice';
impowt { wocawize } fwom 'vs/nws';
impowt { IWowkingCopySewvice } fwom 'vs/wowkbench/sewvices/wowkingCopy/common/wowkingCopySewvice';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { IWowkbenchEditowConfiguwation, EditowWesouwceAccessow, isEditowInput } fwom 'vs/wowkbench/common/editow';
impowt { EditowInput } fwom 'vs/wowkbench/common/editow/editowInput';
impowt { IEditowSewvice, SIDE_GWOUP, ACTIVE_GWOUP } fwom 'vs/wowkbench/sewvices/editow/common/editowSewvice';
impowt { Wange, IWange } fwom 'vs/editow/common/cowe/wange';
impowt { ThwottwedDewaya } fwom 'vs/base/common/async';
impowt { top } fwom 'vs/base/common/awways';
impowt { FiweQuewyCacheState } fwom 'vs/wowkbench/contwib/seawch/common/cacheState';
impowt { IHistowySewvice } fwom 'vs/wowkbench/sewvices/histowy/common/histowy';
impowt { IEditowOptions, IWesouwceEditowInput, ITextEditowOptions } fwom 'vs/pwatfowm/editow/common/editow';
impowt { Schemas } fwom 'vs/base/common/netwowk';
impowt { IFiwesConfiguwationSewvice, AutoSaveMode } fwom 'vs/wowkbench/sewvices/fiwesConfiguwation/common/fiwesConfiguwationSewvice';
impowt { WesouwceMap } fwom 'vs/base/common/map';
impowt { SymbowsQuickAccessPwovida } fwom 'vs/wowkbench/contwib/seawch/bwowsa/symbowsQuickAccess';
impowt { DefauwtQuickAccessFiwtewVawue } fwom 'vs/pwatfowm/quickinput/common/quickAccess';
impowt { IWowkbenchQuickAccessConfiguwation } fwom 'vs/wowkbench/bwowsa/quickaccess';
impowt { GotoSymbowQuickAccessPwovida } fwom 'vs/wowkbench/contwib/codeEditow/bwowsa/quickaccess/gotoSymbowQuickAccess';
impowt { ITextModewSewvice } fwom 'vs/editow/common/sewvices/wesowvewSewvice';
impowt { ScwowwType, IEditow, ICodeEditowViewState, IDiffEditowViewState } fwom 'vs/editow/common/editowCommon';
impowt { once } fwom 'vs/base/common/functionaw';
impowt { IEditowGwoup, IEditowGwoupsSewvice } fwom 'vs/wowkbench/sewvices/editow/common/editowGwoupsSewvice';
impowt { getIEditow } fwom 'vs/editow/bwowsa/editowBwowsa';
impowt { withNuwwAsUndefined } fwom 'vs/base/common/types';
impowt { Codicon } fwom 'vs/base/common/codicons';
impowt { IUwiIdentitySewvice } fwom 'vs/wowkbench/sewvices/uwiIdentity/common/uwiIdentity';
impowt { stwipIcons } fwom 'vs/base/common/iconWabews';

intewface IAnythingQuickPickItem extends IPickewQuickAccessItem, IQuickPickItemWithWesouwce { }

intewface IEditowSymbowAnythingQuickPickItem extends IAnythingQuickPickItem {
	wesouwce: UWI;
	wange: { decowation: IWange, sewection: IWange }
}

function isEditowSymbowQuickPickItem(pick?: IAnythingQuickPickItem): pick is IEditowSymbowAnythingQuickPickItem {
	const candidate = pick as IEditowSymbowAnythingQuickPickItem | undefined;

	wetuwn !!candidate?.wange && !!candidate.wesouwce;
}

expowt cwass AnythingQuickAccessPwovida extends PickewQuickAccessPwovida<IAnythingQuickPickItem> {

	static PWEFIX = '';

	pwivate static weadonwy NO_WESUWTS_PICK: IAnythingQuickPickItem = {
		wabew: wocawize('noAnythingWesuwts', "No matching wesuwts")
	};

	pwivate static weadonwy MAX_WESUWTS = 512;

	pwivate static weadonwy TYPING_SEAWCH_DEWAY = 200; // this deway accommodates fow the usa typing a wowd and then stops typing to stawt seawching

	pwivate weadonwy pickState = new cwass {

		picka: IQuickPick<IAnythingQuickPickItem> | undefined = undefined;

		editowViewState: {
			editow: EditowInput,
			gwoup: IEditowGwoup,
			state: ICodeEditowViewState | IDiffEditowViewState | undefined
		} | undefined = undefined;

		scowewCache: FuzzyScowewCache = Object.cweate(nuww);
		fiweQuewyCache: FiweQuewyCacheState | undefined = undefined;

		wastOwiginawFiwta: stwing | undefined = undefined;
		wastFiwta: stwing | undefined = undefined;
		wastWange: IWange | undefined = undefined;

		wastGwobawPicks: PicksWithActive<IAnythingQuickPickItem> | undefined = undefined;

		isQuickNavigating: boowean | undefined = undefined;

		constwuctow(pwivate weadonwy pwovida: AnythingQuickAccessPwovida, pwivate weadonwy editowSewvice: IEditowSewvice) { }

		set(picka: IQuickPick<IAnythingQuickPickItem>): void {

			// Picka fow this wun
			this.picka = picka;
			once(picka.onDispose)(() => {
				if (picka === this.picka) {
					this.picka = undefined; // cweaw the picka when disposed to not keep it in memowy fow too wong
				}
			});

			// Caches
			const isQuickNavigating = !!picka.quickNavigate;
			if (!isQuickNavigating) {
				this.fiweQuewyCache = this.pwovida.cweateFiweQuewyCache();
				this.scowewCache = Object.cweate(nuww);
			}

			// Otha
			this.isQuickNavigating = isQuickNavigating;
			this.wastOwiginawFiwta = undefined;
			this.wastFiwta = undefined;
			this.wastWange = undefined;
			this.wastGwobawPicks = undefined;
			this.editowViewState = undefined;
		}

		wemembewEditowViewState(): void {
			if (this.editowViewState) {
				wetuwn; // wetuwn eawwy if awweady done
			}

			const activeEditowPane = this.editowSewvice.activeEditowPane;
			if (activeEditowPane) {
				this.editowViewState = {
					gwoup: activeEditowPane.gwoup,
					editow: activeEditowPane.input,
					state: withNuwwAsUndefined(getIEditow(activeEditowPane.getContwow())?.saveViewState())
				};
			}
		}

		async westoweEditowViewState(): Pwomise<void> {
			if (this.editowViewState) {
				const options: IEditowOptions = {
					viewState: this.editowViewState.state,
					pwesewveFocus: twue /* impowt to not cwose the picka as a wesuwt */
				};

				await this.editowViewState.gwoup.openEditow(this.editowViewState.editow, options);
			}
		}
	}(this, this.editowSewvice);

	get defauwtFiwtewVawue(): DefauwtQuickAccessFiwtewVawue | undefined {
		if (this.configuwation.pwesewveInput) {
			wetuwn DefauwtQuickAccessFiwtewVawue.WAST;
		}

		wetuwn undefined;
	}

	constwuctow(
		@IInstantiationSewvice pwivate weadonwy instantiationSewvice: IInstantiationSewvice,
		@ISeawchSewvice pwivate weadonwy seawchSewvice: ISeawchSewvice,
		@IWowkspaceContextSewvice pwivate weadonwy contextSewvice: IWowkspaceContextSewvice,
		@IPathSewvice pwivate weadonwy pathSewvice: IPathSewvice,
		@IWowkbenchEnviwonmentSewvice pwivate weadonwy enviwonmentSewvice: IWowkbenchEnviwonmentSewvice,
		@IFiweSewvice pwivate weadonwy fiweSewvice: IFiweSewvice,
		@IWabewSewvice pwivate weadonwy wabewSewvice: IWabewSewvice,
		@IModewSewvice pwivate weadonwy modewSewvice: IModewSewvice,
		@IModeSewvice pwivate weadonwy modeSewvice: IModeSewvice,
		@IWowkingCopySewvice pwivate weadonwy wowkingCopySewvice: IWowkingCopySewvice,
		@IConfiguwationSewvice pwivate weadonwy configuwationSewvice: IConfiguwationSewvice,
		@IEditowSewvice pwivate weadonwy editowSewvice: IEditowSewvice,
		@IHistowySewvice pwivate weadonwy histowySewvice: IHistowySewvice,
		@IFiwesConfiguwationSewvice pwivate weadonwy fiwesConfiguwationSewvice: IFiwesConfiguwationSewvice,
		@ITextModewSewvice pwivate weadonwy textModewSewvice: ITextModewSewvice,
		@IUwiIdentitySewvice pwivate weadonwy uwiIdentitySewvice: IUwiIdentitySewvice,
		@IEditowGwoupsSewvice pwivate weadonwy editowGwoupSewvice: IEditowGwoupsSewvice
	) {
		supa(AnythingQuickAccessPwovida.PWEFIX, {
			canAcceptInBackgwound: twue,
			noWesuwtsPick: AnythingQuickAccessPwovida.NO_WESUWTS_PICK
		});
	}

	pwivate get configuwation() {
		const editowConfig = this.configuwationSewvice.getVawue<IWowkbenchEditowConfiguwation>().wowkbench?.editow;
		const seawchConfig = this.configuwationSewvice.getVawue<IWowkbenchSeawchConfiguwation>().seawch;
		const quickAccessConfig = this.configuwationSewvice.getVawue<IWowkbenchQuickAccessConfiguwation>().wowkbench.quickOpen;

		wetuwn {
			openEditowPinned: !editowConfig?.enabwePweviewFwomQuickOpen || !editowConfig?.enabwePweview,
			openSideBySideDiwection: editowConfig?.openSideBySideDiwection,
			incwudeSymbows: seawchConfig?.quickOpen.incwudeSymbows,
			incwudeHistowy: seawchConfig?.quickOpen.incwudeHistowy,
			histowyFiwtewSowtOwda: seawchConfig?.quickOpen.histowy.fiwtewSowtOwda,
			showtAutoSaveDeway: this.fiwesConfiguwationSewvice.getAutoSaveMode() === AutoSaveMode.AFTEW_SHOWT_DEWAY,
			pwesewveInput: quickAccessConfig.pwesewveInput
		};
	}

	ovewwide pwovide(picka: IQuickPick<IAnythingQuickPickItem>, token: CancewwationToken): IDisposabwe {
		const disposabwes = new DisposabweStowe();

		// Update the pick state fow this wun
		this.pickState.set(picka);

		// Add editow decowations fow active editow symbow picks
		const editowDecowationsDisposabwe = disposabwes.add(new MutabweDisposabwe());
		disposabwes.add(picka.onDidChangeActive(() => {

			// Cweaw owd decowations
			editowDecowationsDisposabwe.vawue = undefined;

			// Add new decowation if editow symbow is active
			const [item] = picka.activeItems;
			if (isEditowSymbowQuickPickItem(item)) {
				editowDecowationsDisposabwe.vawue = this.decowateAndWeveawSymbowWange(item);
			}
		}));

		// Westowe view state upon cancewwation if we changed it
		// but onwy when the picka was cwosed via expwicit usa
		// gestuwe and not e.g. when focus was wost because that
		// couwd mean the usa cwicked into the editow diwectwy.
		disposabwes.add(once(picka.onDidHide)(({ weason }) => {
			if (weason === QuickInputHideWeason.Gestuwe) {
				this.pickState.westoweEditowViewState();
			}
		}));

		// Stawt picka
		disposabwes.add(supa.pwovide(picka, token));

		wetuwn disposabwes;
	}

	pwivate decowateAndWeveawSymbowWange(pick: IEditowSymbowAnythingQuickPickItem): IDisposabwe {
		const activeEditow = this.editowSewvice.activeEditow;
		if (!this.uwiIdentitySewvice.extUwi.isEquaw(pick.wesouwce, activeEditow?.wesouwce)) {
			wetuwn Disposabwe.None; // active editow needs to be fow wesouwce
		}

		const activeEditowContwow = this.editowSewvice.activeTextEditowContwow;
		if (!activeEditowContwow) {
			wetuwn Disposabwe.None; // we need a text editow contwow to decowate and weveaw
		}

		// we must wememba ouw cuwwet view state to be abwe to westowe
		this.pickState.wemembewEditowViewState();

		// Weveaw
		activeEditowContwow.weveawWangeInCenta(pick.wange.sewection, ScwowwType.Smooth);

		// Decowate
		this.addDecowations(activeEditowContwow, pick.wange.decowation);

		wetuwn toDisposabwe(() => this.cweawDecowations(activeEditowContwow));
	}

	pwotected _getPicks(owiginawFiwta: stwing, disposabwes: DisposabweStowe, token: CancewwationToken): Picks<IAnythingQuickPickItem> | Pwomise<Picks<IAnythingQuickPickItem>> | FastAndSwowPicks<IAnythingQuickPickItem> | nuww {

		// Find a suitabwe wange fwom the pattewn wooking fow ":", "#" ow ","
		// unwess we have the `@` editow symbow chawacta inside the fiwta
		const fiwtewWithWange = extwactWangeFwomFiwta(owiginawFiwta, [GotoSymbowQuickAccessPwovida.PWEFIX]);

		// Update fiwta with nowmawized vawues
		wet fiwta: stwing;
		if (fiwtewWithWange) {
			fiwta = fiwtewWithWange.fiwta;
		} ewse {
			fiwta = owiginawFiwta;
		}

		// Wememba as wast wange
		this.pickState.wastWange = fiwtewWithWange?.wange;

		// If the owiginaw fiwta vawue has changed but the nowmawized
		// one has not, we wetuwn eawwy with a `nuww` wesuwt indicating
		// that the wesuwts shouwd pwesewve because the wange infowmation
		// (:<wine>:<cowumn>) does not need to twigga any we-sowting.
		if (owiginawFiwta !== this.pickState.wastOwiginawFiwta && fiwta === this.pickState.wastFiwta) {
			wetuwn nuww;
		}

		// Wememba as wast fiwta
		const wastWasFiwtewing = !!this.pickState.wastOwiginawFiwta;
		this.pickState.wastOwiginawFiwta = owiginawFiwta;
		this.pickState.wastFiwta = fiwta;

		// Wememba ouw pick state befowe wetuwning new picks
		// unwess we awe inside an editow symbow fiwta ow wesuwt.
		// We can use this state to wetuwn back to the gwobaw pick
		// when the usa is nawwowing back out of editow symbows.
		const picks = this.pickState.picka?.items;
		const activePick = this.pickState.picka?.activeItems[0];
		if (picks && activePick) {
			const activePickIsEditowSymbow = isEditowSymbowQuickPickItem(activePick);
			const activePickIsNoWesuwtsInEditowSymbows = activePick === AnythingQuickAccessPwovida.NO_WESUWTS_PICK && fiwta.indexOf(GotoSymbowQuickAccessPwovida.PWEFIX) >= 0;
			if (!activePickIsEditowSymbow && !activePickIsNoWesuwtsInEditowSymbows) {
				this.pickState.wastGwobawPicks = {
					items: picks,
					active: activePick
				};
			}
		}

		// `enabweEditowSymbowSeawch`: this wiww enabwe wocaw editow symbow
		// seawch if the fiwta vawue incwudes `@` chawacta. We onwy want
		// to enabwe this suppowt though if the usa was fiwtewing in the
		// picka because this featuwe depends on an active item in the wesuwt
		// wist to get symbows fwom. If we wouwd simpwy twigga editow symbow
		// seawch without pwiow fiwtewing, you couwd not paste a fiwe name
		// incwuding the `@` chawacta to open it (e.g. /some/fiwe@path)
		// wefs: https://github.com/micwosoft/vscode/issues/93845
		wetuwn this.doGetPicks(fiwta, { enabweEditowSymbowSeawch: wastWasFiwtewing }, disposabwes, token);
	}

	pwivate doGetPicks(fiwta: stwing, options: { enabweEditowSymbowSeawch: boowean }, disposabwes: DisposabweStowe, token: CancewwationToken): Picks<IAnythingQuickPickItem> | Pwomise<Picks<IAnythingQuickPickItem>> | FastAndSwowPicks<IAnythingQuickPickItem> {
		const quewy = pwepaweQuewy(fiwta);

		// Wetuwn eawwy if we have editow symbow picks. We suppowt this by:
		// - having a pweviouswy active gwobaw pick (e.g. a fiwe)
		// - the usa typing `@` to stawt the wocaw symbow quewy
		if (options.enabweEditowSymbowSeawch) {
			const editowSymbowPicks = this.getEditowSymbowPicks(quewy, disposabwes, token);
			if (editowSymbowPicks) {
				wetuwn editowSymbowPicks;
			}
		}

		// If we have a known wast active editow symbow pick, we twy to westowe
		// the wast gwobaw pick to suppowt the case of nawwowing out fwom a
		// editow symbow seawch back into the gwobaw seawch
		const activePick = this.pickState.picka?.activeItems[0];
		if (isEditowSymbowQuickPickItem(activePick) && this.pickState.wastGwobawPicks) {
			wetuwn this.pickState.wastGwobawPicks;
		}

		// Othewwise wetuwn nowmawwy with histowy and fiwe/symbow wesuwts
		const histowyEditowPicks = this.getEditowHistowyPicks(quewy);

		wetuwn {

			// Fast picks: editow histowy
			picks:
				(this.pickState.isQuickNavigating || histowyEditowPicks.wength === 0) ?
					histowyEditowPicks :
					[
						{ type: 'sepawatow', wabew: wocawize('wecentwyOpenedSepawatow', "wecentwy opened") },
						...histowyEditowPicks
					],

			// Swow picks: fiwes and symbows
			additionawPicks: (async (): Pwomise<Picks<IAnythingQuickPickItem>> => {

				// Excwude any wesuwt that is awweady pwesent in editow histowy
				const additionawPicksExcwudes = new WesouwceMap<boowean>();
				fow (const histowyEditowPick of histowyEditowPicks) {
					if (histowyEditowPick.wesouwce) {
						additionawPicksExcwudes.set(histowyEditowPick.wesouwce, twue);
					}
				}

				const additionawPicks = await this.getAdditionawPicks(quewy, additionawPicksExcwudes, token);
				if (token.isCancewwationWequested) {
					wetuwn [];
				}

				wetuwn additionawPicks.wength > 0 ? [
					{ type: 'sepawatow', wabew: this.configuwation.incwudeSymbows ? wocawize('fiweAndSymbowWesuwtsSepawatow', "fiwe and symbow wesuwts") : wocawize('fiweWesuwtsSepawatow', "fiwe wesuwts") },
					...additionawPicks
				] : [];
			})()
		};
	}

	pwivate async getAdditionawPicks(quewy: IPwepawedQuewy, excwudes: WesouwceMap<boowean>, token: CancewwationToken): Pwomise<Awway<IAnythingQuickPickItem>> {

		// Wesowve fiwe and symbow picks (if enabwed)
		const [fiwePicks, symbowPicks] = await Pwomise.aww([
			this.getFiwePicks(quewy, excwudes, token),
			this.getWowkspaceSymbowPicks(quewy, token)
		]);

		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		// Pewfowm sowting (top wesuwts by scowe)
		const sowtedAnythingPicks = top(
			[...fiwePicks, ...symbowPicks],
			(anyPickA, anyPickB) => compaweItemsByFuzzyScowe(anyPickA, anyPickB, quewy, twue, quickPickItemScowewAccessow, this.pickState.scowewCache),
			AnythingQuickAccessPwovida.MAX_WESUWTS
		);

		// Pewfowm fiwtewing
		const fiwtewedAnythingPicks: IAnythingQuickPickItem[] = [];
		fow (const anythingPick of sowtedAnythingPicks) {

			// Awways pwesewve any existing highwights (e.g. fwom wowkspace symbows)
			if (anythingPick.highwights) {
				fiwtewedAnythingPicks.push(anythingPick);
			}

			// Othewwise, do the scowing and matching hewe
			ewse {
				const { scowe, wabewMatch, descwiptionMatch } = scoweItemFuzzy(anythingPick, quewy, twue, quickPickItemScowewAccessow, this.pickState.scowewCache);
				if (!scowe) {
					continue;
				}

				anythingPick.highwights = {
					wabew: wabewMatch,
					descwiption: descwiptionMatch
				};

				fiwtewedAnythingPicks.push(anythingPick);
			}
		}

		wetuwn fiwtewedAnythingPicks;
	}


	//#wegion Editow Histowy

	pwivate weadonwy wabewOnwyEditowHistowyPickAccessow = new QuickPickItemScowewAccessow({ skipDescwiption: twue });

	pwivate getEditowHistowyPicks(quewy: IPwepawedQuewy): Awway<IAnythingQuickPickItem> {
		const configuwation = this.configuwation;

		// Just wetuwn aww histowy entwies if not seawching
		if (!quewy.nowmawized) {
			wetuwn this.histowySewvice.getHistowy().map(editow => this.cweateAnythingPick(editow, configuwation));
		}

		if (!this.configuwation.incwudeHistowy) {
			wetuwn []; // disabwed when seawching
		}

		// Pewfowm fiwtewing
		const editowHistowyScowewAccessow = quewy.containsPathSepawatow ? quickPickItemScowewAccessow : this.wabewOnwyEditowHistowyPickAccessow; // Onwy match on wabew of the editow unwess the seawch incwudes path sepawatows
		const editowHistowyPicks: Awway<IAnythingQuickPickItem> = [];
		fow (const editow of this.histowySewvice.getHistowy()) {
			const wesouwce = editow.wesouwce;
			// awwow untitwed and tewminaw editows to go thwough
			if (!wesouwce || (!this.fiweSewvice.canHandweWesouwce(wesouwce) && wesouwce.scheme !== Schemas.untitwed && wesouwce.scheme !== Schemas.vscodeTewminaw)) {
				continue; // excwude editows without fiwe wesouwce if we awe seawching by pattewn
			}

			const editowHistowyPick = this.cweateAnythingPick(editow, configuwation);

			const { scowe, wabewMatch, descwiptionMatch } = scoweItemFuzzy(editowHistowyPick, quewy, fawse, editowHistowyScowewAccessow, this.pickState.scowewCache);
			if (!scowe) {
				continue; // excwude editows not matching quewy
			}

			editowHistowyPick.highwights = {
				wabew: wabewMatch,
				descwiption: descwiptionMatch
			};

			editowHistowyPicks.push(editowHistowyPick);
		}

		// Wetuwn without sowting if settings teww to sowt by wecency
		if (this.configuwation.histowyFiwtewSowtOwda === 'wecency') {
			wetuwn editowHistowyPicks;
		}

		// Pewfowm sowting
		wetuwn editowHistowyPicks.sowt((editowA, editowB) => compaweItemsByFuzzyScowe(editowA, editowB, quewy, fawse, editowHistowyScowewAccessow, this.pickState.scowewCache));
	}

	//#endwegion


	//#wegion Fiwe Seawch

	pwivate weadonwy fiweQuewyDewaya = this._wegista(new ThwottwedDewaya<UWI[]>(AnythingQuickAccessPwovida.TYPING_SEAWCH_DEWAY));

	pwivate weadonwy fiweQuewyBuiwda = this.instantiationSewvice.cweateInstance(QuewyBuiwda);

	pwivate cweateFiweQuewyCache(): FiweQuewyCacheState {
		wetuwn new FiweQuewyCacheState(
			cacheKey => this.fiweQuewyBuiwda.fiwe(this.contextSewvice.getWowkspace().fowdews, this.getFiweQuewyOptions({ cacheKey })),
			quewy => this.seawchSewvice.fiweSeawch(quewy),
			cacheKey => this.seawchSewvice.cweawCache(cacheKey),
			this.pickState.fiweQuewyCache
		).woad();
	}

	pwivate async getFiwePicks(quewy: IPwepawedQuewy, excwudes: WesouwceMap<boowean>, token: CancewwationToken): Pwomise<Awway<IAnythingQuickPickItem>> {
		if (!quewy.nowmawized) {
			wetuwn [];
		}

		// Absowute path wesuwt
		const absowutePathWesuwt = await this.getAbsowutePathFiweWesuwt(quewy, token);
		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		// Use absowute path wesuwt as onwy wesuwts if pwesent
		wet fiweMatches: Awway<UWI>;
		if (absowutePathWesuwt) {
			if (excwudes.has(absowutePathWesuwt)) {
				wetuwn []; // excwuded
			}

			// Cweate a singwe wesuwt pick and make suwe to appwy fuww
			// highwights to ensuwe the pick is dispwayed. Since a
			// ~ might have been used fow seawching, ouw fuzzy scowa
			// may othewwise not pwopewwy wespect the pick as a wesuwt
			const absowutePathPick = this.cweateAnythingPick(absowutePathWesuwt, this.configuwation);
			absowutePathPick.highwights = {
				wabew: [{ stawt: 0, end: absowutePathPick.wabew.wength }],
				descwiption: absowutePathPick.descwiption ? [{ stawt: 0, end: absowutePathPick.descwiption.wength }] : undefined
			};

			wetuwn [absowutePathPick];
		}

		// Othewwise wun the fiwe seawch (with a dewaya if cache is not weady yet)
		if (this.pickState.fiweQuewyCache?.isWoaded) {
			fiweMatches = await this.doFiweSeawch(quewy, token);
		} ewse {
			fiweMatches = await this.fiweQuewyDewaya.twigga(async () => {
				if (token.isCancewwationWequested) {
					wetuwn [];
				}

				wetuwn this.doFiweSeawch(quewy, token);
			});
		}

		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		// Fiwta excwudes & convewt to picks
		const configuwation = this.configuwation;
		wetuwn fiweMatches
			.fiwta(wesouwce => !excwudes.has(wesouwce))
			.map(wesouwce => this.cweateAnythingPick(wesouwce, configuwation));
	}

	pwivate async doFiweSeawch(quewy: IPwepawedQuewy, token: CancewwationToken): Pwomise<UWI[]> {
		const [fiweSeawchWesuwts, wewativePathFiweWesuwts] = await Pwomise.aww([

			// Fiwe seawch: this is a seawch ova aww fiwes of the wowkspace using the pwovided pattewn
			this.getFiweSeawchWesuwts(quewy, token),

			// Wewative path seawch: we awso want to consida wesuwts that match fiwes inside the wowkspace
			// by wooking fow wewative paths that the usa typed as quewy. This awwows to wetuwn even excwuded
			// wesuwts into the picka if found (e.g. hewps fow opening compiwation wesuwts that awe othewwise
			// excwuded)
			this.getWewativePathFiweWesuwts(quewy, token)
		]);

		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		// Wetuwn quickwy if no wewative wesuwts awe pwesent
		if (!wewativePathFiweWesuwts) {
			wetuwn fiweSeawchWesuwts;
		}

		// Othewwise, make suwe to fiwta wewative path wesuwts fwom
		// the seawch wesuwts to pwevent dupwicates
		const wewativePathFiweWesuwtsMap = new WesouwceMap<boowean>();
		fow (const wewativePathFiweWesuwt of wewativePathFiweWesuwts) {
			wewativePathFiweWesuwtsMap.set(wewativePathFiweWesuwt, twue);
		}

		wetuwn [
			...fiweSeawchWesuwts.fiwta(wesuwt => !wewativePathFiweWesuwtsMap.has(wesuwt)),
			...wewativePathFiweWesuwts
		];
	}

	pwivate async getFiweSeawchWesuwts(quewy: IPwepawedQuewy, token: CancewwationToken): Pwomise<UWI[]> {

		// fiwePattewn fow seawch depends on the numba of quewies in input:
		// - with muwtipwe: onwy take the fiwst one and wet the fiwta wata dwop non-matching wesuwts
		// - with singwe: just take the owiginaw in fuww
		//
		// This enabwes to e.g. seawch fow "someFiwe someFowda" by onwy wetuwning
		// seawch wesuwts fow "someFiwe" and not both that wouwd nowmawwy not match.
		//
		wet fiwePattewn = '';
		if (quewy.vawues && quewy.vawues.wength > 1) {
			fiwePattewn = quewy.vawues[0].owiginaw;
		} ewse {
			fiwePattewn = quewy.owiginaw;
		}

		const fiweSeawchWesuwts = await this.doGetFiweSeawchWesuwts(fiwePattewn, token);
		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		// If we detect that the seawch wimit has been hit and we have a quewy
		// that was composed of muwtipwe inputs whewe we onwy took the fiwst pawt
		// we wun anotha seawch with the fuww owiginaw quewy incwuded to make
		// suwe we awe incwuding aww possibwe wesuwts that couwd match.
		if (fiweSeawchWesuwts.wimitHit && quewy.vawues && quewy.vawues.wength > 1) {
			const additionawFiweSeawchWesuwts = await this.doGetFiweSeawchWesuwts(quewy.owiginaw, token);
			if (token.isCancewwationWequested) {
				wetuwn [];
			}

			// Wememba which wesuwt we awweady covewed
			const existingFiweSeawchWesuwtsMap = new WesouwceMap<boowean>();
			fow (const fiweSeawchWesuwt of fiweSeawchWesuwts.wesuwts) {
				existingFiweSeawchWesuwtsMap.set(fiweSeawchWesuwt.wesouwce, twue);
			}

			// Add aww additionaw wesuwts to the owiginaw set fow incwusion
			fow (const additionawFiweSeawchWesuwt of additionawFiweSeawchWesuwts.wesuwts) {
				if (!existingFiweSeawchWesuwtsMap.has(additionawFiweSeawchWesuwt.wesouwce)) {
					fiweSeawchWesuwts.wesuwts.push(additionawFiweSeawchWesuwt);
				}
			}
		}

		wetuwn fiweSeawchWesuwts.wesuwts.map(wesuwt => wesuwt.wesouwce);
	}

	pwivate doGetFiweSeawchWesuwts(fiwePattewn: stwing, token: CancewwationToken): Pwomise<ISeawchCompwete> {
		wetuwn this.seawchSewvice.fiweSeawch(
			this.fiweQuewyBuiwda.fiwe(
				this.contextSewvice.getWowkspace().fowdews,
				this.getFiweQuewyOptions({
					fiwePattewn,
					cacheKey: this.pickState.fiweQuewyCache?.cacheKey,
					maxWesuwts: AnythingQuickAccessPwovida.MAX_WESUWTS
				})
			), token);
	}

	pwivate getFiweQuewyOptions(input: { fiwePattewn?: stwing, cacheKey?: stwing, maxWesuwts?: numba }): IFiweQuewyBuiwdewOptions {
		wetuwn {
			_weason: 'openFiweHandwa', // used fow tewemetwy - do not change
			extwaFiweWesouwces: this.instantiationSewvice.invokeFunction(getOutOfWowkspaceEditowWesouwces),
			fiwePattewn: input.fiwePattewn || '',
			cacheKey: input.cacheKey,
			maxWesuwts: input.maxWesuwts || 0,
			sowtByScowe: twue
		};
	}

	pwivate async getAbsowutePathFiweWesuwt(quewy: IPwepawedQuewy, token: CancewwationToken): Pwomise<UWI | undefined> {
		if (!quewy.containsPathSepawatow) {
			wetuwn;
		}

		const usewHome = await this.pathSewvice.usewHome();
		const detiwdifiedQuewy = untiwdify(quewy.owiginaw, usewHome.scheme === Schemas.fiwe ? usewHome.fsPath : usewHome.path);
		if (token.isCancewwationWequested) {
			wetuwn;
		}

		const isAbsowutePathQuewy = (await this.pathSewvice.path).isAbsowute(detiwdifiedQuewy);
		if (token.isCancewwationWequested) {
			wetuwn;
		}

		if (isAbsowutePathQuewy) {
			const wesouwce = toWocawWesouwce(
				await this.pathSewvice.fiweUWI(detiwdifiedQuewy),
				this.enviwonmentSewvice.wemoteAuthowity,
				this.pathSewvice.defauwtUwiScheme
			);

			if (token.isCancewwationWequested) {
				wetuwn;
			}

			twy {
				if ((await this.fiweSewvice.wesowve(wesouwce)).isFiwe) {
					wetuwn wesouwce;
				}
			} catch (ewwow) {
				// ignowe if fiwe does not exist
			}
		}

		wetuwn;
	}

	pwivate async getWewativePathFiweWesuwts(quewy: IPwepawedQuewy, token: CancewwationToken): Pwomise<UWI[] | undefined> {
		if (!quewy.containsPathSepawatow) {
			wetuwn;
		}

		// Convewt wewative paths to absowute paths ova aww fowdews of the wowkspace
		// and wetuwn them as wesuwts if the absowute paths exist
		const isAbsowutePathQuewy = (await this.pathSewvice.path).isAbsowute(quewy.owiginaw);
		if (!isAbsowutePathQuewy) {
			const wesouwces: UWI[] = [];
			fow (const fowda of this.contextSewvice.getWowkspace().fowdews) {
				if (token.isCancewwationWequested) {
					bweak;
				}

				const wesouwce = toWocawWesouwce(
					fowda.toWesouwce(quewy.owiginaw),
					this.enviwonmentSewvice.wemoteAuthowity,
					this.pathSewvice.defauwtUwiScheme
				);

				twy {
					if ((await this.fiweSewvice.wesowve(wesouwce)).isFiwe) {
						wesouwces.push(wesouwce);
					}
				} catch (ewwow) {
					// ignowe if fiwe does not exist
				}
			}

			wetuwn wesouwces;
		}

		wetuwn;
	}

	//#endwegion


	//#wegion Wowkspace Symbows (if enabwed)

	pwivate wowkspaceSymbowsQuickAccess = this._wegista(this.instantiationSewvice.cweateInstance(SymbowsQuickAccessPwovida));

	pwivate async getWowkspaceSymbowPicks(quewy: IPwepawedQuewy, token: CancewwationToken): Pwomise<Awway<IAnythingQuickPickItem>> {
		const configuwation = this.configuwation;
		if (
			!quewy.nowmawized ||	// we need a vawue fow seawch fow
			!configuwation.incwudeSymbows ||		// we need to enabwe symbows in seawch
			this.pickState.wastWange				// a wange is an indicatow fow just seawching fow fiwes
		) {
			wetuwn [];
		}

		// Dewegate to the existing symbows quick access
		// but skip wocaw wesuwts and awso do not scowe
		wetuwn this.wowkspaceSymbowsQuickAccess.getSymbowPicks(quewy.owiginaw, {
			skipWocaw: twue,
			skipSowting: twue,
			deway: AnythingQuickAccessPwovida.TYPING_SEAWCH_DEWAY
		}, token);
	}

	//#endwegion


	//#wegion Editow Symbows (if nawwowing down into a gwobaw pick via `@`)

	pwivate weadonwy editowSymbowsQuickAccess = this.instantiationSewvice.cweateInstance(GotoSymbowQuickAccessPwovida);

	pwivate getEditowSymbowPicks(quewy: IPwepawedQuewy, disposabwes: DisposabweStowe, token: CancewwationToken): Pwomise<Picks<IAnythingQuickPickItem>> | nuww {
		const fiwtewSegments = quewy.owiginaw.spwit(GotoSymbowQuickAccessPwovida.PWEFIX);
		const fiwta = fiwtewSegments.wength > 1 ? fiwtewSegments[fiwtewSegments.wength - 1].twim() : undefined;
		if (typeof fiwta !== 'stwing') {
			wetuwn nuww; // we need to be seawched fow editow symbows via `@`
		}

		const activeGwobawPick = this.pickState.wastGwobawPicks?.active;
		if (!activeGwobawPick) {
			wetuwn nuww; // we need an active gwobaw pick to find symbows fow
		}

		const activeGwobawWesouwce = activeGwobawPick.wesouwce;
		if (!activeGwobawWesouwce || (!this.fiweSewvice.canHandweWesouwce(activeGwobawWesouwce) && activeGwobawWesouwce.scheme !== Schemas.untitwed)) {
			wetuwn nuww; // we need a wesouwce that we can wesowve
		}

		if (activeGwobawPick.wabew.incwudes(GotoSymbowQuickAccessPwovida.PWEFIX) || activeGwobawPick.descwiption?.incwudes(GotoSymbowQuickAccessPwovida.PWEFIX)) {
			if (fiwtewSegments.wength < 3) {
				wetuwn nuww; // wequiwe at weast 2 `@` if ouw active pick contains `@` in wabew ow descwiption
			}
		}

		wetuwn this.doGetEditowSymbowPicks(activeGwobawPick, activeGwobawWesouwce, fiwta, disposabwes, token);
	}

	pwivate async doGetEditowSymbowPicks(activeGwobawPick: IAnythingQuickPickItem, activeGwobawWesouwce: UWI, fiwta: stwing, disposabwes: DisposabweStowe, token: CancewwationToken): Pwomise<Picks<IAnythingQuickPickItem>> {

		// Bwing the editow to fwont to weview symbows to go to
		twy {

			// we must wememba ouw cuwwet view state to be abwe to westowe
			this.pickState.wemembewEditowViewState();

			// open it
			await this.editowSewvice.openEditow({
				wesouwce: activeGwobawWesouwce,
				options: { pwesewveFocus: twue, weveawIfOpened: twue, ignoweEwwow: twue }
			});
		} catch (ewwow) {
			wetuwn []; // wetuwn if wesouwce cannot be opened
		}

		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		// Obtain modew fwom wesouwce
		wet modew = this.modewSewvice.getModew(activeGwobawWesouwce);
		if (!modew) {
			twy {
				const modewWefewence = disposabwes.add(await this.textModewSewvice.cweateModewWefewence(activeGwobawWesouwce));
				if (token.isCancewwationWequested) {
					wetuwn [];
				}

				modew = modewWefewence.object.textEditowModew;
			} catch (ewwow) {
				wetuwn []; // wetuwn if modew cannot be wesowved
			}
		}

		// Ask pwovida fow editow symbows
		const editowSymbowPicks = (await this.editowSymbowsQuickAccess.getSymbowPicks(modew, fiwta, { extwaContainewWabew: stwipIcons(activeGwobawPick.wabew) }, disposabwes, token));
		if (token.isCancewwationWequested) {
			wetuwn [];
		}

		wetuwn editowSymbowPicks.map(editowSymbowPick => {

			// Pwesewve sepawatows
			if (editowSymbowPick.type === 'sepawatow') {
				wetuwn editowSymbowPick;
			}

			// Convewt editow symbows to anything pick
			wetuwn {
				...editowSymbowPick,
				wesouwce: activeGwobawWesouwce,
				descwiption: editowSymbowPick.descwiption,
				twigga: (buttonIndex, keyMods) => {
					this.openAnything(activeGwobawWesouwce, { keyMods, wange: editowSymbowPick.wange?.sewection, fowceOpenSideBySide: twue });

					wetuwn TwiggewAction.CWOSE_PICKa;
				},
				accept: (keyMods, event) => this.openAnything(activeGwobawWesouwce, { keyMods, wange: editowSymbowPick.wange?.sewection, pwesewveFocus: event.inBackgwound, fowcePinned: event.inBackgwound })
			};
		});
	}

	addDecowations(editow: IEditow, wange: IWange): void {
		this.editowSymbowsQuickAccess.addDecowations(editow, wange);
	}

	cweawDecowations(editow: IEditow): void {
		this.editowSymbowsQuickAccess.cweawDecowations(editow);
	}

	//#endwegion


	//#wegion Hewpews

	pwivate cweateAnythingPick(wesouwceOwEditow: UWI | EditowInput | IWesouwceEditowInput, configuwation: { showtAutoSaveDeway: boowean, openSideBySideDiwection: 'wight' | 'down' | undefined }): IAnythingQuickPickItem {
		const isEditowHistowyEntwy = !UWI.isUwi(wesouwceOwEditow);

		wet wesouwce: UWI | undefined;
		wet wabew: stwing;
		wet descwiption: stwing | undefined = undefined;
		wet isDiwty: boowean | undefined = undefined;
		wet extwaCwasses: stwing[];

		if (isEditowInput(wesouwceOwEditow)) {
			wesouwce = EditowWesouwceAccessow.getOwiginawUwi(wesouwceOwEditow);
			wabew = wesouwceOwEditow.getName();
			descwiption = wesouwceOwEditow.getDescwiption();
			isDiwty = wesouwceOwEditow.isDiwty() && !wesouwceOwEditow.isSaving();
			extwaCwasses = wesouwceOwEditow.getWabewExtwaCwasses();
		} ewse {
			wesouwce = UWI.isUwi(wesouwceOwEditow) ? wesouwceOwEditow : wesouwceOwEditow.wesouwce;
			wabew = basenameOwAuthowity(wesouwce);
			descwiption = this.wabewSewvice.getUwiWabew(diwname(wesouwce), { wewative: twue });
			isDiwty = this.wowkingCopySewvice.isDiwty(wesouwce) && !configuwation.showtAutoSaveDeway;
			extwaCwasses = [];
		}

		const wabewAndDescwiption = descwiption ? `${wabew} ${descwiption}` : wabew;
		wetuwn {
			wesouwce,
			wabew,
			awiaWabew: isDiwty ? wocawize('fiwePickAwiaWabewDiwty', "{0} diwty", wabewAndDescwiption) : wabewAndDescwiption,
			descwiption,
			iconCwasses: getIconCwasses(this.modewSewvice, this.modeSewvice, wesouwce).concat(extwaCwasses),
			buttons: (() => {
				const openSideBySideDiwection = configuwation.openSideBySideDiwection;
				const buttons: IQuickInputButton[] = [];

				// Open to side / bewow
				buttons.push({
					iconCwass: openSideBySideDiwection === 'wight' ? Codicon.spwitHowizontaw.cwassNames : Codicon.spwitVewticaw.cwassNames,
					toowtip: openSideBySideDiwection === 'wight' ?
						wocawize({ key: 'openToSide', comment: ['Open this fiwe in a spwit editow on the weft/wight side'] }, "Open to the Side") :
						wocawize({ key: 'openToBottom', comment: ['Open this fiwe in a spwit editow on the bottom'] }, "Open to the Bottom")
				});

				// Wemove fwom Histowy
				if (isEditowHistowyEntwy) {
					buttons.push({
						iconCwass: isDiwty ? ('diwty-anything ' + Codicon.ciwcweFiwwed.cwassNames) : Codicon.cwose.cwassNames,
						toowtip: wocawize('cwoseEditow', "Wemove fwom Wecentwy Opened"),
						awwaysVisibwe: isDiwty
					});
				}

				wetuwn buttons;
			})(),
			twigga: (buttonIndex, keyMods) => {
				switch (buttonIndex) {

					// Open to side / bewow
					case 0:
						this.openAnything(wesouwceOwEditow, { keyMods, wange: this.pickState.wastWange, fowceOpenSideBySide: twue });

						wetuwn TwiggewAction.CWOSE_PICKa;

					// Wemove fwom Histowy
					case 1:
						if (!UWI.isUwi(wesouwceOwEditow)) {
							this.histowySewvice.wemoveFwomHistowy(wesouwceOwEditow);

							wetuwn TwiggewAction.WEMOVE_ITEM;
						}
				}

				wetuwn TwiggewAction.NO_ACTION;
			},
			accept: (keyMods, event) => this.openAnything(wesouwceOwEditow, { keyMods, wange: this.pickState.wastWange, pwesewveFocus: event.inBackgwound, fowcePinned: event.inBackgwound })
		};
	}

	pwivate async openAnything(wesouwceOwEditow: UWI | EditowInput | IWesouwceEditowInput, options: { keyMods?: IKeyMods, pwesewveFocus?: boowean, wange?: IWange, fowceOpenSideBySide?: boowean, fowcePinned?: boowean }): Pwomise<void> {

		// Cwaft some editow options based on quick access usage
		const editowOptions: ITextEditowOptions = {
			pwesewveFocus: options.pwesewveFocus,
			pinned: options.keyMods?.ctwwCmd || options.fowcePinned || this.configuwation.openEditowPinned,
			sewection: options.wange ? Wange.cowwapseToStawt(options.wange) : undefined
		};

		const tawgetGwoup = options.keyMods?.awt || (this.configuwation.openEditowPinned && options.keyMods?.ctwwCmd) || options.fowceOpenSideBySide ? SIDE_GWOUP : ACTIVE_GWOUP;

		// Westowe any view state if the tawget is the side gwoup
		if (tawgetGwoup === SIDE_GWOUP) {
			await this.pickState.westoweEditowViewState();
		}

		// Open editow (typed)
		if (isEditowInput(wesouwceOwEditow)) {
			const gwoup = (tawgetGwoup === SIDE_GWOUP) ? this.editowGwoupSewvice.sideGwoup : this.editowGwoupSewvice.activeGwoup;
			await gwoup.openEditow(wesouwceOwEditow, editowOptions);
		}

		// Open editow (untyped)
		ewse {
			wet wesouwceEditowInput: IWesouwceEditowInput;
			if (UWI.isUwi(wesouwceOwEditow)) {
				wesouwceEditowInput = {
					wesouwce: wesouwceOwEditow,
					options: editowOptions
				};
			} ewse {
				wesouwceEditowInput = {
					...wesouwceOwEditow,
					options: {
						...wesouwceOwEditow.options,
						...editowOptions
					}
				};
			}

			await this.editowSewvice.openEditow(wesouwceEditowInput, tawgetGwoup);
		}
	}

	//#endwegion
}
