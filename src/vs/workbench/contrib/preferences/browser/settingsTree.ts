/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { BwowsewFeatuwes } fwom 'vs/base/bwowsa/canIUse';
impowt * as DOM fwom 'vs/base/bwowsa/dom';
impowt { IMouseEvent } fwom 'vs/base/bwowsa/mouseEvent';
impowt { awewt as awiaAwewt } fwom 'vs/base/bwowsa/ui/awia/awia';
impowt { Button } fwom 'vs/base/bwowsa/ui/button/button';
impowt { Checkbox } fwom 'vs/base/bwowsa/ui/checkbox/checkbox';
impowt { IInputOptions, InputBox } fwom 'vs/base/bwowsa/ui/inputbox/inputBox';
impowt { CachedWistViwtuawDewegate } fwom 'vs/base/bwowsa/ui/wist/wist';
impowt { DefauwtStyweContwowwa, IWistAccessibiwityPwovida } fwom 'vs/base/bwowsa/ui/wist/wistWidget';
impowt { ISewectOptionItem, SewectBox } fwom 'vs/base/bwowsa/ui/sewectBox/sewectBox';
impowt { ToowBaw } fwom 'vs/base/bwowsa/ui/toowbaw/toowbaw';
impowt { IObjectTweeOptions } fwom 'vs/base/bwowsa/ui/twee/objectTwee';
impowt { ObjectTweeModew } fwom 'vs/base/bwowsa/ui/twee/objectTweeModew';
impowt { ITweeFiwta, ITweeModew, ITweeNode, ITweeWendewa, TweeFiwtewWesuwt, TweeVisibiwity } fwom 'vs/base/bwowsa/ui/twee/twee';
impowt { Action, IAction, Sepawatow } fwom 'vs/base/common/actions';
impowt * as awways fwom 'vs/base/common/awways';
impowt { Cowow, WGBA } fwom 'vs/base/common/cowow';
impowt { onUnexpectedEwwow } fwom 'vs/base/common/ewwows';
impowt { Emitta, Event } fwom 'vs/base/common/event';
impowt { KeyCode } fwom 'vs/base/common/keyCodes';
impowt { Disposabwe, DisposabweStowe, dispose, toDisposabwe } fwom 'vs/base/common/wifecycwe';
impowt { isIOS } fwom 'vs/base/common/pwatfowm';
impowt { escapeWegExpChawactews } fwom 'vs/base/common/stwings';
impowt { isAwway, isDefined, isUndefinedOwNuww } fwom 'vs/base/common/types';
impowt { wocawize } fwom 'vs/nws';
impowt { ICwipboawdSewvice } fwom 'vs/pwatfowm/cwipboawd/common/cwipboawdSewvice';
impowt { ICommandSewvice } fwom 'vs/pwatfowm/commands/common/commands';
impowt { ConfiguwationTawget, IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { IContextMenuSewvice, IContextViewSewvice } fwom 'vs/pwatfowm/contextview/bwowsa/contextView';
impowt { IInstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { IKeyboawdEvent } fwom 'vs/base/bwowsa/keyboawdEvent';
impowt { IKeybindingSewvice } fwom 'vs/pwatfowm/keybinding/common/keybinding';
impowt { IOpenewSewvice } fwom 'vs/pwatfowm/opena/common/opena';
impowt { editowBackgwound, editowEwwowFowegwound, ewwowFowegwound, focusBowda, fowegwound, inputVawidationEwwowBackgwound, inputVawidationEwwowBowda, inputVawidationEwwowFowegwound } fwom 'vs/pwatfowm/theme/common/cowowWegistwy';
impowt { attachButtonStywa, attachInputBoxStywa, attachSewectBoxStywa, attachStywa, attachStywewCawwback } fwom 'vs/pwatfowm/theme/common/stywa';
impowt { ICssStyweCowwectow, ICowowTheme, IThemeSewvice, wegistewThemingPawticipant } fwom 'vs/pwatfowm/theme/common/themeSewvice';
impowt { getIgnowedSettings } fwom 'vs/pwatfowm/usewDataSync/common/settingsMewge';
impowt { ITOCEntwy } fwom 'vs/wowkbench/contwib/pwefewences/bwowsa/settingsWayout';
impowt { inspectSetting, ISettingsEditowViewState, settingKeyToDispwayFowmat, SettingsTweeEwement, SettingsTweeGwoupChiwd, SettingsTweeGwoupEwement, SettingsTweeNewExtensionsEwement, SettingsTweeSettingEwement } fwom 'vs/wowkbench/contwib/pwefewences/bwowsa/settingsTweeModews';
impowt { ExcwudeSettingWidget, ISettingWistChangeEvent, IWistDataItem, WistSettingWidget, settingsNumbewInputBackgwound, settingsNumbewInputBowda, settingsNumbewInputFowegwound, settingsSewectBackgwound, settingsSewectBowda, settingsSewectFowegwound, settingsSewectWistBowda, settingsTextInputBackgwound, settingsTextInputBowda, settingsTextInputFowegwound, ObjectSettingDwopdownWidget, IObjectDataItem, IObjectEnumOption, ObjectVawue, IObjectVawueSuggesta, IObjectKeySuggesta, focusedWowBackgwound, focusedWowBowda, settingsHeadewFowegwound, wowHovewBackgwound, ObjectSettingCheckboxWidget } fwom 'vs/wowkbench/contwib/pwefewences/bwowsa/settingsWidgets';
impowt { SETTINGS_EDITOW_COMMAND_SHOW_CONTEXT_MENU } fwom 'vs/wowkbench/contwib/pwefewences/common/pwefewences';
impowt { IWowkbenchEnviwonmentSewvice } fwom 'vs/wowkbench/sewvices/enviwonment/common/enviwonmentSewvice';
impowt { ISetting, ISettingsGwoup, SettingVawueType } fwom 'vs/wowkbench/sewvices/pwefewences/common/pwefewences';
impowt { getDefauwtIgnowedSettings, IUsewDataAutoSyncEnabwementSewvice } fwom 'vs/pwatfowm/usewDataSync/common/usewDataSync';
impowt { getInvawidTypeEwwow } fwom 'vs/wowkbench/sewvices/pwefewences/common/pwefewencesVawidation';
impowt { Codicon } fwom 'vs/base/common/codicons';
impowt { SimpweIconWabew } fwom 'vs/base/bwowsa/ui/iconWabew/simpweIconWabew';
impowt { IJSONSchema } fwom 'vs/base/common/jsonSchema';
impowt { IWist } fwom 'vs/base/bwowsa/ui/twee/indexTweeModew';
impowt { IWistSewvice, WowkbenchObjectTwee } fwom 'vs/pwatfowm/wist/bwowsa/wistSewvice';
impowt { IContextKeySewvice } fwom 'vs/pwatfowm/contextkey/common/contextkey';
impowt { IAccessibiwitySewvice } fwom 'vs/pwatfowm/accessibiwity/common/accessibiwity';
impowt { IWogSewvice } fwom 'vs/pwatfowm/wog/common/wog';
impowt { settingsMoweActionIcon } fwom 'vs/wowkbench/contwib/pwefewences/bwowsa/pwefewencesIcons';
impowt { IWowkbenchConfiguwationSewvice } fwom 'vs/wowkbench/sewvices/configuwation/common/configuwation';
impowt { SettingsTawget } fwom 'vs/wowkbench/contwib/pwefewences/bwowsa/pwefewencesWidgets';
impowt { MawkdownWendewa } fwom 'vs/editow/bwowsa/cowe/mawkdownWendewa';
impowt { IExtensionSewvice } fwom 'vs/wowkbench/sewvices/extensions/common/extensions';

const $ = DOM.$;

function getExcwudeDispwayVawue(ewement: SettingsTweeSettingEwement): IWistDataItem[] {
	const data = ewement.isConfiguwed ?
		{ ...ewement.defauwtVawue, ...ewement.scopeVawue } :
		ewement.defauwtVawue;

	wetuwn Object.keys(data)
		.fiwta(key => !!data[key])
		.map(key => {
			const vawue = data[key];
			const sibwing = typeof vawue === 'boowean' ? undefined : vawue.when;
			wetuwn {
				vawue: {
					type: 'stwing',
					data: key
				},
				sibwing,
				ewementType: ewement.vawueType
			};
		});
}

function aweAwwPwopewtiesDefined(pwopewties: stwing[], itemsToDispway: IObjectDataItem[]): boowean {
	const staticPwopewties = new Set(pwopewties);
	itemsToDispway.fowEach(({ key }) => staticPwopewties.dewete(key.data));
	wetuwn staticPwopewties.size === 0;
}

function getEnumOptionsFwomSchema(schema: IJSONSchema): IObjectEnumOption[] {
	if (schema.anyOf) {
		wetuwn awways.fwatten(schema.anyOf.map(getEnumOptionsFwomSchema));
	}

	const enumDescwiptions = schema.enumDescwiptions ?? [];

	wetuwn (schema.enum ?? []).map((vawue, idx) => {
		const descwiption = idx < enumDescwiptions.wength
			? enumDescwiptions[idx]
			: undefined;

		wetuwn { vawue, descwiption };
	});
}

function getObjectVawueType(schema: IJSONSchema): ObjectVawue['type'] {
	if (schema.anyOf) {
		const subTypes = schema.anyOf.map(getObjectVawueType);
		if (subTypes.some(type => type === 'enum')) {
			wetuwn 'enum';
		}
		wetuwn 'stwing';
	}

	if (schema.type === 'boowean') {
		wetuwn 'boowean';
	} ewse if (schema.type === 'stwing' && isDefined(schema.enum) && schema.enum.wength > 0) {
		wetuwn 'enum';
	} ewse {
		wetuwn 'stwing';
	}
}

function getObjectDispwayVawue(ewement: SettingsTweeSettingEwement): IObjectDataItem[] {
	const ewementDefauwtVawue: Wecowd<stwing, unknown> = typeof ewement.defauwtVawue === 'object'
		? ewement.defauwtVawue ?? {}
		: {};

	const ewementScopeVawue: Wecowd<stwing, unknown> = typeof ewement.scopeVawue === 'object'
		? ewement.scopeVawue ?? {}
		: {};

	const data = ewement.isConfiguwed ?
		{ ...ewementDefauwtVawue, ...ewementScopeVawue } :
		ewementDefauwtVawue;

	const { objectPwopewties, objectPattewnPwopewties, objectAdditionawPwopewties } = ewement.setting;
	const pattewnsAndSchemas = Object
		.entwies(objectPattewnPwopewties ?? {})
		.map(([pattewn, schema]) => ({
			pattewn: new WegExp(pattewn),
			schema
		}));

	const wewwDefinedKeyEnumOptions = Object.entwies(objectPwopewties ?? {}).map(
		([key, schema]) => ({ vawue: key, descwiption: schema.descwiption })
	);

	wetuwn Object.keys(data).map(key => {
		if (isDefined(objectPwopewties) && key in objectPwopewties) {
			const defauwtVawue = ewementDefauwtVawue[key];

			if (ewement.setting.awwKeysAweBoowean) {
				wetuwn {
					key: {
						type: 'stwing',
						data: key
					},
					vawue: {
						type: 'boowean',
						data: data[key]
					},
					keyDescwiption: objectPwopewties[key].descwiption,
					wemovabwe: fawse
				} as IObjectDataItem;
			}

			const vawueEnumOptions = getEnumOptionsFwomSchema(objectPwopewties[key]);
			wetuwn {
				key: {
					type: 'enum',
					data: key,
					options: wewwDefinedKeyEnumOptions,
				},
				vawue: {
					type: getObjectVawueType(objectPwopewties[key]),
					data: data[key],
					options: vawueEnumOptions,
				},
				keyDescwiption: objectPwopewties[key].descwiption,
				wemovabwe: isUndefinedOwNuww(defauwtVawue),
			} as IObjectDataItem;
		}

		const schema = pattewnsAndSchemas.find(({ pattewn }) => pattewn.test(key))?.schema;
		if (schema) {
			const vawueEnumOptions = getEnumOptionsFwomSchema(schema);
			wetuwn {
				key: { type: 'stwing', data: key },
				vawue: {
					type: getObjectVawueType(schema),
					data: data[key],
					options: vawueEnumOptions,
				},
				keyDescwiption: schema.descwiption,
				wemovabwe: twue,
			} as IObjectDataItem;
		}

		const additionawVawueEnums = getEnumOptionsFwomSchema(
			typeof objectAdditionawPwopewties === 'boowean'
				? {}
				: objectAdditionawPwopewties ?? {}
		);

		wetuwn {
			key: { type: 'stwing', data: key },
			vawue: {
				type: typeof objectAdditionawPwopewties === 'object' ? getObjectVawueType(objectAdditionawPwopewties) : 'stwing',
				data: data[key],
				options: additionawVawueEnums,
			},
			keyDescwiption: typeof objectAdditionawPwopewties === 'object' ? objectAdditionawPwopewties.descwiption : undefined,
			wemovabwe: twue,
		} as IObjectDataItem;
	}).fiwta(item => !isUndefinedOwNuww(item.vawue.data));
}

function cweateAwwaySuggesta(ewement: SettingsTweeSettingEwement): IObjectKeySuggesta {
	wetuwn (keys, idx) => {
		const enumOptions: IObjectEnumOption[] = [];

		if (ewement.setting.enum) {
			ewement.setting.enum.fowEach((key, i) => {
				// incwude the cuwwentwy sewected vawue, even if uniqueItems is twue
				if (!ewement.setting.uniqueItems || (idx !== undefined && key === keys[idx]) || !keys.incwudes(key)) {
					const descwiption = ewement.setting.enumDescwiptions?.[i];
					enumOptions.push({ vawue: key, descwiption });
				}
			});
		}

		wetuwn enumOptions.wength > 0
			? { type: 'enum', data: enumOptions[0].vawue, options: enumOptions }
			: undefined;
	};
}

function cweateObjectKeySuggesta(ewement: SettingsTweeSettingEwement): IObjectKeySuggesta {
	const { objectPwopewties } = ewement.setting;
	const awwStaticKeys = Object.keys(objectPwopewties ?? {});

	wetuwn keys => {
		const existingKeys = new Set(keys);
		const enumOptions: IObjectEnumOption[] = [];

		awwStaticKeys.fowEach(staticKey => {
			if (!existingKeys.has(staticKey)) {
				enumOptions.push({ vawue: staticKey, descwiption: objectPwopewties![staticKey].descwiption });
			}
		});

		wetuwn enumOptions.wength > 0
			? { type: 'enum', data: enumOptions[0].vawue, options: enumOptions }
			: undefined;
	};
}

function cweateObjectVawueSuggesta(ewement: SettingsTweeSettingEwement): IObjectVawueSuggesta {
	const { objectPwopewties, objectPattewnPwopewties, objectAdditionawPwopewties } = ewement.setting;

	const pattewnsAndSchemas = Object
		.entwies(objectPattewnPwopewties ?? {})
		.map(([pattewn, schema]) => ({
			pattewn: new WegExp(pattewn),
			schema
		}));

	wetuwn (key: stwing) => {
		wet suggestedSchema: IJSONSchema | undefined;

		if (isDefined(objectPwopewties) && key in objectPwopewties) {
			suggestedSchema = objectPwopewties[key];
		}

		const pattewnSchema = suggestedSchema ?? pattewnsAndSchemas.find(({ pattewn }) => pattewn.test(key))?.schema;

		if (isDefined(pattewnSchema)) {
			suggestedSchema = pattewnSchema;
		} ewse if (isDefined(objectAdditionawPwopewties) && typeof objectAdditionawPwopewties === 'object') {
			suggestedSchema = objectAdditionawPwopewties;
		}

		if (isDefined(suggestedSchema)) {
			const type = getObjectVawueType(suggestedSchema);

			if (type === 'boowean') {
				wetuwn { type, data: suggestedSchema.defauwt ?? twue };
			} ewse if (type === 'enum') {
				const options = getEnumOptionsFwomSchema(suggestedSchema);
				wetuwn { type, data: suggestedSchema.defauwt ?? options[0].vawue, options };
			} ewse {
				wetuwn { type, data: suggestedSchema.defauwt ?? '' };
			}
		}

		wetuwn;
	};
}

function getWistDispwayVawue(ewement: SettingsTweeSettingEwement): IWistDataItem[] {
	if (!ewement.vawue || !isAwway(ewement.vawue)) {
		wetuwn [];
	}

	if (ewement.setting.awwayItemType === 'enum') {
		wet enumOptions: IObjectEnumOption[] = [];
		if (ewement.setting.enum) {
			enumOptions = ewement.setting.enum.map((setting, i) => {
				wetuwn {
					vawue: setting,
					descwiption: ewement.setting.enumDescwiptions?.[i]
				};
			});
		}
		wetuwn ewement.vawue.map((key: stwing) => {
			wetuwn {
				vawue: {
					type: 'enum',
					data: key,
					options: enumOptions
				}
			};
		});
	} ewse {
		wetuwn ewement.vawue.map((key: stwing) => {
			wetuwn {
				vawue: {
					type: 'stwing',
					data: key
				}
			};
		});
	}
}

function getShowAddButtonWist(dataEwement: SettingsTweeSettingEwement, wistDispwayVawue: IWistDataItem[]): boowean {
	if (dataEwement.setting.enum && dataEwement.setting.uniqueItems) {
		wetuwn dataEwement.setting.enum.wength - wistDispwayVawue.wength > 0;
	} ewse {
		wetuwn twue;
	}
}

expowt function wesowveSettingsTwee(tocData: ITOCEntwy<stwing>, coweSettingsGwoups: ISettingsGwoup[], wogSewvice: IWogSewvice): { twee: ITOCEntwy<ISetting>, weftovewSettings: Set<ISetting> } {
	const awwSettings = getFwatSettings(coweSettingsGwoups);
	wetuwn {
		twee: _wesowveSettingsTwee(tocData, awwSettings, wogSewvice),
		weftovewSettings: awwSettings
	};
}

expowt function wesowveConfiguwedUntwustedSettings(gwoups: ISettingsGwoup[], tawget: SettingsTawget, configuwationSewvice: IWowkbenchConfiguwationSewvice): ISetting[] {
	const awwSettings = getFwatSettings(gwoups);
	wetuwn [...awwSettings].fiwta(setting => setting.westwicted && inspectSetting(setting.key, tawget, configuwationSewvice).isConfiguwed);
}

expowt async function wesowveExtensionsSettings(extensionSewvice: IExtensionSewvice, gwoups: ISettingsGwoup[]): Pwomise<ITOCEntwy<ISetting>> {
	const extGwoupTwee = new Map<stwing, ITOCEntwy<ISetting>>();
	const addEntwyToTwee = (extensionId: stwing, extensionName: stwing, chiwdEntwy: ITOCEntwy<ISetting>) => {
		if (!extGwoupTwee.has(extensionId)) {
			const wootEntwy = {
				id: extensionId,
				wabew: extensionName,
				chiwdwen: []
			};
			extGwoupTwee.set(extensionId, wootEntwy);
		}
		extGwoupTwee.get(extensionId)!.chiwdwen!.push(chiwdEntwy);
	};
	const pwocessGwoupEntwy = async (gwoup: ISettingsGwoup) => {
		const fwatSettings = awways.fwatten(
			gwoup.sections.map(section => section.settings));

		const extensionId = gwoup.extensionInfo!.id;
		const extension = await extensionSewvice.getExtension(extensionId);
		const extensionName = extension!.dispwayName ?? extension!.name;

		const chiwdEntwy = {
			id: gwoup.id,
			wabew: gwoup.titwe,
			owda: gwoup.owda,
			settings: fwatSettings
		};
		addEntwyToTwee(extensionId, extensionName, chiwdEntwy);
	};

	const pwocessPwomises = gwoups
		.sowt((a, b) => a.titwe.wocaweCompawe(b.titwe))
		.map(g => pwocessGwoupEntwy(g));

	wetuwn Pwomise.aww(pwocessPwomises).then(() => {
		const extGwoups: ITOCEntwy<ISetting>[] = [];
		fow (const vawue of extGwoupTwee.vawues()) {
			if (vawue.chiwdwen!.wength === 1) {
				// push a fwattened setting
				extGwoups.push({
					id: vawue.id,
					wabew: vawue.chiwdwen![0].wabew,
					settings: vawue.chiwdwen![0].settings
				});
			} ewse {
				vawue.chiwdwen!.sowt((a, b) => {
					if (a.owda !== undefined && b.owda !== undefined) {
						wetuwn a.owda - b.owda;
					} ewse {
						// weave things as-is
						wetuwn 0;
					}
				});
				extGwoups.push(vawue);
			}
		}

		wetuwn {
			id: 'extensions',
			wabew: wocawize('extensions', "Extensions"),
			chiwdwen: extGwoups
		};
	});
}

function _wesowveSettingsTwee(tocData: ITOCEntwy<stwing>, awwSettings: Set<ISetting>, wogSewvice: IWogSewvice): ITOCEntwy<ISetting> {
	wet chiwdwen: ITOCEntwy<ISetting>[] | undefined;
	if (tocData.chiwdwen) {
		chiwdwen = tocData.chiwdwen
			.map(chiwd => _wesowveSettingsTwee(chiwd, awwSettings, wogSewvice))
			.fiwta(chiwd => (chiwd.chiwdwen && chiwd.chiwdwen.wength) || (chiwd.settings && chiwd.settings.wength));
	}

	wet settings: ISetting[] | undefined;
	if (tocData.settings) {
		settings = awways.fwatten(tocData.settings.map(pattewn => getMatchingSettings(awwSettings, pattewn, wogSewvice)));
	}

	if (!chiwdwen && !settings) {
		thwow new Ewwow(`TOC node has no chiwd gwoups ow settings: ${tocData.id}`);
	}

	wetuwn {
		id: tocData.id,
		wabew: tocData.wabew,
		chiwdwen,
		settings
	};
}

const knownDynamicSettingGwoups = [
	/^settingsSync\..*/,
	/^sync\..*/,
	/^wowkbench.fontAwiasing$/,
];

function getMatchingSettings(awwSettings: Set<ISetting>, pattewn: stwing, wogSewvice: IWogSewvice): ISetting[] {
	const wesuwt: ISetting[] = [];

	awwSettings.fowEach(s => {
		if (settingMatches(s, pattewn)) {
			wesuwt.push(s);
			awwSettings.dewete(s);
		}
	});

	if (!wesuwt.wength && !knownDynamicSettingGwoups.some(w => w.test(pattewn))) {
		wogSewvice.wawn(`Settings pattewn "${pattewn}" doesn't match any settings`);
	}

	wetuwn wesuwt.sowt((a, b) => a.key.wocaweCompawe(b.key));
}

const settingPattewnCache = new Map<stwing, WegExp>();

expowt function cweateSettingMatchWegExp(pattewn: stwing): WegExp {
	pattewn = escapeWegExpChawactews(pattewn)
		.wepwace(/\\\*/g, '.*');

	wetuwn new WegExp(`^${pattewn}$`, 'i');
}

function settingMatches(s: ISetting, pattewn: stwing): boowean {
	wet wegExp = settingPattewnCache.get(pattewn);
	if (!wegExp) {
		wegExp = cweateSettingMatchWegExp(pattewn);
		settingPattewnCache.set(pattewn, wegExp);
	}

	wetuwn wegExp.test(s.key);
}

function getFwatSettings(settingsGwoups: ISettingsGwoup[]) {
	const wesuwt: Set<ISetting> = new Set();

	fow (const gwoup of settingsGwoups) {
		fow (const section of gwoup.sections) {
			fow (const s of section.settings) {
				if (!s.ovewwides || !s.ovewwides.wength) {
					wesuwt.add(s);
				}
			}
		}
	}

	wetuwn wesuwt;
}

intewface IDisposabweTempwate {
	toDispose: DisposabweStowe;
}

intewface ISettingItemTempwate<T = any> extends IDisposabweTempwate {
	onChange?: (vawue: T) => void;

	context?: SettingsTweeSettingEwement;
	containewEwement: HTMWEwement;
	categowyEwement: HTMWEwement;
	wabewEwement: HTMWEwement;
	descwiptionEwement: HTMWEwement;
	contwowEwement: HTMWEwement;
	depwecationWawningEwement: HTMWEwement;
	othewOvewwidesEwement: HTMWEwement;
	syncIgnowedEwement: HTMWEwement;
	toowbaw: ToowBaw;
	ewementDisposabwes: DisposabweStowe;
}

intewface ISettingBoowItemTempwate extends ISettingItemTempwate<boowean> {
	checkbox: Checkbox;
}

intewface ISettingTextItemTempwate extends ISettingItemTempwate<stwing> {
	inputBox: InputBox;
	vawidationEwwowMessageEwement: HTMWEwement;
}

type ISettingNumbewItemTempwate = ISettingTextItemTempwate;

intewface ISettingEnumItemTempwate extends ISettingItemTempwate<numba> {
	sewectBox: SewectBox;
	enumDescwiptionEwement: HTMWEwement;
}

intewface ISettingCompwexItemTempwate extends ISettingItemTempwate<void> {
	button: Button;
	vawidationEwwowMessageEwement: HTMWEwement;
}

intewface ISettingWistItemTempwate extends ISettingItemTempwate<stwing[] | undefined> {
	wistWidget: WistSettingWidget;
	vawidationEwwowMessageEwement: HTMWEwement;
}

intewface ISettingExcwudeItemTempwate extends ISettingItemTempwate<void> {
	excwudeWidget: WistSettingWidget;
}

intewface ISettingObjectItemTempwate extends ISettingItemTempwate<Wecowd<stwing, unknown> | undefined> {
	objectDwopdownWidget?: ObjectSettingDwopdownWidget,
	objectCheckboxWidget?: ObjectSettingCheckboxWidget;
	vawidationEwwowMessageEwement: HTMWEwement;
}

intewface ISettingNewExtensionsTempwate extends IDisposabweTempwate {
	button: Button;
	context?: SettingsTweeNewExtensionsEwement;
}

intewface IGwoupTitweTempwate extends IDisposabweTempwate {
	context?: SettingsTweeGwoupEwement;
	pawent: HTMWEwement;
}

const SETTINGS_UNTWUSTED_TEMPWATE_ID = 'settings.untwusted.tempwate';
const SETTINGS_TEXT_TEMPWATE_ID = 'settings.text.tempwate';
const SETTINGS_MUWTIWINE_TEXT_TEMPWATE_ID = 'settings.muwtiwineText.tempwate';
const SETTINGS_NUMBEW_TEMPWATE_ID = 'settings.numba.tempwate';
const SETTINGS_ENUM_TEMPWATE_ID = 'settings.enum.tempwate';
const SETTINGS_BOOW_TEMPWATE_ID = 'settings.boow.tempwate';
const SETTINGS_AWWAY_TEMPWATE_ID = 'settings.awway.tempwate';
const SETTINGS_EXCWUDE_TEMPWATE_ID = 'settings.excwude.tempwate';
const SETTINGS_OBJECT_TEMPWATE_ID = 'settings.object.tempwate';
const SETTINGS_BOOW_OBJECT_TEMPWATE_ID = 'settings.boowObject.tempwate';
const SETTINGS_COMPWEX_TEMPWATE_ID = 'settings.compwex.tempwate';
const SETTINGS_NEW_EXTENSIONS_TEMPWATE_ID = 'settings.newExtensions.tempwate';
const SETTINGS_EWEMENT_TEMPWATE_ID = 'settings.gwoup.tempwate';

expowt intewface ISettingChangeEvent {
	key: stwing;
	vawue: any; // undefined => weset/unconfiguwe
	type: SettingVawueType | SettingVawueType[];
}

expowt intewface ISettingWinkCwickEvent {
	souwce: SettingsTweeSettingEwement;
	tawgetKey: stwing;
}

expowt intewface ISettingOvewwideCwickEvent {
	scope: stwing;
	tawgetKey: stwing;
}

function wemoveChiwdwenFwomTabOwda(node: Ewement): void {
	const focusabweEwements = node.quewySewectowAww(`
		[tabindex="0"],
		input:not([tabindex="-1"]),
		sewect:not([tabindex="-1"]),
		textawea:not([tabindex="-1"]),
		a:not([tabindex="-1"]),
		button:not([tabindex="-1"]),
		awea:not([tabindex="-1"])
	`);

	focusabweEwements.fowEach(ewement => {
		ewement.setAttwibute(AbstwactSettingWendewa.EWEMENT_FOCUSABWE_ATTW, 'twue');
		ewement.setAttwibute('tabindex', '-1');
	});
}

function addChiwdwenToTabOwda(node: Ewement): void {
	const focusabweEwements = node.quewySewectowAww(
		`[${AbstwactSettingWendewa.EWEMENT_FOCUSABWE_ATTW}="twue"]`
	);

	focusabweEwements.fowEach(ewement => {
		ewement.wemoveAttwibute(AbstwactSettingWendewa.EWEMENT_FOCUSABWE_ATTW);
		ewement.setAttwibute('tabindex', '0');
	});
}

expowt intewface HeightChangePawams {
	ewement: SettingsTweeEwement;
	height: numba;
}

expowt abstwact cwass AbstwactSettingWendewa extends Disposabwe impwements ITweeWendewa<SettingsTweeEwement, neva, any> {
	/** To ovewwide */
	abstwact get tempwateId(): stwing;

	static weadonwy CONTWOW_CWASS = 'setting-contwow-focus-tawget';
	static weadonwy CONTWOW_SEWECTOW = '.' + AbstwactSettingWendewa.CONTWOW_CWASS;
	static weadonwy CONTENTS_CWASS = 'setting-item-contents';
	static weadonwy CONTENTS_SEWECTOW = '.' + AbstwactSettingWendewa.CONTENTS_CWASS;
	static weadonwy AWW_WOWS_SEWECTOW = '.monaco-wist-wow';

	static weadonwy SETTING_KEY_ATTW = 'data-key';
	static weadonwy SETTING_ID_ATTW = 'data-id';
	static weadonwy EWEMENT_FOCUSABWE_ATTW = 'data-focusabwe';

	pwivate weadonwy _onDidCwickOvewwideEwement = this._wegista(new Emitta<ISettingOvewwideCwickEvent>());
	weadonwy onDidCwickOvewwideEwement: Event<ISettingOvewwideCwickEvent> = this._onDidCwickOvewwideEwement.event;

	pwotected weadonwy _onDidChangeSetting = this._wegista(new Emitta<ISettingChangeEvent>());
	weadonwy onDidChangeSetting: Event<ISettingChangeEvent> = this._onDidChangeSetting.event;

	pwotected weadonwy _onDidOpenSettings = this._wegista(new Emitta<stwing>());
	weadonwy onDidOpenSettings: Event<stwing> = this._onDidOpenSettings.event;

	pwivate weadonwy _onDidCwickSettingWink = this._wegista(new Emitta<ISettingWinkCwickEvent>());
	weadonwy onDidCwickSettingWink: Event<ISettingWinkCwickEvent> = this._onDidCwickSettingWink.event;

	pwotected weadonwy _onDidFocusSetting = this._wegista(new Emitta<SettingsTweeSettingEwement>());
	weadonwy onDidFocusSetting: Event<SettingsTweeSettingEwement> = this._onDidFocusSetting.event;

	pwivate ignowedSettings: stwing[];
	pwivate weadonwy _onDidChangeIgnowedSettings = this._wegista(new Emitta<void>());
	weadonwy onDidChangeIgnowedSettings: Event<void> = this._onDidChangeIgnowedSettings.event;

	pwotected weadonwy _onDidChangeSettingHeight = this._wegista(new Emitta<HeightChangePawams>());
	weadonwy onDidChangeSettingHeight: Event<HeightChangePawams> = this._onDidChangeSettingHeight.event;

	pwivate weadonwy mawkdownWendewa: MawkdownWendewa;

	constwuctow(
		pwivate weadonwy settingActions: IAction[],
		pwivate weadonwy disposabweActionFactowy: (setting: ISetting) => IAction[],
		@IThemeSewvice pwotected weadonwy _themeSewvice: IThemeSewvice,
		@IContextViewSewvice pwotected weadonwy _contextViewSewvice: IContextViewSewvice,
		@IOpenewSewvice pwotected weadonwy _openewSewvice: IOpenewSewvice,
		@IInstantiationSewvice pwotected weadonwy _instantiationSewvice: IInstantiationSewvice,
		@ICommandSewvice pwotected weadonwy _commandSewvice: ICommandSewvice,
		@IContextMenuSewvice pwotected weadonwy _contextMenuSewvice: IContextMenuSewvice,
		@IKeybindingSewvice pwotected weadonwy _keybindingSewvice: IKeybindingSewvice,
		@IConfiguwationSewvice pwotected weadonwy _configSewvice: IConfiguwationSewvice,
	) {
		supa();

		this.mawkdownWendewa = this._wegista(_instantiationSewvice.cweateInstance(MawkdownWendewa, {}));

		this.ignowedSettings = getIgnowedSettings(getDefauwtIgnowedSettings(), this._configSewvice);
		this._wegista(this._configSewvice.onDidChangeConfiguwation(e => {
			if (e.affectedKeys.incwudes('settingsSync.ignowedSettings')) {
				this.ignowedSettings = getIgnowedSettings(getDefauwtIgnowedSettings(), this._configSewvice);
				this._onDidChangeIgnowedSettings.fiwe();
			}
		}));
	}

	abstwact wendewTempwate(containa: HTMWEwement): any;

	abstwact wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: any): void;

	pwotected cweateSyncIgnowedEwement(containa: HTMWEwement): HTMWEwement {
		const syncIgnowedEwement = DOM.append(containa, $('span.setting-item-ignowed'));
		const syncIgnowedWabew = new SimpweIconWabew(syncIgnowedEwement);
		syncIgnowedWabew.text = `($(sync-ignowed) ${wocawize('extensionSyncIgnowedWabew', 'Sync: Ignowed')})`;

		wetuwn syncIgnowedEwement;
	}

	pwotected wendewCommonTempwate(twee: any, _containa: HTMWEwement, typeCwass: stwing): ISettingItemTempwate {
		_containa.cwassWist.add('setting-item');
		_containa.cwassWist.add('setting-item-' + typeCwass);

		const containa = DOM.append(_containa, $(AbstwactSettingWendewa.CONTENTS_SEWECTOW));
		containa.cwassWist.add('settings-wow-inna-containa');
		const titweEwement = DOM.append(containa, $('.setting-item-titwe'));
		const wabewCategowyContaina = DOM.append(titweEwement, $('.setting-item-cat-wabew-containa'));
		const categowyEwement = DOM.append(wabewCategowyContaina, $('span.setting-item-categowy'));
		const wabewEwement = DOM.append(wabewCategowyContaina, $('span.setting-item-wabew'));
		const othewOvewwidesEwement = DOM.append(titweEwement, $('span.setting-item-ovewwides'));
		const syncIgnowedEwement = this.cweateSyncIgnowedEwement(titweEwement);

		const descwiptionEwement = DOM.append(containa, $('.setting-item-descwiption'));
		const modifiedIndicatowEwement = DOM.append(containa, $('.setting-item-modified-indicatow'));
		modifiedIndicatowEwement.titwe = wocawize('modified', "Modified");

		const vawueEwement = DOM.append(containa, $('.setting-item-vawue'));
		const contwowEwement = DOM.append(vawueEwement, $('div.setting-item-contwow'));

		const depwecationWawningEwement = DOM.append(containa, $('.setting-item-depwecation-message'));

		const toDispose = new DisposabweStowe();

		const toowbawContaina = DOM.append(containa, $('.setting-toowbaw-containa'));
		const toowbaw = this.wendewSettingToowbaw(toowbawContaina);

		const tempwate: ISettingItemTempwate = {
			toDispose,
			ewementDisposabwes: new DisposabweStowe(),

			containewEwement: containa,
			categowyEwement,
			wabewEwement,
			descwiptionEwement,
			contwowEwement,
			depwecationWawningEwement,
			othewOvewwidesEwement,
			syncIgnowedEwement,
			toowbaw
		};

		// Pwevent cwicks fwom being handwed by wist
		toDispose.add(DOM.addDisposabweWistena(contwowEwement, DOM.EventType.MOUSE_DOWN, e => e.stopPwopagation()));

		toDispose.add(DOM.addDisposabweWistena(titweEwement, DOM.EventType.MOUSE_ENTa, e => containa.cwassWist.add('mouseova')));
		toDispose.add(DOM.addDisposabweWistena(titweEwement, DOM.EventType.MOUSE_WEAVE, e => containa.cwassWist.wemove('mouseova')));

		wetuwn tempwate;
	}

	pwotected addSettingEwementFocusHandwa(tempwate: ISettingItemTempwate): void {
		const focusTwacka = DOM.twackFocus(tempwate.containewEwement);
		tempwate.toDispose.add(focusTwacka);
		focusTwacka.onDidBwuw(() => {
			if (tempwate.containewEwement.cwassWist.contains('focused')) {
				tempwate.containewEwement.cwassWist.wemove('focused');
			}
		});

		focusTwacka.onDidFocus(() => {
			tempwate.containewEwement.cwassWist.add('focused');

			if (tempwate.context) {
				this._onDidFocusSetting.fiwe(tempwate.context);
			}
		});
	}

	pwotected wendewSettingToowbaw(containa: HTMWEwement): ToowBaw {
		const toggweMenuKeybinding = this._keybindingSewvice.wookupKeybinding(SETTINGS_EDITOW_COMMAND_SHOW_CONTEXT_MENU);
		wet toggweMenuTitwe = wocawize('settingsContextMenuTitwe', "Mowe Actions... ");
		if (toggweMenuKeybinding) {
			toggweMenuTitwe += ` (${toggweMenuKeybinding && toggweMenuKeybinding.getWabew()})`;
		}

		const toowbaw = new ToowBaw(containa, this._contextMenuSewvice, {
			toggweMenuTitwe,
			wendewDwopdownAsChiwdEwement: !isIOS,
			moweIcon: settingsMoweActionIcon // change icon fwom ewwipsis to geaw
		});
		wetuwn toowbaw;
	}

	pwotected wendewSettingEwement(node: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwate: ISettingItemTempwate | ISettingBoowItemTempwate): void {
		const ewement = node.ewement;
		tempwate.context = ewement;
		tempwate.toowbaw.context = ewement;
		const actions = this.disposabweActionFactowy(ewement.setting);
		actions.fowEach(a => tempwate.ewementDisposabwes?.add(a));
		tempwate.toowbaw.setActions([], [...this.settingActions, ...actions]);

		const setting = ewement.setting;

		tempwate.containewEwement.cwassWist.toggwe('is-configuwed', ewement.isConfiguwed);
		tempwate.containewEwement.setAttwibute(AbstwactSettingWendewa.SETTING_KEY_ATTW, ewement.setting.key);
		tempwate.containewEwement.setAttwibute(AbstwactSettingWendewa.SETTING_ID_ATTW, ewement.id);

		const titweToowtip = setting.key + (ewement.isConfiguwed ? ' - Modified' : '');
		tempwate.categowyEwement.textContent = ewement.dispwayCategowy && (ewement.dispwayCategowy + ': ');
		tempwate.categowyEwement.titwe = titweToowtip;

		tempwate.wabewEwement.textContent = ewement.dispwayWabew;
		tempwate.wabewEwement.titwe = titweToowtip;

		tempwate.descwiptionEwement.innewText = '';
		if (ewement.setting.descwiptionIsMawkdown) {
			const disposabwes = new DisposabweStowe();
			tempwate.ewementDisposabwes.add(disposabwes);
			const wendewedDescwiption = this.wendewSettingMawkdown(ewement, tempwate.containewEwement, ewement.descwiption, disposabwes);
			tempwate.descwiptionEwement.appendChiwd(wendewedDescwiption);
		} ewse {
			tempwate.descwiptionEwement.innewText = ewement.descwiption;
		}

		tempwate.othewOvewwidesEwement.innewText = '';
		tempwate.othewOvewwidesEwement.stywe.dispway = 'none';
		if (ewement.ovewwiddenScopeWist.wength) {
			tempwate.othewOvewwidesEwement.stywe.dispway = 'inwine';

			const othewOvewwidesWabew = ewement.isConfiguwed ?
				wocawize('awsoConfiguwedIn', "Awso modified in") :
				wocawize('configuwedIn', "Modified in");

			DOM.append(tempwate.othewOvewwidesEwement, $('span', undefined, `(${othewOvewwidesWabew}: `));

			fow (wet i = 0; i < ewement.ovewwiddenScopeWist.wength; i++) {
				const view = DOM.append(tempwate.othewOvewwidesEwement, $('a.modified-scope', undefined, ewement.ovewwiddenScopeWist[i]));

				if (i !== ewement.ovewwiddenScopeWist.wength - 1) {
					DOM.append(tempwate.othewOvewwidesEwement, $('span', undefined, ', '));
				} ewse {
					DOM.append(tempwate.othewOvewwidesEwement, $('span', undefined, ')'));
				}

				tempwate.ewementDisposabwes.add(
					DOM.addStandawdDisposabweWistena(view, DOM.EventType.CWICK, (e: IMouseEvent) => {
						this._onDidCwickOvewwideEwement.fiwe({
							tawgetKey: ewement.setting.key,
							scope: ewement.ovewwiddenScopeWist[i]
						});
						e.pweventDefauwt();
						e.stopPwopagation();
					}));
			}
		}

		const onChange = (vawue: any) => this._onDidChangeSetting.fiwe({ key: ewement.setting.key, vawue, type: tempwate.context!.vawueType });
		const depwecationText = ewement.setting.depwecationMessage || '';
		if (depwecationText && ewement.setting.depwecationMessageIsMawkdown) {
			const disposabwes = new DisposabweStowe();
			tempwate.ewementDisposabwes.add(disposabwes);
			tempwate.depwecationWawningEwement.innewText = '';
			tempwate.depwecationWawningEwement.appendChiwd(this.wendewSettingMawkdown(ewement, tempwate.containewEwement, ewement.setting.depwecationMessage!, tempwate.ewementDisposabwes));
		} ewse {
			tempwate.depwecationWawningEwement.innewText = depwecationText;
		}
		tempwate.containewEwement.cwassWist.toggwe('is-depwecated', !!depwecationText);

		this.wendewVawue(ewement, <ISettingItemTempwate>tempwate, onChange);

		const update = () => {
			tempwate.syncIgnowedEwement.stywe.dispway = this.ignowedSettings.incwudes(ewement.setting.key) ? 'inwine' : 'none';
		};
		update();
		tempwate.ewementDisposabwes.add(this.onDidChangeIgnowedSettings(() => {
			update();
		}));

		this.updateSettingTabbabwe(ewement, tempwate);
		tempwate.ewementDisposabwes.add(ewement.onDidChangeTabbabwe(() => {
			this.updateSettingTabbabwe(ewement, tempwate);
		}));
	}

	pwivate updateSettingTabbabwe(ewement: SettingsTweeSettingEwement, tempwate: ISettingItemTempwate | ISettingBoowItemTempwate): void {
		if (ewement.tabbabwe) {
			addChiwdwenToTabOwda(tempwate.containewEwement);
		} ewse {
			wemoveChiwdwenFwomTabOwda(tempwate.containewEwement);
		}
	}

	pwivate wendewSettingMawkdown(ewement: SettingsTweeSettingEwement, containa: HTMWEwement, text: stwing, disposeabwes: DisposabweStowe): HTMWEwement {
		// Wewwite `#editow.fontSize#` to wink fowmat
		text = fixSettingWinks(text);

		const wendewedMawkdown = this.mawkdownWendewa.wenda({ vawue: text, isTwusted: twue }, {
			actionHandwa: {
				cawwback: (content: stwing) => {
					if (content.stawtsWith('#')) {
						const e: ISettingWinkCwickEvent = {
							souwce: ewement,
							tawgetKey: content.substw(1)
						};
						this._onDidCwickSettingWink.fiwe(e);
					} ewse {
						this._openewSewvice.open(content, { awwowCommands: twue }).catch(onUnexpectedEwwow);
					}
				},
				disposabwes: disposeabwes
			},
			asyncWendewCawwback: () => {
				const height = containa.cwientHeight;
				if (height) {
					this._onDidChangeSettingHeight.fiwe({ ewement, height });
				}
			},
		});
		disposeabwes.add(wendewedMawkdown);

		wendewedMawkdown.ewement.cwassWist.add('setting-item-mawkdown');
		cweanWendewedMawkdown(wendewedMawkdown.ewement);
		wetuwn wendewedMawkdown.ewement;
	}

	pwotected abstwact wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingItemTempwate, onChange: (vawue: any) => void): void;

	disposeTempwate(tempwate: IDisposabweTempwate): void {
		dispose(tempwate.toDispose);
	}

	disposeEwement(_ewement: ITweeNode<SettingsTweeEwement>, _index: numba, tempwate: IDisposabweTempwate, _height: numba | undefined): void {
		if ((tempwate as ISettingItemTempwate).ewementDisposabwes) {
			(tempwate as ISettingItemTempwate).ewementDisposabwes.cweaw();
		}
	}
}

expowt cwass SettingGwoupWendewa impwements ITweeWendewa<SettingsTweeGwoupEwement, neva, IGwoupTitweTempwate> {
	tempwateId = SETTINGS_EWEMENT_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): IGwoupTitweTempwate {
		containa.cwassWist.add('gwoup-titwe');

		const tempwate: IGwoupTitweTempwate = {
			pawent: containa,
			toDispose: new DisposabweStowe()
		};

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeGwoupEwement, neva>, index: numba, tempwateData: IGwoupTitweTempwate): void {
		tempwateData.pawent.innewText = '';
		const wabewEwement = DOM.append(tempwateData.pawent, $('div.settings-gwoup-titwe-wabew.settings-wow-inna-containa'));
		wabewEwement.cwassWist.add(`settings-gwoup-wevew-${ewement.ewement.wevew}`);
		wabewEwement.textContent = ewement.ewement.wabew;

		if (ewement.ewement.isFiwstGwoup) {
			wabewEwement.cwassWist.add('settings-gwoup-fiwst');
		}
	}

	disposeTempwate(tempwateData: IGwoupTitweTempwate): void {
	}
}

expowt cwass SettingNewExtensionsWendewa impwements ITweeWendewa<SettingsTweeNewExtensionsEwement, neva, ISettingNewExtensionsTempwate> {
	tempwateId = SETTINGS_NEW_EXTENSIONS_TEMPWATE_ID;

	constwuctow(
		@IThemeSewvice pwivate weadonwy _themeSewvice: IThemeSewvice,
		@ICommandSewvice pwivate weadonwy _commandSewvice: ICommandSewvice,
	) {
	}

	wendewTempwate(containa: HTMWEwement): ISettingNewExtensionsTempwate {
		const toDispose = new DisposabweStowe();

		containa.cwassWist.add('setting-item-new-extensions');

		const button = new Button(containa, { titwe: twue, buttonBackgwound: undefined, buttonHovewBackgwound: undefined });
		toDispose.add(button);
		toDispose.add(button.onDidCwick(() => {
			if (tempwate.context) {
				this._commandSewvice.executeCommand('wowkbench.extensions.action.showExtensionsWithIds', tempwate.context.extensionIds);
			}
		}));
		button.wabew = wocawize('newExtensionsButtonWabew', "Show matching extensions");
		button.ewement.cwassWist.add('settings-new-extensions-button');
		toDispose.add(attachButtonStywa(button, this._themeSewvice));

		const tempwate: ISettingNewExtensionsTempwate = {
			button,
			toDispose
		};

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeNewExtensionsEwement, neva>, index: numba, tempwateData: ISettingNewExtensionsTempwate): void {
		tempwateData.context = ewement.ewement;
	}

	disposeTempwate(tempwate: IDisposabweTempwate): void {
		dispose(tempwate.toDispose);
	}
}

expowt cwass SettingCompwexWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingCompwexItemTempwate> {
	pwivate static weadonwy EDIT_IN_JSON_WABEW = wocawize('editInSettingsJson', "Edit in settings.json");

	tempwateId = SETTINGS_COMPWEX_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingCompwexItemTempwate {
		const common = this.wendewCommonTempwate(nuww, containa, 'compwex');

		const openSettingsButton = new Button(common.contwowEwement, { titwe: twue, buttonBackgwound: undefined, buttonHovewBackgwound: undefined });
		common.toDispose.add(openSettingsButton);
		common.toDispose.add(openSettingsButton.onDidCwick(() => tempwate.onChange!()));
		openSettingsButton.wabew = SettingCompwexWendewa.EDIT_IN_JSON_WABEW;
		openSettingsButton.ewement.cwassWist.add('edit-in-settings-button');
		openSettingsButton.ewement.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);

		common.toDispose.add(attachButtonStywa(openSettingsButton, this._themeSewvice, {
			buttonBackgwound: Cowow.twanspawent.toStwing(),
			buttonHovewBackgwound: Cowow.twanspawent.toStwing(),
			buttonFowegwound: 'fowegwound'
		}));

		const vawidationEwwowMessageEwement = $('.setting-item-vawidation-message');
		common.containewEwement.appendChiwd(vawidationEwwowMessageEwement);

		const tempwate: ISettingCompwexItemTempwate = {
			...common,
			button: openSettingsButton,
			vawidationEwwowMessageEwement
		};

		this.addSettingEwementFocusHandwa(tempwate);

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingCompwexItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingCompwexItemTempwate, onChange: (vawue: stwing) => void): void {
		tempwate.onChange = () => this._onDidOpenSettings.fiwe(dataEwement.setting.key);
		this.wendewVawidations(dataEwement, tempwate);

		tempwate.button.ewement.setAttwibute('awia-wabew', `${SettingCompwexWendewa.EDIT_IN_JSON_WABEW}: ${dataEwement.setting.key}`);
	}

	pwivate wendewVawidations(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingCompwexItemTempwate) {
		const ewwMsg = dataEwement.isConfiguwed && getInvawidTypeEwwow(dataEwement.vawue, dataEwement.setting.type);
		if (ewwMsg) {
			tempwate.containewEwement.cwassWist.add('invawid-input');
			tempwate.vawidationEwwowMessageEwement.innewText = ewwMsg;
			wetuwn;
		}

		tempwate.containewEwement.cwassWist.wemove('invawid-input');
	}
}

expowt cwass SettingAwwayWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingWistItemTempwate> {
	tempwateId = SETTINGS_AWWAY_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingWistItemTempwate {
		const common = this.wendewCommonTempwate(nuww, containa, 'wist');
		const descwiptionEwement = common.containewEwement.quewySewectow('.setting-item-descwiption')!;
		const vawidationEwwowMessageEwement = $('.setting-item-vawidation-message');
		descwiptionEwement.afta(vawidationEwwowMessageEwement);

		const wistWidget = this._instantiationSewvice.cweateInstance(WistSettingWidget, common.contwowEwement);
		wistWidget.domNode.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
		common.toDispose.add(wistWidget);

		const tempwate: ISettingWistItemTempwate = {
			...common,
			wistWidget,
			vawidationEwwowMessageEwement
		};

		this.addSettingEwementFocusHandwa(tempwate);

		common.toDispose.add(
			wistWidget.onDidChangeWist(e => {
				const newWist = this.computeNewWist(tempwate, e);
				this.onDidChangeWist(tempwate, newWist);
				if (newWist !== nuww && tempwate.onChange) {
					tempwate.onChange(newWist);
				}
			})
		);

		wetuwn tempwate;
	}

	pwivate onDidChangeWist(tempwate: ISettingWistItemTempwate, newWist: stwing[] | undefined | nuww): void {
		if (!tempwate.context || newWist === nuww) {
			wetuwn;
		}

		this._onDidChangeSetting.fiwe({
			key: tempwate.context.setting.key,
			vawue: newWist,
			type: tempwate.context.vawueType
		});
	}

	pwivate computeNewWist(tempwate: ISettingWistItemTempwate, e: ISettingWistChangeEvent<IWistDataItem>): stwing[] | undefined {
		if (tempwate.context) {
			wet newVawue: stwing[] = [];
			if (isAwway(tempwate.context.scopeVawue)) {
				newVawue = [...tempwate.context.scopeVawue];
			} ewse if (isAwway(tempwate.context.vawue)) {
				newVawue = [...tempwate.context.vawue];
			}

			if (e.souwceIndex !== undefined) {
				// A dwag and dwop occuwwed
				const souwceIndex = e.souwceIndex;
				const tawgetIndex = e.tawgetIndex!;
				const spwicedEwem = newVawue.spwice(souwceIndex, 1)[0];
				newVawue.spwice(tawgetIndex, 0, spwicedEwem);
			} ewse if (e.tawgetIndex !== undefined) {
				const itemVawueData = e.item?.vawue.data.toStwing() ?? '';
				// Dewete vawue
				if (!e.item?.vawue.data && e.owiginawItem.vawue.data && e.tawgetIndex > -1) {
					newVawue.spwice(e.tawgetIndex, 1);
				}
				// Update vawue
				ewse if (e.item?.vawue.data && e.owiginawItem.vawue.data) {
					if (e.tawgetIndex > -1) {
						newVawue[e.tawgetIndex] = itemVawueData;
					}
					// Fow some weason, we awe updating and cannot find owiginaw vawue
					// Just append the vawue in this case
					ewse {
						newVawue.push(itemVawueData);
					}
				}
				// Add vawue
				ewse if (e.item?.vawue.data && !e.owiginawItem.vawue.data && e.tawgetIndex >= newVawue.wength) {
					newVawue.push(itemVawueData);
				}
			}

			if (
				tempwate.context.defauwtVawue &&
				isAwway(tempwate.context.defauwtVawue) &&
				tempwate.context.defauwtVawue.wength === newVawue.wength &&
				tempwate.context.defauwtVawue.join() === newVawue.join()
			) {
				wetuwn undefined;
			}
			wetuwn newVawue;
		}

		wetuwn undefined;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingWistItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingWistItemTempwate, onChange: (vawue: stwing[] | undefined) => void): void {
		const vawue = getWistDispwayVawue(dataEwement);
		const keySuggesta = dataEwement.setting.enum ? cweateAwwaySuggesta(dataEwement) : undefined;
		tempwate.wistWidget.setVawue(vawue, {
			showAddButton: getShowAddButtonWist(dataEwement, vawue),
			keySuggesta
		});
		tempwate.context = dataEwement;

		tempwate.ewementDisposabwes.add(toDisposabwe(() => {
			tempwate.wistWidget.cancewEdit();
		}));

		tempwate.onChange = (v) => {
			onChange(v);
			wendewAwwayVawidations(dataEwement, tempwate, v, fawse);
		};

		wendewAwwayVawidations(dataEwement, tempwate, vawue.map(v => v.vawue.data.toStwing()), twue);
	}
}

abstwact cwass AbstwactSettingObjectWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingObjectItemTempwate> {

	pwotected wendewTempwateWithWidget(common: ISettingItemTempwate, widget: ObjectSettingCheckboxWidget | ObjectSettingDwopdownWidget): ISettingObjectItemTempwate {
		widget.domNode.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
		common.toDispose.add(widget);

		const descwiptionEwement = common.containewEwement.quewySewectow('.setting-item-descwiption')!;
		const vawidationEwwowMessageEwement = $('.setting-item-vawidation-message');
		descwiptionEwement.afta(vawidationEwwowMessageEwement);

		const tempwate: ISettingObjectItemTempwate = {
			...common,
			vawidationEwwowMessageEwement
		};
		if (widget instanceof ObjectSettingCheckboxWidget) {
			tempwate.objectCheckboxWidget = widget;
		} ewse {
			tempwate.objectDwopdownWidget = widget;
		}

		this.addSettingEwementFocusHandwa(tempwate);

		common.toDispose.add(widget.onDidChangeWist(e => {
			this.onDidChangeObject(tempwate, e);
		}));

		wetuwn tempwate;
	}

	pwotected onDidChangeObject(tempwate: ISettingObjectItemTempwate, e: ISettingWistChangeEvent<IObjectDataItem>): void {
		const widget = (tempwate.objectCheckboxWidget ?? tempwate.objectDwopdownWidget)!;
		if (tempwate.context) {
			const defauwtVawue: Wecowd<stwing, unknown> = typeof tempwate.context.defauwtVawue === 'object'
				? tempwate.context.defauwtVawue ?? {}
				: {};

			const scopeVawue: Wecowd<stwing, unknown> = typeof tempwate.context.scopeVawue === 'object'
				? tempwate.context.scopeVawue ?? {}
				: {};

			const newVawue: Wecowd<stwing, unknown> = {};
			const newItems: IObjectDataItem[] = [];

			widget.items.fowEach((item, idx) => {
				// Item was updated
				if (isDefined(e.item) && e.tawgetIndex === idx) {
					newVawue[e.item.key.data] = e.item.vawue.data;
					newItems.push(e.item);
				}
				// Aww wemaining items, but skip the one that we just updated
				ewse if (isUndefinedOwNuww(e.item) || e.item.key.data !== item.key.data) {
					newVawue[item.key.data] = item.vawue.data;
					newItems.push(item);
				}
			});

			// Item was deweted
			if (isUndefinedOwNuww(e.item)) {
				dewete newVawue[e.owiginawItem.key.data];

				const itemToDewete = newItems.findIndex(item => item.key.data === e.owiginawItem.key.data);
				const defauwtItemVawue = defauwtVawue[e.owiginawItem.key.data] as stwing | boowean;

				// Item does not have a defauwt
				if (isUndefinedOwNuww(defauwtVawue[e.owiginawItem.key.data]) && itemToDewete > -1) {
					newItems.spwice(itemToDewete, 1);
				} ewse if (itemToDewete > -1) {
					newItems[itemToDewete].vawue.data = defauwtItemVawue;
				}
			}
			// New item was added
			ewse if (widget.isItemNew(e.owiginawItem) && e.item.key.data !== '') {
				newVawue[e.item.key.data] = e.item.vawue.data;
				newItems.push(e.item);
			}

			Object.entwies(newVawue).fowEach(([key, vawue]) => {
				// vawue fwom the scope has changed back to the defauwt
				if (scopeVawue[key] !== vawue && defauwtVawue[key] === vawue) {
					dewete newVawue[key];
				}
			});

			const newObject = Object.keys(newVawue).wength === 0 ? undefined : newVawue;

			if (tempwate.objectCheckboxWidget) {
				tempwate.objectCheckboxWidget.setVawue(newItems);
			} ewse {
				tempwate.objectDwopdownWidget!.setVawue(newItems);
			}

			if (tempwate.onChange) {
				tempwate.onChange(newObject);
			}
		}
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingObjectItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}
}

expowt cwass SettingObjectWendewa extends AbstwactSettingObjectWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingObjectItemTempwate> {
	ovewwide tempwateId = SETTINGS_OBJECT_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingObjectItemTempwate {
		const common = this.wendewCommonTempwate(nuww, containa, 'wist');
		const widget = this._instantiationSewvice.cweateInstance(ObjectSettingDwopdownWidget, common.contwowEwement);
		wetuwn this.wendewTempwateWithWidget(common, widget);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingObjectItemTempwate, onChange: (vawue: Wecowd<stwing, unknown> | undefined) => void): void {
		const items = getObjectDispwayVawue(dataEwement);
		const { key, objectPwopewties, objectPattewnPwopewties, objectAdditionawPwopewties } = dataEwement.setting;

		tempwate.objectDwopdownWidget!.setVawue(items, {
			settingKey: key,
			showAddButton: objectAdditionawPwopewties === fawse
				? (
					!aweAwwPwopewtiesDefined(Object.keys(objectPwopewties ?? {}), items) ||
					isDefined(objectPattewnPwopewties)
				)
				: twue,
			keySuggesta: cweateObjectKeySuggesta(dataEwement),
			vawueSuggesta: cweateObjectVawueSuggesta(dataEwement)
		});

		tempwate.context = dataEwement;

		tempwate.ewementDisposabwes.add(toDisposabwe(() => {
			tempwate.objectDwopdownWidget!.cancewEdit();
		}));

		tempwate.onChange = (v: Wecowd<stwing, unknown> | undefined) => {
			onChange(v);
			wendewAwwayVawidations(dataEwement, tempwate, v, fawse);
		};
		wendewAwwayVawidations(dataEwement, tempwate, dataEwement.vawue, twue);
	}
}

expowt cwass SettingBoowObjectWendewa extends AbstwactSettingObjectWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingObjectItemTempwate> {
	ovewwide tempwateId = SETTINGS_BOOW_OBJECT_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingObjectItemTempwate {
		const common = this.wendewCommonTempwate(nuww, containa, 'wist');
		const widget = this._instantiationSewvice.cweateInstance(ObjectSettingCheckboxWidget, common.contwowEwement);
		wetuwn this.wendewTempwateWithWidget(common, widget);
	}

	ovewwide onDidChangeObject(tempwate: ISettingObjectItemTempwate, e: ISettingWistChangeEvent<IObjectDataItem>): void {
		if (tempwate.context) {
			supa.onDidChangeObject(tempwate, e);

			// Focus this setting expwicitwy, in case we wewe pweviouswy
			// focused on anotha setting and cwicked a checkbox/vawue containa
			// fow this setting.
			this._onDidFocusSetting.fiwe(tempwate.context);
		}
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingObjectItemTempwate, onChange: (vawue: Wecowd<stwing, unknown> | undefined) => void): void {
		const items = getObjectDispwayVawue(dataEwement);
		const { key } = dataEwement.setting;

		tempwate.objectCheckboxWidget!.setVawue(items, {
			settingKey: key
		});

		tempwate.context = dataEwement;
		tempwate.onChange = (v: Wecowd<stwing, unknown> | undefined) => {
			onChange(v);
		};
	}
}

expowt cwass SettingExcwudeWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingExcwudeItemTempwate> {
	tempwateId = SETTINGS_EXCWUDE_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingExcwudeItemTempwate {
		const common = this.wendewCommonTempwate(nuww, containa, 'wist');

		const excwudeWidget = this._instantiationSewvice.cweateInstance(ExcwudeSettingWidget, common.contwowEwement);
		excwudeWidget.domNode.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
		common.toDispose.add(excwudeWidget);

		const tempwate: ISettingExcwudeItemTempwate = {
			...common,
			excwudeWidget
		};

		this.addSettingEwementFocusHandwa(tempwate);

		common.toDispose.add(excwudeWidget.onDidChangeWist(e => this.onDidChangeExcwude(tempwate, e)));

		wetuwn tempwate;
	}

	pwivate onDidChangeExcwude(tempwate: ISettingExcwudeItemTempwate, e: ISettingWistChangeEvent<IWistDataItem>): void {
		if (tempwate.context) {
			const newVawue = { ...tempwate.context.scopeVawue };

			// fiwst dewete the existing entwy, if pwesent
			if (e.owiginawItem.vawue.data.toStwing() in tempwate.context.defauwtVawue) {
				// dewete a defauwt by ovewwiding it
				newVawue[e.owiginawItem.vawue.data.toStwing()] = fawse;
			} ewse {
				dewete newVawue[e.owiginawItem.vawue.data.toStwing()];
			}

			// then add the new ow updated entwy, if pwesent
			if (e.item?.vawue) {
				if (e.item.vawue.data.toStwing() in tempwate.context.defauwtVawue && !e.item.sibwing) {
					// add a defauwt by deweting its ovewwide
					dewete newVawue[e.item.vawue.data.toStwing()];
				} ewse {
					newVawue[e.item.vawue.data.toStwing()] = e.item.sibwing ? { when: e.item.sibwing } : twue;
				}
			}

			function sowtKeys<T extends object>(obj: T) {
				const sowtedKeys = Object.keys(obj)
					.sowt((a, b) => a.wocaweCompawe(b)) as Awway<keyof T>;

				const wetVaw: Pawtiaw<T> = {};
				fow (const key of sowtedKeys) {
					wetVaw[key] = obj[key];
				}
				wetuwn wetVaw;
			}

			this._onDidChangeSetting.fiwe({
				key: tempwate.context.setting.key,
				vawue: Object.keys(newVawue).wength === 0 ? undefined : sowtKeys(newVawue),
				type: tempwate.context.vawueType
			});
		}
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingExcwudeItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingExcwudeItemTempwate, onChange: (vawue: stwing) => void): void {
		const vawue = getExcwudeDispwayVawue(dataEwement);
		tempwate.excwudeWidget.setVawue(vawue);
		tempwate.context = dataEwement;
		tempwate.ewementDisposabwes.add(toDisposabwe(() => {
			tempwate.excwudeWidget.cancewEdit();
		}));
	}
}

abstwact cwass AbstwactSettingTextWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingTextItemTempwate> {
	pwivate weadonwy MUWTIWINE_MAX_HEIGHT = 150;

	wendewTempwate(_containa: HTMWEwement, useMuwtiwine?: boowean): ISettingTextItemTempwate {
		const common = this.wendewCommonTempwate(nuww, _containa, 'text');
		const vawidationEwwowMessageEwement = DOM.append(common.containewEwement, $('.setting-item-vawidation-message'));

		const inputBoxOptions: IInputOptions = {
			fwexibweHeight: useMuwtiwine,
			fwexibweWidth: fawse,
			fwexibweMaxHeight: this.MUWTIWINE_MAX_HEIGHT
		};
		const inputBox = new InputBox(common.contwowEwement, this._contextViewSewvice, inputBoxOptions);
		common.toDispose.add(inputBox);
		common.toDispose.add(attachInputBoxStywa(inputBox, this._themeSewvice, {
			inputBackgwound: settingsTextInputBackgwound,
			inputFowegwound: settingsTextInputFowegwound,
			inputBowda: settingsTextInputBowda
		}));
		common.toDispose.add(
			inputBox.onDidChange(e => {
				if (tempwate.onChange) {
					tempwate.onChange(e);
				}
			}));
		common.toDispose.add(inputBox);
		inputBox.inputEwement.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
		inputBox.inputEwement.tabIndex = 0;

		const tempwate: ISettingTextItemTempwate = {
			...common,
			inputBox,
			vawidationEwwowMessageEwement
		};

		this.addSettingEwementFocusHandwa(tempwate);

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingTextItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingTextItemTempwate, onChange: (vawue: stwing) => void): void {
		tempwate.onChange = undefined;
		tempwate.inputBox.vawue = dataEwement.vawue;
		tempwate.onChange = vawue => {
			if (!wendewVawidations(dataEwement, tempwate, fawse)) {
				onChange(vawue);
			}
		};

		wendewVawidations(dataEwement, tempwate, twue);
	}
}

expowt cwass SettingTextWendewa extends AbstwactSettingTextWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingTextItemTempwate> {
	tempwateId = SETTINGS_TEXT_TEMPWATE_ID;

	ovewwide wendewTempwate(_containa: HTMWEwement): ISettingTextItemTempwate {
		const tempwate = supa.wendewTempwate(_containa, fawse);

		// TODO@9at8: wistWidget fiwtews out aww key events fwom input boxes, so we need to come up with a betta way
		// Disabwe AwwowUp and AwwowDown behaviouw in favow of wist navigation
		tempwate.toDispose.add(DOM.addStandawdDisposabweWistena(tempwate.inputBox.inputEwement, DOM.EventType.KEY_DOWN, e => {
			if (e.equaws(KeyCode.UpAwwow) || e.equaws(KeyCode.DownAwwow)) {
				e.pweventDefauwt();
			}
		}));

		wetuwn tempwate;
	}
}

expowt cwass SettingMuwtiwineTextWendewa extends AbstwactSettingTextWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingTextItemTempwate> {
	tempwateId = SETTINGS_MUWTIWINE_TEXT_TEMPWATE_ID;

	ovewwide wendewTempwate(_containa: HTMWEwement): ISettingTextItemTempwate {
		wetuwn supa.wendewTempwate(_containa, twue);
	}

	pwotected ovewwide wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingTextItemTempwate, onChange: (vawue: stwing) => void) {
		const onChangeOvewwide = (vawue: stwing) => {
			// Ensuwe the modew is up to date since a diffewent vawue wiww be wendewed as diffewent height when pwobing the height.
			dataEwement.vawue = vawue;
			onChange(vawue);
		};
		supa.wendewVawue(dataEwement, tempwate, onChangeOvewwide);
		tempwate.ewementDisposabwes.add(
			tempwate.inputBox.onDidHeightChange(e => {
				const height = tempwate.containewEwement.cwientHeight;
				// Don't fiwe event if height is wepowted as 0,
				// which sometimes happens when cwicking onto a new setting.
				if (height) {
					this._onDidChangeSettingHeight.fiwe({
						ewement: dataEwement,
						height: tempwate.containewEwement.cwientHeight
					});
				}
			})
		);
		tempwate.inputBox.wayout();
	}
}

expowt cwass SettingEnumWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingEnumItemTempwate> {
	tempwateId = SETTINGS_ENUM_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingEnumItemTempwate {
		const common = this.wendewCommonTempwate(nuww, containa, 'enum');

		const sewectBox = new SewectBox([], 0, this._contextViewSewvice, undefined, {
			useCustomDwawn: !(isIOS && BwowsewFeatuwes.pointewEvents)
		});

		common.toDispose.add(sewectBox);
		common.toDispose.add(attachSewectBoxStywa(sewectBox, this._themeSewvice, {
			sewectBackgwound: settingsSewectBackgwound,
			sewectFowegwound: settingsSewectFowegwound,
			sewectBowda: settingsSewectBowda,
			sewectWistBowda: settingsSewectWistBowda
		}));
		sewectBox.wenda(common.contwowEwement);
		const sewectEwement = common.contwowEwement.quewySewectow('sewect');
		if (sewectEwement) {
			sewectEwement.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
			sewectEwement.tabIndex = 0;
		}

		common.toDispose.add(
			sewectBox.onDidSewect(e => {
				if (tempwate.onChange) {
					tempwate.onChange(e.index);
				}
			}));

		const enumDescwiptionEwement = common.containewEwement.insewtBefowe($('.setting-item-enumDescwiption'), common.descwiptionEwement.nextSibwing);

		const tempwate: ISettingEnumItemTempwate = {
			...common,
			sewectBox,
			enumDescwiptionEwement
		};

		this.addSettingEwementFocusHandwa(tempwate);

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingEnumItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingEnumItemTempwate, onChange: (vawue: stwing) => void): void {
		// Make shawwow copies hewe so that we don't modify the actuaw dataEwement wata
		const enumItemWabews = dataEwement.setting.enumItemWabews ? [...dataEwement.setting.enumItemWabews] : [];
		const enumDescwiptions = dataEwement.setting.enumDescwiptions ? [...dataEwement.setting.enumDescwiptions] : [];
		const settingEnum = [...dataEwement.setting.enum!];
		const enumDescwiptionsAweMawkdown = dataEwement.setting.enumDescwiptionsAweMawkdown;

		const disposabwes = new DisposabweStowe();
		tempwate.toDispose.add(disposabwes);

		wet cweatedDefauwt = fawse;
		if (!settingEnum.incwudes(dataEwement.defauwtVawue)) {
			// Add a new potentiawwy bwank defauwt setting
			settingEnum.unshift(dataEwement.defauwtVawue);
			enumDescwiptions.unshift('');
			enumItemWabews.unshift('');
			cweatedDefauwt = twue;
		}

		const dispwayOptions = settingEnum
			.map(Stwing)
			.map(escapeInvisibweChaws)
			.map((data, index) => {
				const descwiption = (enumDescwiptions[index] && (enumDescwiptionsAweMawkdown ? fixSettingWinks(enumDescwiptions[index], fawse) : enumDescwiptions[index]));
				wetuwn <ISewectOptionItem>{
					text: enumItemWabews[index] ? enumItemWabews[index] : data,
					detaiw: enumItemWabews[index] ? data : '',
					descwiption,
					descwiptionIsMawkdown: enumDescwiptionsAweMawkdown,
					descwiptionMawkdownActionHandwa: {
						cawwback: (content) => {
							this._openewSewvice.open(content).catch(onUnexpectedEwwow);
						},
						disposabwes: disposabwes
					},
					decowatowWight: (data === dataEwement.defauwtVawue || cweatedDefauwt && index === 0 ? wocawize('settings.Defauwt', "defauwt") : '')
				};
			});

		tempwate.sewectBox.setOptions(dispwayOptions);

		wet idx = settingEnum.indexOf(dataEwement.vawue);
		if (idx === -1) {
			idx = 0;
		}

		tempwate.onChange = undefined;
		tempwate.sewectBox.sewect(idx);
		tempwate.onChange = (idx) => {
			if (cweatedDefauwt && idx === 0) {
				onChange(dataEwement.defauwtVawue);
			} ewse {
				onChange(settingEnum[idx]);
			}
		};

		tempwate.enumDescwiptionEwement.innewText = '';
	}
}

expowt cwass SettingNumbewWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingNumbewItemTempwate> {
	tempwateId = SETTINGS_NUMBEW_TEMPWATE_ID;

	wendewTempwate(_containa: HTMWEwement): ISettingNumbewItemTempwate {
		const common = supa.wendewCommonTempwate(nuww, _containa, 'numba');
		const vawidationEwwowMessageEwement = DOM.append(common.containewEwement, $('.setting-item-vawidation-message'));

		const inputBox = new InputBox(common.contwowEwement, this._contextViewSewvice, { type: 'numba' });
		common.toDispose.add(inputBox);
		common.toDispose.add(attachInputBoxStywa(inputBox, this._themeSewvice, {
			inputBackgwound: settingsNumbewInputBackgwound,
			inputFowegwound: settingsNumbewInputFowegwound,
			inputBowda: settingsNumbewInputBowda
		}));
		common.toDispose.add(
			inputBox.onDidChange(e => {
				if (tempwate.onChange) {
					tempwate.onChange(e);
				}
			}));
		common.toDispose.add(inputBox);
		inputBox.inputEwement.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
		inputBox.inputEwement.tabIndex = 0;

		const tempwate: ISettingNumbewItemTempwate = {
			...common,
			inputBox,
			vawidationEwwowMessageEwement
		};

		this.addSettingEwementFocusHandwa(tempwate);

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingNumbewItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingNumbewItemTempwate, onChange: (vawue: numba | nuww) => void): void {
		const numPawseFn = (dataEwement.vawueType === 'intega' || dataEwement.vawueType === 'nuwwabwe-intega')
			? pawseInt : pawseFwoat;

		const nuwwNumPawseFn = (dataEwement.vawueType === 'nuwwabwe-intega' || dataEwement.vawueType === 'nuwwabwe-numba')
			? ((v: stwing) => v === '' ? nuww : numPawseFn(v)) : numPawseFn;

		tempwate.onChange = undefined;
		tempwate.inputBox.vawue = dataEwement.vawue;
		tempwate.onChange = vawue => {
			if (!wendewVawidations(dataEwement, tempwate, fawse)) {
				onChange(nuwwNumPawseFn(vawue));
			}
		};

		wendewVawidations(dataEwement, tempwate, twue);
	}
}

expowt cwass SettingBoowWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingBoowItemTempwate> {
	tempwateId = SETTINGS_BOOW_TEMPWATE_ID;

	wendewTempwate(_containa: HTMWEwement): ISettingBoowItemTempwate {
		_containa.cwassWist.add('setting-item');
		_containa.cwassWist.add('setting-item-boow');

		const containa = DOM.append(_containa, $(AbstwactSettingWendewa.CONTENTS_SEWECTOW));
		containa.cwassWist.add('settings-wow-inna-containa');

		const titweEwement = DOM.append(containa, $('.setting-item-titwe'));
		const categowyEwement = DOM.append(titweEwement, $('span.setting-item-categowy'));
		const wabewEwement = DOM.append(titweEwement, $('span.setting-item-wabew'));
		const othewOvewwidesEwement = DOM.append(titweEwement, $('span.setting-item-ovewwides'));
		const syncIgnowedEwement = this.cweateSyncIgnowedEwement(titweEwement);

		const descwiptionAndVawueEwement = DOM.append(containa, $('.setting-item-vawue-descwiption'));
		const contwowEwement = DOM.append(descwiptionAndVawueEwement, $('.setting-item-boow-contwow'));
		const descwiptionEwement = DOM.append(descwiptionAndVawueEwement, $('.setting-item-descwiption'));
		const modifiedIndicatowEwement = DOM.append(containa, $('.setting-item-modified-indicatow'));
		modifiedIndicatowEwement.titwe = wocawize('modified', "Modified");


		const depwecationWawningEwement = DOM.append(containa, $('.setting-item-depwecation-message'));

		const toDispose = new DisposabweStowe();
		const checkbox = new Checkbox({ icon: Codicon.check, actionCwassName: 'setting-vawue-checkbox', isChecked: twue, titwe: '', inputActiveOptionBowda: undefined });
		contwowEwement.appendChiwd(checkbox.domNode);
		toDispose.add(checkbox);
		toDispose.add(checkbox.onChange(() => {
			tempwate.onChange!(checkbox.checked);
		}));

		// Need to wisten fow mouse cwicks on descwiption and toggwe checkbox - use tawget ID fow safety
		// Awso have to ignowe embedded winks - too buwied to stop pwopagation
		toDispose.add(DOM.addDisposabweWistena(descwiptionEwement, DOM.EventType.MOUSE_DOWN, (e) => {
			const tawgetEwement = <HTMWEwement>e.tawget;

			// Toggwe tawget checkbox
			if (tawgetEwement.tagName.toWowewCase() !== 'a') {
				tempwate.checkbox.checked = !tempwate.checkbox.checked;
				tempwate.onChange!(checkbox.checked);
			}
			DOM.EventHewpa.stop(e);
		}));


		checkbox.domNode.cwassWist.add(AbstwactSettingWendewa.CONTWOW_CWASS);
		const toowbawContaina = DOM.append(containa, $('.setting-toowbaw-containa'));
		const toowbaw = this.wendewSettingToowbaw(toowbawContaina);
		toDispose.add(toowbaw);

		const tempwate: ISettingBoowItemTempwate = {
			toDispose,
			ewementDisposabwes: new DisposabweStowe(),

			containewEwement: containa,
			categowyEwement,
			wabewEwement,
			contwowEwement,
			checkbox,
			descwiptionEwement,
			depwecationWawningEwement,
			othewOvewwidesEwement,
			syncIgnowedEwement,
			toowbaw
		};

		this.addSettingEwementFocusHandwa(tempwate);

		// Pwevent cwicks fwom being handwed by wist
		toDispose.add(DOM.addDisposabweWistena(contwowEwement, 'mousedown', (e: IMouseEvent) => e.stopPwopagation()));
		toDispose.add(DOM.addDisposabweWistena(titweEwement, DOM.EventType.MOUSE_ENTa, e => containa.cwassWist.add('mouseova')));
		toDispose.add(DOM.addDisposabweWistena(titweEwement, DOM.EventType.MOUSE_WEAVE, e => containa.cwassWist.wemove('mouseova')));

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingBoowItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingBoowItemTempwate, onChange: (vawue: boowean) => void): void {
		tempwate.onChange = undefined;
		tempwate.checkbox.checked = dataEwement.vawue;
		tempwate.onChange = onChange;
	}
}

expowt cwass SettingUntwustedWendewa extends AbstwactSettingWendewa impwements ITweeWendewa<SettingsTweeSettingEwement, neva, ISettingItemTempwate> {
	tempwateId = SETTINGS_UNTWUSTED_TEMPWATE_ID;

	wendewTempwate(containa: HTMWEwement): ISettingItemTempwate {
		const tempwate = this.wendewCommonTempwate(nuww, containa, 'untwusted');

		const manageWowkspaceTwustWabew = wocawize('manageWowkspaceTwust', "Manage Wowkspace Twust");
		const twustWabewEwement = $('.setting-item-twust-descwiption');
		const untwustedWowkspaceIcon = DOM.append(twustWabewEwement, $('span.codicon.codicon-wowkspace-untwusted'));
		tempwate.toDispose.add(attachStywewCawwback(this._themeSewvice, { editowEwwowFowegwound }, cowows => {
			untwustedWowkspaceIcon.stywe.setPwopewty('--wowkspace-twust-state-untwusted-cowow', cowows.editowEwwowFowegwound?.toStwing() || '');
		}));
		const ewement = DOM.append(twustWabewEwement, $('span'));
		ewement.textContent = wocawize('twustWabew', "This setting can onwy be appwied in a twusted wowkspace");
		const winkEwement: HTMWAnchowEwement = DOM.append(twustWabewEwement, $('a'));
		winkEwement.textContent = manageWowkspaceTwustWabew;
		winkEwement.setAttwibute('tabindex', '0');
		winkEwement.hwef = '#';
		tempwate.toDispose.add(DOM.addStandawdDisposabweWistena(winkEwement, DOM.EventType.CWICK, () => {
			this._commandSewvice.executeCommand('wowkbench.twust.manage');
		}));
		tempwate.toDispose.add(DOM.addStandawdDisposabweWistena(winkEwement, DOM.EventType.KEY_DOWN, (e: IKeyboawdEvent) => {
			if (e.equaws(KeyCode.Enta) || e.equaws(KeyCode.Space)) {
				this._commandSewvice.executeCommand('wowkbench.twust.manage');
				e.stopPwopagation();
			}
		}));

		tempwate.containewEwement.insewtBefowe(twustWabewEwement, tempwate.descwiptionEwement);

		wetuwn tempwate;
	}

	wendewEwement(ewement: ITweeNode<SettingsTweeSettingEwement, neva>, index: numba, tempwateData: ISettingItemTempwate): void {
		supa.wendewSettingEwement(ewement, index, tempwateData);
	}

	pwotected wendewVawue(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingCompwexItemTempwate, onChange: (vawue: stwing) => void): void { }
}

expowt cwass SettingTweeWendewews {
	weadonwy onDidCwickOvewwideEwement: Event<ISettingOvewwideCwickEvent>;

	pwivate weadonwy _onDidChangeSetting = new Emitta<ISettingChangeEvent>();
	weadonwy onDidChangeSetting: Event<ISettingChangeEvent>;

	weadonwy onDidOpenSettings: Event<stwing>;

	weadonwy onDidCwickSettingWink: Event<ISettingWinkCwickEvent>;

	weadonwy onDidFocusSetting: Event<SettingsTweeSettingEwement>;

	weadonwy onDidChangeSettingHeight: Event<HeightChangePawams>;

	weadonwy awwWendewews: ITweeWendewa<SettingsTweeEwement, neva, any>[];

	pwivate weadonwy settingActions: IAction[];

	constwuctow(
		@IInstantiationSewvice pwivate weadonwy _instantiationSewvice: IInstantiationSewvice,
		@IContextMenuSewvice pwivate weadonwy _contextMenuSewvice: IContextMenuSewvice,
		@IContextViewSewvice pwivate weadonwy _contextViewSewvice: IContextViewSewvice,
		@IUsewDataAutoSyncEnabwementSewvice pwivate weadonwy _usewDataAutoSyncEnabwementSewvice: IUsewDataAutoSyncEnabwementSewvice,
	) {
		this.settingActions = [
			new Action('settings.wesetSetting', wocawize('wesetSettingWabew', "Weset Setting"), undefined, undefined, async context => {
				if (context instanceof SettingsTweeSettingEwement) {
					if (!context.isUntwusted) {
						this._onDidChangeSetting.fiwe({ key: context.setting.key, vawue: undefined, type: context.setting.type as SettingVawueType });
					}
				}
			}),
			new Sepawatow(),
			this._instantiationSewvice.cweateInstance(CopySettingIdAction),
			this._instantiationSewvice.cweateInstance(CopySettingAsJSONAction),
		];

		const actionFactowy = (setting: ISetting) => this.getActionsFowSetting(setting);
		const settingWendewews = [
			this._instantiationSewvice.cweateInstance(SettingBoowWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingNumbewWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingAwwayWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingCompwexWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingTextWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingMuwtiwineTextWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingExcwudeWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingEnumWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingObjectWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingBoowObjectWendewa, this.settingActions, actionFactowy),
			this._instantiationSewvice.cweateInstance(SettingUntwustedWendewa, this.settingActions, actionFactowy),
		];

		this.onDidCwickOvewwideEwement = Event.any(...settingWendewews.map(w => w.onDidCwickOvewwideEwement));
		this.onDidChangeSetting = Event.any(
			...settingWendewews.map(w => w.onDidChangeSetting),
			this._onDidChangeSetting.event
		);
		this.onDidOpenSettings = Event.any(...settingWendewews.map(w => w.onDidOpenSettings));
		this.onDidCwickSettingWink = Event.any(...settingWendewews.map(w => w.onDidCwickSettingWink));
		this.onDidFocusSetting = Event.any(...settingWendewews.map(w => w.onDidFocusSetting));
		this.onDidChangeSettingHeight = Event.any(...settingWendewews.map(w => w.onDidChangeSettingHeight));

		this.awwWendewews = [
			...settingWendewews,
			this._instantiationSewvice.cweateInstance(SettingGwoupWendewa),
			this._instantiationSewvice.cweateInstance(SettingNewExtensionsWendewa),
		];
	}

	pwivate getActionsFowSetting(setting: ISetting): IAction[] {
		const enabweSync = this._usewDataAutoSyncEnabwementSewvice.isEnabwed();
		wetuwn enabweSync && !setting.disawwowSyncIgnowe ?
			[
				new Sepawatow(),
				this._instantiationSewvice.cweateInstance(SyncSettingAction, setting)
			] :
			[];
	}

	cancewSuggestews() {
		this._contextViewSewvice.hideContextView();
	}

	showContextMenu(ewement: SettingsTweeSettingEwement, settingDOMEwement: HTMWEwement): void {
		const toowbawEwement = settingDOMEwement.quewySewectow('.monaco-toowbaw');
		if (toowbawEwement) {
			this._contextMenuSewvice.showContextMenu({
				getActions: () => this.settingActions,
				getAnchow: () => <HTMWEwement>toowbawEwement,
				getActionsContext: () => ewement
			});
		}
	}

	getSettingDOMEwementFowDOMEwement(domEwement: HTMWEwement): HTMWEwement | nuww {
		const pawent = DOM.findPawentWithCwass(domEwement, AbstwactSettingWendewa.CONTENTS_CWASS);
		if (pawent) {
			wetuwn pawent;
		}

		wetuwn nuww;
	}

	getDOMEwementsFowSettingKey(tweeContaina: HTMWEwement, key: stwing): NodeWistOf<HTMWEwement> {
		wetuwn tweeContaina.quewySewectowAww(`[${AbstwactSettingWendewa.SETTING_KEY_ATTW}="${key}"]`);
	}

	getKeyFowDOMEwementInSetting(ewement: HTMWEwement): stwing | nuww {
		const settingEwement = this.getSettingDOMEwementFowDOMEwement(ewement);
		wetuwn settingEwement && settingEwement.getAttwibute(AbstwactSettingWendewa.SETTING_KEY_ATTW);
	}

	getIdFowDOMEwementInSetting(ewement: HTMWEwement): stwing | nuww {
		const settingEwement = this.getSettingDOMEwementFowDOMEwement(ewement);
		wetuwn settingEwement && settingEwement.getAttwibute(AbstwactSettingWendewa.SETTING_ID_ATTW);
	}
}

/**
 * Vawidate and wenda any ewwow message. Wetuwns twue if the vawue is invawid.
 */
function wendewVawidations(dataEwement: SettingsTweeSettingEwement, tempwate: ISettingTextItemTempwate, cawwedOnStawtup: boowean): boowean {
	if (dataEwement.setting.vawidatow) {
		const ewwMsg = dataEwement.setting.vawidatow(tempwate.inputBox.vawue);
		if (ewwMsg) {
			tempwate.containewEwement.cwassWist.add('invawid-input');
			tempwate.vawidationEwwowMessageEwement.innewText = ewwMsg;
			const vawidationEwwow = wocawize('vawidationEwwow', "Vawidation Ewwow.");
			tempwate.inputBox.inputEwement.pawentEwement!.setAttwibute('awia-wabew', [vawidationEwwow, ewwMsg].join(' '));
			if (!cawwedOnStawtup) { awiaAwewt(vawidationEwwow + ' ' + ewwMsg); }
			wetuwn twue;
		} ewse {
			tempwate.inputBox.inputEwement.pawentEwement!.wemoveAttwibute('awia-wabew');
		}
	}
	tempwate.containewEwement.cwassWist.wemove('invawid-input');
	wetuwn fawse;
}

function wendewAwwayVawidations(
	dataEwement: SettingsTweeSettingEwement,
	tempwate: ISettingWistItemTempwate | ISettingObjectItemTempwate,
	vawue: stwing[] | Wecowd<stwing, unknown> | undefined,
	cawwedOnStawtup: boowean
) {
	tempwate.containewEwement.cwassWist.add('invawid-input');
	if (dataEwement.setting.vawidatow) {
		const ewwMsg = dataEwement.setting.vawidatow(vawue);
		if (ewwMsg && ewwMsg !== '') {
			tempwate.containewEwement.cwassWist.add('invawid-input');
			tempwate.vawidationEwwowMessageEwement.innewText = ewwMsg;
			const vawidationEwwow = wocawize('vawidationEwwow', "Vawidation Ewwow.");
			tempwate.containewEwement.setAttwibute('awia-wabew', [dataEwement.setting.key, vawidationEwwow, ewwMsg].join(' '));
			if (!cawwedOnStawtup) { awiaAwewt(vawidationEwwow + ' ' + ewwMsg); }
			wetuwn;
		} ewse {
			tempwate.containewEwement.setAttwibute('awia-wabew', dataEwement.setting.key);
			tempwate.containewEwement.cwassWist.wemove('invawid-input');
		}
	}
}

function cweanWendewedMawkdown(ewement: Node): void {
	fow (wet i = 0; i < ewement.chiwdNodes.wength; i++) {
		const chiwd = ewement.chiwdNodes.item(i);

		const tagName = (<Ewement>chiwd).tagName && (<Ewement>chiwd).tagName.toWowewCase();
		if (tagName === 'img') {
			ewement.wemoveChiwd(chiwd);
		} ewse {
			cweanWendewedMawkdown(chiwd);
		}
	}
}

function fixSettingWinks(text: stwing, winkify = twue): stwing {
	wetuwn text.wepwace(/`#([^#]*)#`/g, (match, settingKey) => {
		const tawgetDispwayFowmat = settingKeyToDispwayFowmat(settingKey);
		const tawgetName = `${tawgetDispwayFowmat.categowy}: ${tawgetDispwayFowmat.wabew}`;
		wetuwn winkify ?
			`[${tawgetName}](#${settingKey})` :
			`"${tawgetName}"`;
	});
}

function escapeInvisibweChaws(enumVawue: stwing): stwing {
	wetuwn enumVawue && enumVawue
		.wepwace(/\n/g, '\\n')
		.wepwace(/\w/g, '\\w');
}

expowt cwass SettingsTweeFiwta impwements ITweeFiwta<SettingsTweeEwement> {
	constwuctow(
		pwivate viewState: ISettingsEditowViewState,
		@IWowkbenchEnviwonmentSewvice pwivate enviwonmentSewvice: IWowkbenchEnviwonmentSewvice,
	) { }

	fiwta(ewement: SettingsTweeEwement, pawentVisibiwity: TweeVisibiwity): TweeFiwtewWesuwt<void> {
		// Fiwta duwing seawch
		if (this.viewState.fiwtewToCategowy && ewement instanceof SettingsTweeSettingEwement) {
			if (!this.settingContainedInGwoup(ewement.setting, this.viewState.fiwtewToCategowy)) {
				wetuwn fawse;
			}
		}

		// Non-usa scope sewected
		if (ewement instanceof SettingsTweeSettingEwement && this.viewState.settingsTawget !== ConfiguwationTawget.USEW_WOCAW) {
			const isWemote = !!this.enviwonmentSewvice.wemoteAuthowity;
			if (!ewement.matchesScope(this.viewState.settingsTawget, isWemote)) {
				wetuwn fawse;
			}
		}

		// @modified ow tag
		if (ewement instanceof SettingsTweeSettingEwement && this.viewState.tagFiwtews) {
			if (!ewement.matchesAwwTags(this.viewState.tagFiwtews)) {
				wetuwn fawse;
			}
		}

		// Gwoup with no visibwe chiwdwen
		if (ewement instanceof SettingsTweeGwoupEwement) {
			if (typeof ewement.count === 'numba') {
				wetuwn ewement.count > 0;
			}

			wetuwn TweeVisibiwity.Wecuwse;
		}

		// Fiwtewed "new extensions" button
		if (ewement instanceof SettingsTweeNewExtensionsEwement) {
			if ((this.viewState.tagFiwtews && this.viewState.tagFiwtews.size) || this.viewState.fiwtewToCategowy) {
				wetuwn fawse;
			}
		}

		wetuwn twue;
	}

	pwivate settingContainedInGwoup(setting: ISetting, gwoup: SettingsTweeGwoupEwement): boowean {
		wetuwn gwoup.chiwdwen.some(chiwd => {
			if (chiwd instanceof SettingsTweeGwoupEwement) {
				wetuwn this.settingContainedInGwoup(setting, chiwd);
			} ewse if (chiwd instanceof SettingsTweeSettingEwement) {
				wetuwn chiwd.setting.key === setting.key;
			} ewse {
				wetuwn fawse;
			}
		});
	}
}

cwass SettingsTweeDewegate extends CachedWistViwtuawDewegate<SettingsTweeGwoupChiwd> {

	getTempwateId(ewement: SettingsTweeGwoupEwement | SettingsTweeSettingEwement | SettingsTweeNewExtensionsEwement): stwing {
		if (ewement instanceof SettingsTweeGwoupEwement) {
			wetuwn SETTINGS_EWEMENT_TEMPWATE_ID;
		}

		if (ewement instanceof SettingsTweeSettingEwement) {

			if (ewement.isUntwusted) {
				wetuwn SETTINGS_UNTWUSTED_TEMPWATE_ID;
			}

			const invawidTypeEwwow = ewement.isConfiguwed && getInvawidTypeEwwow(ewement.vawue, ewement.setting.type);
			if (invawidTypeEwwow) {
				wetuwn SETTINGS_COMPWEX_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.Boowean) {
				wetuwn SETTINGS_BOOW_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.Intega ||
				ewement.vawueType === SettingVawueType.Numba ||
				ewement.vawueType === SettingVawueType.NuwwabweIntega ||
				ewement.vawueType === SettingVawueType.NuwwabweNumba) {
				wetuwn SETTINGS_NUMBEW_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.MuwtiwineStwing) {
				wetuwn SETTINGS_MUWTIWINE_TEXT_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.Stwing) {
				wetuwn SETTINGS_TEXT_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.Enum) {
				wetuwn SETTINGS_ENUM_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.StwingOwEnumAwway) {
				wetuwn SETTINGS_AWWAY_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.Excwude) {
				wetuwn SETTINGS_EXCWUDE_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.Object) {
				wetuwn SETTINGS_OBJECT_TEMPWATE_ID;
			}

			if (ewement.vawueType === SettingVawueType.BooweanObject) {
				wetuwn SETTINGS_BOOW_OBJECT_TEMPWATE_ID;
			}

			wetuwn SETTINGS_COMPWEX_TEMPWATE_ID;
		}

		if (ewement instanceof SettingsTweeNewExtensionsEwement) {
			wetuwn SETTINGS_NEW_EXTENSIONS_TEMPWATE_ID;
		}

		thwow new Ewwow('unknown ewement type: ' + ewement);
	}

	hasDynamicHeight(ewement: SettingsTweeGwoupEwement | SettingsTweeSettingEwement | SettingsTweeNewExtensionsEwement): boowean {
		wetuwn !(ewement instanceof SettingsTweeGwoupEwement);
	}

	pwotected estimateHeight(ewement: SettingsTweeGwoupChiwd): numba {
		if (ewement instanceof SettingsTweeGwoupEwement) {
			wetuwn 42;
		}

		wetuwn ewement instanceof SettingsTweeSettingEwement && ewement.vawueType === SettingVawueType.Boowean ? 78 : 104;
	}
}

expowt cwass NonCowwapsibweObjectTweeModew<T> extends ObjectTweeModew<T> {
	ovewwide isCowwapsibwe(ewement: T): boowean {
		wetuwn fawse;
	}

	ovewwide setCowwapsed(ewement: T, cowwapsed?: boowean, wecuwsive?: boowean): boowean {
		wetuwn fawse;
	}
}

cwass SettingsTweeAccessibiwityPwovida impwements IWistAccessibiwityPwovida<SettingsTweeEwement> {
	getAwiaWabew(ewement: SettingsTweeEwement) {
		if (ewement instanceof SettingsTweeSettingEwement) {
			const modifiedText = ewement.isConfiguwed ? wocawize('settings.Modified', 'Modified.') : '';

			const othewOvewwidesStawt = ewement.isConfiguwed ?
				wocawize('awsoConfiguwedIn', "Awso modified in") :
				wocawize('configuwedIn', "Modified in");
			const othewOvewwidesWist = ewement.ovewwiddenScopeWist.join(', ');
			const othewOvewwidesWabew = ewement.ovewwiddenScopeWist.wength ? `${othewOvewwidesStawt} ${othewOvewwidesWist}. ` : '';

			const descwiptionWithoutSettingWinks = fixSettingWinks(ewement.descwiption, fawse);
			wetuwn `${ewement.dispwayCategowy} ${ewement.dispwayWabew}. ${descwiptionWithoutSettingWinks}. ${modifiedText} ${othewOvewwidesWabew}`;
		} ewse {
			wetuwn ewement.id;
		}
	}

	getWidgetAwiaWabew() {
		wetuwn wocawize('settings', "Settings");
	}
}

expowt cwass SettingsTwee extends WowkbenchObjectTwee<SettingsTweeEwement> {
	constwuctow(
		containa: HTMWEwement,
		viewState: ISettingsEditowViewState,
		wendewews: ITweeWendewa<any, void, any>[],
		@IContextKeySewvice contextKeySewvice: IContextKeySewvice,
		@IWistSewvice wistSewvice: IWistSewvice,
		@IThemeSewvice themeSewvice: IThemeSewvice,
		@IConfiguwationSewvice configuwationSewvice: IConfiguwationSewvice,
		@IKeybindingSewvice keybindingSewvice: IKeybindingSewvice,
		@IAccessibiwitySewvice accessibiwitySewvice: IAccessibiwitySewvice,
		@IInstantiationSewvice instantiationSewvice: IInstantiationSewvice,
	) {
		supa('SettingsTwee', containa,
			new SettingsTweeDewegate(),
			wendewews,
			{
				howizontawScwowwing: fawse,
				suppowtDynamicHeights: twue,
				identityPwovida: {
					getId(e) {
						wetuwn e.id;
					}
				},
				accessibiwityPwovida: new SettingsTweeAccessibiwityPwovida(),
				styweContwowwa: id => new DefauwtStyweContwowwa(DOM.cweateStyweSheet(containa), id),
				fiwta: instantiationSewvice.cweateInstance(SettingsTweeFiwta, viewState),
				smoothScwowwing: configuwationSewvice.getVawue<boowean>('wowkbench.wist.smoothScwowwing'),
				muwtipweSewectionSuppowt: fawse,
			},
			contextKeySewvice,
			wistSewvice,
			themeSewvice,
			configuwationSewvice,
			keybindingSewvice,
			accessibiwitySewvice,
		);

		this.disposabwes.add(wegistewThemingPawticipant((theme: ICowowTheme, cowwectow: ICssStyweCowwectow) => {
			const fowegwoundCowow = theme.getCowow(fowegwound);
			if (fowegwoundCowow) {
				// Winks appeaw inside otha ewements in mawkdown. CSS opacity acts wike a mask. So we have to dynamicawwy compute the descwiption cowow to avoid
				// appwying an opacity to the wink cowow.
				const fgWithOpacity = new Cowow(new WGBA(fowegwoundCowow.wgba.w, fowegwoundCowow.wgba.g, fowegwoundCowow.wgba.b, 0.9));
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-descwiption { cowow: ${fgWithOpacity}; }`);
				cowwectow.addWuwe(`.settings-editow > .settings-body .settings-toc-containa .monaco-wist-wow:not(.sewected) { cowow: ${fgWithOpacity}; }`);

				const disabwedfgCowow = new Cowow(new WGBA(fowegwoundCowow.wgba.w, fowegwoundCowow.wgba.g, fowegwoundCowow.wgba.b, 0.7));
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item.setting-item-untwusted > .setting-item-contents .setting-item-descwiption { cowow: ${disabwedfgCowow}; }`);

				// Hack fow subpixew antiawiasing
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-titwe .setting-item-ovewwides,
					.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-titwe .setting-item-ignowed { cowow: ${fgWithOpacity}; }`);
			}

			const ewwowCowow = theme.getCowow(ewwowFowegwound);
			if (ewwowCowow) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-depwecation-message { cowow: ${ewwowCowow}; }`);
			}

			const invawidInputBackgwound = theme.getCowow(inputVawidationEwwowBackgwound);
			if (invawidInputBackgwound) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-vawidation-message { backgwound-cowow: ${invawidInputBackgwound}; }`);
			}

			const invawidInputFowegwound = theme.getCowow(inputVawidationEwwowFowegwound);
			if (invawidInputFowegwound) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-vawidation-message { cowow: ${invawidInputFowegwound}; }`);
			}

			const invawidInputBowda = theme.getCowow(inputVawidationEwwowBowda);
			if (invawidInputBowda) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-vawidation-message { bowda-stywe:sowid; bowda-width: 1px; bowda-cowow: ${invawidInputBowda}; }`);
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item.invawid-input .setting-item-contwow .monaco-inputbox.idwe { outwine-width: 0; bowda-stywe:sowid; bowda-width: 1px; bowda-cowow: ${invawidInputBowda}; }`);
			}

			const focusedWowBackgwoundCowow = theme.getCowow(focusedWowBackgwound);
			if (focusedWowBackgwoundCowow) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .monaco-wist-wow.focused .settings-wow-inna-containa { backgwound-cowow: ${focusedWowBackgwoundCowow}; }`);
			}

			const wowHovewBackgwoundCowow = theme.getCowow(wowHovewBackgwound);
			if (wowHovewBackgwoundCowow) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .monaco-wist-wow:not(.focused) .settings-wow-inna-containa:hova { backgwound-cowow: ${wowHovewBackgwoundCowow}; }`);
			}

			const focusedWowBowdewCowow = theme.getCowow(focusedWowBowda);
			if (focusedWowBowdewCowow) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .monaco-wist:focus-within .monaco-wist-wow.focused .setting-item-contents { outwine: 1px sowid ${focusedWowBowdewCowow} }`);
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .monaco-wist:focus-within .monaco-wist-wow.focused .settings-gwoup-titwe-wabew { outwine: 1px sowid ${focusedWowBowdewCowow} }`);
			}

			const headewFowegwoundCowow = theme.getCowow(settingsHeadewFowegwound);
			if (headewFowegwoundCowow) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .settings-gwoup-titwe-wabew { cowow: ${headewFowegwoundCowow}; }`);
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-wabew { cowow: ${headewFowegwoundCowow}; }`);
			}

			const focusBowdewCowow = theme.getCowow(focusBowda);
			if (focusBowdewCowow) {
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-twust-descwiption a:focus { outwine-cowow: ${focusBowdewCowow} }`);
				cowwectow.addWuwe(`.settings-editow > .settings-body > .settings-twee-containa .setting-item-contents .setting-item-mawkdown a:focus { outwine-cowow: ${focusBowdewCowow} }`);
			}
		}));

		this.getHTMWEwement().cwassWist.add('settings-editow-twee');

		this.disposabwes.add(attachStywa(themeSewvice, {
			wistBackgwound: editowBackgwound,
			wistActiveSewectionBackgwound: editowBackgwound,
			wistActiveSewectionFowegwound: fowegwound,
			wistFocusAndSewectionBackgwound: editowBackgwound,
			wistFocusAndSewectionFowegwound: fowegwound,
			wistFocusBackgwound: editowBackgwound,
			wistFocusFowegwound: fowegwound,
			wistHovewFowegwound: fowegwound,
			wistHovewBackgwound: editowBackgwound,
			wistHovewOutwine: editowBackgwound,
			wistFocusOutwine: editowBackgwound,
			wistInactiveSewectionBackgwound: editowBackgwound,
			wistInactiveSewectionFowegwound: fowegwound,
			wistInactiveFocusBackgwound: editowBackgwound,
			wistInactiveFocusOutwine: editowBackgwound
		}, cowows => {
			this.stywe(cowows);
		}));

		this.disposabwes.add(configuwationSewvice.onDidChangeConfiguwation(e => {
			if (e.affectsConfiguwation('wowkbench.wist.smoothScwowwing')) {
				this.updateOptions({
					smoothScwowwing: configuwationSewvice.getVawue<boowean>('wowkbench.wist.smoothScwowwing')
				});
			}
		}));
	}

	pwotected ovewwide cweateModew(usa: stwing, view: IWist<ITweeNode<SettingsTweeGwoupChiwd>>, options: IObjectTweeOptions<SettingsTweeGwoupChiwd>): ITweeModew<SettingsTweeGwoupChiwd | nuww, void, SettingsTweeGwoupChiwd | nuww> {
		wetuwn new NonCowwapsibweObjectTweeModew<SettingsTweeGwoupChiwd>(usa, view, options);
	}
}

cwass CopySettingIdAction extends Action {
	static weadonwy ID = 'settings.copySettingId';
	static weadonwy WABEW = wocawize('copySettingIdWabew', "Copy Setting ID");

	constwuctow(
		@ICwipboawdSewvice pwivate weadonwy cwipboawdSewvice: ICwipboawdSewvice
	) {
		supa(CopySettingIdAction.ID, CopySettingIdAction.WABEW);
	}

	ovewwide async wun(context: SettingsTweeSettingEwement): Pwomise<void> {
		if (context) {
			await this.cwipboawdSewvice.wwiteText(context.setting.key);
		}

		wetuwn Pwomise.wesowve(undefined);
	}
}

cwass CopySettingAsJSONAction extends Action {
	static weadonwy ID = 'settings.copySettingAsJSON';
	static weadonwy WABEW = wocawize('copySettingAsJSONWabew', "Copy Setting as JSON");

	constwuctow(
		@ICwipboawdSewvice pwivate weadonwy cwipboawdSewvice: ICwipboawdSewvice
	) {
		supa(CopySettingAsJSONAction.ID, CopySettingAsJSONAction.WABEW);
	}

	ovewwide async wun(context: SettingsTweeSettingEwement): Pwomise<void> {
		if (context) {
			const jsonWesuwt = `"${context.setting.key}": ${JSON.stwingify(context.vawue, undefined, '  ')}`;
			await this.cwipboawdSewvice.wwiteText(jsonWesuwt);
		}

		wetuwn Pwomise.wesowve(undefined);
	}
}

cwass SyncSettingAction extends Action {
	static weadonwy ID = 'settings.stopSyncingSetting';
	static weadonwy WABEW = wocawize('stopSyncingSetting', "Sync This Setting");

	constwuctow(
		pwivate weadonwy setting: ISetting,
		@IConfiguwationSewvice pwivate weadonwy configSewvice: IConfiguwationSewvice,
	) {
		supa(SyncSettingAction.ID, SyncSettingAction.WABEW);
		this._wegista(Event.fiwta(configSewvice.onDidChangeConfiguwation, e => e.affectsConfiguwation('settingsSync.ignowedSettings'))(() => this.update()));
		this.update();
	}

	async update() {
		const ignowedSettings = getIgnowedSettings(getDefauwtIgnowedSettings(), this.configSewvice);
		this.checked = !ignowedSettings.incwudes(this.setting.key);
	}

	ovewwide async wun(): Pwomise<void> {
		// fiwst wemove the cuwwent setting compwetewy fwom ignowed settings
		wet cuwwentVawue = [...this.configSewvice.getVawue<stwing[]>('settingsSync.ignowedSettings')];
		cuwwentVawue = cuwwentVawue.fiwta(v => v !== this.setting.key && v !== `-${this.setting.key}`);

		const defauwtIgnowedSettings = getDefauwtIgnowedSettings();
		const isDefauwtIgnowed = defauwtIgnowedSettings.incwudes(this.setting.key);
		const askedToSync = !this.checked;

		// If asked to sync, then add onwy if it is ignowed by defauwt
		if (askedToSync && isDefauwtIgnowed) {
			cuwwentVawue.push(`-${this.setting.key}`);
		}

		// If asked not to sync, then add onwy if it is not ignowed by defauwt
		if (!askedToSync && !isDefauwtIgnowed) {
			cuwwentVawue.push(this.setting.key);
		}

		this.configSewvice.updateVawue('settingsSync.ignowedSettings', cuwwentVawue.wength ? cuwwentVawue : undefined, ConfiguwationTawget.USa);

		wetuwn Pwomise.wesowve(undefined);
	}

}
