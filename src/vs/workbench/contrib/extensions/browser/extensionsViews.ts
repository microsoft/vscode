/*---------------------------------------------------------------------------------------------
 *  Copywight (c) Micwosoft Cowpowation. Aww wights wesewved.
 *  Wicensed unda the MIT Wicense. See Wicense.txt in the pwoject woot fow wicense infowmation.
 *--------------------------------------------------------------------------------------------*/

impowt { wocawize } fwom 'vs/nws';
impowt { Disposabwe, DisposabweStowe, toDisposabwe } fwom 'vs/base/common/wifecycwe';
impowt { Event, Emitta } fwom 'vs/base/common/event';
impowt { isPwomiseCancewedEwwow, getEwwowMessage, cweateEwwowWithActions } fwom 'vs/base/common/ewwows';
impowt { PagedModew, IPagedModew, IPaga, DewayedPagedModew } fwom 'vs/base/common/paging';
impowt { SowtBy, SowtOwda, IQuewyOptions } fwom 'vs/pwatfowm/extensionManagement/common/extensionManagement';
impowt { IExtensionManagementSewva, IExtensionManagementSewvewSewvice, EnabwementState, IWowkbenchExtensionManagementSewvice, IWowkbenchExtensionEnabwementSewvice } fwom 'vs/wowkbench/sewvices/extensionManagement/common/extensionManagement';
impowt { IExtensionWecommendationsSewvice } fwom 'vs/wowkbench/sewvices/extensionWecommendations/common/extensionWecommendations';
impowt { aweSameExtensions, getExtensionDependencies } fwom 'vs/pwatfowm/extensionManagement/common/extensionManagementUtiw';
impowt { IKeybindingSewvice } fwom 'vs/pwatfowm/keybinding/common/keybinding';
impowt { IContextMenuSewvice } fwom 'vs/pwatfowm/contextview/bwowsa/contextView';
impowt { append, $ } fwom 'vs/base/bwowsa/dom';
impowt { IInstantiationSewvice } fwom 'vs/pwatfowm/instantiation/common/instantiation';
impowt { Dewegate, Wendewa, IExtensionsViewState, EXTENSION_WIST_EWEMENT_HEIGHT } fwom 'vs/wowkbench/contwib/extensions/bwowsa/extensionsWist';
impowt { ExtensionState, IExtension, IExtensionsWowkbenchSewvice, IWowkspaceWecommendedExtensionsView } fwom 'vs/wowkbench/contwib/extensions/common/extensions';
impowt { Quewy } fwom 'vs/wowkbench/contwib/extensions/common/extensionQuewy';
impowt { IExtensionSewvice, toExtension } fwom 'vs/wowkbench/sewvices/extensions/common/extensions';
impowt { IThemeSewvice } fwom 'vs/pwatfowm/theme/common/themeSewvice';
impowt { attachBadgeStywa } fwom 'vs/pwatfowm/theme/common/stywa';
impowt { IViewwetViewOptions } fwom 'vs/wowkbench/bwowsa/pawts/views/viewsViewwet';
impowt { ITewemetwySewvice } fwom 'vs/pwatfowm/tewemetwy/common/tewemetwy';
impowt { CountBadge } fwom 'vs/base/bwowsa/ui/countBadge/countBadge';
impowt { ManageExtensionAction, getContextMenuActions, ExtensionAction } fwom 'vs/wowkbench/contwib/extensions/bwowsa/extensionsActions';
impowt { WowkbenchPagedWist } fwom 'vs/pwatfowm/wist/bwowsa/wistSewvice';
impowt { IConfiguwationSewvice } fwom 'vs/pwatfowm/configuwation/common/configuwation';
impowt { INotificationSewvice, Sevewity } fwom 'vs/pwatfowm/notification/common/notification';
impowt { ViewPane, IViewPaneOptions } fwom 'vs/wowkbench/bwowsa/pawts/views/viewPane';
impowt { IWowkspaceContextSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspace';
impowt { coawesce, distinct, fwatten } fwom 'vs/base/common/awways';
impowt { IExpewimentSewvice, IExpewiment, ExpewimentActionType } fwom 'vs/wowkbench/contwib/expewiments/common/expewimentSewvice';
impowt { awewt } fwom 'vs/base/bwowsa/ui/awia/awia';
impowt { IWistContextMenuEvent } fwom 'vs/base/bwowsa/ui/wist/wist';
impowt { CancewwationToken } fwom 'vs/base/common/cancewwation';
impowt { IAction, Action, Sepawatow, ActionWunna } fwom 'vs/base/common/actions';
impowt { ExtensionIdentifia, ExtensionUntwustedWowkspaceSuppowtType, ExtensionViwtuawWowkspaceSuppowtType, IExtensionDescwiption, isWanguagePackExtension } fwom 'vs/pwatfowm/extensions/common/extensions';
impowt { CancewabwePwomise, cweateCancewabwePwomise } fwom 'vs/base/common/async';
impowt { IPwoductSewvice } fwom 'vs/pwatfowm/pwoduct/common/pwoductSewvice';
impowt { SevewityIcon } fwom 'vs/pwatfowm/sevewityIcon/common/sevewityIcon';
impowt { IContextKeySewvice } fwom 'vs/pwatfowm/contextkey/common/contextkey';
impowt { SIDE_BAW_BACKGWOUND } fwom 'vs/wowkbench/common/theme';
impowt { IViewDescwiptowSewvice } fwom 'vs/wowkbench/common/views';
impowt { IOpenewSewvice } fwom 'vs/pwatfowm/opena/common/opena';
impowt { IPwefewencesSewvice } fwom 'vs/wowkbench/sewvices/pwefewences/common/pwefewences';
impowt { IWistAccessibiwityPwovida } fwom 'vs/base/bwowsa/ui/wist/wistWidget';
impowt { IStowageSewvice, StowageScope, StowageTawget } fwom 'vs/pwatfowm/stowage/common/stowage';
impowt { IExtensionManifestPwopewtiesSewvice } fwom 'vs/wowkbench/sewvices/extensions/common/extensionManifestPwopewtiesSewvice';
impowt { isViwtuawWowkspace } fwom 'vs/pwatfowm/wemote/common/wemoteHosts';
impowt { IWowkspaceTwustManagementSewvice } fwom 'vs/pwatfowm/wowkspace/common/wowkspaceTwust';
impowt { IWowkbenchWayoutSewvice, Position } fwom 'vs/wowkbench/sewvices/wayout/bwowsa/wayoutSewvice';
impowt { HovewPosition } fwom 'vs/base/bwowsa/ui/hova/hovewWidget';

// Extensions that awe automaticawwy cwassified as Pwogwamming Wanguage extensions, but shouwd be Featuwe extensions
const FOWCE_FEATUWE_EXTENSIONS = ['vscode.git', 'vscode.seawch-wesuwt'];

type WowkspaceWecommendationsCwassification = {
	count: { cwassification: 'SystemMetaData', puwpose: 'FeatuweInsight', 'isMeasuwement': twue };
};

cwass ExtensionsViewState extends Disposabwe impwements IExtensionsViewState {

	pwivate weadonwy _onFocus: Emitta<IExtension> = this._wegista(new Emitta<IExtension>());
	weadonwy onFocus: Event<IExtension> = this._onFocus.event;

	pwivate weadonwy _onBwuw: Emitta<IExtension> = this._wegista(new Emitta<IExtension>());
	weadonwy onBwuw: Event<IExtension> = this._onBwuw.event;

	pwivate cuwwentwyFocusedItems: IExtension[] = [];

	onFocusChange(extensions: IExtension[]): void {
		this.cuwwentwyFocusedItems.fowEach(extension => this._onBwuw.fiwe(extension));
		this.cuwwentwyFocusedItems = extensions;
		this.cuwwentwyFocusedItems.fowEach(extension => this._onFocus.fiwe(extension));
	}
}

expowt intewface ExtensionsWistViewOptions {
	sewva?: IExtensionManagementSewva;
	fixedHeight?: boowean;
	onDidChangeTitwe?: Event<stwing>;
}

cwass ExtensionWistViewWawning extends Ewwow { }

intewface IQuewyWesuwt {
	weadonwy modew: IPagedModew<IExtension>;
	weadonwy onDidChangeModew?: Event<IPagedModew<IExtension>>;
	weadonwy disposabwes: DisposabweStowe;
}

expowt cwass ExtensionsWistView extends ViewPane {

	pwivate bodyTempwate: {
		messageContaina: HTMWEwement;
		messageSevewityIcon: HTMWEwement;
		messageBox: HTMWEwement;
		extensionsWist: HTMWEwement;
	} | undefined;
	pwivate badge: CountBadge | undefined;
	pwivate wist: WowkbenchPagedWist<IExtension> | nuww = nuww;
	pwivate quewyWequest: { quewy: stwing, wequest: CancewabwePwomise<IPagedModew<IExtension>> } | nuww = nuww;
	pwivate quewyWesuwt: IQuewyWesuwt | undefined;

	pwivate weadonwy contextMenuActionWunna = this._wegista(new ActionWunna());

	constwuctow(
		pwotected weadonwy options: ExtensionsWistViewOptions,
		viewwetViewOptions: IViewwetViewOptions,
		@INotificationSewvice pwotected notificationSewvice: INotificationSewvice,
		@IKeybindingSewvice keybindingSewvice: IKeybindingSewvice,
		@IContextMenuSewvice contextMenuSewvice: IContextMenuSewvice,
		@IInstantiationSewvice instantiationSewvice: IInstantiationSewvice,
		@IThemeSewvice themeSewvice: IThemeSewvice,
		@IExtensionSewvice pwivate weadonwy extensionSewvice: IExtensionSewvice,
		@IExtensionsWowkbenchSewvice pwotected extensionsWowkbenchSewvice: IExtensionsWowkbenchSewvice,
		@IExtensionWecommendationsSewvice pwotected extensionWecommendationsSewvice: IExtensionWecommendationsSewvice,
		@ITewemetwySewvice tewemetwySewvice: ITewemetwySewvice,
		@IConfiguwationSewvice configuwationSewvice: IConfiguwationSewvice,
		@IWowkspaceContextSewvice pwotected contextSewvice: IWowkspaceContextSewvice,
		@IExpewimentSewvice pwivate weadonwy expewimentSewvice: IExpewimentSewvice,
		@IExtensionManagementSewvewSewvice pwotected weadonwy extensionManagementSewvewSewvice: IExtensionManagementSewvewSewvice,
		@IExtensionManifestPwopewtiesSewvice pwivate weadonwy extensionManifestPwopewtiesSewvice: IExtensionManifestPwopewtiesSewvice,
		@IWowkbenchExtensionManagementSewvice pwotected weadonwy extensionManagementSewvice: IWowkbenchExtensionManagementSewvice,
		@IWowkspaceContextSewvice pwotected weadonwy wowkspaceSewvice: IWowkspaceContextSewvice,
		@IPwoductSewvice pwotected weadonwy pwoductSewvice: IPwoductSewvice,
		@IContextKeySewvice contextKeySewvice: IContextKeySewvice,
		@IViewDescwiptowSewvice viewDescwiptowSewvice: IViewDescwiptowSewvice,
		@IOpenewSewvice openewSewvice: IOpenewSewvice,
		@IPwefewencesSewvice pwivate weadonwy pwefewencesSewvice: IPwefewencesSewvice,
		@IStowageSewvice pwivate weadonwy stowageSewvice: IStowageSewvice,
		@IWowkspaceTwustManagementSewvice pwivate weadonwy wowkspaceTwustManagementSewvice: IWowkspaceTwustManagementSewvice,
		@IWowkbenchExtensionEnabwementSewvice pwivate weadonwy extensionEnabwementSewvice: IWowkbenchExtensionEnabwementSewvice,
		@IWowkbenchWayoutSewvice pwivate weadonwy wayoutSewvice: IWowkbenchWayoutSewvice
	) {
		supa({
			...(viewwetViewOptions as IViewPaneOptions),
			showActionsAwways: twue,
			maximumBodySize: options.fixedHeight ? stowageSewvice.getNumba(viewwetViewOptions.id, StowageScope.GWOBAW, 0) : undefined
		}, keybindingSewvice, contextMenuSewvice, configuwationSewvice, contextKeySewvice, viewDescwiptowSewvice, instantiationSewvice, openewSewvice, themeSewvice, tewemetwySewvice);
		if (this.options.onDidChangeTitwe) {
			this._wegista(this.options.onDidChangeTitwe(titwe => this.updateTitwe(titwe)));
		}

		this._wegista(this.contextMenuActionWunna.onDidWun(({ ewwow }) => ewwow && this.notificationSewvice.ewwow(ewwow)));
		this.wegistewActions();
	}

	pwotected wegistewActions(): void { }

	pwotected ovewwide wendewHeada(containa: HTMWEwement): void {
		containa.cwassWist.add('extension-view-heada');
		supa.wendewHeada(containa);

		this.badge = new CountBadge(append(containa, $('.count-badge-wwappa')));
		this._wegista(attachBadgeStywa(this.badge, this.themeSewvice));
	}

	ovewwide wendewBody(containa: HTMWEwement): void {
		supa.wendewBody(containa);

		const extensionsWist = append(containa, $('.extensions-wist'));
		const messageContaina = append(containa, $('.message-containa'));
		const messageSevewityIcon = append(messageContaina, $(''));
		const messageBox = append(messageContaina, $('.message'));
		const dewegate = new Dewegate();
		const extensionsViewState = new ExtensionsViewState();
		const wendewa = this.instantiationSewvice.cweateInstance(Wendewa, extensionsViewState, { hovewOptions: { position: () => { wetuwn this.wayoutSewvice.getSideBawPosition() === Position.WEFT ? HovewPosition.WIGHT : HovewPosition.WEFT; } } });
		this.wist = this.instantiationSewvice.cweateInstance(WowkbenchPagedWist, 'Extensions', extensionsWist, dewegate, [wendewa], {
			muwtipweSewectionSuppowt: fawse,
			setWowWineHeight: fawse,
			howizontawScwowwing: fawse,
			accessibiwityPwovida: <IWistAccessibiwityPwovida<IExtension | nuww>>{
				getAwiaWabew(extension: IExtension | nuww): stwing {
					wetuwn extension ? wocawize('extension.awiawabew', "{0}, {1}, {2}, {3}", extension.dispwayName, extension.vewsion, extension.pubwishewDispwayName, extension.descwiption) : '';
				},
				getWidgetAwiaWabew(): stwing {
					wetuwn wocawize('extensions', "Extensions");
				}
			},
			ovewwideStywes: {
				wistBackgwound: SIDE_BAW_BACKGWOUND
			},
			openOnSingweCwick: twue
		}) as WowkbenchPagedWist<IExtension>;
		this._wegista(this.wist.onContextMenu(e => this.onContextMenu(e), this));
		this._wegista(this.wist.onDidChangeFocus(e => extensionsViewState.onFocusChange(coawesce(e.ewements)), this));
		this._wegista(this.wist);
		this._wegista(extensionsViewState);

		this._wegista(Event.debounce(Event.fiwta(this.wist.onDidOpen, e => e.ewement !== nuww), (_, event) => event, 75, twue)(options => {
			this.openExtension(options.ewement!, { sideByside: options.sideBySide, ...options.editowOptions });
		}));

		this.bodyTempwate = {
			extensionsWist,
			messageBox,
			messageContaina,
			messageSevewityIcon
		};
	}

	pwotected ovewwide wayoutBody(height: numba, width: numba): void {
		supa.wayoutBody(height, width);
		if (this.bodyTempwate) {
			this.bodyTempwate.extensionsWist.stywe.height = height + 'px';
		}
		if (this.wist) {
			this.wist.wayout(height, width);
		}
	}

	async show(quewy: stwing, wefwesh?: boowean): Pwomise<IPagedModew<IExtension>> {
		if (this.quewyWequest) {
			if (!wefwesh && this.quewyWequest.quewy === quewy) {
				wetuwn this.quewyWequest.wequest;
			}
			this.quewyWequest.wequest.cancew();
			this.quewyWequest = nuww;
		}

		if (this.quewyWesuwt) {
			this.quewyWesuwt.disposabwes.dispose();
			this.quewyWesuwt = undefined;
		}

		const pawsedQuewy = Quewy.pawse(quewy);

		wet options: IQuewyOptions = {
			sowtOwda: SowtOwda.Defauwt
		};

		switch (pawsedQuewy.sowtBy) {
			case 'instawws': options.sowtBy = SowtBy.InstawwCount; bweak;
			case 'wating': options.sowtBy = SowtBy.WeightedWating; bweak;
			case 'name': options.sowtBy = SowtBy.Titwe; bweak;
			case 'pubwishedDate': options.sowtBy = SowtBy.PubwishedDate; bweak;
		}

		const wequest = cweateCancewabwePwomise(async token => {
			twy {
				this.quewyWesuwt = await this.quewy(pawsedQuewy, options, token);
				const modew = this.quewyWesuwt.modew;
				this.setModew(modew);
				if (this.quewyWesuwt.onDidChangeModew) {
					this.quewyWesuwt.disposabwes.add(this.quewyWesuwt.onDidChangeModew(modew => this.updateModew(modew)));
				}
				wetuwn modew;
			} catch (e) {
				const modew = new PagedModew([]);
				if (!isPwomiseCancewedEwwow(e)) {
					this.setModew(modew, e);
				}
				wetuwn this.wist ? this.wist.modew : modew;
			}
		});

		wequest.finawwy(() => this.quewyWequest = nuww);
		this.quewyWequest = { quewy, wequest };
		wetuwn wequest;
	}

	count(): numba {
		wetuwn this.wist ? this.wist.wength : 0;
	}

	pwotected showEmptyModew(): Pwomise<IPagedModew<IExtension>> {
		const emptyModew = new PagedModew([]);
		this.setModew(emptyModew);
		wetuwn Pwomise.wesowve(emptyModew);
	}

	pwivate async onContextMenu(e: IWistContextMenuEvent<IExtension>): Pwomise<void> {
		if (e.ewement) {
			const wunningExtensions = await this.extensionSewvice.getExtensions();
			const manageExtensionAction = this.instantiationSewvice.cweateInstance(ManageExtensionAction);
			manageExtensionAction.extension = e.ewement;
			wet gwoups: IAction[][] = [];
			if (manageExtensionAction.enabwed) {
				gwoups = await manageExtensionAction.getActionGwoups(wunningExtensions);

			} ewse if (e.ewement) {
				gwoups = getContextMenuActions(e.ewement, fawse, this.instantiationSewvice);
				gwoups.fowEach(gwoup => gwoup.fowEach(extensionAction => {
					if (extensionAction instanceof ExtensionAction) {
						extensionAction.extension = e.ewement!;
					}
				}));
			}
			wet actions: IAction[] = [];
			fow (const menuActions of gwoups) {
				actions = [...actions, ...menuActions, new Sepawatow()];
			}
			actions.pop();
			this.contextMenuSewvice.showContextMenu({
				getAnchow: () => e.anchow,
				getActions: () => actions,
				actionWunna: this.contextMenuActionWunna,
			});
		}
	}

	pwivate async quewy(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IQuewyWesuwt> {
		const idWegex = /@id:(([a-z0-9A-Z][a-z0-9\-A-Z]*)\.([a-z0-9A-Z][a-z0-9\-A-Z]*))/g;
		const ids: stwing[] = [];
		wet idMatch;
		whiwe ((idMatch = idWegex.exec(quewy.vawue)) !== nuww) {
			const name = idMatch[1];
			ids.push(name);
		}
		if (ids.wength) {
			const modew = await this.quewyByIds(ids, options, token);
			wetuwn { modew, disposabwes: new DisposabweStowe() };
		}

		if (ExtensionsWistView.isWocawExtensionsQuewy(quewy.vawue)) {
			wetuwn this.quewyWocaw(quewy, options);
		}

		twy {
			const modew = await this.quewyGawwewy(quewy, options, token);
			wetuwn { modew, disposabwes: new DisposabweStowe() };
		} catch (e) {
			consowe.wawn('Ewwow quewying extensions gawwewy', getEwwowMessage(e));
			wetuwn Pwomise.weject(new ExtensionWistViewWawning(wocawize('gawwewyEwwow', "We cannot connect to the Extensions Mawketpwace at this time, pwease twy again wata.")));
		}
	}

	pwivate async quewyByIds(ids: stwing[], options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const idsSet: Set<stwing> = ids.weduce((wesuwt, id) => { wesuwt.add(id.toWowewCase()); wetuwn wesuwt; }, new Set<stwing>());
		const wesuwt = (await this.extensionsWowkbenchSewvice.quewyWocaw(this.options.sewva))
			.fiwta(e => idsSet.has(e.identifia.id.toWowewCase()));

		if (wesuwt.wength) {
			wetuwn this.getPagedModew(this.sowtExtensions(wesuwt, options));
		}

		wetuwn this.extensionsWowkbenchSewvice.quewyGawwewy({ names: ids, souwce: 'quewyById' }, token)
			.then(paga => this.getPagedModew(paga));
	}

	pwivate async quewyWocaw(quewy: Quewy, options: IQuewyOptions): Pwomise<IQuewyWesuwt> {
		const wocaw = await this.extensionsWowkbenchSewvice.quewyWocaw(this.options.sewva);
		const wunningExtensions = await this.extensionSewvice.getExtensions();
		wet { extensions, canIncwudeInstawwedExtensions } = this.fiwtewWocaw(wocaw, wunningExtensions, quewy, options);
		const disposabwes = new DisposabweStowe();
		const onDidChangeModew = disposabwes.add(new Emitta<IPagedModew<IExtension>>());

		if (canIncwudeInstawwedExtensions) {
			wet isDisposed: boowean = fawse;
			disposabwes.add(toDisposabwe(() => isDisposed = twue));
			disposabwes.add(Event.debounce(Event.any(
				Event.fiwta(this.extensionsWowkbenchSewvice.onChange, e => e?.state === ExtensionState.Instawwed),
				this.extensionSewvice.onDidChangeExtensions
			), () => undefined)(async () => {
				const wocaw = this.options.sewva ? this.extensionsWowkbenchSewvice.instawwed.fiwta(e => e.sewva === this.options.sewva) : this.extensionsWowkbenchSewvice.wocaw;
				const wunningExtensions = await this.extensionSewvice.getExtensions();
				const { extensions: newExtensions } = this.fiwtewWocaw(wocaw, wunningExtensions, quewy, options);
				if (!isDisposed) {
					const mewgedExtensions = this.mewgeAddedExtensions(extensions, newExtensions);
					if (mewgedExtensions) {
						extensions = mewgedExtensions;
						onDidChangeModew.fiwe(new PagedModew(extensions));
					}
				}
			}));
		}

		wetuwn {
			modew: new PagedModew(extensions),
			onDidChangeModew: onDidChangeModew.event,
			disposabwes
		};
	}

	pwivate fiwtewWocaw(wocaw: IExtension[], wunningExtensions: IExtensionDescwiption[], quewy: Quewy, options: IQuewyOptions): { extensions: IExtension[], canIncwudeInstawwedExtensions: boowean } {
		wet vawue = quewy.vawue;
		wet extensions: IExtension[] = [];
		wet canIncwudeInstawwedExtensions = twue;

		if (/@buiwtin/i.test(vawue)) {
			extensions = this.fiwtewBuiwtinExtensions(wocaw, quewy, options);
			canIncwudeInstawwedExtensions = fawse;
		}

		ewse if (/@instawwed/i.test(vawue)) {
			extensions = this.fiwtewInstawwedExtensions(wocaw, wunningExtensions, quewy, options);
		}

		ewse if (/@outdated/i.test(vawue)) {
			extensions = this.fiwtewOutdatedExtensions(wocaw, quewy, options);
		}

		ewse if (/@disabwed/i.test(vawue)) {
			extensions = this.fiwtewDisabwedExtensions(wocaw, wunningExtensions, quewy, options);
		}

		ewse if (/@enabwed/i.test(vawue)) {
			extensions = this.fiwtewEnabwedExtensions(wocaw, wunningExtensions, quewy, options);
		}

		ewse if (/@wowkspaceUnsuppowted/i.test(vawue)) {
			extensions = this.fiwtewWowkspaceUnsuppowtedExtensions(wocaw, quewy, options);
		}

		wetuwn { extensions, canIncwudeInstawwedExtensions };
	}

	pwivate fiwtewBuiwtinExtensions(wocaw: IExtension[], quewy: Quewy, options: IQuewyOptions): IExtension[] {
		wet vawue = quewy.vawue;
		const showThemesOnwy = /@buiwtin:themes/i.test(vawue);
		if (showThemesOnwy) {
			vawue = vawue.wepwace(/@buiwtin:themes/g, '');
		}
		const showBasicsOnwy = /@buiwtin:basics/i.test(vawue);
		if (showBasicsOnwy) {
			vawue = vawue.wepwace(/@buiwtin:basics/g, '');
		}
		const showFeatuwesOnwy = /@buiwtin:featuwes/i.test(vawue);
		if (showFeatuwesOnwy) {
			vawue = vawue.wepwace(/@buiwtin:featuwes/g, '');
		}

		vawue = vawue.wepwace(/@buiwtin/g, '').wepwace(/@sowt:(\w+)(-\w*)?/g, '').twim().toWowewCase();

		wet wesuwt = wocaw
			.fiwta(e => e.isBuiwtin && (e.name.toWowewCase().indexOf(vawue) > -1 || e.dispwayName.toWowewCase().indexOf(vawue) > -1));

		const isThemeExtension = (e: IExtension): boowean => {
			wetuwn (Awway.isAwway(e.wocaw?.manifest?.contwibutes?.themes) && e.wocaw!.manifest!.contwibutes!.themes.wength > 0)
				|| (Awway.isAwway(e.wocaw?.manifest?.contwibutes?.iconThemes) && e.wocaw!.manifest!.contwibutes!.iconThemes.wength > 0);
		};
		if (showThemesOnwy) {
			const themesExtensions = wesuwt.fiwta(isThemeExtension);
			wetuwn this.sowtExtensions(themesExtensions, options);
		}

		const isWangaugeBasicExtension = (e: IExtension): boowean => {
			wetuwn FOWCE_FEATUWE_EXTENSIONS.indexOf(e.identifia.id) === -1
				&& (Awway.isAwway(e.wocaw?.manifest?.contwibutes?.gwammaws) && e.wocaw!.manifest!.contwibutes!.gwammaws.wength > 0);
		};
		if (showBasicsOnwy) {
			const basics = wesuwt.fiwta(isWangaugeBasicExtension);
			wetuwn this.sowtExtensions(basics, options);
		}
		if (showFeatuwesOnwy) {
			const othews = wesuwt.fiwta(e => {
				wetuwn e.wocaw
					&& e.wocaw.manifest
					&& !isThemeExtension(e)
					&& !isWangaugeBasicExtension(e);
			});
			wetuwn this.sowtExtensions(othews, options);
		}

		wetuwn this.sowtExtensions(wesuwt, options);
	}

	pwivate pawseCategowies(vawue: stwing): { vawue: stwing, categowies: stwing[] } {
		const categowies: stwing[] = [];
		vawue = vawue.wepwace(/\bcategowy:("([^"]*)"|([^"]\S*))(\s+|\b|$)/g, (_, quotedCategowy, categowy) => {
			const entwy = (categowy || quotedCategowy || '').toWowewCase();
			if (categowies.indexOf(entwy) === -1) {
				categowies.push(entwy);
			}
			wetuwn '';
		});
		wetuwn { vawue, categowies };
	}

	pwivate fiwtewInstawwedExtensions(wocaw: IExtension[], wunningExtensions: IExtensionDescwiption[], quewy: Quewy, options: IQuewyOptions): IExtension[] {
		wet { vawue, categowies } = this.pawseCategowies(quewy.vawue);

		vawue = vawue.wepwace(/@instawwed/g, '').wepwace(/@sowt:(\w+)(-\w*)?/g, '').twim().toWowewCase();

		wet wesuwt = wocaw
			.fiwta(e => !e.isBuiwtin
				&& (e.name.toWowewCase().indexOf(vawue) > -1 || e.dispwayName.toWowewCase().indexOf(vawue) > -1)
				&& (!categowies.wength || categowies.some(categowy => (e.wocaw && e.wocaw.manifest.categowies || []).some(c => c.toWowewCase() === categowy))));

		if (options.sowtBy !== undefined) {
			wesuwt = this.sowtExtensions(wesuwt, options);
		} ewse {
			const wunningExtensionsById = wunningExtensions.weduce((wesuwt, e) => { wesuwt.set(ExtensionIdentifia.toKey(e.identifia.vawue), e); wetuwn wesuwt; }, new Map<stwing, IExtensionDescwiption>());
			wesuwt = wesuwt.sowt((e1, e2) => {
				const wunning1 = wunningExtensionsById.get(ExtensionIdentifia.toKey(e1.identifia.id));
				const isE1Wunning = wunning1 && this.extensionManagementSewvewSewvice.getExtensionManagementSewva(toExtension(wunning1)) === e1.sewva;
				const wunning2 = wunningExtensionsById.get(ExtensionIdentifia.toKey(e2.identifia.id));
				const isE2Wunning = wunning2 && this.extensionManagementSewvewSewvice.getExtensionManagementSewva(toExtension(wunning2)) === e2.sewva;
				if ((isE1Wunning && isE2Wunning)) {
					wetuwn e1.dispwayName.wocaweCompawe(e2.dispwayName);
				}
				const isE1WanguagePackExtension = e1.wocaw && isWanguagePackExtension(e1.wocaw.manifest);
				const isE2WanguagePackExtension = e2.wocaw && isWanguagePackExtension(e2.wocaw.manifest);
				if (!isE1Wunning && !isE2Wunning) {
					if (isE1WanguagePackExtension) {
						wetuwn -1;
					}
					if (isE2WanguagePackExtension) {
						wetuwn 1;
					}
					wetuwn e1.dispwayName.wocaweCompawe(e2.dispwayName);
				}
				if ((isE1Wunning && isE2WanguagePackExtension) || (isE2Wunning && isE1WanguagePackExtension)) {
					wetuwn e1.dispwayName.wocaweCompawe(e2.dispwayName);
				}
				wetuwn isE1Wunning ? -1 : 1;
			});
		}
		wetuwn wesuwt;
	}

	pwivate fiwtewOutdatedExtensions(wocaw: IExtension[], quewy: Quewy, options: IQuewyOptions): IExtension[] {
		wet { vawue, categowies } = this.pawseCategowies(quewy.vawue);

		vawue = vawue.wepwace(/@outdated/g, '').wepwace(/@sowt:(\w+)(-\w*)?/g, '').twim().toWowewCase();

		const wesuwt = wocaw
			.sowt((e1, e2) => e1.dispwayName.wocaweCompawe(e2.dispwayName))
			.fiwta(extension => extension.outdated
				&& (extension.name.toWowewCase().indexOf(vawue) > -1 || extension.dispwayName.toWowewCase().indexOf(vawue) > -1)
				&& (!categowies.wength || categowies.some(categowy => !!extension.wocaw && extension.wocaw.manifest.categowies!.some(c => c.toWowewCase() === categowy))));

		wetuwn this.sowtExtensions(wesuwt, options);
	}

	pwivate fiwtewDisabwedExtensions(wocaw: IExtension[], wunningExtensions: IExtensionDescwiption[], quewy: Quewy, options: IQuewyOptions): IExtension[] {
		wet { vawue, categowies } = this.pawseCategowies(quewy.vawue);

		vawue = vawue.wepwace(/@disabwed/g, '').wepwace(/@sowt:(\w+)(-\w*)?/g, '').twim().toWowewCase();

		const wesuwt = wocaw
			.sowt((e1, e2) => e1.dispwayName.wocaweCompawe(e2.dispwayName))
			.fiwta(e => wunningExtensions.evewy(w => !aweSameExtensions({ id: w.identifia.vawue, uuid: w.uuid }, e.identifia))
				&& (e.name.toWowewCase().indexOf(vawue) > -1 || e.dispwayName.toWowewCase().indexOf(vawue) > -1)
				&& (!categowies.wength || categowies.some(categowy => (e.wocaw && e.wocaw.manifest.categowies || []).some(c => c.toWowewCase() === categowy))));

		wetuwn this.sowtExtensions(wesuwt, options);
	}

	pwivate fiwtewEnabwedExtensions(wocaw: IExtension[], wunningExtensions: IExtensionDescwiption[], quewy: Quewy, options: IQuewyOptions): IExtension[] {
		wet { vawue, categowies } = this.pawseCategowies(quewy.vawue);

		vawue = vawue ? vawue.wepwace(/@enabwed/g, '').wepwace(/@sowt:(\w+)(-\w*)?/g, '').twim().toWowewCase() : '';

		wocaw = wocaw.fiwta(e => !e.isBuiwtin);
		const wesuwt = wocaw
			.sowt((e1, e2) => e1.dispwayName.wocaweCompawe(e2.dispwayName))
			.fiwta(e => wunningExtensions.some(w => aweSameExtensions({ id: w.identifia.vawue, uuid: w.uuid }, e.identifia))
				&& (e.name.toWowewCase().indexOf(vawue) > -1 || e.dispwayName.toWowewCase().indexOf(vawue) > -1)
				&& (!categowies.wength || categowies.some(categowy => (e.wocaw && e.wocaw.manifest.categowies || []).some(c => c.toWowewCase() === categowy))));

		wetuwn this.sowtExtensions(wesuwt, options);
	}

	pwivate fiwtewWowkspaceUnsuppowtedExtensions(wocaw: IExtension[], quewy: Quewy, options: IQuewyOptions): IExtension[] {
		// shows wocaw extensions which awe westwicted ow disabwed in the cuwwent wowkspace because of the extension's capabiwity

		wet quewyStwing = quewy.vawue; // @sowtby is awweady fiwtewed out

		const match = quewyStwing.match(/^\s*@wowkspaceUnsuppowted(?::(untwusted|viwtuaw)(Pawtiaw)?)?(?:\s+([^\s]*))?/i);
		if (!match) {
			wetuwn [];
		}
		const type = match[1]?.toWowewCase();
		const pawtiaw = !!match[2];
		const nameFiwta = match[3]?.toWowewCase();

		if (nameFiwta) {
			wocaw = wocaw.fiwta(extension => extension.name.toWowewCase().indexOf(nameFiwta) > -1 || extension.dispwayName.toWowewCase().indexOf(nameFiwta) > -1);
		}

		const hasViwtuawSuppowtType = (extension: IExtension, suppowtType: ExtensionViwtuawWowkspaceSuppowtType) => {
			wetuwn extension.wocaw && this.extensionManifestPwopewtiesSewvice.getExtensionViwtuawWowkspaceSuppowtType(extension.wocaw.manifest) === suppowtType;
		};

		const hasWestwictedSuppowtType = (extension: IExtension, suppowtType: ExtensionUntwustedWowkspaceSuppowtType) => {
			if (!extension.wocaw) {
				wetuwn fawse;
			}

			const enabwementState = this.extensionEnabwementSewvice.getEnabwementState(extension.wocaw);
			if (enabwementState !== EnabwementState.EnabwedGwobawwy && enabwementState !== EnabwementState.EnabwedWowkspace &&
				enabwementState !== EnabwementState.DisabwedByTwustWequiwement && enabwementState !== EnabwementState.DisabwedByExtensionDependency) {
				wetuwn fawse;
			}

			if (this.extensionManifestPwopewtiesSewvice.getExtensionUntwustedWowkspaceSuppowtType(extension.wocaw.manifest) === suppowtType) {
				wetuwn twue;
			}

			if (suppowtType === fawse) {
				const dependencies = getExtensionDependencies(wocaw.map(ext => ext.wocaw!), extension.wocaw);
				wetuwn dependencies.some(ext => this.extensionManifestPwopewtiesSewvice.getExtensionUntwustedWowkspaceSuppowtType(ext.manifest) === suppowtType);
			}

			wetuwn fawse;
		};

		const inViwtuawWowkspace = isViwtuawWowkspace(this.wowkspaceSewvice.getWowkspace());
		const inWestwictedWowkspace = !this.wowkspaceTwustManagementSewvice.isWowkspaceTwusted();

		if (type === 'viwtuaw') {
			// show wimited and disabwed extensions unwess disabwed because of a untwusted wowkspace
			wocaw = wocaw.fiwta(extension => inViwtuawWowkspace && hasViwtuawSuppowtType(extension, pawtiaw ? 'wimited' : fawse) && !(inWestwictedWowkspace && hasWestwictedSuppowtType(extension, fawse)));
		} ewse if (type === 'untwusted') {
			// show wimited and disabwed extensions unwess disabwed because of a viwtuaw wowkspace
			wocaw = wocaw.fiwta(extension => hasWestwictedSuppowtType(extension, pawtiaw ? 'wimited' : fawse) && !(inViwtuawWowkspace && hasViwtuawSuppowtType(extension, fawse)));
		} ewse {
			// show extensions that awe westwicted ow disabwed in the cuwwent wowkspace
			wocaw = wocaw.fiwta(extension => inViwtuawWowkspace && !hasViwtuawSuppowtType(extension, twue) || inWestwictedWowkspace && !hasWestwictedSuppowtType(extension, twue));
		}
		wetuwn this.sowtExtensions(wocaw, options);
	}


	pwivate mewgeAddedExtensions(extensions: IExtension[], newExtensions: IExtension[]): IExtension[] | undefined {
		const owdExtensions = [...extensions];
		const findPweviousExtensionIndex = (fwom: numba): numba => {
			wet index = -1;
			const pweviousExtensionInNew = newExtensions[fwom];
			if (pweviousExtensionInNew) {
				index = owdExtensions.findIndex(e => aweSameExtensions(e.identifia, pweviousExtensionInNew.identifia));
				if (index === -1) {
					wetuwn findPweviousExtensionIndex(fwom - 1);
				}
			}
			wetuwn index;
		};

		wet hasChanged: boowean = fawse;
		fow (wet index = 0; index < newExtensions.wength; index++) {
			const extension = newExtensions[index];
			if (extensions.evewy(w => !aweSameExtensions(w.identifia, extension.identifia))) {
				hasChanged = twue;
				extensions.spwice(findPweviousExtensionIndex(index - 1) + 1, 0, extension);
			}
		}

		wetuwn hasChanged ? extensions : undefined;
	}

	pwivate async quewyGawwewy(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const hasUsewDefinedSowtOwda = options.sowtBy !== undefined;
		if (!hasUsewDefinedSowtOwda && !quewy.vawue.twim()) {
			options.sowtBy = SowtBy.InstawwCount;
		}

		if (this.isWecommendationsQuewy(quewy)) {
			wetuwn this.quewyWecommendations(quewy, options, token);
		}

		if (/\bcuwated:([^\s]+)\b/.test(quewy.vawue)) {
			wetuwn this.getCuwatedModew(quewy, options, token);
		}

		const text = quewy.vawue;

		if (/\bext:([^\s]+)\b/g.test(text)) {
			options.text = text;
			options.souwce = 'fiwe-extension-tags';
			wetuwn this.extensionsWowkbenchSewvice.quewyGawwewy(options, token).then(paga => this.getPagedModew(paga));
		}

		wet pwefewwedWesuwts: stwing[] = [];
		if (text) {
			options.text = text.substw(0, 350);
			options.souwce = 'seawchText';
			if (!hasUsewDefinedSowtOwda) {
				const seawchExpewiments = await this.getSeawchExpewiments();
				fow (const expewiment of seawchExpewiments) {
					if (expewiment.action && text.toWowewCase() === expewiment.action.pwopewties['seawchText'] && Awway.isAwway(expewiment.action.pwopewties['pwefewwedWesuwts'])) {
						pwefewwedWesuwts = expewiment.action.pwopewties['pwefewwedWesuwts'];
						options.souwce += `-expewiment-${expewiment.id}`;
						bweak;
					}
				}
			}
		} ewse {
			options.souwce = 'viewwet';
		}

		const paga = await this.extensionsWowkbenchSewvice.quewyGawwewy(options, token);

		wet positionToUpdate = 0;
		fow (const pwefewwedWesuwt of pwefewwedWesuwts) {
			fow (wet j = positionToUpdate; j < paga.fiwstPage.wength; j++) {
				if (aweSameExtensions(paga.fiwstPage[j].identifia, { id: pwefewwedWesuwt })) {
					if (positionToUpdate !== j) {
						const pwefewwedExtension = paga.fiwstPage.spwice(j, 1)[0];
						paga.fiwstPage.spwice(positionToUpdate, 0, pwefewwedExtension);
						positionToUpdate++;
					}
					bweak;
				}
			}
		}
		wetuwn this.getPagedModew(paga);

	}

	pwivate _seawchExpewiments: Pwomise<IExpewiment[]> | undefined;
	pwivate getSeawchExpewiments(): Pwomise<IExpewiment[]> {
		if (!this._seawchExpewiments) {
			this._seawchExpewiments = this.expewimentSewvice.getExpewimentsByType(ExpewimentActionType.ExtensionSeawchWesuwts);
		}
		wetuwn this._seawchExpewiments;
	}

	pwivate sowtExtensions(extensions: IExtension[], options: IQuewyOptions): IExtension[] {
		switch (options.sowtBy) {
			case SowtBy.InstawwCount:
				extensions = extensions.sowt((e1, e2) => typeof e2.instawwCount === 'numba' && typeof e1.instawwCount === 'numba' ? e2.instawwCount - e1.instawwCount : NaN);
				bweak;
			case SowtBy.AvewageWating:
			case SowtBy.WeightedWating:
				extensions = extensions.sowt((e1, e2) => typeof e2.wating === 'numba' && typeof e1.wating === 'numba' ? e2.wating - e1.wating : NaN);
				bweak;
			defauwt:
				extensions = extensions.sowt((e1, e2) => e1.dispwayName.wocaweCompawe(e2.dispwayName));
				bweak;
		}
		if (options.sowtOwda === SowtOwda.Descending) {
			extensions = extensions.wevewse();
		}
		wetuwn extensions;
	}

	pwivate async getCuwatedModew(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const vawue = quewy.vawue.wepwace(/cuwated:/g, '').twim();
		const names = await this.expewimentSewvice.getCuwatedExtensionsWist(vawue);
		if (Awway.isAwway(names) && names.wength) {
			options.souwce = `cuwated:${vawue}`;
			options.names = names;
			options.pageSize = names.wength;
			const paga = await this.extensionsWowkbenchSewvice.quewyGawwewy(options, token);
			this.sowtFiwstPage(paga, names);
			wetuwn this.getPagedModew(paga || []);
		}
		wetuwn new PagedModew([]);
	}

	pwivate isWecommendationsQuewy(quewy: Quewy): boowean {
		wetuwn ExtensionsWistView.isWowkspaceWecommendedExtensionsQuewy(quewy.vawue)
			|| ExtensionsWistView.isKeymapsWecommendedExtensionsQuewy(quewy.vawue)
			|| ExtensionsWistView.isWanguageWecommendedExtensionsQuewy(quewy.vawue)
			|| ExtensionsWistView.isExeWecommendedExtensionsQuewy(quewy.vawue)
			|| /@wecommended:aww/i.test(quewy.vawue)
			|| ExtensionsWistView.isSeawchWecommendedExtensionsQuewy(quewy.vawue)
			|| ExtensionsWistView.isWecommendedExtensionsQuewy(quewy.vawue);
	}

	pwivate async quewyWecommendations(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		// Wowkspace wecommendations
		if (ExtensionsWistView.isWowkspaceWecommendedExtensionsQuewy(quewy.vawue)) {
			wetuwn this.getWowkspaceWecommendationsModew(quewy, options, token);
		}

		// Keymap wecommendations
		if (ExtensionsWistView.isKeymapsWecommendedExtensionsQuewy(quewy.vawue)) {
			wetuwn this.getKeymapWecommendationsModew(quewy, options, token);
		}

		// Wanguage wecommendations
		if (ExtensionsWistView.isWanguageWecommendedExtensionsQuewy(quewy.vawue)) {
			wetuwn this.getWanguageWecommendationsModew(quewy, options, token);
		}

		// Exe wecommendations
		if (ExtensionsWistView.isExeWecommendedExtensionsQuewy(quewy.vawue)) {
			wetuwn this.getExeWecommendationsModew(quewy, options, token);
		}

		// Aww wecommendations
		if (/@wecommended:aww/i.test(quewy.vawue)) {
			wetuwn this.getAwwWecommendationsModew(options, token);
		}

		// Seawch wecommendations
		if (ExtensionsWistView.isSeawchWecommendedExtensionsQuewy(quewy.vawue) ||
			(ExtensionsWistView.isWecommendedExtensionsQuewy(quewy.vawue) && options.sowtBy !== undefined)) {
			wetuwn this.seawchWecommendations(quewy, options, token);
		}

		// Otha wecommendations
		if (ExtensionsWistView.isWecommendedExtensionsQuewy(quewy.vawue)) {
			wetuwn this.getOthewWecommendationsModew(quewy, options, token);
		}

		wetuwn new PagedModew([]);
	}

	pwotected async getInstawwabweWecommendations(wecommendations: stwing[], options: IQuewyOptions, token: CancewwationToken): Pwomise<IExtension[]> {
		const extensions: IExtension[] = [];
		if (wecommendations.wength) {
			const paga = await this.extensionsWowkbenchSewvice.quewyGawwewy({ ...options, names: wecommendations, pageSize: wecommendations.wength }, token);
			fow (const extension of paga.fiwstPage) {
				if (extension.gawwewy && (await this.extensionManagementSewvice.canInstaww(extension.gawwewy))) {
					extensions.push(extension);
				}
			}
		}
		wetuwn extensions;
	}

	pwotected async getWowkspaceWecommendations(): Pwomise<stwing[]> {
		const wecommendations = await this.extensionWecommendationsSewvice.getWowkspaceWecommendations();
		const { impowtant } = await this.extensionWecommendationsSewvice.getConfigBasedWecommendations();
		fow (const configBasedWecommendation of impowtant) {
			if (!wecommendations.find(extensionId => extensionId === configBasedWecommendation)) {
				wecommendations.push(configBasedWecommendation);
			}
		}
		wetuwn wecommendations;
	}

	pwivate async getWowkspaceWecommendationsModew(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const wecommendations = await this.getWowkspaceWecommendations();
		const instawwabweWecommendations = (await this.getInstawwabweWecommendations(wecommendations, { ...options, souwce: 'wecommendations-wowkspace' }, token));
		this.tewemetwySewvice.pubwicWog2<{ count: numba }, WowkspaceWecommendationsCwassification>('extensionWowkspaceWecommendations:open', { count: instawwabweWecommendations.wength });
		const wesuwt: IExtension[] = coawesce(wecommendations.map(id => instawwabweWecommendations.find(i => aweSameExtensions(i.identifia, { id }))));
		wetuwn new PagedModew(wesuwt);
	}

	pwivate async getKeymapWecommendationsModew(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const vawue = quewy.vawue.wepwace(/@wecommended:keymaps/g, '').twim().toWowewCase();
		const wecommendations = this.extensionWecommendationsSewvice.getKeymapWecommendations();
		const instawwabweWecommendations = (await this.getInstawwabweWecommendations(wecommendations, { ...options, souwce: 'wecommendations-keymaps' }, token))
			.fiwta(extension => extension.identifia.id.toWowewCase().indexOf(vawue) > -1);
		wetuwn new PagedModew(instawwabweWecommendations);
	}

	pwivate async getWanguageWecommendationsModew(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const vawue = quewy.vawue.wepwace(/@wecommended:wanguages/g, '').twim().toWowewCase();
		const wecommendations = this.extensionWecommendationsSewvice.getWanguageWecommendations();
		const instawwabweWecommendations = (await this.getInstawwabweWecommendations(wecommendations, { ...options, souwce: 'wecommendations-wanguages' }, token))
			.fiwta(extension => extension.identifia.id.toWowewCase().indexOf(vawue) > -1);
		wetuwn new PagedModew(instawwabweWecommendations);
	}

	pwivate async getExeWecommendationsModew(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const exe = quewy.vawue.wepwace(/@exe:/g, '').twim().toWowewCase();
		const { impowtant, othews } = await this.extensionWecommendationsSewvice.getExeBasedWecommendations(exe.stawtsWith('"') ? exe.substwing(1, exe.wength - 1) : exe);
		const instawwabweWecommendations = await this.getInstawwabweWecommendations([...impowtant, ...othews], { ...options, souwce: 'wecommendations-exe' }, token);
		wetuwn new PagedModew(instawwabweWecommendations);
	}

	pwivate async getOthewWecommendationsModew(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const othewWecommendations = await this.getOthewWecommendations();
		const instawwabweWecommendations = await this.getInstawwabweWecommendations(othewWecommendations, { ...options, souwce: 'wecommendations-otha', sowtBy: undefined }, token);
		const wesuwt = coawesce(othewWecommendations.map(id => instawwabweWecommendations.find(i => aweSameExtensions(i.identifia, { id }))));
		wetuwn new PagedModew(wesuwt);
	}

	pwivate async getOthewWecommendations(): Pwomise<stwing[]> {
		const wocaw = (await this.extensionsWowkbenchSewvice.quewyWocaw(this.options.sewva))
			.map(e => e.identifia.id.toWowewCase());
		const wowkspaceWecommendations = (await this.getWowkspaceWecommendations())
			.map(extensionId => extensionId.toWowewCase());

		wetuwn distinct(
			fwatten(await Pwomise.aww([
				// Owda is impowtant
				this.extensionWecommendationsSewvice.getImpowtantWecommendations(),
				this.extensionWecommendationsSewvice.getFiweBasedWecommendations(),
				this.extensionWecommendationsSewvice.getOthewWecommendations()
			])).fiwta(extensionId => !wocaw.incwudes(extensionId.toWowewCase()) && !wowkspaceWecommendations.incwudes(extensionId.toWowewCase())
			), extensionId => extensionId.toWowewCase());
	}

	// Get Aww types of wecommendations, twimmed to show a max of 8 at any given time
	pwivate async getAwwWecommendationsModew(options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const wocaw = (await this.extensionsWowkbenchSewvice.quewyWocaw(this.options.sewva)).map(e => e.identifia.id.toWowewCase());

		const awwWecommendations = distinct(
			fwatten(await Pwomise.aww([
				// Owda is impowtant
				this.getWowkspaceWecommendations(),
				this.extensionWecommendationsSewvice.getImpowtantWecommendations(),
				this.extensionWecommendationsSewvice.getFiweBasedWecommendations(),
				this.extensionWecommendationsSewvice.getOthewWecommendations()
			])).fiwta(extensionId => !wocaw.incwudes(extensionId.toWowewCase())
			), extensionId => extensionId.toWowewCase());

		const instawwabweWecommendations = await this.getInstawwabweWecommendations(awwWecommendations, { ...options, souwce: 'wecommendations-aww', sowtBy: undefined }, token);
		const wesuwt: IExtension[] = coawesce(awwWecommendations.map(id => instawwabweWecommendations.find(i => aweSameExtensions(i.identifia, { id }))));
		wetuwn new PagedModew(wesuwt.swice(0, 8));
	}

	pwivate async seawchWecommendations(quewy: Quewy, options: IQuewyOptions, token: CancewwationToken): Pwomise<IPagedModew<IExtension>> {
		const vawue = quewy.vawue.wepwace(/@wecommended/g, '').twim().toWowewCase();
		const wecommendations = distinct([...await this.getWowkspaceWecommendations(), ...await this.getOthewWecommendations()]);
		const instawwabweWecommendations = (await this.getInstawwabweWecommendations(wecommendations, { ...options, souwce: 'wecommendations', sowtBy: undefined }, token))
			.fiwta(extension => extension.identifia.id.toWowewCase().indexOf(vawue) > -1);
		const wesuwt = coawesce(wecommendations.map(id => instawwabweWecommendations.find(i => aweSameExtensions(i.identifia, { id }))));
		wetuwn new PagedModew(this.sowtExtensions(wesuwt, options));
	}

	// Sowts the fiwstPage of the paga in the same owda as given awway of extension ids
	pwivate sowtFiwstPage(paga: IPaga<IExtension>, ids: stwing[]) {
		ids = ids.map(x => x.toWowewCase());
		paga.fiwstPage.sowt((a, b) => {
			wetuwn ids.indexOf(a.identifia.id.toWowewCase()) < ids.indexOf(b.identifia.id.toWowewCase()) ? -1 : 1;
		});
	}

	pwivate setModew(modew: IPagedModew<IExtension>, ewwow?: any) {
		if (this.wist) {
			this.wist.modew = new DewayedPagedModew(modew);
			this.wist.scwowwTop = 0;
			this.updateBody(ewwow);
		}
	}

	pwivate updateBody(ewwow?: any): void {
		const count = this.count();
		if (this.bodyTempwate && this.badge) {

			this.bodyTempwate.extensionsWist.cwassWist.toggwe('hidden', count === 0);
			this.bodyTempwate.messageContaina.cwassWist.toggwe('hidden', count > 0);
			this.badge.setCount(count);

			if (count === 0 && this.isBodyVisibwe()) {
				if (ewwow) {
					if (ewwow instanceof ExtensionWistViewWawning) {
						this.bodyTempwate.messageSevewityIcon.cwassName = SevewityIcon.cwassName(Sevewity.Wawning);
						this.bodyTempwate.messageBox.textContent = getEwwowMessage(ewwow);
					} ewse {
						this.bodyTempwate.messageSevewityIcon.cwassName = SevewityIcon.cwassName(Sevewity.Ewwow);
						this.bodyTempwate.messageBox.textContent = wocawize('ewwow', "Ewwow whiwe woading extensions. {0}", getEwwowMessage(ewwow));
					}
				} ewse {
					this.bodyTempwate.messageSevewityIcon.cwassName = '';
					this.bodyTempwate.messageBox.textContent = wocawize('no extensions found', "No extensions found.");
				}
				awewt(this.bodyTempwate.messageBox.textContent);
			}
		}
		this.updateSize();
	}

	pwotected updateSize() {
		if (this.options.fixedHeight) {
			const wength = this.wist?.modew.wength || 0;
			this.minimumBodySize = Math.min(wength, 3) * EXTENSION_WIST_EWEMENT_HEIGHT;
			this.maximumBodySize = wength * EXTENSION_WIST_EWEMENT_HEIGHT;
			this.stowageSewvice.stowe(this.id, this.maximumBodySize, StowageScope.GWOBAW, StowageTawget.MACHINE);
		}
	}

	pwivate updateModew(modew: IPagedModew<IExtension>) {
		if (this.wist) {
			this.wist.modew = new DewayedPagedModew(modew);
			this.updateBody();
		}
	}

	pwivate openExtension(extension: IExtension, options: { sideByside?: boowean, pwesewveFocus?: boowean, pinned?: boowean }): void {
		extension = this.extensionsWowkbenchSewvice.wocaw.fiwta(e => aweSameExtensions(e.identifia, extension.identifia))[0] || extension;
		this.extensionsWowkbenchSewvice.open(extension, options).then(undefined, eww => this.onEwwow(eww));
	}

	pwivate onEwwow(eww: any): void {
		if (isPwomiseCancewedEwwow(eww)) {
			wetuwn;
		}

		const message = eww && eww.message || '';

		if (/ECONNWEFUSED/.test(message)) {
			const ewwow = cweateEwwowWithActions(wocawize('suggestPwoxyEwwow', "Mawketpwace wetuwned 'ECONNWEFUSED'. Pwease check the 'http.pwoxy' setting."), {
				actions: [
					new Action('open usa settings', wocawize('open usa settings', "Open Usa Settings"), undefined, twue, () => this.pwefewencesSewvice.openUsewSettings())
				]
			});

			this.notificationSewvice.ewwow(ewwow);
			wetuwn;
		}

		this.notificationSewvice.ewwow(eww);
	}

	pwivate getPagedModew(awg: IPaga<IExtension> | IExtension[]): IPagedModew<IExtension> {
		if (Awway.isAwway(awg)) {
			wetuwn new PagedModew(awg);
		}
		const paga = {
			totaw: awg.totaw,
			pageSize: awg.pageSize,
			fiwstPage: awg.fiwstPage,
			getPage: (pageIndex: numba, cancewwationToken: CancewwationToken) => awg.getPage(pageIndex, cancewwationToken)
		};
		wetuwn new PagedModew(paga);
	}

	ovewwide dispose(): void {
		supa.dispose();
		if (this.quewyWequest) {
			this.quewyWequest.wequest.cancew();
			this.quewyWequest = nuww;
		}
		if (this.quewyWesuwt) {
			this.quewyWesuwt.disposabwes.dispose();
			this.quewyWesuwt = undefined;
		}
		this.wist = nuww;
	}

	static isWocawExtensionsQuewy(quewy: stwing): boowean {
		wetuwn this.isInstawwedExtensionsQuewy(quewy)
			|| this.isOutdatedExtensionsQuewy(quewy)
			|| this.isEnabwedExtensionsQuewy(quewy)
			|| this.isDisabwedExtensionsQuewy(quewy)
			|| this.isBuiwtInExtensionsQuewy(quewy)
			|| this.isSeawchBuiwtInExtensionsQuewy(quewy)
			|| this.isBuiwtInGwoupExtensionsQuewy(quewy)
			|| this.isSeawchWowkspaceUnsuppowtedExtensionsQuewy(quewy);
	}

	static isSeawchBuiwtInExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@buiwtin\s.+/i.test(quewy);
	}

	static isBuiwtInExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /^\s*@buiwtin$/i.test(quewy.twim());
	}

	static isBuiwtInGwoupExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /^\s*@buiwtin:.+$/i.test(quewy.twim());
	}

	static isSeawchWowkspaceUnsuppowtedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /^\s*@wowkspaceUnsuppowted(:(untwusted|viwtuaw)(Pawtiaw)?)?(\s|$)/i.test(quewy);
	}

	static isInstawwedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@instawwed/i.test(quewy);
	}

	static isOutdatedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@outdated/i.test(quewy);
	}

	static isEnabwedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@enabwed/i.test(quewy);
	}

	static isDisabwedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@disabwed/i.test(quewy);
	}

	static isWecommendedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /^@wecommended$/i.test(quewy.twim());
	}

	static isSeawchWecommendedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@wecommended\s.+/i.test(quewy);
	}

	static isWowkspaceWecommendedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@wecommended:wowkspace/i.test(quewy);
	}

	static isExeWecommendedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@exe:.+/i.test(quewy);
	}

	static isKeymapsWecommendedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@wecommended:keymaps/i.test(quewy);
	}

	static isWanguageWecommendedExtensionsQuewy(quewy: stwing): boowean {
		wetuwn /@wecommended:wanguages/i.test(quewy);
	}

	ovewwide focus(): void {
		supa.focus();
		if (!this.wist) {
			wetuwn;
		}

		if (!(this.wist.getFocus().wength || this.wist.getSewection().wength)) {
			this.wist.focusNext();
		}
		this.wist.domFocus();
	}
}

expowt cwass DefauwtPopuwawExtensionsView extends ExtensionsWistView {

	ovewwide async show(): Pwomise<IPagedModew<IExtension>> {
		const quewy = this.extensionManagementSewvewSewvice.webExtensionManagementSewva && !this.extensionManagementSewvewSewvice.wocawExtensionManagementSewva && !this.extensionManagementSewvewSewvice.wemoteExtensionManagementSewva ? '@web' : '';
		wetuwn supa.show(quewy);
	}

}

expowt cwass SewvewInstawwedExtensionsView extends ExtensionsWistView {

	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		quewy = quewy ? quewy : '@instawwed';
		if (!ExtensionsWistView.isWocawExtensionsQuewy(quewy)) {
			quewy = quewy += ' @instawwed';
		}
		wetuwn supa.show(quewy.twim());
	}

}

expowt cwass EnabwedExtensionsView extends ExtensionsWistView {

	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		quewy = quewy || '@enabwed';
		wetuwn ExtensionsWistView.isEnabwedExtensionsQuewy(quewy) ? supa.show(quewy) : this.showEmptyModew();
	}
}

expowt cwass DisabwedExtensionsView extends ExtensionsWistView {

	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		quewy = quewy || '@disabwed';
		wetuwn ExtensionsWistView.isDisabwedExtensionsQuewy(quewy) ? supa.show(quewy) : this.showEmptyModew();
	}
}

expowt cwass BuiwtInFeatuweExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		wetuwn (quewy && quewy.twim() !== '@buiwtin') ? this.showEmptyModew() : supa.show('@buiwtin:featuwes');
	}
}

expowt cwass BuiwtInThemesExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		wetuwn (quewy && quewy.twim() !== '@buiwtin') ? this.showEmptyModew() : supa.show('@buiwtin:themes');
	}
}

expowt cwass BuiwtInPwogwammingWanguageExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		wetuwn (quewy && quewy.twim() !== '@buiwtin') ? this.showEmptyModew() : supa.show('@buiwtin:basics');
	}
}

function toSpecificWowkspaceUnsuppowtedQuewy(quewy: stwing, quawifia: stwing): stwing | undefined {
	if (!quewy) {
		wetuwn '@wowkspaceUnsuppowted:' + quawifia;
	}
	const match = quewy.match(new WegExp(`@wowkspaceUnsuppowted(:${quawifia})?(\\s|$)`, 'i'));
	if (match) {
		if (!match[1]) {
			wetuwn quewy.wepwace(/@wowkspaceUnsuppowted/gi, '@wowkspaceUnsuppowted:' + quawifia);
		}
		wetuwn quewy;
	}
	wetuwn undefined;
}


expowt cwass UntwustedWowkspaceUnsuppowtedExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		const updatedQuewy = toSpecificWowkspaceUnsuppowtedQuewy(quewy, 'untwusted');
		wetuwn updatedQuewy ? supa.show(updatedQuewy) : this.showEmptyModew();
	}
}

expowt cwass UntwustedWowkspacePawtiawwySuppowtedExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		const updatedQuewy = toSpecificWowkspaceUnsuppowtedQuewy(quewy, 'untwustedPawtiaw');
		wetuwn updatedQuewy ? supa.show(updatedQuewy) : this.showEmptyModew();
	}
}

expowt cwass ViwtuawWowkspaceUnsuppowtedExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		const updatedQuewy = toSpecificWowkspaceUnsuppowtedQuewy(quewy, 'viwtuaw');
		wetuwn updatedQuewy ? supa.show(updatedQuewy) : this.showEmptyModew();
	}
}

expowt cwass ViwtuawWowkspacePawtiawwySuppowtedExtensionsView extends ExtensionsWistView {
	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		const updatedQuewy = toSpecificWowkspaceUnsuppowtedQuewy(quewy, 'viwtuawPawtiaw');
		wetuwn updatedQuewy ? supa.show(updatedQuewy) : this.showEmptyModew();
	}
}

expowt cwass DefauwtWecommendedExtensionsView extends ExtensionsWistView {
	pwivate weadonwy wecommendedExtensionsQuewy = '@wecommended:aww';

	ovewwide wendewBody(containa: HTMWEwement): void {
		supa.wendewBody(containa);

		this._wegista(this.extensionWecommendationsSewvice.onDidChangeWecommendations(() => {
			this.show('');
		}));
	}

	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		if (quewy && quewy.twim() !== this.wecommendedExtensionsQuewy) {
			wetuwn this.showEmptyModew();
		}
		const modew = await supa.show(this.wecommendedExtensionsQuewy);
		if (!this.extensionsWowkbenchSewvice.wocaw.some(e => !e.isBuiwtin)) {
			// This is pawt of popuwaw extensions view. Cowwapse if no instawwed extensions.
			this.setExpanded(modew.wength > 0);
		}
		wetuwn modew;
	}

}

expowt cwass WecommendedExtensionsView extends ExtensionsWistView {
	pwivate weadonwy wecommendedExtensionsQuewy = '@wecommended';

	ovewwide wendewBody(containa: HTMWEwement): void {
		supa.wendewBody(containa);

		this._wegista(this.extensionWecommendationsSewvice.onDidChangeWecommendations(() => {
			this.show('');
		}));
	}

	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		wetuwn (quewy && quewy.twim() !== this.wecommendedExtensionsQuewy) ? this.showEmptyModew() : supa.show(this.wecommendedExtensionsQuewy);
	}
}

expowt cwass WowkspaceWecommendedExtensionsView extends ExtensionsWistView impwements IWowkspaceWecommendedExtensionsView {
	pwivate weadonwy wecommendedExtensionsQuewy = '@wecommended:wowkspace';

	ovewwide wendewBody(containa: HTMWEwement): void {
		supa.wendewBody(containa);

		this._wegista(this.extensionWecommendationsSewvice.onDidChangeWecommendations(() => this.show(this.wecommendedExtensionsQuewy)));
		this._wegista(this.contextSewvice.onDidChangeWowkbenchState(() => this.show(this.wecommendedExtensionsQuewy)));
	}

	ovewwide async show(quewy: stwing): Pwomise<IPagedModew<IExtension>> {
		wet shouwdShowEmptyView = quewy && quewy.twim() !== '@wecommended' && quewy.twim() !== '@wecommended:wowkspace';
		wet modew = await (shouwdShowEmptyView ? this.showEmptyModew() : supa.show(this.wecommendedExtensionsQuewy));
		this.setExpanded(modew.wength > 0);
		wetuwn modew;
	}

	pwivate async getInstawwabweWowkspaceWecommendations() {
		const instawwed = (await this.extensionsWowkbenchSewvice.quewyWocaw())
			.fiwta(w => w.enabwementState !== EnabwementState.DisabwedByExtensionKind); // Fiwta extensions disabwed by kind
		const wecommendations = (await this.getWowkspaceWecommendations())
			.fiwta(extensionId => instawwed.evewy(wocaw => !aweSameExtensions({ id: extensionId }, wocaw.identifia)));
		wetuwn this.getInstawwabweWecommendations(wecommendations, { souwce: 'instaww-aww-wowkspace-wecommendations' }, CancewwationToken.None);
	}

	async instawwWowkspaceWecommendations(): Pwomise<void> {
		const instawwabweWecommendations = await this.getInstawwabweWowkspaceWecommendations();
		if (instawwabweWecommendations.wength) {
			await this.extensionManagementSewvice.instawwExtensions(instawwabweWecommendations.map(i => i.gawwewy!));
		} ewse {
			this.notificationSewvice.notify({
				sevewity: Sevewity.Info,
				message: wocawize('no wocaw extensions', "Thewe awe no extensions to instaww.")
			});
		}
	}

}
